

==================================================
ARCHIVO: ./requirements.txt
==================================================

# --- CORE API ---
fastapi>=0.115.0
uvicorn[standard]>=0.32.0
starlette>=0.41.0
pydantic>=2.9.0
pydantic-settings>=2.6.0

# --- BASE DE DATOS ---
sqlalchemy>=2.0.36
psycopg2-binary>=2.9.9

# --- UTILIDADES ---
python-dotenv>=1.0.1
requests>=2.32.3
python-dateutil>=2.9.0
Jinja2>=3.1.4
MarkupSafe>=3.0.2
click>=8.1.7

# --- SCRAPING (CR√çTICO: Versiones Flexibles) ---
# Usamos >= para asegurar compatibilidad con Chrome 142+
selenium>=4.27.0
webdriver-manager>=4.0.2

# --- TAREAS AS√çNCRONAS ---
celery>=5.4.0
kombu>=5.4.0
redis>=5.2.0
amqp>=5.2.0
billiard>=4.2.0
vine>=5.1.0

# --- ASYNC & PERFORMANCE ---
anyio>=4.6.0
greenlet>=3.1.1
h11>=0.14.0
httptools>=0.6.4
uvloop>=0.21.0
watchfiles>=0.24.0
websockets>=13.1
trio>=0.27.0

# --- OTROS ---
certifi>=2024.8.30
charset-normalizer>=3.4.0
idna>=3.10
urllib3>=2.2.3
typing_extensions>=4.12.0
packaging>=24.1
annotated-types>=0.7.0
sniffio>=1.3.1
sortedcontainers>=2.4.0

# --- SEGURIDAD (FIX) ---
python-multipart
python-jose[cryptography]
passlib==1.7.4
bcrypt==4.0.1

beautifulsoup4


==================================================
ARCHIVO: ./README.md
==================================================

# GoAnalisis - Dashboard de Inteligencia de Negocio Operativo

**GoAnalisis** es una aplicaci√≥n web full-stack dise√±ada para la monitorizaci√≥n y an√°lisis en tiempo real de una plataforma de gesti√≥n de pedidos.
 La aplicaci√≥n utiliza un sistema de web scraping avanzado para extraer datos 24/7, los procesa para generar KPIs clave y los presenta en un dashboard
 interactivo y profesional.

El objetivo principal de GoAnalisis es identificar cuellos de botella operativos, analizar tendencias de negocio y proporcionar una visi√≥n clara del
 rendimiento de entidades clave como tiendas y repartidores.

---

## Caracter√≠sticas Principales

*   **Monitorizaci√≥n 24/7:** Workers as√≠ncronos con Celery y Selenium que extraen datos continuamente.
*   **An√°lisis de Cuellos de Botella:** Calcula y visualiza el tiempo promedio que los pedidos pasan en cada estado operativo.
*   **KPIs en Tiempo Real:** Tarjetas con m√©tricas clave que se actualizan peri√≥dicamente (total de pedidos, ingresos, etc.).
*   **An√°lisis de Tendencias:** Gr√°ficos interactivos para visualizar la evoluci√≥n de los ingresos y el volumen de pedidos a lo largo del tiempo.
*   **Rankings de Entidades:** Gr√°ficos y listas con el top 10 de repartidores y tiendas por volumen de pedidos.
*   **Dashboard Interactivo:** Frontend moderno construido con Bootstrap 5 y Chart.js, con filtros por rango de fechas.
*   **Arquitectura Contenerizada:** Todo el ecosistema (API, workers, base de datos, broker) est√° dockerizado para un despliegue f√°cil y reproducible.

---

## Arquitectura y Tecnolog√≠as

| Componente        | Tecnolog√≠a                               | Prop√≥sito                                                |
|-------------------|------------------------------------------|----------------------------------------------------------|
| **Backend API**   | Python 3.12, FastAPI                     | Servir los datos procesados a trav√©s de una API RESTful. |
| **Scraping**      | Selenium                                 | Simular la navegaci√≥n y extraer datos de la plataforma.  |
| **Tareas Async**  | Celery                                   | Orquestar y programar las tareas de scraping.            |
| **Message Broker**| Redis                                    | Comunicar las tareas programadas a los workers.          |
| **Base de Datos** | PostgreSQL                               | Almacenar y persistir todos los datos extra√≠dos.         |
| **ORM**           | SQLAlchemy                               | Mapear los objetos de Python a las tablas de la BD.      |
| **An√°lisis**      | Pandas (a futuro), SQLAlchemy            | Procesar y agregar los datos para los KPIs.              |
| **Frontend**      | HTML5, CSS3, JavaScript                  | Estructura y l√≥gica del dashboard.                       |
| **UI Frameworks** | Bootstrap 5, Chart.js, Flatpickr.js      | Dise√±o responsive, gr√°ficos y selector de fechas.        |
| **Entorno**       | Docker, Docker Compose                   | Contenerizaci√≥n y orquestaci√≥n de todos los servicios.   |

---

## Puesta en Marcha (Despliegue)

Para levantar la aplicaci√≥n completa en un entorno de desarrollo o producci√≥n, sigue estos pasos.

### Prerrequisitos

*   [Docker](https://www.docker.com/get-started) instalado.
*   [Docker Compose](https://docs.docker.com/compose/install/) instalado.
*   Git (para clonar el repositorio).

### 1. Clonar el Repositorio

```bash
git clone [URL_DE_TU_REPOSITORIO]
cd goanalisis
```

### 2. Configurar el Entorno

La aplicaci√≥n se configura a trav√©s de un archivo `.env`. Crea una copia del archivo de ejemplo y rellena las variables.

```bash
# A√∫n no tenemos un .env.example, pero este ser√≠a el paso.
# Por ahora, crea el archivo .env manualmente.
touch .env
```

Abre el archivo `.env` y a√±ade la siguiente configuraci√≥n, reemplazando los valores necesarios:

```ini
# Configuraci√≥n de PostgreSQL (Docker la usar√° para inicializar la BD)
POSTGRES_USER=operaciones
POSTGRES_PASSWORD=[TU_CONTRASE√ëA_SEGURA_PARA_LA_BD]
POSTGRES_DB=goanalisis_db

# Configuraci√≥n de la Aplicaci√≥n (los contenedores la leer√°n)
# ¬°IMPORTANTE! POSTGRES_SERVER debe ser el nombre del servicio de Docker ('db')
POSTGRES_SERVER=db
REDIS_URL=redis://redis:6379/0

# Credenciales de la plataforma de scraping
LOGIN_URL=https://ecosistema.gopharma.com.ve/login/admin
GOPHARMA_EMAIL=[TU_EMAIL_DE_LOGIN]
GOPHARMA_PASSWORD=[TU_PASSWORD_DE_LOGIN]
SCRAPER_HEADLESS=True
```

### 3. Levantar la Aplicaci√≥n con Docker Compose

Este comando construir√° las im√°genes de la aplicaci√≥n, descargar√° las de Postgres y Redis, crear√° la red y lanzar√° todos los contenedores.

```bash
docker compose up --build
```

La primera vez, la construcci√≥n puede tardar varios minutos. En las siguientes ejecuciones, ser√° mucho m√°s r√°pido. Ver√°s los logs de todos los servicios en tu terminal. Para detener todo, presiona `Ctrl + C`.

### 4. Inicializar la Base de Datos

La primera vez que levantes la aplicaci√≥n, la base de datos estar√° vac√≠a. Abre una **nueva terminal** (sin detener `docker compose`) y ejecuta el siguiente comando para crear todas las tablas:

```bash
docker compose exec api python create_tables.py```

Deber√≠as ver el mensaje "¬°Tablas creadas con √©xito!".

### 5. Acceder al Dashboard

¬°Listo! La aplicaci√≥n est√° en marcha.

*   **Dashboard:** Abre tu navegador y ve a `http://localhost:8000`
*   **Documentaci√≥n de la API:** Accede a `http://localhost:8000/docs`

El sistema comenzar√° a recopilar y procesar datos autom√°ticamente. La informaci√≥n aparecer√° en el dashboard a medida que los workers de Celery completen sus ciclos.

---

## Estructura del Proyecto

```
/goanalisis/
‚îú‚îÄ‚îÄ app/                  # C√≥digo de la aplicaci√≥n FastAPI (API, frontend, DB)
‚îÇ   ‚îú‚îÄ‚îÄ api/              # Endpoints y dependencias de la API
‚îÇ   ‚îú‚îÄ‚îÄ core/             # Configuraci√≥n central
‚îÇ   ‚îú‚îÄ‚îÄ db/               # Modelos y sesi√≥n de SQLAlchemy
‚îÇ   ‚îú‚îÄ‚îÄ schemas/          # Esquemas Pydantic para validaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ services/         # L√≥gica de negocio (c√°lculos, etc.)
‚îÇ   ‚îî‚îÄ‚îÄ static/           # Archivos CSS y JS
‚îÇ   ‚îî‚îÄ‚îÄ templates/        # Plantillas HTML (index.html)
‚îú‚îÄ‚îÄ tasks/                # C√≥digo de las tareas as√≠ncronas de Celery
‚îÇ   ‚îú‚îÄ‚îÄ scraper/          # L√≥gica de scraping con Selenium
‚îÇ   ‚îî‚îÄ‚îÄ celery_tasks.py   # Definici√≥n de las tareas
‚îú‚îÄ‚îÄ .env                  # Archivo de configuraci√≥n (NO versionar)
‚îú‚îÄ‚îÄ create_tables.py      # Script para inicializar la BD
‚îú‚îÄ‚îÄ Dockerfile            # Instrucciones para construir la imagen de la app
‚îî‚îÄ‚îÄ docker-compose.yml    # Orquestaci√≥n de todos los servicios
```


==================================================
ARCHIVO: ./.gitignore
==================================================

# --- Archivos de Entorno Virtual y Dependencias Locales ---
# No queremos subir el contenido del entorno virtual
venv/
/venv/

# Archivos de cach√© de pip
pip-cache/
*.pip

# --- Archivos Sensibles ---
# El archivo .env contiene credenciales y nunca debe ser versionado
.env
/.env
*.env.*

# --- Archivos de Configuraci√≥n de IDEs y Editores ---
.vscode/
.idea/
*.swp
*.swo

# --- Archivos de Cach√© y Compilados de Python ---
__pycache__/
*.py[cod]
*$py.class

# --- Archivos del Sistema Operativo ---
.DS_Store
Thumbs.db

# --- Archivos de Docker ---
# No es necesario ignorar Dockerfile o docker-compose.yml,
# pero s√≠ los archivos generados por Docker localmente, como los vol√∫menes de cach√©.
.dockerignore
docker-compose.override.yml

# --- Archivos de Celery ---
# Archivo de persistencia del planificador (scheduler) de Celery Beat
celerybeat-schedule
celerybeat.pid

# --- Archivos de Pruebas ---
.pytest_cache/
htmlcov/
.coverage

# --- Logs y Bases de Datos Locales (si las hubiera fuera de Docker) ---
*.log
*.sqlite3
*.db

# --- CR√çTICO: Datos y Vol√∫menes del Proyecto ---
# La carpeta donde Docker guarda la DB localmente (si usas bind mounts)
postgres_data/

# Archivos de respaldo de base de datos (¬°No subir la data real!)
backup.sql
*.sql
*.dump

# Persistencia de Redis (si se genera localmente)
dump.rdb

# Archivos temporales de Selenium/Chrome (si se generan en el proyecto)
.wdm/
chromedriver*
.env
__pycache__/
venv/


==================================================
ARCHIVO: ./Dockerfile
==================================================

# Usamos una imagen base que ya incluye muchas herramientas comunes
FROM python:3.12-bullseye

# Establecemos el directorio de trabajo
WORKDIR /app

# Actualizamos los paquetes e instalamos 'wget' y 'build-essential'
RUN apt-get update && apt-get install -y wget build-essential locales

# --- NUEVO: Configurar la localizaci√≥n en espa√±ol ---
RUN echo "es_ES.UTF-8 UTF-8" >> /etc/locale.gen && \
    locale-gen es_ES.UTF-8 && \
    update-locale LANG=es_ES.UTF-8
ENV LANG es_ES.UTF-8

# --- INSTALACI√ìN DIRECTA DE GOOGLE CHROME ---
# 1. Descargamos el paquete oficial .deb de Google Chrome
RUN wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb

# 2. Instalamos el paquete. El comando 'apt-get install -f -y' es crucial,
# ya que autom√°ticamente busca e instala TODAS las dependencias que Chrome necesita.
RUN apt-get install -y ./google-chrome-stable_current_amd64.deb || apt-get install -f -y

# 3. Limpiamos el archivo descargado para mantener la imagen ligera
RUN rm google-chrome-stable_current_amd64.deb
# --------------------------------------------

# Copiamos solo el archivo de requerimientos para aprovechar la cach√© de Docker
COPY requirements.txt .

# Instalamos las dependencias de Python
RUN pip install --no-cache-dir -r requirements.txt

# Copiamos todo el c√≥digo fuente de nuestra aplicaci√≥n a la imagen
COPY . .

# Exponemos el puerto de la API
EXPOSE 8000

# Definimos el comando por defecto para iniciar el servidor uvicorn
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]


==================================================
ARCHIVO: ./celery_worker.py
==================================================



==================================================
ARCHIVO: ./create_tables.py
==================================================

# Es posible que necesitemos instalar SQLAlchemy si no lo hemos hecho
# pip install SQLAlchemy
from app.db.base import Base
from app.db.session import engine

def create_database_tables():
    """
    Se conecta a la base de datos definida en el engine y crea todas las
    tablas definidas en los modelos que heredan de la Base declarativa.
    """
    print("Iniciando la creaci√≥n de tablas en la base de datos...")
    
    try:
        # La magia sucede aqu√≠: SQLAlchemy inspecciona todos los modelos
        # importados que heredan de `Base` y crea las tablas correspondientes.
        Base.metadata.create_all(bind=engine)
        print("¬°Tablas creadas con √©xito!")
        print("Puedes verificarlo conect√°ndote a la base de datos 'goanalisis_db'.")
    except Exception as e:
        print(f"Ocurri√≥ un error al intentar crear las tablas: {e}")

if __name__ == "__main__":
    create_database_tables()


==================================================
ARCHIVO: ./debug_customer.py
==================================================

import logging
from tasks.scraper.customer_scraper import CustomerScraper
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

logging.basicConfig(level=logging.INFO)

def debug():
    print("üïµÔ∏è‚Äç‚ôÇÔ∏è INICIANDO ESPIONAJE DE CLIENTES...")
    s = CustomerScraper()
    if not s.login(): return print("‚ùå Login fall√≥")
    
    s.driver.get(s.users_url)
    WebDriverWait(s.driver, 15).until(EC.presence_of_element_located((By.TAG_NAME, "table")))
    
    # Imprimir cabeceras para ver el orden
    headers = s.driver.find_elements(By.TAG_NAME, "th")
    print(f"CABECERAS: {[h.text for h in headers]}")
    
    # Imprimir primeras 5 filas completas
    rows = s.driver.find_elements(By.XPATH, "//table/tbody/tr")
    for i, row in enumerate(rows[:5]):
        cols = row.find_elements(By.TAG_NAME, "td")
        print(f"\n--- FILA {i+1} ---")
        for j, col in enumerate(cols):
            print(f"Col {j}: '{col.text}'")
            
    s.close_driver()

if __name__ == "__main__":
    debug()


==================================================
ARCHIVO: ./debug_newyear.py
==================================================

import logging
from tasks.scraper.order_scraper import OrderScraper
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

# Configurar logs para verlos en consola
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def debug_now():
    print("\nüïµÔ∏è‚Äç‚ôÇÔ∏è INICIANDO DIAGN√ìSTICO DE A√ëO NUEVO...\n")
    
    scraper = OrderScraper()
    if not scraper.login():
        print("‚ùå Error de Login.")
        return

    print("üï∑Ô∏è Navegando a la lista de pedidos...")
    scraper.driver.get(scraper.orders_url)
    
    try:
        WebDriverWait(scraper.driver, 15).until(EC.presence_of_element_located((By.TAG_NAME, "body")))
        
        # 1. Verificaci√≥n de IDs
        print("\n--- PRUEBA 1: BUSCANDO IDs ---")
        links = scraper.driver.find_elements(By.CSS_SELECTOR, "a[href*='/admin/order/details/']")
        if links:
            print(f"‚úÖ Se encontraron {len(links)} enlaces de detalle.")
            print(f"Ejemplo ID: {links[0].get_attribute('href')}")
        else:
            print("‚ùå NO SE ENCONTRARON ENLACES DE PEDIDOS. ¬øCambi√≥ el selector?")

        # 2. Verificaci√≥n de Fechas (La parte cr√≠tica)
        print("\n--- PRUEBA 2: LECTURA DE FECHAS ---")
        rows = scraper.driver.find_elements(By.XPATH, "//table/tbody/tr")
        count = 0
        for row in rows:
            text = row.text
            # Filtramos filas vac√≠as o de carrito para ver solo pedidos reales
            if "Procesado" in text or "Entregado" in text:
                print(f"\n[FILA {count+1}] Texto completo:")
                print(text)
                print("-" * 20)
                count += 1
            if count >= 3: break
            
    except Exception as e:
        print(f"üí• Error durante el diagn√≥stico: {e}")
    finally:
        scraper.close_driver()
        print("\nüèÅ Diagn√≥stico finalizado.")

if __name__ == "__main__":
    debug_now()


==================================================
ARCHIVO: ./debug_order.py
==================================================

import sys
from tasks.scraper.drone_scraper import DroneScraper

# ID del pedido rebelde (c√°mbialo si es otro)
ORDER_ID = "106893" 

if len(sys.argv) > 1:
    ORDER_ID = sys.argv[1]

def diagnose():
    print(f"üïµÔ∏è‚Äç‚ôÇÔ∏è DIAGNOSTICANDO PEDIDO #{ORDER_ID}...")
    
    drone = DroneScraper()
    if not drone.login():
        print("‚ùå Error de Login")
        return

    try:
        # Extraemos la data CRUDA
        print("üöÄ Extrayendo datos...")
        data = drone.scrape_detail(ORDER_ID, mode='full')
        
        print("\n--- RESULTADOS DEL ROBOT ---")
        print(f"ID Externo: {data.get('external_id')}")
        print(f"Texto Estatus (RAW HTML): '{data.get('status_text')}'")  # <--- ESTO ES LO IMPORTANTE
        print(f"Conductor: '{data.get('driver_name')}'")
        print(f"Monto: {data.get('total_amount')}")
        print("----------------------------\n")
        
        # Simulamos la l√≥gica de decisi√≥n
        status_text = data.get('status_text', '').lower()
        db_status = "pending (default)"
        
        if "entregado" in status_text: db_status = "delivered"
        elif "cancelado" in status_text: db_status = "canceled"
        elif "asignado" in status_text: db_status = "driver_assigned"
        elif "camino" in status_text or "ruta" in status_text: db_status = "on_the_way"
        elif "proceso" in status_text: db_status = "processing"
        elif "confirmado" in status_text: db_status = "confirmed"
        
        print(f"‚öñÔ∏è VEREDICTO DEL SISTEMA: El estatus se guardar√≠a como: -> {db_status.upper()}")

    except Exception as e:
        print(f"‚ùå Error: {e}")
    finally:
        drone.close_driver()

if __name__ == "__main__":
    diagnose()


==================================================
ARCHIVO: ./debug_pickups.py
==================================================

from sqlalchemy import text
from app.db.session import SessionLocal

def check_weird_pickups():
    db = SessionLocal()
    print("üïµÔ∏è‚Äç‚ôÇÔ∏è BUSCANDO FALSOS PICKUPS (Versi√≥n Compatible Postgres)...")
    
    # CASO 1: Pickup pero TIENE un Driver asignado
    # Correcci√≥n: Usamos order_type::text para evitar error de Enum
    sql_drivers = text("""
        SELECT external_id, order_type, driver_id, distance_km 
        FROM orders 
        WHERE order_type::text = 'Pickup' AND driver_id IS NOT NULL;
    """)
    
    try:
        results_drivers = db.execute(sql_drivers).fetchall()
        print(f"\nüö® CASO 1: Pickups que tienen ID de Chofer en DB ({len(results_drivers)}):")
        for r in results_drivers:
            print(f"   - #{r.external_id} (Dist: {r.distance_km}km) -> DriverID: {r.driver_id}")
    except Exception as e:
        print(f"Error en Caso 1: {e}")

    # CASO 2: Pickup con distancia sospechosa (> 0.5 km)
    sql_dist = text("""
        SELECT external_id, order_type, distance_km 
        FROM orders 
        WHERE order_type::text = 'Pickup' AND distance_km > 0.5;
    """)
    
    try:
        results_dist = db.execute(sql_dist).fetchall()
        print(f"\nüö® CASO 2: Pickups con distancia larga (>0.5km) ({len(results_dist)}):")
        for r in results_dist:
            print(f"   - #{r.external_id} -> {r.distance_km} km")
    except Exception as e:
        print(f"Error en Caso 2: {e}")

    db.close()

if __name__ == "__main__":
    check_weird_pickups()


==================================================
ARCHIVO: ./docker-compose.yml
==================================================

version: '3.8'

services:
  # 1. Base de Datos
  db:
    image: postgres:15-alpine
    container_name: goanalisis_db
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "5433:5432"
    restart: unless-stopped

  # 2. Redis
  redis:
    image: redis:7-alpine
    container_name: goanalisis_redis
    ports:
      - "6380:6379"
    restart: unless-stopped

  # 3. API (FastAPI)
  api:
    build: .
    container_name: goanalisis_api
    environment:
      - REDIS_URL=redis://redis:6379/0
      - POSTGRES_SERVER=db
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    env_file:
      - .env
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    volumes:
      - .:/app:z
    ports:
      - "8001:8000"
    depends_on:
      - db
      - redis
    restart: unless-stopped

  # 4. Worker (Celery + Selenium) - RENOMBRADO PARA CORREGIR ERROR
  celery_node:
    build: .
    container_name: goanalisis_celery_node
    environment:
      - REDIS_URL=redis://redis:6379/0
      - POSTGRES_SERVER=db
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    env_file:
      - .env
    command: celery -A tasks.celery_app worker --loglevel=info --concurrency=3
    volumes:
      - .:/app
    depends_on:
      - redis
      - db
    # AUMENTO DE MEMORIA PARA EVITAR CRASH DE CHROME
    shm_size: '2gb' 
    restart: unless-stopped
    
  # 5. Beat (Scheduler)
  celery_beat:
    build: .
    container_name: goanalisis_celery_beat
    environment:
      - REDIS_URL=redis://redis:6379/0
    env_file:
      - .env
    command: celery -A tasks.celery_app beat --loglevel=info
    volumes:
      - .:/app
    depends_on:
      - redis
      - db
    restart: unless-stopped

volumes:
  postgres_data:


==================================================
ARCHIVO: ./fix_stuck_orders.py
==================================================

# fix_stuck_orders.py
import logging
from datetime import datetime, timedelta
from app.db.session import SessionLocal
from app.db.base import Order
from tasks.scraper.drone_scraper import DroneScraper
from tasks.celery_tasks import process_drone_data

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def run_fix():
    db = SessionLocal()
    drone = DroneScraper()
    
    # Rango: Desde ayer a las 00:00 hasta hace 4 horas
    yesterday = datetime.utcnow() - timedelta(hours=30)
    limit_time = datetime.utcnow() - timedelta(hours=4)
    
    # Buscamos TODO lo que no est√© finalizado
    stuck_orders = db.query(Order).filter(
        Order.created_at >= yesterday,
        Order.created_at <= limit_time,
        Order.current_status.in_(['pending', 'processing', 'confirmed', 'driver_assigned', 'on_the_way'])
    ).all()
    
    logger.info(f"üö® Encontrados {len(stuck_orders)} pedidos atascados. Iniciando limpieza...")
    
    if not stuck_orders:
        return

    if not drone.login():
        logger.error("Fallo login dron")
        return

    count = 0
    for order in stuck_orders:
        count += 1
        logger.info(f"[{count}/{len(stuck_orders)}] Auditando #{order.external_id} ({order.current_status})...")
        try:
            # Modo full para traer estatus, mapa y finanzas
            data = drone.scrape_detail(order.external_id, mode='full')
            process_drone_data(db, data)
        except Exception as e:
            logger.error(f"Error en {order.external_id}: {e}")
            
    drone.close_driver()
    db.close()
    logger.info("‚úÖ Limpieza terminada.")

if __name__ == "__main__":
    run_fix()


==================================================
ARCHIVO: ./full_historical_repair.py
==================================================

import logging
import time
from datetime import datetime, timedelta
from sqlalchemy import or_, and_

from app.db.session import SessionLocal
from app.db.base import Order, Driver
from tasks.scraper.drone_scraper import DroneScraper
from tasks.celery_tasks import process_drone_data

# Configuraci√≥n de Logging
logging.basicConfig(
    format='%(asctime)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

def run_full_audit():
    logger.info("ü¶ñ INICIANDO AUDITOR√çA PALEONTOL√ìGICA (TODA LA HISTORIA)...")
    
    db = SessionLocal()
    
    # FECHA CORTE: Ignoramos los pedidos de las √∫ltimas 24h (est√°n vivos)
    cutoff_time = datetime.utcnow() - timedelta(hours=24)
    
    logger.info("üîç Buscando incoherencias en la Base de Datos...")

    # --- GRUPO 1: ZOMBIES (No finalizados y viejos) ---
    zombies = db.query(Order).filter(
        Order.created_at < cutoff_time,
        Order.current_status.in_(['pending', 'processing', 'confirmed', 'driver_assigned', 'on_the_way'])
    ).all()
    
    # --- GRUPO 2: FALSOS DELIVERIES (Entregado + Delivery + Sin Chofer) ---
    # Esto corregir√° todos los Pickups mal clasificados hist√≥ricamente
    fake_deliveries = db.query(Order).filter(
        Order.current_status == 'delivered',
        Order.order_type == 'Delivery',
        Order.driver_id == None
    ).all()

    # --- GRUPO 3: MONTOS CERO (Datos incompletos) ---
    empty_amounts = db.query(Order).filter(
        Order.total_amount == 0,
        Order.current_status != 'canceled' # Ignoramos cancelados que pueden ser 0
    ).all()

    # Consolidar lista √∫nica de IDs para no repetir trabajo
    targets = {}
    
    for o in zombies: targets[o.external_id] = "Zombie (No cerrado)"
    for o in fake_deliveries: targets[o.external_id] = "Falso Delivery (Pickup real)"
    for o in empty_amounts: targets[o.external_id] = "Monto Cero"

    total_targets = len(targets)
    logger.info(f"üìä DIAGN√ìSTICO INICIAL:")
    logger.info(f"   - Zombies encontrados: {len(zombies)}")
    logger.info(f"   - Falsos Deliveries (Pickups): {len(fake_deliveries)}")
    logger.info(f"   - Montos vac√≠os: {len(empty_amounts)}")
    logger.info(f"   ----------------------------------------")
    logger.info(f"   üéØ TOTAL A REPARAR: {total_targets} pedidos √∫nicos.")

    if total_targets == 0:
        logger.info("‚ú® ¬°El sistema est√° inmaculado! Nada que reparar.")
        return

    # --- EJECUCI√ìN DEL DRON ---
    drone = DroneScraper()
    if not drone.login():
        logger.error("‚ùå Fallo cr√≠tico: No se pudo loguear el Dron.")
        return

    logger.info("üöÄ Iniciando reparaciones masivas...")
    
    count = 0
    errors = 0
    
    for eid, reason in targets.items():
        count += 1
        try:
            logger.info(f"üîß [{count}/{total_targets}] Reparando #{eid} -> Causa: {reason}")
            
            # 1. Scrape Full (Trae estatus, montos, chofer y mapa)
            data = drone.scrape_detail(eid, mode='full')
            
            # 2. Guardado Inteligente (Aplica las reglas nuevas de Pickup)
            process_drone_data(db, data)
            
            # Peque√±a pausa para no tumbar el servidor de GoPharma
            # time.sleep(0.5) 
            
        except Exception as e:
            logger.error(f"‚ö†Ô∏è Error reparando {eid}: {e}")
            errors += 1

    drone.close_driver()
    db.close()
    
    logger.info("üèÅ AUDITOR√çA HIST√ìRICA FINALIZADA.")
    logger.info(f"‚úÖ Procesados: {count - errors}")
    logger.info(f"‚ùå Errores: {errors}")

if __name__ == "__main__":
    run_full_audit()


==================================================
ARCHIVO: ./main.py
==================================================

from fastapi import FastAPI, Request
from fastapi.responses import HTMLResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates
from app.api.endpoints import analysis, kpis, data, auth, audit, schedules, holidays
from pathlib import Path
import os

app = FastAPI(title="GoAnalisis Dashboard", version="2.0.2")

# --- CONFIGURACI√ìN DE RUTAS INTELIGENTE ---
# Obtenemos la ruta donde vive este archivo main.py (ej: /app)
BASE_DIR = Path(__file__).resolve().parent

# L√ìGICA DEL DOBLE APP:
# Verificamos si existe la carpeta 'app' dentro del directorio actual
# Esto soluciona la anidaci√≥n /app/app/templates vs /app/templates
if (BASE_DIR / "app" / "templates").exists():
    print("INFO: Detectada estructura anidada (/app/app). Ajustando rutas...")
    static_path = BASE_DIR / "app" / "static"
    templates_path = BASE_DIR / "app" / "templates"
else:
    print("INFO: Estructura est√°ndar detectada.")
    static_path = BASE_DIR / "static"
    templates_path = BASE_DIR / "templates"

print(f"DEBUG: Static Path final: {static_path}")
print(f"DEBUG: Templates Path final: {templates_path}")

# Montamos est√°ticos con la ruta calculada
app.mount(
    "/static", StaticFiles(directory=str(static_path), check_dir=False), name="static"
)
templates = Jinja2Templates(directory=str(templates_path))

# --- RUTAS DE LA API ---
app.include_router(analysis.router, prefix="/api/analysis", tags=["Analysis"])
app.include_router(kpis.router, prefix="/api/kpi", tags=["KPIs"])
app.include_router(data.router, prefix="/api/data", tags=["Data"])
app.include_router(auth.router, prefix="/api/auth", tags=["Auth"])
app.include_router(audit.router, prefix="/api/audit", tags=["audit"])
app.include_router(schedules.router, prefix="/api/schedules", tags=["schedules"])
app.include_router(holidays.router, prefix="/api/holidays", tags=["holidays"])


@app.get("/login", response_class=HTMLResponse)
async def login_page(request: Request):
    return templates.TemplateResponse("login.html", {"request": request})


@app.get("/", response_class=HTMLResponse)
async def read_root(request: Request):
    return templates.TemplateResponse("index.html", {"request": request})


@app.get("/report", response_class=HTMLResponse)
async def report_page(request: Request):
    return templates.TemplateResponse("report.html", {"request": request})


@app.get("/api/health")
def health_check():
    return {"status": "ok"}


==================================================
ARCHIVO: ./migrate_times.py
==================================================

import logging
import re
from datetime import datetime, timedelta
from sqlalchemy import func
from app.db.session import SessionLocal
from app.db.base import Order, OrderStatusLog

# Configuraci√≥n
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(message)s")
logger = logging.getLogger(__name__)


def _parse_duration_to_minutes(duration_str: str) -> float:
    if not duration_str or duration_str == "--":
        return 0.0
    try:
        minutes = 0.0
        s = duration_str.lower()
        h_match = re.search(r"(\d+)\s*(?:h|hr|hora)", s)
        if h_match:
            minutes += float(h_match.group(1)) * 60
        m_match = re.search(r"(\d+)\s*(?:m|min)", s)
        if m_match:
            minutes += float(m_match.group(1))
        return minutes
    except:
        return 0.0


def run_migration():
    db = SessionLocal()
    logger.info("üöÄ INICIANDO MIGRACI√ìN MASIVA DE TIEMPOS DE ENTREGA")
    logger.info("===================================================")

    # 1. Obtener todos los pedidos entregados
    orders = db.query(Order).filter(Order.current_status == "delivered").all()
    logger.info(f"üì¶ Analizando {len(orders)} pedidos entregados...")

    updated_count = 0

    for o in orders:
        original_val = o.delivery_time_minutes or 0.0
        new_val = 0.0

        # --- L√ìGICA DE C√ÅLCULO BLINDADA (La misma del KPI) ---

        # A. Intentar Texto del Legacy (Prioridad 1)
        if o.duration:
            new_val = _parse_duration_to_minutes(o.duration)

        # B. Intentar Logs (Prioridad 2)
        if new_val == 0:
            # Buscar log de entrega (usando query directa para precisi√≥n)
            done_log = (
                db.query(OrderStatusLog)
                .filter(
                    OrderStatusLog.order_id == o.id,
                    OrderStatusLog.status == "delivered",
                )
                .order_by(OrderStatusLog.timestamp.desc())
                .first()
            )  # El √∫ltimo delivered v√°lido

            if done_log and o.created_at:
                # Ajuste VET -> UTC
                created_utc = o.created_at + timedelta(hours=4)
                delta = (done_log.timestamp - created_utc).total_seconds() / 60.0

                # Filtro de cordura (entre 1 min y 24 horas)
                if 1.0 < delta < 1440:
                    new_val = delta

        # --- ACTUALIZACI√ìN ---
        # Si el valor nuevo es v√°lido y diferente al viejo (o el viejo era 0/None)
        if new_val > 0 and abs(new_val - original_val) > 0.1:
            o.delivery_time_minutes = round(new_val, 2)
            updated_count += 1

            if updated_count % 100 == 0:
                logger.info(f"‚ö° Procesados {updated_count} cambios...")

    # Confirmaci√≥n
    if updated_count > 0:
        logger.info(f"üíæ Guardando {updated_count} correcciones en la Base de Datos...")
        db.commit()
        logger.info("‚úÖ MIGRACI√ìN COMPLETADA EXITOSAMENTE.")
    else:
        logger.info("‚ú® La base de datos ya estaba perfecta. No hubo cambios.")

    db.close()


if __name__ == "__main__":
    run_migration()


==================================================
ARCHIVO: ./recuperar_ayer.py
==================================================

import logging
from tasks.scraper.order_scraper import OrderScraper
from tasks.celery_tasks import process_drone_data
from tasks.scraper.drone_scraper import DroneScraper
from app.db.session import SessionLocal

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def run_recovery():
    print("üöÄ Iniciando recuperaci√≥n de √∫ltimas 48 horas...")
    
    ls = OrderScraper()
    if not ls.login(): return

    # Leemos 10 p√°ginas para asegurar que agarramos todo lo de ayer
    print("üìÑ Escaneando √∫ltimas 10 p√°ginas...")
    items = ls.get_historical_ids(max_pages=10) 
    ls.close_driver()
    
    print(f"üì¶ Encontrados {len(items)} pedidos recientes. Procesando faltantes...")

    db = SessionLocal()
    drone = DroneScraper()
    if not drone.login(): return

    count = 0
    for item in items:
        eid = item['id']
        duration = item['duration']
        
        # Entramos SIEMPRE para asegurar que tenga la data correcta
        print(f"üîç ({count+1}/{len(items)}) Verificando #{eid}...")
        data = drone.scrape_detail(eid, mode='full')
        data['duration_text'] = duration # Inyectamos duraci√≥n de lista
        
        process_drone_data(db, data)
        count += 1

    drone.close_driver()
    db.close()
    print("‚úÖ Recuperaci√≥n finalizada.")

if __name__ == "__main__":
    run_recovery()


==================================================
ARCHIVO: ./sentinel.sh
==================================================

#!/bin/bash

# ==========================================
# GOANALISIS SENTINEL V4.0 - OMNISCIENT
# ==========================================
# 1. Recursos (RAM/CPU/Disco)
# 2. Zombies (Procesos Chrome)
# 3. Heartbeat (Logs de actividad)
# 4. Salud DB (Conexi√≥n SQL)
# 5. Atasco de Cola (Redis Overflow)
# ==========================================

LOG_FILE="/root/GoAnalisis/sentinel.log"
MAX_RAM_USAGE=85
MAX_DISK_USAGE=90
MAX_CHROME_PROCESSES=15
MAX_REDIS_QUEUE=200 # Si hay m√°s de 200 tareas en cola, algo va mal

# Nombres de contenedores
C_WORKER="goanalisis_celery_node"
C_BEAT="goanalisis_celery_beat"
C_DB="goanalisis_db"
C_REDIS="goanalisis_redis"
C_API="goanalisis_api"

# Funci√≥n para registrar logs
log_msg() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> $LOG_FILE
}

# --- 1. CHEQUEO DE DISCO DURO (PREVENCI√ìN DE CRASH) ---
DISK_USAGE=$(df / | grep / | awk '{ print $5 }' | sed 's/%//g')
if [ "$DISK_USAGE" -gt "$MAX_DISK_USAGE" ]; then
    log_msg "üßπ ALERTA: Disco al $DISK_USAGE%. Limpiando temporales y Docker..."
    docker system prune -f > /dev/null 2>&1
    rm -rf /tmp/tmp*
    rm -rf /tmp/.com.google.Chrome*
    log_msg "‚úÖ Limpieza de disco realizada."
fi

# --- 2. SALUD DE BASE DE DATOS (NUEVO) ---
# Intentamos una consulta simple. Si falla, la DB est√° pegada.
if ! docker exec $C_DB psql -U operaciones -d goanalisis_db -c "SELECT 1;" > /dev/null 2>&1; then
    log_msg "üíÄ BASE DE DATOS INACCESIBLE. Reiniciando ecosistema..."
    cd /root/GoAnalisis && docker compose restart db api celery_node
    sleep 10
    log_msg "‚úÖ DB Reiniciada."
fi

# --- 3. ATASCO DE COLA REDIS (NUEVO) ---
# Si hay demasiadas tareas acumuladas, limpiamos para destrabar
QUEUE_SIZE=$(docker exec $C_REDIS redis-cli -n 0 LLEN celery 2>/dev/null)
# Asegurar que sea n√∫mero
re='^[0-9]+$'
if ! [[ $QUEUE_SIZE =~ $re ]]; then QUEUE_SIZE=0; fi

if [ "$QUEUE_SIZE" -gt "$MAX_REDIS_QUEUE" ]; then
    log_msg "üö¶ ATASCO DETECTADO: $QUEUE_SIZE tareas en cola. Purgando Redis..."
    docker exec $C_REDIS redis-cli FLUSHALL
    cd /root/GoAnalisis && docker compose restart celery_node
    log_msg "‚úÖ Cola liberada y worker reiniciado."
fi

# --- 4. VERIFICAR WORKER VIVO ---
if [ ! "$(docker ps -q -f name=$C_WORKER)" ]; then
    log_msg "‚ùå P√ÅNICO: El Worker no est√° corriendo. Levantando..."
    cd /root/GoAnalisis && docker compose up -d
    exit 0
fi

# --- 5. VERIFICAR RAM ---
RAM_USAGE=$(free | grep Mem | awk '{print $3/$2 * 100.0}')
RAM_USAGE=${RAM_USAGE%.*}

if [ "$RAM_USAGE" -gt "$MAX_RAM_USAGE" ]; then
    log_msg "‚ö†Ô∏è ALERTA: RAM Cr√≠tica ($RAM_USAGE%). Reiniciando Workers..."
    cd /root/GoAnalisis && docker compose restart celery_node celery_beat
    log_msg "‚úÖ Reinicio por RAM completado."
    exit 0
fi

# --- 6. CAZADOR DE ZOMBIES (CHROME) ---
CHROME_COUNT=$(docker exec $C_WORKER ps aux | grep -c "chrome")

if [ "$CHROME_COUNT" -gt "$MAX_CHROME_PROCESSES" ]; then
    log_msg "üßü PLAGA DETECTADA: $CHROME_COUNT procesos Chrome. Limpiando..."
    docker exec $C_WORKER pkill -f chrome || true
    docker exec $C_WORKER pkill -f chromedriver || true
    
    if [ "$CHROME_COUNT" -gt 50 ]; then
        log_msg "‚ò¢Ô∏è Demasiados zombies. Reinicio fuerte del contenedor."
        cd /root/GoAnalisis && docker compose restart celery_node
    fi
    log_msg "‚úÖ Limpieza de zombies completada."
fi

# --- 7. HEARTBEAT (SIGNOS VITALES) ---
RECENT_LOGS=$(docker logs --since 15m $C_WORKER 2>&1 | grep "Monitor V4")
if [ -z "$RECENT_LOGS" ]; then
    log_msg "üíÄ SIGNOS VITALES PERDIDOS: Monitor inactivo por 15 min."
    log_msg "üöë Reiniciando..."
    docker exec $C_WORKER pkill -f chrome || true
    cd /root/GoAnalisis && docker compose restart celery_node celery_beat
    log_msg "‚úÖ Sistema reanimado."
fi

# Rotaci√≥n de logs
tail -n 1000 $LOG_FILE > "$LOG_FILE.tmp" && mv "$LOG_FILE.tmp" $LOG_FILE

==================================================
ARCHIVO: ./celery.log
==================================================

 
 -------------- celery@fedora v5.6.2 (recovery)
--- ***** ----- 
-- ******* ---- Linux-6.18.6-200.fc43.x86_64-x86_64-with-glibc2.42 2026-01-29 09:10:09
- *** --- * --- 
- ** ---------- [config]
- ** ---------- .> app:         goanalisis_tasks:0x7fe00caa6660
- ** ---------- .> transport:   redis://redis:6379/0
- ** ---------- .> results:     redis://redis:6379/0
- *** --- * --- .> concurrency: 12 (prefork)
-- ******* ---- .> task events: OFF (enable -E to monitor tasks in this worker)
--- ***** ----- 
 -------------- [queues]
                .> celery           exchange=celery(direct) key=celery
                

[tasks]
  . tasks.celery_tasks.backfill_historical_data
  . tasks.celery_tasks.enrich_missing_data
  . tasks.celery_tasks.monitor_active_orders
  . tasks.celery_tasks.sync_customer_database
  . tasks.celery_tasks.sync_store_commissions

[2026-01-29 09:10:10,747: INFO/MainProcess] Connected to redis://redis:6379/0
[2026-01-29 09:10:10,754: INFO/MainProcess] mingle: searching for neighbors
[2026-01-29 09:10:11,767: INFO/MainProcess] mingle: all alone
[2026-01-29 09:10:11,823: INFO/MainProcess] celery@fedora ready.

Restarting celery worker (/home/jesus/Desarrollo/Activos/goanalisis/venv/bin/celery -A tasks.celery_app worker --loglevel=info)
 
 -------------- celery@fedora v5.6.2 (recovery)
--- ***** ----- 
-- ******* ---- Linux-6.18.6-200.fc43.x86_64-x86_64-with-glibc2.42 2026-01-29 09:31:01
- *** --- * --- 
- ** ---------- [config]
- ** ---------- .> app:         goanalisis_tasks:0x7f2249caa660
- ** ---------- .> transport:   redis://localhost:6379/0
- ** ---------- .> results:     redis://localhost:6379/0
- *** --- * --- .> concurrency: 12 (prefork)
-- ******* ---- .> task events: OFF (enable -E to monitor tasks in this worker)
--- ***** ----- 
 -------------- [queues]
                .> celery           exchange=celery(direct) key=celery
                

[tasks]
  . tasks.celery_tasks.backfill_historical_data
  . tasks.celery_tasks.enrich_missing_data
  . tasks.celery_tasks.monitor_active_orders
  . tasks.celery_tasks.sync_customer_database
  . tasks.celery_tasks.sync_store_commissions

[2026-01-29 09:31:02,659: INFO/MainProcess] Connected to redis://localhost:6379/0
[2026-01-29 09:31:02,664: INFO/MainProcess] mingle: searching for neighbors
[2026-01-29 09:31:03,676: INFO/MainProcess] mingle: all alone
[2026-01-29 09:31:03,727: INFO/MainProcess] celery@fedora ready.

worker: Warm shutdown (MainProcess)
[2026-01-29 12:11:16,805: WARNING/MainProcess] consumer: Connection to broker lost. Trying to re-establish the connection...
Traceback (most recent call last):
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/retry.py", line 116, in call_with_retry
    return do()
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/client.py", line 973, in <lambda>
    lambda: command(*args, **kwargs),
            ~~~~~~~^^^^^^^^^^^^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/client.py", line 996, in try_read
    return conn.read_response(disconnect_on_error=False, push_request=True)
           ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/connection.py", line 1133, in read_response
    response = self._parser.read_response(disable_decoding=disable_decoding)
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/_parsers/resp2.py", line 15, in read_response
    result = self._read_response(disable_decoding=disable_decoding)
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/_parsers/resp2.py", line 25, in _read_response
    raw = self._buffer.readline()
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/_parsers/socket.py", line 115, in readline
    self._read_from_socket()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/_parsers/socket.py", line 68, in _read_from_socket
    raise ConnectionError(SERVER_CLOSED_CONNECTION_ERROR)
redis.exceptions.ConnectionError: Connection closed by server.

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/connection.py", line 855, in connect_check_health
    sock = self.retry.call_with_retry(
        lambda: self._connect(), lambda error: self.disconnect(error)
    )
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/retry.py", line 116, in call_with_retry
    return do()
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/connection.py", line 856, in <lambda>
    lambda: self._connect(), lambda error: self.disconnect(error)
            ~~~~~~~~~~~~~^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/connection.py", line 1306, in _connect
    raise err
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/connection.py", line 1290, in _connect
    sock.connect(socket_address)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
ConnectionRefusedError: [Errno 111] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/celery/worker/consumer/consumer.py", line 346, in start
    blueprint.start(self)
    ~~~~~~~~~~~~~~~^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/celery/bootsteps.py", line 116, in start
    step.start(parent)
    ~~~~~~~~~~^^^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/celery/worker/consumer/consumer.py", line 788, in start
    c.loop(*c.loop_args())
    ~~~~~~^^^^^^^^^^^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/celery/worker/loops.py", line 96, in asynloop
    next(loop)
    ~~~~^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/kombu/asynchronous/hub.py", line 377, in create_loop
    cb(*cbargs)
    ~~^^^^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/kombu/transport/redis.py", line 1394, in on_readable
    self.cycle.on_readable(fileno)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/kombu/transport/redis.py", line 579, in on_readable
    chan.handlers[type]()
    ~~~~~~~~~~~~~~~~~~~^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/kombu/transport/redis.py", line 931, in _receive
    ret.append(self._receive_one(c))
               ~~~~~~~~~~~~~~~~~^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/kombu/transport/redis.py", line 941, in _receive_one
    response = c.parse_response()
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/client.py", line 998, in parse_response
    response = self._execute(conn, try_read)
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/client.py", line 972, in _execute
    response = conn.retry.call_with_retry(
        lambda: command(*args, **kwargs),
        lambda _: self._reconnect(conn),
    )
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/retry.py", line 121, in call_with_retry
    fail(error)
    ~~~~^^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/client.py", line 974, in <lambda>
    lambda _: self._reconnect(conn),
              ~~~~~~~~~~~~~~~^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/client.py", line 958, in _reconnect
    conn.connect()
    ~~~~~~~~~~~~^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/connection.py", line 846, in connect
    self.connect_check_health(check_health=True)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/connection.py", line 863, in connect_check_health
    raise ConnectionError(self._error_message(e))
redis.exceptions.ConnectionError: Error 111 connecting to localhost:6379. Connection refused.


==================================================
ARCHIVO: ./init_local_db.py
==================================================

import logging
from app.db.session import SessionLocal
from tasks.scraper.order_scraper import OrderScraper
from tasks.scraper.drone_scraper import DroneScraper
from tasks.celery_tasks import process_drone_data

# Configurar logs para ver el progreso
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(message)s')
logger = logging.getLogger(__name__)

def poblar_base_datos_local():
    print("üå± INICIANDO POBLADO DE BASE DE DATOS LOCAL...")
    
    # 1. Configurar Scrapers
    # NOTA: Aseg√∫rate de tener las credenciales en tu .env local
    ls = OrderScraper()
    drone = DroneScraper()
    db = SessionLocal()

    if not ls.login():
        print("‚ùå Error: No se pudo loguear el OrderScraper. Revisa tu .env")
        return

    # 2. Obtener lista de pedidos (Backfill)
    # Traemos 15 p√°ginas (~375 pedidos) para tener data suficiente para probar
    PAGINAS_A_ESCANEAR = 15
    print(f"üìÑ Escaneando las √∫ltimas {PAGINAS_A_ESCANEAR} p√°ginas del Legacy...")
    
    items = ls.get_historical_ids(max_pages=PAGINAS_A_ESCANEAR)
    ls.close_driver()
    
    print(f"üì¶ Se encontraron {len(items)} pedidos. Iniciando extracci√≥n detallada...")

    if not drone.login():
        print("‚ùå Error: No se pudo loguear el Dron.")
        return

    # 3. Procesar cada pedido
    count = 0
    for item in items:
        count += 1
        eid = item['id']
        duration = item.get('duration', '')
        
        print(f"üì• [{count}/{len(items)}] Importando Pedido #{eid}...")
        
        try:
            # Extraer detalle completo (Finanzas, Mapa, Items)
            data = drone.scrape_detail(eid, mode='full')
            data['duration_text'] = duration
            
            # Guardar en Postgres Local
            process_drone_data(db, data)
            
        except Exception as e:
            print(f"‚ö†Ô∏è Error en {eid}: {e}")

    drone.close_driver()
    db.close()
    print("‚úÖ ¬°BASE DE DATOS LOCAL LISTA! Ya puedes desarrollar.")

if __name__ == "__main__":
    poblar_base_datos_local()

==================================================
ARCHIVO: ./force_maintenance_local.py
==================================================

import logging
import time
from tasks.celery_tasks import sync_customer_database, sync_store_commissions
from tasks.maintenance import nightly_deep_clean

# Configuraci√≥n de logs para ver qu√© pasa en la consola
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

def run_manual_protocols():
    print("\n‚ö° INICIANDO PROTOCOLOS DE MANTENIMIENTO MANUAL (MODO LOCAL) ‚ö°")
    print("===============================================================")

    # --- 1. SINCRONIZACI√ìN DE CLIENTES ---
    print("\nüë• [1/3] Iniciando Sincronizaci√≥n de Clientes...")
    print("    (Esto escanea la lista de usuarios para obtener fechas reales y tel√©fonos)")
    try:
        # Llamamos a la funci√≥n directamente (s√≠ncrona), no a trav√©s de Celery (.delay)
        # limit_pages=10 para que sea r√°pido en la prueba (aprox 200 usuarios recientes)
        # Si quieres TODOS, quita el limit_pages (tardar√° bastante)
        result = sync_customer_database(limit_pages=20) 
        print(f"    ‚úÖ Resultado: {result}")
    except Exception as e:
        print(f"    ‚ùå Error en Clientes: {e}")

    # --- 2. COMISIONES DE TIENDAS (R√°pido) ---
    print("\nüè™ [2/3] Sincronizando Comisiones de Tiendas...")
    try:
        result = sync_store_commissions()
        print(f"    ‚úÖ Resultado: {result}")
    except Exception as e:
        print(f"    ‚ùå Error en Tiendas: {e}")

    # --- 3. MANTENIMIENTO NOCTURNO (AUTOCURACI√ìN) ---
    print("\nüåô [3/3] Ejecutando Protocolo 'Nightly Deep Clean'...")
    print("    (Buscando zombies, falsos deliveries y montos cero en las √∫ltimas 48h)")
    try:
        result = nightly_deep_clean()
        print(f"    ‚úÖ Resultado: {result}")
    except Exception as e:
        print(f"    ‚ùå Error en Mantenimiento: {e}")

    print("\n===============================================================")
    print("‚ú® ¬°LISTO! Tu entorno local est√° sincronizado y auditado.")

if __name__ == "__main__":
    run_manual_protocols()

==================================================
ARCHIVO: ./debug_kpi_local.py
==================================================

import logging
from sqlalchemy import func
from app.db.session import SessionLocal
from app.db.base import Order

# Configuraci√≥n b√°sica
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


def diagnose_kpi():
    db = SessionLocal()
    print("\nüïµÔ∏è‚Äç‚ôÇÔ∏è DIAGN√ìSTICO DE KPI LOCAL")
    print("============================")

    # 1. Ver si hay pedidos en general
    total_orders = db.query(Order).count()
    print(f"üì¶ Total Pedidos en DB: {total_orders}")

    if total_orders == 0:
        print("‚ùå ERROR: La base de datos est√° vac√≠a. Ejecuta init_local_db.py")
        return

    # 2. Ver una muestra de 10 pedidos para ver sus datos financieros
    orders = db.query(Order).limit(10).all()

    print("\nüìä Muestra de Datos (Primeros 10):")
    print(
        f"{'ID':<10} | {'TIPO':<10} | {'TOTAL($)':<10} | {'DELIV FEE($)':<15} | {'ESTATUS':<10}"
    )
    print("-" * 70)

    count_delivery = 0
    accum_fee = 0.0

    for o in orders:
        # L√≥gica id√©ntica al servicio
        raw = o.order_type
        o_type_str = raw.value if hasattr(raw, "value") else str(raw)
        if o_type_str == "None":
            o_type_str = "Delivery"

        # L√≥gica de Fee
        fee_raw = o.delivery_fee
        gross_fee = o.gross_delivery_fee

        calc_fee = float(gross_fee if gross_fee and gross_fee > 0 else (fee_raw or 0.0))

        print(
            f"{o.external_id:<10} | {o_type_str:<10} | {o.total_amount:<10} | {calc_fee:<15} | {o.current_status}"
        )

        if o_type_str == "Delivery":
            count_delivery += 1
            accum_fee += calc_fee

    print("-" * 70)
    print(f"üßÆ Simulaci√≥n r√°pida:")
    print(f"   Deliveries contados: {count_delivery}")
    print(f"   Fees Acumulados: {accum_fee}")

    if count_delivery > 0:
        print(f"   üëâ PROMEDIO ENV√çO: {accum_fee / count_delivery}")
    else:
        print(f"   üëâ PROMEDIO ENV√çO: 0 (No hay deliveries)")

    db.close()


if __name__ == "__main__":
    diagnose_kpi()


==================================================
ARCHIVO: ./sanear_hoy.py
==================================================

import logging
from sqlalchemy import asc
from app.db.session import SessionLocal
from app.db.base import Order, OrderStatusLog

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


def sanear_historial_completo():
    db = SessionLocal()
    print("\nüßπ INICIANDO SANEAMIENTO INTELIGENTE DE LOGS üßπ")
    print("====================================================")

    # Traemos todos los pedidos que tienen m√°s de 1 log
    orders = db.query(Order).all()
    total_borrados = 0
    pedidos_afectados = 0

    for o in orders:
        logs = (
            db.query(OrderStatusLog)
            .filter(OrderStatusLog.order_id == o.id)
            .order_by(asc(OrderStatusLog.timestamp))
            .all()
        )

        if len(logs) <= 1:
            continue

        logs_a_borrar = []
        estados_vistos = set()
        estado_final_alcanzado = False

        for log in logs:
            estado_actual = log.status.lower().strip()

            # REGLA 1: Si ya hab√≠amos llegado a un estado final (entregado/cancelado)
            # cualquier log que aparezca despu√©s (incluso otro entregado) es basura de re-escaneo.
            if estado_final_alcanzado:
                logs_a_borrar.append(log)
                continue

            # REGLA 2: Si este estado ya lo hab√≠amos pasado antes (Ej: volvemos a Pending)
            # es un "rebote" del robot (falso positivo). Lo borramos.
            if estado_actual in estados_vistos:
                logs_a_borrar.append(log)
                continue

            # Si pasa las pruebas, es un log leg√≠timo. Lo anotamos como "visto".
            estados_vistos.add(estado_actual)

            # Si este log leg√≠timo es el final, activamos la bandera para matar todo lo que siga.
            if estado_actual in ["delivered", "canceled"]:
                estado_final_alcanzado = True

        # Ejecutamos el borrado para este pedido
        if logs_a_borrar:
            print(
                f"üì¶ Pedido #{o.external_id}: Borrando {len(logs_a_borrar)} logs (Rebotes/Zombies)."
            )
            for basura in logs_a_borrar:
                db.delete(basura)
            total_borrados += len(logs_a_borrar)
            pedidos_afectados += 1

    if total_borrados > 0:
        print(
            f"\n‚ö†Ô∏è RESUMEN: Se borrar√°n {total_borrados} logs en {pedidos_afectados} pedidos."
        )
        confirm = input("¬øProceder con la amputaci√≥n? (s/n): ")

        if confirm.lower() == "s":
            db.commit()
            print("‚úÖ Limpieza Quir√∫rgica completada.")
        else:
            db.rollback()
            print("‚ùå Operaci√≥n cancelada. No se toc√≥ la BD.")
    else:
        print("\n‚ú® La Base de Datos est√° inmaculada. No hay rebotes.")

    db.close()


if __name__ == "__main__":
    sanear_historial_completo()


==================================================
ARCHIVO: ./debug_schedules.py
==================================================

from app.db.session import SessionLocal
from app.db.base import StoreSchedule, Store
from datetime import datetime, timedelta


def debug_time_and_rules():
    db = SessionLocal()

    # 1. VERIFICAR HORA Y D√çA DEL SISTEMA
    now_utc = datetime.utcnow()
    now_vet = now_utc - timedelta(hours=4)
    current_day = now_vet.weekday()  # 0=Lunes, 5=S√°bado, 6=Domingo

    print("\nüïí DIAGN√ìSTICO DE TIEMPO")
    print("========================")
    print(f"Hora UTC: {now_utc}")
    print(f"Hora VET: {now_vet}")
    print(f"D√≠a Num√©rico (Python): {current_day}")

    dias = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"]
    print(f"D√≠a Humano: {dias[current_day]}")

    # 2. VERIFICAR REGLAS EN DB
    print("\nüìã REGLAS GUARDADAS EN DB")
    print("========================")
    rules = db.query(StoreSchedule).all()

    if not rules:
        print("‚ùå LA BASE DE DATOS EST√Å VAC√çA (No hay reglas).")
    else:
        for r in rules:
            store = db.query(Store).get(r.store_id)
            store_name = store.name if store else "ID Desconocido"
            status = "‚úÖ ACTIVA" if r.is_active else "‚ùå INACTIVA"
            match = "üëà ¬°ES HOY!" if r.day_of_week == current_day else ""

            print(
                f"ID: {r.id} | Tienda: {store_name} | D√≠a: {r.day_of_week} ({dias[r.day_of_week]}) | {status} {match}"
            )

    db.close()


if __name__ == "__main__":
    debug_time_and_rules()


==================================================
ARCHIVO: ./CONTEXTO_PROYECTO.txt
==================================================



==================================================
ARCHIVO: ./requirements.txt
==================================================

# --- CORE API ---
fastapi>=0.115.0
uvicorn[standard]>=0.32.0
starlette>=0.41.0
pydantic>=2.9.0
pydantic-settings>=2.6.0

# --- BASE DE DATOS ---
sqlalchemy>=2.0.36
psycopg2-binary>=2.9.9

# --- UTILIDADES ---
python-dotenv>=1.0.1
requests>=2.32.3
python-dateutil>=2.9.0
Jinja2>=3.1.4
MarkupSafe>=3.0.2
click>=8.1.7

# --- SCRAPING (CR√çTICO: Versiones Flexibles) ---
# Usamos >= para asegurar compatibilidad con Chrome 142+
selenium>=4.27.0
webdriver-manager>=4.0.2

# --- TAREAS AS√çNCRONAS ---
celery>=5.4.0
kombu>=5.4.0
redis>=5.2.0
amqp>=5.2.0
billiard>=4.2.0
vine>=5.1.0

# --- ASYNC & PERFORMANCE ---
anyio>=4.6.0
greenlet>=3.1.1
h11>=0.14.0
httptools>=0.6.4
uvloop>=0.21.0
watchfiles>=0.24.0
websockets>=13.1
trio>=0.27.0

# --- OTROS ---
certifi>=2024.8.30
charset-normalizer>=3.4.0
idna>=3.10
urllib3>=2.2.3
typing_extensions>=4.12.0
packaging>=24.1
annotated-types>=0.7.0
sniffio>=1.3.1
sortedcontainers>=2.4.0

# --- SEGURIDAD (FIX) ---
python-multipart
python-jose[cryptography]
passlib==1.7.4
bcrypt==4.0.1

beautifulsoup4


==================================================
ARCHIVO: ./README.md
==================================================

# GoAnalisis - Dashboard de Inteligencia de Negocio Operativo

**GoAnalisis** es una aplicaci√≥n web full-stack dise√±ada para la monitorizaci√≥n y an√°lisis en tiempo real de una plataforma de gesti√≥n de pedidos.
 La aplicaci√≥n utiliza un sistema de web scraping avanzado para extraer datos 24/7, los procesa para generar KPIs clave y los presenta en un dashboard
 interactivo y profesional.

El objetivo principal de GoAnalisis es identificar cuellos de botella operativos, analizar tendencias de negocio y proporcionar una visi√≥n clara del
 rendimiento de entidades clave como tiendas y repartidores.

---

## Caracter√≠sticas Principales

*   **Monitorizaci√≥n 24/7:** Workers as√≠ncronos con Celery y Selenium que extraen datos continuamente.
*   **An√°lisis de Cuellos de Botella:** Calcula y visualiza el tiempo promedio que los pedidos pasan en cada estado operativo.
*   **KPIs en Tiempo Real:** Tarjetas con m√©tricas clave que se actualizan peri√≥dicamente (total de pedidos, ingresos, etc.).
*   **An√°lisis de Tendencias:** Gr√°ficos interactivos para visualizar la evoluci√≥n de los ingresos y el volumen de pedidos a lo largo del tiempo.
*   **Rankings de Entidades:** Gr√°ficos y listas con el top 10 de repartidores y tiendas por volumen de pedidos.
*   **Dashboard Interactivo:** Frontend moderno construido con Bootstrap 5 y Chart.js, con filtros por rango de fechas.
*   **Arquitectura Contenerizada:** Todo el ecosistema (API, workers, base de datos, broker) est√° dockerizado para un despliegue f√°cil y reproducible.

---

## Arquitectura y Tecnolog√≠as

| Componente        | Tecnolog√≠a                               | Prop√≥sito                                                |
|-------------------|------------------------------------------|----------------------------------------------------------|
| **Backend API**   | Python 3.12, FastAPI                     | Servir los datos procesados a trav√©s de una API RESTful. |
| **Scraping**      | Selenium                                 | Simular la navegaci√≥n y extraer datos de la plataforma.  |
| **Tareas Async**  | Celery                                   | Orquestar y programar las tareas de scraping.            |
| **Message Broker**| Redis                                    | Comunicar las tareas programadas a los workers.          |
| **Base de Datos** | PostgreSQL                               | Almacenar y persistir todos los datos extra√≠dos.         |
| **ORM**           | SQLAlchemy                               | Mapear los objetos de Python a las tablas de la BD.      |
| **An√°lisis**      | Pandas (a futuro), SQLAlchemy            | Procesar y agregar los datos para los KPIs.              |
| **Frontend**      | HTML5, CSS3, JavaScript                  | Estructura y l√≥gica del dashboard.                       |
| **UI Frameworks** | Bootstrap 5, Chart.js, Flatpickr.js      | Dise√±o responsive, gr√°ficos y selector de fechas.        |
| **Entorno**       | Docker, Docker Compose                   | Contenerizaci√≥n y orquestaci√≥n de todos los servicios.   |

---

## Puesta en Marcha (Despliegue)

Para levantar la aplicaci√≥n completa en un entorno de desarrollo o producci√≥n, sigue estos pasos.

### Prerrequisitos

*   [Docker](https://www.docker.com/get-started) instalado.
*   [Docker Compose](https://docs.docker.com/compose/install/) instalado.
*   Git (para clonar el repositorio).

### 1. Clonar el Repositorio

```bash
git clone [URL_DE_TU_REPOSITORIO]
cd goanalisis
```

### 2. Configurar el Entorno

La aplicaci√≥n se configura a trav√©s de un archivo `.env`. Crea una copia del archivo de ejemplo y rellena las variables.

```bash
# A√∫n no tenemos un .env.example, pero este ser√≠a el paso.
# Por ahora, crea el archivo .env manualmente.
touch .env
```

Abre el archivo `.env` y a√±ade la siguiente configuraci√≥n, reemplazando los valores necesarios:

```ini
# Configuraci√≥n de PostgreSQL (Docker la usar√° para inicializar la BD)
POSTGRES_USER=operaciones
POSTGRES_PASSWORD=[TU_CONTRASE√ëA_SEGURA_PARA_LA_BD]
POSTGRES_DB=goanalisis_db

# Configuraci√≥n de la Aplicaci√≥n (los contenedores la leer√°n)
# ¬°IMPORTANTE! POSTGRES_SERVER debe ser el nombre del servicio de Docker ('db')
POSTGRES_SERVER=db
REDIS_URL=redis://redis:6379/0

# Credenciales de la plataforma de scraping
LOGIN_URL=https://ecosistema.gopharma.com.ve/login/admin
GOPHARMA_EMAIL=[TU_EMAIL_DE_LOGIN]
GOPHARMA_PASSWORD=[TU_PASSWORD_DE_LOGIN]
SCRAPER_HEADLESS=True
```

### 3. Levantar la Aplicaci√≥n con Docker Compose

Este comando construir√° las im√°genes de la aplicaci√≥n, descargar√° las de Postgres y Redis, crear√° la red y lanzar√° todos los contenedores.

```bash
docker compose up --build
```

La primera vez, la construcci√≥n puede tardar varios minutos. En las siguientes ejecuciones, ser√° mucho m√°s r√°pido. Ver√°s los logs de todos los servicios en tu terminal. Para detener todo, presiona `Ctrl + C`.

### 4. Inicializar la Base de Datos

La primera vez que levantes la aplicaci√≥n, la base de datos estar√° vac√≠a. Abre una **nueva terminal** (sin detener `docker compose`) y ejecuta el siguiente comando para crear todas las tablas:

```bash
docker compose exec api python create_tables.py```

Deber√≠as ver el mensaje "¬°Tablas creadas con √©xito!".

### 5. Acceder al Dashboard

¬°Listo! La aplicaci√≥n est√° en marcha.

*   **Dashboard:** Abre tu navegador y ve a `http://localhost:8000`
*   **Documentaci√≥n de la API:** Accede a `http://localhost:8000/docs`

El sistema comenzar√° a recopilar y procesar datos autom√°ticamente. La informaci√≥n aparecer√° en el dashboard a medida que los workers de Celery completen sus ciclos.

---

## Estructura del Proyecto

```
/goanalisis/
‚îú‚îÄ‚îÄ app/                  # C√≥digo de la aplicaci√≥n FastAPI (API, frontend, DB)
‚îÇ   ‚îú‚îÄ‚îÄ api/              # Endpoints y dependencias de la API
‚îÇ   ‚îú‚îÄ‚îÄ core/             # Configuraci√≥n central
‚îÇ   ‚îú‚îÄ‚îÄ db/               # Modelos y sesi√≥n de SQLAlchemy
‚îÇ   ‚îú‚îÄ‚îÄ schemas/          # Esquemas Pydantic para validaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ services/         # L√≥gica de negocio (c√°lculos, etc.)
‚îÇ   ‚îî‚îÄ‚îÄ static/           # Archivos CSS y JS
‚îÇ   ‚îî‚îÄ‚îÄ templates/        # Plantillas HTML (index.html)
‚îú‚îÄ‚îÄ tasks/                # C√≥digo de las tareas as√≠ncronas de Celery
‚îÇ   ‚îú‚îÄ‚îÄ scraper/          # L√≥gica de scraping con Selenium
‚îÇ   ‚îî‚îÄ‚îÄ celery_tasks.py   # Definici√≥n de las tareas
‚îú‚îÄ‚îÄ .env                  # Archivo de configuraci√≥n (NO versionar)
‚îú‚îÄ‚îÄ create_tables.py      # Script para inicializar la BD
‚îú‚îÄ‚îÄ Dockerfile            # Instrucciones para construir la imagen de la app
‚îî‚îÄ‚îÄ docker-compose.yml    # Orquestaci√≥n de todos los servicios
```


==================================================
ARCHIVO: ./.gitignore
==================================================

# --- Archivos de Entorno Virtual y Dependencias Locales ---
# No queremos subir el contenido del entorno virtual
venv/
/venv/

# Archivos de cach√© de pip
pip-cache/
*.pip

# --- Archivos Sensibles ---
# El archivo .env contiene credenciales y nunca debe ser versionado
.env
/.env
*.env.*

# --- Archivos de Configuraci√≥n de IDEs y Editores ---
.vscode/
.idea/
*.swp
*.swo

# --- Archivos de Cach√© y Compilados de Python ---
__pycache__/
*.py[cod]
*$py.class

# --- Archivos del Sistema Operativo ---
.DS_Store
Thumbs.db

# --- Archivos de Docker ---
# No es necesario ignorar Dockerfile o docker-compose.yml,
# pero s√≠ los archivos generados por Docker localmente, como los vol√∫menes de cach√©.
.dockerignore
docker-compose.override.yml

# --- Archivos de Celery ---
# Archivo de persistencia del planificador (scheduler) de Celery Beat
celerybeat-schedule
celerybeat.pid

# --- Archivos de Pruebas ---
.pytest_cache/
htmlcov/
.coverage

# --- Logs y Bases de Datos Locales (si las hubiera fuera de Docker) ---
*.log
*.sqlite3
*.db

# --- CR√çTICO: Datos y Vol√∫menes del Proyecto ---
# La carpeta donde Docker guarda la DB localmente (si usas bind mounts)
postgres_data/

# Archivos de respaldo de base de datos (¬°No subir la data real!)
backup.sql
*.sql
*.dump

# Persistencia de Redis (si se genera localmente)
dump.rdb

# Archivos temporales de Selenium/Chrome (si se generan en el proyecto)
.wdm/
chromedriver*
.env
__pycache__/
venv/


==================================================
ARCHIVO: ./Dockerfile
==================================================

# Usamos una imagen base que ya incluye muchas herramientas comunes
FROM python:3.12-bullseye

# Establecemos el directorio de trabajo
WORKDIR /app

# Actualizamos los paquetes e instalamos 'wget' y 'build-essential'
RUN apt-get update && apt-get install -y wget build-essential locales

# --- NUEVO: Configurar la localizaci√≥n en espa√±ol ---
RUN echo "es_ES.UTF-8 UTF-8" >> /etc/locale.gen && \
    locale-gen es_ES.UTF-8 && \
    update-locale LANG=es_ES.UTF-8
ENV LANG es_ES.UTF-8

# --- INSTALACI√ìN DIRECTA DE GOOGLE CHROME ---
# 1. Descargamos el paquete oficial .deb de Google Chrome
RUN wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb

# 2. Instalamos el paquete. El comando 'apt-get install -f -y' es crucial,
# ya que autom√°ticamente busca e instala TODAS las dependencias que Chrome necesita.
RUN apt-get install -y ./google-chrome-stable_current_amd64.deb || apt-get install -f -y

# 3. Limpiamos el archivo descargado para mantener la imagen ligera
RUN rm google-chrome-stable_current_amd64.deb
# --------------------------------------------

# Copiamos solo el archivo de requerimientos para aprovechar la cach√© de Docker
COPY requirements.txt .

# Instalamos las dependencias de Python
RUN pip install --no-cache-dir -r requirements.txt

# Copiamos todo el c√≥digo fuente de nuestra aplicaci√≥n a la imagen
COPY . .

# Exponemos el puerto de la API
EXPOSE 8000

# Definimos el comando por defecto para iniciar el servidor uvicorn
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]


==================================================
ARCHIVO: ./celery_worker.py
==================================================



==================================================
ARCHIVO: ./create_tables.py
==================================================

# Es posible que necesitemos instalar SQLAlchemy si no lo hemos hecho
# pip install SQLAlchemy
from app.db.base import Base
from app.db.session import engine

def create_database_tables():
    """
    Se conecta a la base de datos definida en el engine y crea todas las
    tablas definidas en los modelos que heredan de la Base declarativa.
    """
    print("Iniciando la creaci√≥n de tablas en la base de datos...")
    
    try:
        # La magia sucede aqu√≠: SQLAlchemy inspecciona todos los modelos
        # importados que heredan de `Base` y crea las tablas correspondientes.
        Base.metadata.create_all(bind=engine)
        print("¬°Tablas creadas con √©xito!")
        print("Puedes verificarlo conect√°ndote a la base de datos 'goanalisis_db'.")
    except Exception as e:
        print(f"Ocurri√≥ un error al intentar crear las tablas: {e}")

if __name__ == "__main__":
    create_database_tables()


==================================================
ARCHIVO: ./debug_customer.py
==================================================

import logging
from tasks.scraper.customer_scraper import CustomerScraper
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

logging.basicConfig(level=logging.INFO)

def debug():
    print("üïµÔ∏è‚Äç‚ôÇÔ∏è INICIANDO ESPIONAJE DE CLIENTES...")
    s = CustomerScraper()
    if not s.login(): return print("‚ùå Login fall√≥")
    
    s.driver.get(s.users_url)
    WebDriverWait(s.driver, 15).until(EC.presence_of_element_located((By.TAG_NAME, "table")))
    
    # Imprimir cabeceras para ver el orden
    headers = s.driver.find_elements(By.TAG_NAME, "th")
    print(f"CABECERAS: {[h.text for h in headers]}")
    
    # Imprimir primeras 5 filas completas
    rows = s.driver.find_elements(By.XPATH, "//table/tbody/tr")
    for i, row in enumerate(rows[:5]):
        cols = row.find_elements(By.TAG_NAME, "td")
        print(f"\n--- FILA {i+1} ---")
        for j, col in enumerate(cols):
            print(f"Col {j}: '{col.text}'")
            
    s.close_driver()

if __name__ == "__main__":
    debug()


==================================================
ARCHIVO: ./debug_newyear.py
==================================================

import logging
from tasks.scraper.order_scraper import OrderScraper
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

# Configurar logs para verlos en consola
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def debug_now():
    print("\nüïµÔ∏è‚Äç‚ôÇÔ∏è INICIANDO DIAGN√ìSTICO DE A√ëO NUEVO...\n")
    
    scraper = OrderScraper()
    if not scraper.login():
        print("‚ùå Error de Login.")
        return

    print("üï∑Ô∏è Navegando a la lista de pedidos...")
    scraper.driver.get(scraper.orders_url)
    
    try:
        WebDriverWait(scraper.driver, 15).until(EC.presence_of_element_located((By.TAG_NAME, "body")))
        
        # 1. Verificaci√≥n de IDs
        print("\n--- PRUEBA 1: BUSCANDO IDs ---")
        links = scraper.driver.find_elements(By.CSS_SELECTOR, "a[href*='/admin/order/details/']")
        if links:
            print(f"‚úÖ Se encontraron {len(links)} enlaces de detalle.")
            print(f"Ejemplo ID: {links[0].get_attribute('href')}")
        else:
            print("‚ùå NO SE ENCONTRARON ENLACES DE PEDIDOS. ¬øCambi√≥ el selector?")

        # 2. Verificaci√≥n de Fechas (La parte cr√≠tica)
        print("\n--- PRUEBA 2: LECTURA DE FECHAS ---")
        rows = scraper.driver.find_elements(By.XPATH, "//table/tbody/tr")
        count = 0
        for row in rows:
            text = row.text
            # Filtramos filas vac√≠as o de carrito para ver solo pedidos reales
            if "Procesado" in text or "Entregado" in text:
                print(f"\n[FILA {count+1}] Texto completo:")
                print(text)
                print("-" * 20)
                count += 1
            if count >= 3: break
            
    except Exception as e:
        print(f"üí• Error durante el diagn√≥stico: {e}")
    finally:
        scraper.close_driver()
        print("\nüèÅ Diagn√≥stico finalizado.")

if __name__ == "__main__":
    debug_now()


==================================================
ARCHIVO: ./debug_order.py
==================================================

import sys
from tasks.scraper.drone_scraper import DroneScraper

# ID del pedido rebelde (c√°mbialo si es otro)
ORDER_ID = "106893" 

if len(sys.argv) > 1:
    ORDER_ID = sys.argv[1]

def diagnose():
    print(f"üïµÔ∏è‚Äç‚ôÇÔ∏è DIAGNOSTICANDO PEDIDO #{ORDER_ID}...")
    
    drone = DroneScraper()
    if not drone.login():
        print("‚ùå Error de Login")
        return

    try:
        # Extraemos la data CRUDA
        print("üöÄ Extrayendo datos...")
        data = drone.scrape_detail(ORDER_ID, mode='full')
        
        print("\n--- RESULTADOS DEL ROBOT ---")
        print(f"ID Externo: {data.get('external_id')}")
        print(f"Texto Estatus (RAW HTML): '{data.get('status_text')}'")  # <--- ESTO ES LO IMPORTANTE
        print(f"Conductor: '{data.get('driver_name')}'")
        print(f"Monto: {data.get('total_amount')}")
        print("----------------------------\n")
        
        # Simulamos la l√≥gica de decisi√≥n
        status_text = data.get('status_text', '').lower()
        db_status = "pending (default)"
        
        if "entregado" in status_text: db_status = "delivered"
        elif "cancelado" in status_text: db_status = "canceled"
        elif "asignado" in status_text: db_status = "driver_assigned"
        elif "camino" in status_text or "ruta" in status_text: db_status = "on_the_way"
        elif "proceso" in status_text: db_status = "processing"
        elif "confirmado" in status_text: db_status = "confirmed"
        
        print(f"‚öñÔ∏è VEREDICTO DEL SISTEMA: El estatus se guardar√≠a como: -> {db_status.upper()}")

    except Exception as e:
        print(f"‚ùå Error: {e}")
    finally:
        drone.close_driver()

if __name__ == "__main__":
    diagnose()


==================================================
ARCHIVO: ./debug_pickups.py
==================================================

from sqlalchemy import text
from app.db.session import SessionLocal

def check_weird_pickups():
    db = SessionLocal()
    print("üïµÔ∏è‚Äç‚ôÇÔ∏è BUSCANDO FALSOS PICKUPS (Versi√≥n Compatible Postgres)...")
    
    # CASO 1: Pickup pero TIENE un Driver asignado
    # Correcci√≥n: Usamos order_type::text para evitar error de Enum
    sql_drivers = text("""
        SELECT external_id, order_type, driver_id, distance_km 
        FROM orders 
        WHERE order_type::text = 'Pickup' AND driver_id IS NOT NULL;
    """)
    
    try:
        results_drivers = db.execute(sql_drivers).fetchall()
        print(f"\nüö® CASO 1: Pickups que tienen ID de Chofer en DB ({len(results_drivers)}):")
        for r in results_drivers:
            print(f"   - #{r.external_id} (Dist: {r.distance_km}km) -> DriverID: {r.driver_id}")
    except Exception as e:
        print(f"Error en Caso 1: {e}")

    # CASO 2: Pickup con distancia sospechosa (> 0.5 km)
    sql_dist = text("""
        SELECT external_id, order_type, distance_km 
        FROM orders 
        WHERE order_type::text = 'Pickup' AND distance_km > 0.5;
    """)
    
    try:
        results_dist = db.execute(sql_dist).fetchall()
        print(f"\nüö® CASO 2: Pickups con distancia larga (>0.5km) ({len(results_dist)}):")
        for r in results_dist:
            print(f"   - #{r.external_id} -> {r.distance_km} km")
    except Exception as e:
        print(f"Error en Caso 2: {e}")

    db.close()

if __name__ == "__main__":
    check_weird_pickups()


==================================================
ARCHIVO: ./docker-compose.yml
==================================================

version: '3.8'

services:
  # 1. Base de Datos
  db:
    image: postgres:15-alpine
    container_name: goanalisis_db
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "5433:5432"
    restart: unless-stopped

  # 2. Redis
  redis:
    image: redis:7-alpine
    container_name: goanalisis_redis
    ports:
      - "6380:6379"
    restart: unless-stopped

  # 3. API (FastAPI)
  api:
    build: .
    container_name: goanalisis_api
    environment:
      - REDIS_URL=redis://redis:6379/0
      - POSTGRES_SERVER=db
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    env_file:
      - .env
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    volumes:
      - .:/app:z
    ports:
      - "8001:8000"
    depends_on:
      - db
      - redis
    restart: unless-stopped

  # 4. Worker (Celery + Selenium) - RENOMBRADO PARA CORREGIR ERROR
  celery_node:
    build: .
    container_name: goanalisis_celery_node
    environment:
      - REDIS_URL=redis://redis:6379/0
      - POSTGRES_SERVER=db
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    env_file:
      - .env
    command: celery -A tasks.celery_app worker --loglevel=info --concurrency=3
    volumes:
      - .:/app
    depends_on:
      - redis
      - db
    # AUMENTO DE MEMORIA PARA EVITAR CRASH DE CHROME
    shm_size: '2gb' 
    restart: unless-stopped
    
  # 5. Beat (Scheduler)
  celery_beat:
    build: .
    container_name: goanalisis_celery_beat
    environment:
      - REDIS_URL=redis://redis:6379/0
    env_file:
      - .env
    command: celery -A tasks.celery_app beat --loglevel=info
    volumes:
      - .:/app
    depends_on:
      - redis
      - db
    restart: unless-stopped

volumes:
  postgres_data:


==================================================
ARCHIVO: ./fix_stuck_orders.py
==================================================

# fix_stuck_orders.py
import logging
from datetime import datetime, timedelta
from app.db.session import SessionLocal
from app.db.base import Order
from tasks.scraper.drone_scraper import DroneScraper
from tasks.celery_tasks import process_drone_data

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def run_fix():
    db = SessionLocal()
    drone = DroneScraper()
    
    # Rango: Desde ayer a las 00:00 hasta hace 4 horas
    yesterday = datetime.utcnow() - timedelta(hours=30)
    limit_time = datetime.utcnow() - timedelta(hours=4)
    
    # Buscamos TODO lo que no est√© finalizado
    stuck_orders = db.query(Order).filter(
        Order.created_at >= yesterday,
        Order.created_at <= limit_time,
        Order.current_status.in_(['pending', 'processing', 'confirmed', 'driver_assigned', 'on_the_way'])
    ).all()
    
    logger.info(f"üö® Encontrados {len(stuck_orders)} pedidos atascados. Iniciando limpieza...")
    
    if not stuck_orders:
        return

    if not drone.login():
        logger.error("Fallo login dron")
        return

    count = 0
    for order in stuck_orders:
        count += 1
        logger.info(f"[{count}/{len(stuck_orders)}] Auditando #{order.external_id} ({order.current_status})...")
        try:
            # Modo full para traer estatus, mapa y finanzas
            data = drone.scrape_detail(order.external_id, mode='full')
            process_drone_data(db, data)
        except Exception as e:
            logger.error(f"Error en {order.external_id}: {e}")
            
    drone.close_driver()
    db.close()
    logger.info("‚úÖ Limpieza terminada.")

if __name__ == "__main__":
    run_fix()


==================================================
ARCHIVO: ./full_historical_repair.py
==================================================

import logging
import time
from datetime import datetime, timedelta
from sqlalchemy import or_, and_

from app.db.session import SessionLocal
from app.db.base import Order, Driver
from tasks.scraper.drone_scraper import DroneScraper
from tasks.celery_tasks import process_drone_data

# Configuraci√≥n de Logging
logging.basicConfig(
    format='%(asctime)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

def run_full_audit():
    logger.info("ü¶ñ INICIANDO AUDITOR√çA PALEONTOL√ìGICA (TODA LA HISTORIA)...")
    
    db = SessionLocal()
    
    # FECHA CORTE: Ignoramos los pedidos de las √∫ltimas 24h (est√°n vivos)
    cutoff_time = datetime.utcnow() - timedelta(hours=24)
    
    logger.info("üîç Buscando incoherencias en la Base de Datos...")

    # --- GRUPO 1: ZOMBIES (No finalizados y viejos) ---
    zombies = db.query(Order).filter(
        Order.created_at < cutoff_time,
        Order.current_status.in_(['pending', 'processing', 'confirmed', 'driver_assigned', 'on_the_way'])
    ).all()
    
    # --- GRUPO 2: FALSOS DELIVERIES (Entregado + Delivery + Sin Chofer) ---
    # Esto corregir√° todos los Pickups mal clasificados hist√≥ricamente
    fake_deliveries = db.query(Order).filter(
        Order.current_status == 'delivered',
        Order.order_type == 'Delivery',
        Order.driver_id == None
    ).all()

    # --- GRUPO 3: MONTOS CERO (Datos incompletos) ---
    empty_amounts = db.query(Order).filter(
        Order.total_amount == 0,
        Order.current_status != 'canceled' # Ignoramos cancelados que pueden ser 0
    ).all()

    # Consolidar lista √∫nica de IDs para no repetir trabajo
    targets = {}
    
    for o in zombies: targets[o.external_id] = "Zombie (No cerrado)"
    for o in fake_deliveries: targets[o.external_id] = "Falso Delivery (Pickup real)"
    for o in empty_amounts: targets[o.external_id] = "Monto Cero"

    total_targets = len(targets)
    logger.info(f"üìä DIAGN√ìSTICO INICIAL:")
    logger.info(f"   - Zombies encontrados: {len(zombies)}")
    logger.info(f"   - Falsos Deliveries (Pickups): {len(fake_deliveries)}")
    logger.info(f"   - Montos vac√≠os: {len(empty_amounts)}")
    logger.info(f"   ----------------------------------------")
    logger.info(f"   üéØ TOTAL A REPARAR: {total_targets} pedidos √∫nicos.")

    if total_targets == 0:
        logger.info("‚ú® ¬°El sistema est√° inmaculado! Nada que reparar.")
        return

    # --- EJECUCI√ìN DEL DRON ---
    drone = DroneScraper()
    if not drone.login():
        logger.error("‚ùå Fallo cr√≠tico: No se pudo loguear el Dron.")
        return

    logger.info("üöÄ Iniciando reparaciones masivas...")
    
    count = 0
    errors = 0
    
    for eid, reason in targets.items():
        count += 1
        try:
            logger.info(f"üîß [{count}/{total_targets}] Reparando #{eid} -> Causa: {reason}")
            
            # 1. Scrape Full (Trae estatus, montos, chofer y mapa)
            data = drone.scrape_detail(eid, mode='full')
            
            # 2. Guardado Inteligente (Aplica las reglas nuevas de Pickup)
            process_drone_data(db, data)
            
            # Peque√±a pausa para no tumbar el servidor de GoPharma
            # time.sleep(0.5) 
            
        except Exception as e:
            logger.error(f"‚ö†Ô∏è Error reparando {eid}: {e}")
            errors += 1

    drone.close_driver()
    db.close()
    
    logger.info("üèÅ AUDITOR√çA HIST√ìRICA FINALIZADA.")
    logger.info(f"‚úÖ Procesados: {count - errors}")
    logger.info(f"‚ùå Errores: {errors}")

if __name__ == "__main__":
    run_full_audit()


==================================================
ARCHIVO: ./main.py
==================================================

from fastapi import FastAPI, Request
from fastapi.responses import HTMLResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates
from app.api.endpoints import analysis, kpis, data, auth, audit, schedules, holidays
from pathlib import Path
import os

app = FastAPI(title="GoAnalisis Dashboard", version="2.0.2")

# --- CONFIGURACI√ìN DE RUTAS INTELIGENTE ---
# Obtenemos la ruta donde vive este archivo main.py (ej: /app)
BASE_DIR = Path(__file__).resolve().parent

# L√ìGICA DEL DOBLE APP:
# Verificamos si existe la carpeta 'app' dentro del directorio actual
# Esto soluciona la anidaci√≥n /app/app/templates vs /app/templates
if (BASE_DIR / "app" / "templates").exists():
    print("INFO: Detectada estructura anidada (/app/app). Ajustando rutas...")
    static_path = BASE_DIR / "app" / "static"
    templates_path = BASE_DIR / "app" / "templates"
else:
    print("INFO: Estructura est√°ndar detectada.")
    static_path = BASE_DIR / "static"
    templates_path = BASE_DIR / "templates"

print(f"DEBUG: Static Path final: {static_path}")
print(f"DEBUG: Templates Path final: {templates_path}")

# Montamos est√°ticos con la ruta calculada
app.mount(
    "/static", StaticFiles(directory=str(static_path), check_dir=False), name="static"
)
templates = Jinja2Templates(directory=str(templates_path))

# --- RUTAS DE LA API ---
app.include_router(analysis.router, prefix="/api/analysis", tags=["Analysis"])
app.include_router(kpis.router, prefix="/api/kpi", tags=["KPIs"])
app.include_router(data.router, prefix="/api/data", tags=["Data"])
app.include_router(auth.router, prefix="/api/auth", tags=["Auth"])
app.include_router(audit.router, prefix="/api/audit", tags=["audit"])
app.include_router(schedules.router, prefix="/api/schedules", tags=["schedules"])
app.include_router(holidays.router, prefix="/api/holidays", tags=["holidays"])


@app.get("/login", response_class=HTMLResponse)
async def login_page(request: Request):
    return templates.TemplateResponse("login.html", {"request": request})


@app.get("/", response_class=HTMLResponse)
async def read_root(request: Request):
    return templates.TemplateResponse("index.html", {"request": request})


@app.get("/report", response_class=HTMLResponse)
async def report_page(request: Request):
    return templates.TemplateResponse("report.html", {"request": request})


@app.get("/api/health")
def health_check():
    return {"status": "ok"}


==================================================
ARCHIVO: ./migrate_times.py
==================================================

import logging
import re
from datetime import datetime, timedelta
from sqlalchemy import func
from app.db.session import SessionLocal
from app.db.base import Order, OrderStatusLog

# Configuraci√≥n
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(message)s")
logger = logging.getLogger(__name__)


def _parse_duration_to_minutes(duration_str: str) -> float:
    if not duration_str or duration_str == "--":
        return 0.0
    try:
        minutes = 0.0
        s = duration_str.lower()
        h_match = re.search(r"(\d+)\s*(?:h|hr|hora)", s)
        if h_match:
            minutes += float(h_match.group(1)) * 60
        m_match = re.search(r"(\d+)\s*(?:m|min)", s)
        if m_match:
            minutes += float(m_match.group(1))
        return minutes
    except:
        return 0.0


def run_migration():
    db = SessionLocal()
    logger.info("üöÄ INICIANDO MIGRACI√ìN MASIVA DE TIEMPOS DE ENTREGA")
    logger.info("===================================================")

    # 1. Obtener todos los pedidos entregados
    orders = db.query(Order).filter(Order.current_status == "delivered").all()
    logger.info(f"üì¶ Analizando {len(orders)} pedidos entregados...")

    updated_count = 0

    for o in orders:
        original_val = o.delivery_time_minutes or 0.0
        new_val = 0.0

        # --- L√ìGICA DE C√ÅLCULO BLINDADA (La misma del KPI) ---

        # A. Intentar Texto del Legacy (Prioridad 1)
        if o.duration:
            new_val = _parse_duration_to_minutes(o.duration)

        # B. Intentar Logs (Prioridad 2)
        if new_val == 0:
            # Buscar log de entrega (usando query directa para precisi√≥n)
            done_log = (
                db.query(OrderStatusLog)
                .filter(
                    OrderStatusLog.order_id == o.id,
                    OrderStatusLog.status == "delivered",
                )
                .order_by(OrderStatusLog.timestamp.desc())
                .first()
            )  # El √∫ltimo delivered v√°lido

            if done_log and o.created_at:
                # Ajuste VET -> UTC
                created_utc = o.created_at + timedelta(hours=4)
                delta = (done_log.timestamp - created_utc).total_seconds() / 60.0

                # Filtro de cordura (entre 1 min y 24 horas)
                if 1.0 < delta < 1440:
                    new_val = delta

        # --- ACTUALIZACI√ìN ---
        # Si el valor nuevo es v√°lido y diferente al viejo (o el viejo era 0/None)
        if new_val > 0 and abs(new_val - original_val) > 0.1:
            o.delivery_time_minutes = round(new_val, 2)
            updated_count += 1

            if updated_count % 100 == 0:
                logger.info(f"‚ö° Procesados {updated_count} cambios...")

    # Confirmaci√≥n
    if updated_count > 0:
        logger.info(f"üíæ Guardando {updated_count} correcciones en la Base de Datos...")
        db.commit()
        logger.info("‚úÖ MIGRACI√ìN COMPLETADA EXITOSAMENTE.")
    else:
        logger.info("‚ú® La base de datos ya estaba perfecta. No hubo cambios.")

    db.close()


if __name__ == "__main__":
    run_migration()


==================================================
ARCHIVO: ./recuperar_ayer.py
==================================================

import logging
from tasks.scraper.order_scraper import OrderScraper
from tasks.celery_tasks import process_drone_data
from tasks.scraper.drone_scraper import DroneScraper
from app.db.session import SessionLocal

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def run_recovery():
    print("üöÄ Iniciando recuperaci√≥n de √∫ltimas 48 horas...")
    
    ls = OrderScraper()
    if not ls.login(): return

    # Leemos 10 p√°ginas para asegurar que agarramos todo lo de ayer
    print("üìÑ Escaneando √∫ltimas 10 p√°ginas...")
    items = ls.get_historical_ids(max_pages=10) 
    ls.close_driver()
    
    print(f"üì¶ Encontrados {len(items)} pedidos recientes. Procesando faltantes...")

    db = SessionLocal()
    drone = DroneScraper()
    if not drone.login(): return

    count = 0
    for item in items:
        eid = item['id']
        duration = item['duration']
        
        # Entramos SIEMPRE para asegurar que tenga la data correcta
        print(f"üîç ({count+1}/{len(items)}) Verificando #{eid}...")
        data = drone.scrape_detail(eid, mode='full')
        data['duration_text'] = duration # Inyectamos duraci√≥n de lista
        
        process_drone_data(db, data)
        count += 1

    drone.close_driver()
    db.close()
    print("‚úÖ Recuperaci√≥n finalizada.")

if __name__ == "__main__":
    run_recovery()


==================================================
ARCHIVO: ./sentinel.sh
==================================================

#!/bin/bash

# ==========================================
# GOANALISIS SENTINEL V4.0 - OMNISCIENT
# ==========================================
# 1. Recursos (RAM/CPU/Disco)
# 2. Zombies (Procesos Chrome)
# 3. Heartbeat (Logs de actividad)
# 4. Salud DB (Conexi√≥n SQL)
# 5. Atasco de Cola (Redis Overflow)
# ==========================================

LOG_FILE="/root/GoAnalisis/sentinel.log"
MAX_RAM_USAGE=85
MAX_DISK_USAGE=90
MAX_CHROME_PROCESSES=15
MAX_REDIS_QUEUE=200 # Si hay m√°s de 200 tareas en cola, algo va mal

# Nombres de contenedores
C_WORKER="goanalisis_celery_node"
C_BEAT="goanalisis_celery_beat"
C_DB="goanalisis_db"
C_REDIS="goanalisis_redis"
C_API="goanalisis_api"

# Funci√≥n para registrar logs
log_msg() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> $LOG_FILE
}

# --- 1. CHEQUEO DE DISCO DURO (PREVENCI√ìN DE CRASH) ---
DISK_USAGE=$(df / | grep / | awk '{ print $5 }' | sed 's/%//g')
if [ "$DISK_USAGE" -gt "$MAX_DISK_USAGE" ]; then
    log_msg "üßπ ALERTA: Disco al $DISK_USAGE%. Limpiando temporales y Docker..."
    docker system prune -f > /dev/null 2>&1
    rm -rf /tmp/tmp*
    rm -rf /tmp/.com.google.Chrome*
    log_msg "‚úÖ Limpieza de disco realizada."
fi

# --- 2. SALUD DE BASE DE DATOS (NUEVO) ---
# Intentamos una consulta simple. Si falla, la DB est√° pegada.
if ! docker exec $C_DB psql -U operaciones -d goanalisis_db -c "SELECT 1;" > /dev/null 2>&1; then
    log_msg "üíÄ BASE DE DATOS INACCESIBLE. Reiniciando ecosistema..."
    cd /root/GoAnalisis && docker compose restart db api celery_node
    sleep 10
    log_msg "‚úÖ DB Reiniciada."
fi

# --- 3. ATASCO DE COLA REDIS (NUEVO) ---
# Si hay demasiadas tareas acumuladas, limpiamos para destrabar
QUEUE_SIZE=$(docker exec $C_REDIS redis-cli -n 0 LLEN celery 2>/dev/null)
# Asegurar que sea n√∫mero
re='^[0-9]+$'
if ! [[ $QUEUE_SIZE =~ $re ]]; then QUEUE_SIZE=0; fi

if [ "$QUEUE_SIZE" -gt "$MAX_REDIS_QUEUE" ]; then
    log_msg "üö¶ ATASCO DETECTADO: $QUEUE_SIZE tareas en cola. Purgando Redis..."
    docker exec $C_REDIS redis-cli FLUSHALL
    cd /root/GoAnalisis && docker compose restart celery_node
    log_msg "‚úÖ Cola liberada y worker reiniciado."
fi

# --- 4. VERIFICAR WORKER VIVO ---
if [ ! "$(docker ps -q -f name=$C_WORKER)" ]; then
    log_msg "‚ùå P√ÅNICO: El Worker no est√° corriendo. Levantando..."
    cd /root/GoAnalisis && docker compose up -d
    exit 0
fi

# --- 5. VERIFICAR RAM ---
RAM_USAGE=$(free | grep Mem | awk '{print $3/$2 * 100.0}')
RAM_USAGE=${RAM_USAGE%.*}

if [ "$RAM_USAGE" -gt "$MAX_RAM_USAGE" ]; then
    log_msg "‚ö†Ô∏è ALERTA: RAM Cr√≠tica ($RAM_USAGE%). Reiniciando Workers..."
    cd /root/GoAnalisis && docker compose restart celery_node celery_beat
    log_msg "‚úÖ Reinicio por RAM completado."
    exit 0
fi

# --- 6. CAZADOR DE ZOMBIES (CHROME) ---
CHROME_COUNT=$(docker exec $C_WORKER ps aux | grep -c "chrome")

if [ "$CHROME_COUNT" -gt "$MAX_CHROME_PROCESSES" ]; then
    log_msg "üßü PLAGA DETECTADA: $CHROME_COUNT procesos Chrome. Limpiando..."
    docker exec $C_WORKER pkill -f chrome || true
    docker exec $C_WORKER pkill -f chromedriver || true
    
    if [ "$CHROME_COUNT" -gt 50 ]; then
        log_msg "‚ò¢Ô∏è Demasiados zombies. Reinicio fuerte del contenedor."
        cd /root/GoAnalisis && docker compose restart celery_node
    fi
    log_msg "‚úÖ Limpieza de zombies completada."
fi

# --- 7. HEARTBEAT (SIGNOS VITALES) ---
RECENT_LOGS=$(docker logs --since 15m $C_WORKER 2>&1 | grep "Monitor V4")
if [ -z "$RECENT_LOGS" ]; then
    log_msg "üíÄ SIGNOS VITALES PERDIDOS: Monitor inactivo por 15 min."
    log_msg "üöë Reiniciando..."
    docker exec $C_WORKER pkill -f chrome || true
    cd /root/GoAnalisis && docker compose restart celery_node celery_beat
    log_msg "‚úÖ Sistema reanimado."
fi

# Rotaci√≥n de logs
tail -n 1000 $LOG_FILE > "$LOG_FILE.tmp" && mv "$LOG_FILE.tmp" $LOG_FILE

==================================================
ARCHIVO: ./celery.log
==================================================

 
 -------------- celery@fedora v5.6.2 (recovery)
--- ***** ----- 
-- ******* ---- Linux-6.18.6-200.fc43.x86_64-x86_64-with-glibc2.42 2026-01-29 09:10:09
- *** --- * --- 
- ** ---------- [config]
- ** ---------- .> app:         goanalisis_tasks:0x7fe00caa6660
- ** ---------- .> transport:   redis://redis:6379/0
- ** ---------- .> results:     redis://redis:6379/0
- *** --- * --- .> concurrency: 12 (prefork)
-- ******* ---- .> task events: OFF (enable -E to monitor tasks in this worker)
--- ***** ----- 
 -------------- [queues]
                .> celery           exchange=celery(direct) key=celery
                

[tasks]
  . tasks.celery_tasks.backfill_historical_data
  . tasks.celery_tasks.enrich_missing_data
  . tasks.celery_tasks.monitor_active_orders
  . tasks.celery_tasks.sync_customer_database
  . tasks.celery_tasks.sync_store_commissions

[2026-01-29 09:10:10,747: INFO/MainProcess] Connected to redis://redis:6379/0
[2026-01-29 09:10:10,754: INFO/MainProcess] mingle: searching for neighbors
[2026-01-29 09:10:11,767: INFO/MainProcess] mingle: all alone
[2026-01-29 09:10:11,823: INFO/MainProcess] celery@fedora ready.

Restarting celery worker (/home/jesus/Desarrollo/Activos/goanalisis/venv/bin/celery -A tasks.celery_app worker --loglevel=info)
 
 -------------- celery@fedora v5.6.2 (recovery)
--- ***** ----- 
-- ******* ---- Linux-6.18.6-200.fc43.x86_64-x86_64-with-glibc2.42 2026-01-29 09:31:01
- *** --- * --- 
- ** ---------- [config]
- ** ---------- .> app:         goanalisis_tasks:0x7f2249caa660
- ** ---------- .> transport:   redis://localhost:6379/0
- ** ---------- .> results:     redis://localhost:6379/0
- *** --- * --- .> concurrency: 12 (prefork)
-- ******* ---- .> task events: OFF (enable -E to monitor tasks in this worker)
--- ***** ----- 
 -------------- [queues]
                .> celery           exchange=celery(direct) key=celery
                

[tasks]
  . tasks.celery_tasks.backfill_historical_data
  . tasks.celery_tasks.enrich_missing_data
  . tasks.celery_tasks.monitor_active_orders
  . tasks.celery_tasks.sync_customer_database
  . tasks.celery_tasks.sync_store_commissions

[2026-01-29 09:31:02,659: INFO/MainProcess] Connected to redis://localhost:6379/0
[2026-01-29 09:31:02,664: INFO/MainProcess] mingle: searching for neighbors
[2026-01-29 09:31:03,676: INFO/MainProcess] mingle: all alone
[2026-01-29 09:31:03,727: INFO/MainProcess] celery@fedora ready.

worker: Warm shutdown (MainProcess)
[2026-01-29 12:11:16,805: WARNING/MainProcess] consumer: Connection to broker lost. Trying to re-establish the connection...
Traceback (most recent call last):
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/retry.py", line 116, in call_with_retry
    return do()
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/client.py", line 973, in <lambda>
    lambda: command(*args, **kwargs),
            ~~~~~~~^^^^^^^^^^^^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/client.py", line 996, in try_read
    return conn.read_response(disconnect_on_error=False, push_request=True)
           ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/connection.py", line 1133, in read_response
    response = self._parser.read_response(disable_decoding=disable_decoding)
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/_parsers/resp2.py", line 15, in read_response
    result = self._read_response(disable_decoding=disable_decoding)
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/_parsers/resp2.py", line 25, in _read_response
    raw = self._buffer.readline()
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/_parsers/socket.py", line 115, in readline
    self._read_from_socket()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/_parsers/socket.py", line 68, in _read_from_socket
    raise ConnectionError(SERVER_CLOSED_CONNECTION_ERROR)
redis.exceptions.ConnectionError: Connection closed by server.

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/connection.py", line 855, in connect_check_health
    sock = self.retry.call_with_retry(
        lambda: self._connect(), lambda error: self.disconnect(error)
    )
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/retry.py", line 116, in call_with_retry
    return do()
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/connection.py", line 856, in <lambda>
    lambda: self._connect(), lambda error: self.disconnect(error)
            ~~~~~~~~~~~~~^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/connection.py", line 1306, in _connect
    raise err
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/connection.py", line 1290, in _connect
    sock.connect(socket_address)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^
ConnectionRefusedError: [Errno 111] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/celery/worker/consumer/consumer.py", line 346, in start
    blueprint.start(self)
    ~~~~~~~~~~~~~~~^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/celery/bootsteps.py", line 116, in start
    step.start(parent)
    ~~~~~~~~~~^^^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/celery/worker/consumer/consumer.py", line 788, in start
    c.loop(*c.loop_args())
    ~~~~~~^^^^^^^^^^^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/celery/worker/loops.py", line 96, in asynloop
    next(loop)
    ~~~~^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/kombu/asynchronous/hub.py", line 377, in create_loop
    cb(*cbargs)
    ~~^^^^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/kombu/transport/redis.py", line 1394, in on_readable
    self.cycle.on_readable(fileno)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/kombu/transport/redis.py", line 579, in on_readable
    chan.handlers[type]()
    ~~~~~~~~~~~~~~~~~~~^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/kombu/transport/redis.py", line 931, in _receive
    ret.append(self._receive_one(c))
               ~~~~~~~~~~~~~~~~~^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/kombu/transport/redis.py", line 941, in _receive_one
    response = c.parse_response()
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/client.py", line 998, in parse_response
    response = self._execute(conn, try_read)
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/client.py", line 972, in _execute
    response = conn.retry.call_with_retry(
        lambda: command(*args, **kwargs),
        lambda _: self._reconnect(conn),
    )
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/retry.py", line 121, in call_with_retry
    fail(error)
    ~~~~^^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/client.py", line 974, in <lambda>
    lambda _: self._reconnect(conn),
              ~~~~~~~~~~~~~~~^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/client.py", line 958, in _reconnect
    conn.connect()
    ~~~~~~~~~~~~^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/connection.py", line 846, in connect
    self.connect_check_health(check_health=True)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "/home/jesus/Desarrollo/Activos/goanalisis/venv/lib64/python3.14/site-packages/redis/connection.py", line 863, in connect_check_health
    raise ConnectionError(self._error_message(e))
redis.exceptions.ConnectionError: Error 111 connecting to localhost:6379. Connection refused.


==================================================
ARCHIVO: ./init_local_db.py
==================================================

import logging
from app.db.session import SessionLocal
from tasks.scraper.order_scraper import OrderScraper
from tasks.scraper.drone_scraper import DroneScraper
from tasks.celery_tasks import process_drone_data

# Configurar logs para ver el progreso
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(message)s')
logger = logging.getLogger(__name__)

def poblar_base_datos_local():
    print("üå± INICIANDO POBLADO DE BASE DE DATOS LOCAL...")
    
    # 1. Configurar Scrapers
    # NOTA: Aseg√∫rate de tener las credenciales en tu .env local
    ls = OrderScraper()
    drone = DroneScraper()
    db = SessionLocal()

    if not ls.login():
        print("‚ùå Error: No se pudo loguear el OrderScraper. Revisa tu .env")
        return

    # 2. Obtener lista de pedidos (Backfill)
    # Traemos 15 p√°ginas (~375 pedidos) para tener data suficiente para probar
    PAGINAS_A_ESCANEAR = 15
    print(f"üìÑ Escaneando las √∫ltimas {PAGINAS_A_ESCANEAR} p√°ginas del Legacy...")
    
    items = ls.get_historical_ids(max_pages=PAGINAS_A_ESCANEAR)
    ls.close_driver()
    
    print(f"üì¶ Se encontraron {len(items)} pedidos. Iniciando extracci√≥n detallada...")

    if not drone.login():
        print("‚ùå Error: No se pudo loguear el Dron.")
        return

    # 3. Procesar cada pedido
    count = 0
    for item in items:
        count += 1
        eid = item['id']
        duration = item.get('duration', '')
        
        print(f"üì• [{count}/{len(items)}] Importando Pedido #{eid}...")
        
        try:
            # Extraer detalle completo (Finanzas, Mapa, Items)
            data = drone.scrape_detail(eid, mode='full')
            data['duration_text'] = duration
            
            # Guardar en Postgres Local
            process_drone_data(db, data)
            
        except Exception as e:
            print(f"‚ö†Ô∏è Error en {eid}: {e}")

    drone.close_driver()
    db.close()
    print("‚úÖ ¬°BASE DE DATOS LOCAL LISTA! Ya puedes desarrollar.")

if __name__ == "__main__":
    poblar_base_datos_local()

==================================================
ARCHIVO: ./force_maintenance_local.py
==================================================

import logging
import time
from tasks.celery_tasks import sync_customer_database, sync_store_commissions
from tasks.maintenance import nightly_deep_clean

# Configuraci√≥n de logs para ver qu√© pasa en la consola
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

def run_manual_protocols():
    print("\n‚ö° INICIANDO PROTOCOLOS DE MANTENIMIENTO MANUAL (MODO LOCAL) ‚ö°")
    print("===============================================================")

    # --- 1. SINCRONIZACI√ìN DE CLIENTES ---
    print("\nüë• [1/3] Iniciando Sincronizaci√≥n de Clientes...")
    print("    (Esto escanea la lista de usuarios para obtener fechas reales y tel√©fonos)")
    try:
        # Llamamos a la funci√≥n directamente (s√≠ncrona), no a trav√©s de Celery (.delay)
        # limit_pages=10 para que sea r√°pido en la prueba (aprox 200 usuarios recientes)
        # Si quieres TODOS, quita el limit_pages (tardar√° bastante)
        result = sync_customer_database(limit_pages=20) 
        print(f"    ‚úÖ Resultado: {result}")
    except Exception as e:
        print(f"    ‚ùå Error en Clientes: {e}")

    # --- 2. COMISIONES DE TIENDAS (R√°pido) ---
    print("\nüè™ [2/3] Sincronizando Comisiones de Tiendas...")
    try:
        result = sync_store_commissions()
        print(f"    ‚úÖ Resultado: {result}")
    except Exception as e:
        print(f"    ‚ùå Error en Tiendas: {e}")

    # --- 3. MANTENIMIENTO NOCTURNO (AUTOCURACI√ìN) ---
    print("\nüåô [3/3] Ejecutando Protocolo 'Nightly Deep Clean'...")
    print("    (Buscando zombies, falsos deliveries y montos cero en las √∫ltimas 48h)")
    try:
        result = nightly_deep_clean()
        print(f"    ‚úÖ Resultado: {result}")
    except Exception as e:
        print(f"    ‚ùå Error en Mantenimiento: {e}")

    print("\n===============================================================")
    print("‚ú® ¬°LISTO! Tu entorno local est√° sincronizado y auditado.")

if __name__ == "__main__":
    run_manual_protocols()

==================================================
ARCHIVO: ./debug_kpi_local.py
==================================================

import logging
from sqlalchemy import func
from app.db.session import SessionLocal
from app.db.base import Order

# Configuraci√≥n b√°sica
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


def diagnose_kpi():
    db = SessionLocal()
    print("\nüïµÔ∏è‚Äç‚ôÇÔ∏è DIAGN√ìSTICO DE KPI LOCAL")
    print("============================")

    # 1. Ver si hay pedidos en general
    total_orders = db.query(Order).count()
    print(f"üì¶ Total Pedidos en DB: {total_orders}")

    if total_orders == 0:
        print("‚ùå ERROR: La base de datos est√° vac√≠a. Ejecuta init_local_db.py")
        return

    # 2. Ver una muestra de 10 pedidos para ver sus datos financieros
    orders = db.query(Order).limit(10).all()

    print("\nüìä Muestra de Datos (Primeros 10):")
    print(
        f"{'ID':<10} | {'TIPO':<10} | {'TOTAL($)':<10} | {'DELIV FEE($)':<15} | {'ESTATUS':<10}"
    )
    print("-" * 70)

    count_delivery = 0
    accum_fee = 0.0

    for o in orders:
        # L√≥gica id√©ntica al servicio
        raw = o.order_type
        o_type_str = raw.value if hasattr(raw, "value") else str(raw)
        if o_type_str == "None":
            o_type_str = "Delivery"

        # L√≥gica de Fee
        fee_raw = o.delivery_fee
        gross_fee = o.gross_delivery_fee

        calc_fee = float(gross_fee if gross_fee and gross_fee > 0 else (fee_raw or 0.0))

        print(
            f"{o.external_id:<10} | {o_type_str:<10} | {o.total_amount:<10} | {calc_fee:<15} | {o.current_status}"
        )

        if o_type_str == "Delivery":
            count_delivery += 1
            accum_fee += calc_fee

    print("-" * 70)
    print(f"üßÆ Simulaci√≥n r√°pida:")
    print(f"   Deliveries contados: {count_delivery}")
    print(f"   Fees Acumulados: {accum_fee}")

    if count_delivery > 0:
        print(f"   üëâ PROMEDIO ENV√çO: {accum_fee / count_delivery}")
    else:
        print(f"   üëâ PROMEDIO ENV√çO: 0 (No hay deliveries)")

    db.close()


if __name__ == "__main__":
    diagnose_kpi()


==================================================
ARCHIVO: ./sanear_hoy.py
==================================================

import logging
from sqlalchemy import asc
from app.db.session import SessionLocal
from app.db.base import Order, OrderStatusLog

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


def sanear_historial_completo():
    db = SessionLocal()
    print("\nüßπ INICIANDO SANEAMIENTO INTELIGENTE DE LOGS üßπ")
    print("====================================================")

    # Traemos todos los pedidos que tienen m√°s de 1 log
    orders = db.query(Order).all()
    total_borrados = 0
    pedidos_afectados = 0

    for o in orders:
        logs = (
            db.query(OrderStatusLog)
            .filter(OrderStatusLog.order_id == o.id)
            .order_by(asc(OrderStatusLog.timestamp))
            .all()
        )

        if len(logs) <= 1:
            continue

        logs_a_borrar = []
        estados_vistos = set()
        estado_final_alcanzado = False

        for log in logs:
            estado_actual = log.status.lower().strip()

            # REGLA 1: Si ya hab√≠amos llegado a un estado final (entregado/cancelado)
            # cualquier log que aparezca despu√©s (incluso otro entregado) es basura de re-escaneo.
            if estado_final_alcanzado:
                logs_a_borrar.append(log)
                continue

            # REGLA 2: Si este estado ya lo hab√≠amos pasado antes (Ej: volvemos a Pending)
            # es un "rebote" del robot (falso positivo). Lo borramos.
            if estado_actual in estados_vistos:
                logs_a_borrar.append(log)
                continue

            # Si pasa las pruebas, es un log leg√≠timo. Lo anotamos como "visto".
            estados_vistos.add(estado_actual)

            # Si este log leg√≠timo es el final, activamos la bandera para matar todo lo que siga.
            if estado_actual in ["delivered", "canceled"]:
                estado_final_alcanzado = True

        # Ejecutamos el borrado para este pedido
        if logs_a_borrar:
            print(
                f"üì¶ Pedido #{o.external_id}: Borrando {len(logs_a_borrar)} logs (Rebotes/Zombies)."
            )
            for basura in logs_a_borrar:
                db.delete(basura)
            total_borrados += len(logs_a_borrar)
            pedidos_afectados += 1

    if total_borrados > 0:
        print(
            f"\n‚ö†Ô∏è RESUMEN: Se borrar√°n {total_borrados} logs en {pedidos_afectados} pedidos."
        )
        confirm = input("¬øProceder con la amputaci√≥n? (s/n): ")

        if confirm.lower() == "s":
            db.commit()
            print("‚úÖ Limpieza Quir√∫rgica completada.")
        else:
            db.rollback()
            print("‚ùå Operaci√≥n cancelada. No se toc√≥ la BD.")
    else:
        print("\n‚ú® La Base de Datos est√° inmaculada. No hay rebotes.")

    db.close()


if __name__ == "__main__":
    sanear_historial_completo()


==================================================
ARCHIVO: ./app/__init__.py
==================================================



==================================================
ARCHIVO: ./app/api/__init__.py
==================================================



==================================================
ARCHIVO: ./app/api/deps.py
==================================================

from typing import Generator, Optional
from fastapi import Depends, HTTPException, status
from fastapi.security import OAuth2PasswordBearer
from jose import jwt, JWTError
from sqlalchemy.orm import Session
from app.db.session import SessionLocal
from app.core import security
from app.db.base import User # Aseg√∫rate de importar User

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/api/auth/login")

def get_db() -> Generator:
    try:
        db = SessionLocal()
        yield db
    finally:
        db.close()

def get_current_user(
    db: Session = Depends(get_db), 
    token: str = Depends(oauth2_scheme)
) -> User:
    credentials_exception = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="No se pudieron validar las credenciales",
        headers={"WWW-Authenticate": "Bearer"},
    )
    try:
        payload = jwt.decode(token, security.SECRET_KEY, algorithms=[security.ALGORITHM])
        username: str = payload.get("sub")
        if username is None:
            raise credentials_exception
    except JWTError:
        raise credentials_exception
        
    user = db.query(User).filter(User.username == username).first()
    if user is None:
        raise credentials_exception
    return user


==================================================
ARCHIVO: ./app/api/endpoints/__init__.py
==================================================



==================================================
ARCHIVO: ./app/api/endpoints/analysis.py
==================================================

from fastapi import APIRouter, Depends, Query
from sqlalchemy.orm import Session
from typing import List, Optional
from datetime import date  # <--- Importante para date.today()
from app.db.base import OrderStatusLog, User

# Importamos deps y nuestros servicios
from app.api import deps
from app.services import analysis_service, task_service

router = APIRouter()


@router.get("/bottlenecks", summary="Calcular Tiempos Promedio por Estado")
def get_bottleneck_analysis(
    db: Session = Depends(deps.get_db),
    start_date: Optional[date] = Query(None),  # <--- AGREGADO
    end_date: Optional[date] = Query(None),  # <--- AGREGADO
    store_name: Optional[str] = Query(None, description="Filtrar por nombre de tienda"),
    search: Optional[str] = Query(None, description="Buscar por ID o Cliente"),
):
    bottlenecks = analysis_service.calculate_bottlenecks(
        db=db,
        start_date=start_date,  # <--- PASAMOS EL DATO
        end_date=end_date,  # <--- PASAMOS EL DATO
        store_name=store_name,
        search_query=search,
    )
    return bottlenecks


@router.get(
    "/order-duration/{order_id}", summary="Calcular Duraci√≥n Total de un Pedido"
)
def get_order_duration(order_id: int, db: Session = Depends(deps.get_db)):
    duration_data = analysis_service.get_total_duration_for_order(
        db=db, order_id=order_id
    )
    return duration_data


@router.post(
    "/trigger-backfill",
    status_code=202,
    summary="Disparar Tarea de Backfilling Hist√≥rico",
)
def trigger_backfill_task():
    task_id = task_service.trigger_backfill()
    return {
        "message": "La tarea de backfilling de datos hist√≥ricos ha sido iniciada.",
        "task_id": task_id,
    }


@router.get("/cancellations", summary="Obtener motivos de cancelaci√≥n")
def get_cancellation_analysis(
    db: Session = Depends(deps.get_db),
    start_date: Optional[date] = Query(None),
    end_date: Optional[date] = Query(None),
    store_name: Optional[str] = Query(None, description="Filtrar por nombre de tienda"),
    search: Optional[str] = Query(None, description="Buscar por ID o Cliente"),
):
    # --- L√ìGICA: SI NO HAY FILTROS, MOSTRAR SOLO HOY ---
    if not start_date and not end_date and not store_name and not search:
        start_date = date.today()
        end_date = date.today()
    # ---------------------------------------------------

    return analysis_service.get_cancellation_reasons(
        db=db,
        start_date=start_date,
        end_date=end_date,
        store_name=store_name,
        search_query=search,
    )


@router.post(
    "/trigger-drone", status_code=202, summary="Activar Drone de Enriquecimiento"
)
def trigger_drone_task(
    force: bool = Query(False, description="Set a True para borrar candados zombies.")
):
    task_id = task_service.trigger_drone(force=force)

    msg = "Drone desplegado."
    if force:
        msg += " (AVISO: Se forz√≥ la liberaci√≥n del candado)."

    return {"message": msg, "task_id": task_id}


@router.post("/trigger-customer-sync", status_code=202)
def trigger_customer_sync_task():
    task_service.trigger_customer_sync()
    return {"message": "Sincronizaci√≥n de clientes iniciada"}


@router.get("/order/{order_id}/timeline", summary="Cronolog√≠a detallada de un pedido")
def get_order_timeline(
    order_id: int,
    db: Session = Depends(deps.get_db),
    current_user: User = Depends(deps.get_current_user),
):
    """
    Calcula cu√°nto tiempo pas√≥ el pedido en cada estado.
    Retorna etiquetas y tiempos en minutos para graficar.
    """
    # 1. Obtener logs ordenados
    logs = (
        db.query(OrderStatusLog)
        .filter(OrderStatusLog.order_id == order_id)
        .order_by(OrderStatusLog.timestamp.asc())
        .all()
    )

    if not logs:
        return {"labels": [], "data": [], "colors": []}

    labels = []
    durations = []
    colors = []

    # Mapa de colores coherente con el Dashboard
    color_map = {
        "created": "#343a40",  # Dark
        "pending": "#6c757d",  # Grey
        "processing": "#ffc107",  # Warning (Amarillo)
        "confirmed": "#0d6efd",  # Primary (Azul)
        "driver_assigned": "#212529",  # Dark (Negro)
        "on_the_way": "#0dcaf0",  # Info (Celeste)
        "delivered": "#198754",  # Success (Verde)
        "canceled": "#dc3545",  # Danger (Rojo)
    }

    # Traductor
    trans_map = {
        "created": "Creado",
        "pending": "Pendiente",
        "processing": "Facturando",
        "confirmed": "Solicitando",
        "driver_assigned": "Asignado",
        "on_the_way": "En Camino",
        "delivered": "Entregado",
        "canceled": "Cancelado",
    }

    # 2. Calcular Deltas
    for i in range(len(logs) - 1):
        current_log = logs[i]
        next_log = logs[i + 1]

        # Diferencia en minutos
        delta = (next_log.timestamp - current_log.timestamp).total_seconds() / 60

        # Solo guardamos si dur√≥ algo significativo (> 0.1 min)
        if delta > 0.1:
            status_key = current_log.status.lower()
            labels.append(trans_map.get(status_key, status_key))
            durations.append(round(delta, 1))
            colors.append(color_map.get(status_key, "#cccccc"))

    # El √∫ltimo estado es el final (no tiene duraci√≥n medible hasta el infinito)
    # A menos que queramos mostrar cu√°ndo termin√≥

    return {"labels": labels, "data": durations, "colors": colors}


==================================================
ARCHIVO: ./app/api/endpoints/auth.py
==================================================

from fastapi import APIRouter, Depends, HTTPException, status
from fastapi.security import OAuth2PasswordRequestForm
from sqlalchemy.orm import Session
from app.api import deps
from app.core import security
from app.db.base import User

router = APIRouter()

@router.post("/login")
def login(db: Session = Depends(deps.get_db), form_data: OAuth2PasswordRequestForm = Depends()):
    user = db.query(User).filter(User.username == form_data.username).first()
    if not user or not security.verify_password(form_data.password, user.hashed_password):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Usuario o contrase√±a incorrectos",
            headers={"WWW-Authenticate": "Bearer"},
        )
    
    access_token = security.create_access_token(data={"sub": user.username, "role": user.role})
    return {"access_token": access_token, "token_type": "bearer", "role": user.role}




==================================================
ARCHIVO: ./app/api/endpoints/data.py
==================================================

from fastapi import APIRouter, Depends, Query
from sqlalchemy.orm import Session
from sqlalchemy import func
from typing import List, Optional
from datetime import date
from fastapi.responses import StreamingResponse, JSONResponse
import io
from tasks.scraper.order_scraper import OrderScraper
from app.api import deps
from app.db.base import Order, OrderStatusLog, Store, Customer, User, Driver, OrderItem
from app.services import analysis_service
from tasks.scraper.drone_scraper import DroneScraper
from tasks.celery_tasks import process_drone_data
from fastapi import HTTPException

router = APIRouter()


# --- HELPER INTERNO ---
def apply_filters(query, start_date, end_date, store_name, search):
    local_date = func.date(
        func.timezone("America/Caracas", func.timezone("UTC", Order.created_at))
    )
    if start_date:
        query = query.filter(local_date >= start_date)
    if end_date:
        query = query.filter(local_date <= end_date)
    if store_name:
        query = query.join(Store, Order.store_id == Store.id).filter(
            Store.name == store_name
        )
    if search:
        term = search.strip()
        if term.isdigit():
            query = query.filter(Order.external_id.like(f"{term}%"))
        else:
            query = query.join(
                Customer, Order.customer_id == Customer.id, isouter=True
            ).filter(Customer.name.ilike(f"%{term}%"))
    return query


@router.get("/orders", summary="Lista de pedidos con Items (Drill-Down)")
def get_recent_orders(
    db: Session = Depends(deps.get_db),
    start_date: Optional[date] = Query(None),
    end_date: Optional[date] = Query(None),
    store_name: Optional[str] = Query(None),
    search: Optional[str] = Query(None),
    current_user: User = Depends(deps.get_current_user),
):
    query = db.query(Order)
    query = apply_filters(query, start_date, end_date, store_name, search)

    # L√≠mite de 50 para velocidad
    orders = query.order_by(Order.created_at.desc()).limit(50).all()

    data_response = []
    for o in orders:
        # 1. Tiempos
        last_log = (
            db.query(OrderStatusLog)
            .filter(OrderStatusLog.order_id == o.id)
            .order_by(OrderStatusLog.timestamp.desc())
            .first()
        )
        state_start = last_log.timestamp if last_log else o.created_at

        # 2. Lealtad
        order_count = 0
        if o.customer_id:
            order_count = (
                db.query(func.count(Order.id))
                .filter(Order.customer_id == o.customer_id)
                .scalar()
            )

        # 3. Driver
        driver_info = {"name": "No Asignado", "phone": None}
        if o.driver:
            driver_info["name"] = o.driver.name
            driver_info["phone"] = getattr(o.driver, "phone", None)

        # 4. ITEMS (ESTO ES LO QUE FALTABA PARA VER LA LISTA)
        db_items = db.query(OrderItem).filter(OrderItem.order_id == o.id).all()
        items_list = [
            {
                "name": i.name,
                "quantity": i.quantity,
                "unit_price": i.unit_price,
                "total_price": i.total_price,
            }
            for i in db_items
        ]

        has_audit_record = True if o.audits and len(o.audits) > 0 else False

        data_response.append(
            {
                "id": o.id,
                "external_id": o.external_id,
                "current_status": o.current_status,
                "order_type": o.order_type,
                "total_amount": o.total_amount,
                "store_name": o.store.name if o.store else "Sin Tienda",
                "customer_name": o.customer.name if o.customer else "An√≥nimo",
                "customer_phone": o.customer.phone if o.customer else None,
                "customer_orders_count": order_count,
                "driver": driver_info,
                "created_at": o.created_at,
                "state_start_at": state_start,
                "duration_text": o.duration,
                "items": items_list,  # <--- AQU√ç SE ENV√çA LA DATA AL FRONT
                "has_audit": has_audit_record,
            }
        )
    return data_response


# --- ENDPOINTS DELEGADOS AL SERVICIO (Igual que antes) ---


@router.get("/heatmap")
def get_heatmap_endpoint(
    db: Session = Depends(deps.get_db),
    start_date: Optional[date] = Query(None),
    end_date: Optional[date] = Query(None),
    store_name: Optional[str] = Query(None),
):
    return analysis_service.get_heatmap_data(db, start_date, end_date, store_name)


@router.get("/trends")
def get_trends_data(
    db: Session = Depends(deps.get_db),
    start_date: Optional[date] = Query(None),
    end_date: Optional[date] = Query(None),
    store_name: Optional[str] = Query(None),
    search: Optional[str] = Query(None),
):
    return analysis_service.get_daily_trends(
        db, start_date, end_date, store_name, search
    )


@router.get("/top-products")
def get_top_products_data(
    db: Session = Depends(deps.get_db),
    start_date: Optional[date] = Query(None),
    end_date: Optional[date] = Query(None),
    store_name: Optional[str] = Query(None),
    search: Optional[str] = Query(None),
):
    return analysis_service.get_top_products(
        db, start_date, end_date, store_name, search
    )


@router.get("/driver-leaderboard")
def get_driver_leaderboard_data(
    db: Session = Depends(deps.get_db),
    start_date: Optional[date] = Query(None),
    end_date: Optional[date] = Query(None),
    store_name: Optional[str] = Query(None),
    search: Optional[str] = Query(None),
):
    return analysis_service.get_driver_leaderboard(
        db, start_date, end_date, store_name, search
    )


@router.get("/top-stores")
def get_top_stores_data(
    db: Session = Depends(deps.get_db),
    start_date: Optional[date] = Query(None),
    end_date: Optional[date] = Query(None),
    store_name: Optional[str] = Query(None),
    search: Optional[str] = Query(None),
):
    return analysis_service.get_top_stores(db, start_date, end_date, store_name, search)


@router.get("/top-customers")
def get_top_customers_data(
    db: Session = Depends(deps.get_db),
    start_date: Optional[date] = Query(None),
    end_date: Optional[date] = Query(None),
    store_name: Optional[str] = Query(None),
    search: Optional[str] = Query(None),
):
    return analysis_service.get_top_customers(
        db, start_date, end_date, store_name, search
    )


@router.get("/stores-locations")
def get_stores_locations(db: Session = Depends(deps.get_db)):
    stores = db.query(Store).filter(Store.latitude != None).all()
    # Agregamos "id": s.id
    return [
        {"id": s.id, "name": s.name, "lat": s.latitude, "lng": s.longitude}
        for s in stores
    ]


@router.get("/all-stores-names")
def get_all_stores_names(db: Session = Depends(deps.get_db)):
    stores = db.query(Store.name).order_by(Store.name.asc()).all()
    return [s.name for s in stores if s.name]


@router.get(
    "/download-legacy-excel/{order_id}", summary="Descargar Excel Oficial (Proxy)"
)
def download_legacy_excel(
    order_id: str, current_user: User = Depends(deps.get_current_user)
):
    """
    Act√∫a como proxy: Se loguea en GoPharma, descarga el Excel real y lo entrega al usuario.
    """
    scraper = OrderScraper()

    # Ejecutamos la descarga
    # El scraper ya gestiona su propio ciclo de vida (abre y cierra driver internamente)
    file_content, filename = scraper.download_official_excel(order_id)

    if not file_content:
        # Si falla, devolvemos un JSON (pero ya no crashear√° con 500)
        from fastapi.responses import JSONResponse

        return JSONResponse(
            status_code=404,
            content={
                "error": "No se pudo descargar el archivo. Verifica la captura de error en /static/error_login.png"
            },
        )

    # Convertimos bytes a un stream para FastAPI
    stream = io.BytesIO(file_content)

    return StreamingResponse(
        stream,
        media_type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        headers={"Content-Disposition": f"attachment; filename={filename}"},
    )


@router.get("/live-audit/{order_id}", summary="Auditor√≠a en Vivo + Items")
def get_live_audit_data(
    order_id: str,
    db: Session = Depends(deps.get_db),  # Inyectamos DB
    current_user: User = Depends(deps.get_current_user),
):
    """
    1. Scrapea el CSV oficial (Fuente de verdad financiera).
    2. Busca los items en la DB local (Detalle de productos).
    3. Retorna todo unido para la Ficha ATC.
    """
    scraper = OrderScraper()
    csv_data_list = scraper.get_official_data_json(order_id)

    if not csv_data_list:
        return JSONResponse(
            status_code=404, content={"error": "Fallo al obtener CSV del Legacy."}
        )

    # Tomamos la data del CSV (Fila 0)
    legacy_data = csv_data_list[0]

    # Buscamos los productos en nuestra DB
    # Usamos external_id porque order_id del par√°metro es el ID externo (ej: 106866)
    local_order = db.query(Order).filter(Order.external_id == order_id).first()

    items_response = []
    if local_order and local_order.items:
        for i in local_order.items:
            items_response.append(
                {
                    "name": i.name,
                    "quantity": i.quantity,
                    "unit_price": i.unit_price,
                    "total_price": i.total_price,
                }
            )

    return {"legacy": legacy_data, "items": items_response}


@router.post("/orders/{order_id}/resync", summary="Sincronizaci√≥n Manual Quir√∫rgica")
def resync_single_order(
    order_id: str,
    db: Session = Depends(deps.get_db),
    current_user: User = Depends(deps.get_current_user),
):
    # --- SEGURIDAD ---
    if current_user.role != "admin":
        raise HTTPException(
            status_code=403,
            detail="Permiso denegado. Solo administradores pueden forzar sincronizaci√≥n.",
        )
    """
    Fuerza una actualizaci√≥n inmediata de un solo pedido desde el Legacy.
    √ötil para corregir nombres de clientes o montos tras una edici√≥n manual.
    NO borra logs de tiempos (Bottlenecks).
    """
    drone = DroneScraper()

    if not drone.login():
        return JSONResponse(
            status_code=500, content={"error": "El Dron no pudo iniciar sesi√≥n."}
        )

    try:
        # 1. Scrapeo en vivo
        data = drone.scrape_detail(order_id, mode="full")

        # 2. Guardado seguro (La funci√≥n process_drone_data respeta el historial)
        process_drone_data(db, data)

        drone.close_driver()
        return {"status": "success", "message": f"Pedido #{order_id} sincronizado."}

    except Exception as e:
        drone.close_driver()
        return JSONResponse(status_code=500, content={"error": str(e)})


==================================================
ARCHIVO: ./app/api/endpoints/kpis.py
==================================================

from fastapi import APIRouter, Depends, Query
from sqlalchemy.orm import Session
from datetime import date
from typing import Optional

from app.api import deps
from app.services import kpi_service
from app.db.base import User # Importar User

router = APIRouter()

@router.get("/main", summary="Obtener KPIs Principales con Filtros")
def get_main_kpis(
    db: Session = Depends(deps.get_db),
    start_date: Optional[date] = Query(None),
    end_date: Optional[date] = Query(None),
    store_name: Optional[str] = Query(None),
    search: Optional[str] = Query(None),
    current_user: User = Depends(deps.get_current_user) # Obtenemos el usuario
):
    # 1. Obtener la data cruda
    data = kpi_service.get_main_kpis(
        db=db, start_date=start_date, end_date=end_date, 
        store_name=store_name, search_query=search
    )

    # 2. FILTRO DE SEGURIDAD (CENSURA)
    # Si NO es admin, sobrescribimos los valores financieros con 0 o None
    if current_user.role != 'admin':
        data['total_revenue'] = 0
        data['total_fees'] = 0
        data['total_coupons'] = 0
        data['driver_payout'] = 0
        data['company_profit'] = 0
    
    return data


==================================================
ARCHIVO: ./app/api/endpoints/audit.py
==================================================

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from app.api import deps
from app.db.base import OrderAudit, User, Order
from app.schemas.audit import AuditCreate

router = APIRouter()


@router.post("/log", summary="Registrar Gesti√≥n de ATC")
def log_audit(
    audit_in: AuditCreate,
    db: Session = Depends(deps.get_db),
    current_user: User = Depends(deps.get_current_user),
):
    """
    Guarda el registro de la gesti√≥n realizada por el operador sobre un pedido retrasado.
    """
    # 1. Verificar que el pedido existe
    order = db.query(Order).filter(Order.id == audit_in.order_id).first()
    if not order:
        raise HTTPException(status_code=404, detail="Pedido no encontrado")

    # 2. Crear auditor√≠a
    new_audit = OrderAudit(
        order_id=audit_in.order_id,
        user_id=current_user.id,
        stage=audit_in.stage,
        action_taken=audit_in.action_taken,
        root_cause=audit_in.root_cause,
        notes=audit_in.notes,
    )

    db.add(new_audit)
    db.commit()

    return {"status": "success", "message": "Gesti√≥n registrada correctamente"}


@router.get("/history/{order_id}", summary="Ver historial de gesti√≥n")
def get_audit_history(
    order_id: int,
    db: Session = Depends(deps.get_db),
    current_user: User = Depends(deps.get_current_user),
):
    audits = (
        db.query(OrderAudit)
        .filter(OrderAudit.order_id == order_id)
        .order_by(OrderAudit.created_at.desc())
        .all()
    )

    return [
        {
            "user": a.user.username if a.user else "Desconocido",
            "stage": a.stage,
            "action": a.action_taken,
            "cause": a.root_cause,
            "date": a.created_at,
            "notes": a.notes,
        }
        for a in audits
    ]


==================================================
ARCHIVO: ./app/api/endpoints/schedules.py
==================================================

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
from app.api import deps
from app.db.base import StoreSchedule, Store, User
from app.schemas.schedule import ScheduleCreate, ScheduleOut

router = APIRouter()


@router.get("/", response_model=List[ScheduleOut])
def get_schedules(
    db: Session = Depends(deps.get_db),
    current_user: User = Depends(deps.get_current_user),
):
    # Traemos las reglas unidas con el nombre de la tienda
    results = (
        db.query(StoreSchedule, Store.name)
        .join(Store, StoreSchedule.store_id == Store.id)
        .all()
    )

    # Formateamos la salida
    output = []
    for schedule, store_name in results:
        s_dict = schedule.__dict__
        s_dict["store_name"] = store_name
        output.append(s_dict)

    return output


@router.post("/", response_model=ScheduleOut)
def create_schedule(
    schedule_in: ScheduleCreate,
    db: Session = Depends(deps.get_db),
    current_user: User = Depends(deps.get_current_user),
):
    if current_user.role != "admin":
        raise HTTPException(
            status_code=403, detail="Solo administradores pueden configurar horarios"
        )

    new_rule = StoreSchedule(**schedule_in.dict())
    db.add(new_rule)
    db.commit()
    db.refresh(new_rule)

    # Obtenemos nombre para la respuesta
    store = db.query(Store).filter(Store.id == new_rule.store_id).first()

    # Hack para Pydantic response
    response = new_rule.__dict__
    response["store_name"] = store.name if store else "Desconocida"

    return response


@router.delete("/{schedule_id}")
def delete_schedule(
    schedule_id: int,
    db: Session = Depends(deps.get_db),
    current_user: User = Depends(deps.get_current_user),
):
    if current_user.role != "admin":
        raise HTTPException(status_code=403, detail="Permiso denegado")

    rule = db.query(StoreSchedule).filter(StoreSchedule.id == schedule_id).first()
    if not rule:
        raise HTTPException(status_code=404, detail="Regla no encontrada")

    db.delete(rule)
    db.commit()
    return {"status": "deleted"}


==================================================
ARCHIVO: ./app/api/endpoints/holidays.py
==================================================

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List, Optional  # <--- ¬°ASEG√öRATE DE AGREGAR 'Optional' AQU√ç!
from app.api import deps
from app.db.base import StoreHoliday, User, Store  # Agregamos Store para el JOIN
from pydantic import BaseModel
from datetime import date

router = APIRouter()


# Esquema simple para recibir datos
class HolidayCreate(BaseModel):
    date: date
    description: str
    store_id: Optional[int] = None  # Ahora s√≠ Python sabr√° qu√© es Optional


@router.get("/")
def get_holidays(db: Session = Depends(deps.get_db)):
    # Ejecutamos la consulta con el JOIN
    results = (
        db.query(StoreHoliday, Store.name)
        .join(Store, StoreHoliday.store_id == Store.id, isouter=True)
        .order_by(StoreHoliday.date.asc())
        .all()
    )

    # --- PLANCHADO DE DATOS ---
    # Convertimos la lista de tuplas (Objeto, String) en una lista de diccionarios planos
    output = []
    for holiday, store_name in results:
        output.append(
            {
                "id": holiday.id,
                "date": holiday.date,
                "description": holiday.description,
                "store_name": store_name
                or "üåç Todas las Tiendas",  # Si store_name es None, es global
            }
        )

    return output


@router.post("/")
def create_holiday(
    holiday_in: HolidayCreate,
    db: Session = Depends(deps.get_db),
    current_user: User = Depends(deps.get_current_user),
):
    if current_user.role != "admin":
        raise HTTPException(status_code=403)

    new_h = StoreHoliday(
        date=holiday_in.date,
        description=holiday_in.description,
        store_id=holiday_in.store_id,  # Guardamos el ID de la tienda (o None)
        is_closed_all_day=True,
    )
    db.add(new_h)
    db.commit()
    db.refresh(new_h)
    return {"status": "ok"}


@router.delete("/{holiday_id}")
def delete_holiday(
    holiday_id: int,
    db: Session = Depends(deps.get_db),
    current_user: User = Depends(deps.get_current_user),
):
    if current_user.role != "admin":
        raise HTTPException(status_code=403, detail="No autorizado")

    h = db.query(StoreHoliday).filter(StoreHoliday.id == holiday_id).first()
    if h:
        db.delete(h)
        db.commit()
    return {"status": "ok"}


==================================================
ARCHIVO: ./app/core/__init__.py
==================================================



==================================================
ARCHIVO: ./app/core/config.py
==================================================

import os
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # Variables de entorno para la conexi√≥n a PostgreSQL
    # Usamos os.getenv con valores por defecto para asegurar que no falle si falta el .env
    POSTGRES_SERVER: str = os.getenv("POSTGRES_SERVER", "db")
    POSTGRES_USER: str = os.getenv("POSTGRES_USER", "operaciones")
    POSTGRES_PASSWORD: str = os.getenv("POSTGRES_PASSWORD", "admin123")
    POSTGRES_DB: str = os.getenv("POSTGRES_DB", "goanalisis_db")

    # Variable para Redis (AQU√ç ESTABA EL PROBLEMA)
    # Forzamos la ruta interna de Docker por defecto
    REDIS_URL: str = os.getenv("REDIS_URL", "redis://redis:6379/0")

    # Variables para el Scraper
    LOGIN_URL: str = "https://ecosistema.gopharma.com.ve/login/admin"
    GOPHARMA_EMAIL: str = os.getenv("GOPHARMA_EMAIL", "soporte@gopharma.com.ve")
    GOPHARMA_PASSWORD: str = os.getenv("GOPHARMA_PASSWORD", "GoPharma2024.")
    SCRAPER_HEADLESS: bool = True 

    # --- NUEVAS CREDENCIALES E-COMMERCE ---
    EC_USER: str = os.getenv("EC_USER", "usuario_por_defecto@test.com")
    EC_PASSWORD: str = os.getenv("EC_PASSWORD", "clave_por_defecto")

    @property
    def DATABASE_URL(self) -> str:
        # Construcci√≥n robusta de la URL
        return (
            f"postgresql+psycopg2://{self.POSTGRES_USER}:{self.POSTGRES_PASSWORD}"
            f"@{self.POSTGRES_SERVER}/{self.POSTGRES_DB}"
        )

    class Config:
        env_file = ".env"
        extra = "ignore"
        case_sensitive = True

settings = Settings()


==================================================
ARCHIVO: ./app/core/security.py
==================================================

import os # <--- NUEVO IMPORT
from datetime import datetime, timedelta
from typing import Optional
from jose import jwt
from passlib.context import CryptContext

# --- CAMBIO CR√çTICO DE SEGURIDAD ---
# Intenta leer del .env, si no existe usa una por defecto (solo para dev)
SECRET_KEY = os.getenv("SECRET_KEY", "tu_secreto_super_seguro_cambialo") 
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60 * 24 # 24 Horas

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def verify_password(plain_password, hashed_password):
    return pwd_context.verify(plain_password, hashed_password)

def get_password_hash(password):
    return pwd_context.hash(password)

def create_access_token(data: dict, expires_delta: Optional[timedelta] = None):
    to_encode = data.copy()
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    
    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt






==================================================
ARCHIVO: ./app/db/__init__.py
==================================================



==================================================
ARCHIVO: ./app/db/base.py
==================================================

from sqlalchemy import (
    Column,
    Integer,
    String,
    Float,
    DateTime,
    Date,
    ForeignKey,
    Enum,
    Boolean,
)
from sqlalchemy.orm import relationship, declarative_base
from datetime import datetime
import enum

Base = declarative_base()


class OrderTypeEnum(str, enum.Enum):
    DELIVERY = "Delivery"
    PICKUP = "Pickup"


class Order(Base):
    __tablename__ = "orders"

    id = Column(Integer, primary_key=True, index=True)
    external_id = Column(String, unique=True, index=True, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)

    # Datos financieros
    total_amount = Column(Float, nullable=True)
    delivery_fee = Column(Float, nullable=True)
    product_price = Column(Float, default=0.0)

    # Estado y Tipo
    current_status = Column(String, default="pending")
    order_type = Column(Enum(OrderTypeEnum), nullable=True)

    # --- NUEVOS CAMPOS DE AN√ÅLISIS ---
    payment_method = Column(String, nullable=True)  # Ej: Pago M√≥vil, Zelle
    cancellation_reason = Column(String, nullable=True)  # Ej: Problemas con el pago
    canceled_by = Column(String, nullable=True)  # Ej: customer, admin

    # --- CAMPO CORREGIDO (AMPLIADO) ---
    duration = Column(
        String(255), nullable=True
    )  # Antes String (50), ahora soporta texto largo
    # ---------------------------------
    # --- NUEVOS CAMPOS V3 (Drone) ---
    latitude = Column(Float, nullable=True)
    longitude = Column(Float, nullable=True)

    # --- NUEVO CAMPO V4 (Estad√≠sticas de Tiempo) ---
    delivery_time_minutes = Column(Float, nullable=True)

    # --- FINANZAS PROFUNDAS ---
    service_fee = Column(Float, default=0.0)
    coupon_discount = Column(Float, default=0.0)
    tips = Column(Float, default=0.0)

    # --- NUEVO: Tarifa Bruta (Base para el 80/20) ---
    gross_delivery_fee = Column(Float, default=0.0)
    # ...
    # --- NUEVO CAMPO V6 ---
    distance_km = Column(Float, default=0.0)  # Distancia Tienda -> Cliente
    # ...

    # RELACI√ìN NUEVA
    items = relationship(
        "OrderItem", back_populates="order", cascade="all, delete-orphan"
    )
    audits = relationship(
        "OrderAudit", back_populates="order", cascade="all, delete-orphan"
    )

    # Relaciones (Foreing Keys)
    store_id = Column(Integer, ForeignKey("stores.id"), nullable=True)
    customer_id = Column(Integer, ForeignKey("customers.id"), nullable=True)
    driver_id = Column(Integer, ForeignKey("drivers.id"), nullable=True)

    # Relaciones (Objetos)
    status_logs = relationship(
        "OrderStatusLog", back_populates="order", cascade="all, delete-orphan"
    )
    store = relationship("Store", back_populates="orders")
    customer = relationship("Customer", back_populates="orders")
    driver = relationship("Driver", back_populates="orders")


class OrderStatusLog(Base):
    __tablename__ = "order_status_logs"
    id = Column(Integer, primary_key=True, index=True)
    order_id = Column(Integer, ForeignKey("orders.id"), nullable=False)
    status = Column(String, nullable=False)
    timestamp = Column(DateTime, default=datetime.utcnow)
    order = relationship("Order", back_populates="status_logs")


class Store(Base):
    __tablename__ = "stores"
    id = Column(Integer, primary_key=True, index=True)
    external_id = Column(String, unique=True, index=True)
    name = Column(String, nullable=True)
    latitude = Column(Float, nullable=True)
    commission_rate = Column(Float, default=0.0)
    longitude = Column(Float, nullable=True)
    orders = relationship("Order", back_populates="store")


# --- NUEVA CLASE ---
class OrderItem(Base):
    __tablename__ = "order_items"
    id = Column(Integer, primary_key=True, index=True)
    order_id = Column(Integer, ForeignKey("orders.id"))

    name = Column(String)
    quantity = Column(Integer)
    unit_price = Column(Float)
    total_price = Column(Float)
    barcode = Column(String, nullable=True)

    order = relationship("Order", back_populates="items")


# -------------------


class Customer(Base):
    __tablename__ = "customers"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, nullable=True)
    external_id = Column(String, unique=True)
    phone = Column(String, nullable=True)  # <--- NUEVO CAMPO
    joined_at = Column(DateTime, nullable=True)
    orders = relationship("Order", back_populates="customer")


class Driver(Base):
    __tablename__ = "drivers"
    id = Column(Integer, primary_key=True, index=True)
    external_id = Column(String, unique=True, index=True)
    name = Column(String, nullable=True)
    orders = relationship("Order", back_populates="driver")


class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True, index=True)
    username = Column(String, unique=True, index=True)
    hashed_password = Column(String)
    role = Column(String, default="viewer")  # 'admin' o 'viewer'
    is_active = Column(Boolean, default=True)


class OrderAudit(Base):
    __tablename__ = "order_audits"

    id = Column(Integer, primary_key=True, index=True)
    order_id = Column(Integer, ForeignKey("orders.id"))
    user_id = Column(Integer, ForeignKey("users.id"))

    stage = Column(String)  # En qu√© fase estaba (pending, processing...)
    action_taken = Column(String)  # Qu√© hizo (Checklist: "Llam√≥ cliente", "Reasign√≥")
    root_cause = Column(String)  # Por qu√© pas√≥ (Desplegable: "Lluvia", "Sin Luz")
    notes = Column(String, nullable=True)  # Notas opcionales

    created_at = Column(DateTime, default=datetime.utcnow)

    # Relaciones
    order = relationship("Order", back_populates="audits")
    user = relationship("User")


class StoreSchedule(Base):
    __tablename__ = "store_schedules"

    id = Column(Integer, primary_key=True, index=True)
    store_id = Column(Integer, ForeignKey("stores.id"), nullable=False)

    # 0=Lunes, 1=Martes... 6=Domingo
    day_of_week = Column(Integer, nullable=False)

    # Hora militar (ej: "08:00", "20:00")
    open_time = Column(String, nullable=False)
    close_time = Column(String, nullable=False)

    # Minutos antes del cierre real para "matar" la app (Ej: 60 min)
    buffer_minutes = Column(Integer, default=60)

    # Interruptor maestro para activar/desactivar esta regla
    is_active = Column(Boolean, default=True)

    # Relaci√≥n
    store = relationship("Store")


class StoreHoliday(Base):
    __tablename__ = "store_holidays"

    id = Column(Integer, primary_key=True, index=True)
    store_id = Column(
        Integer, ForeignKey("stores.id"), nullable=True
    )  # NULL significa "Todas las tiendas"

    date = Column(Date, nullable=False)  # Fecha espec√≠fica: 2026-04-19

    is_closed_all_day = Column(Boolean, default=True)  # ¬øCierra todo el d√≠a?

    # Si no cierra todo el d√≠a, podemos definir un horario especial para ese feriado
    open_time = Column(String, nullable=True)  # Ej: "09:00"
    close_time = Column(String, nullable=True)  # Ej: "14:00"

    description = Column(String, nullable=True)  # Ej: "Semana Santa"

    store = relationship("Store")


==================================================
ARCHIVO: ./app/db/session.py
==================================================

from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

from app.core.config import settings

# El 'engine' es el punto de entrada a la base de datos.
# Le decimos a SQLAlchemy c√≥mo conectarse usando la URL que construimos.
# pool_pre_ping=True verifica las conexiones antes de usarlas, lo que previene errores
# con conexiones que la base de datos haya cerrado por inactividad.
engine = create_engine(settings.DATABASE_URL, pool_pre_ping=True)

# SessionLocal es una "f√°brica" de sesiones. Cada vez que la llamemos,
# nos dar√° una nueva sesi√≥n de base de datos para una transacci√≥n o petici√≥n.
# autocommit=False y autoflush=False es la configuraci√≥n est√°ndar para usar
# sesiones de SQLAlchemy dentro de un framework web como FastAPI.
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)


==================================================
ARCHIVO: ./app/db/utils.py
==================================================

from contextlib import contextmanager
from app.db.session import SessionLocal

@contextmanager
def get_db_session():
    """
    Context manager para proporcionar una sesi√≥n de base de datos a las tareas
    de Celery y asegurar que se cierre correctamente.
    """
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


==================================================
ARCHIVO: ./app/schemas/__init__.py
==================================================



==================================================
ARCHIVO: ./app/schemas/order.py
==================================================

from pydantic import BaseModel
from typing import Optional
from datetime import datetime

# Este es nuestro "plano" para la respuesta JSON.
class OrderSchema(BaseModel):
    id: int
    external_id: str
    current_status: str
    
    # Campos opcionales (ahora con Optional para evitar errores 500)
    order_type: Optional[str] = None 
    distance_km: Optional[float] = None 
    total_amount: Optional[float] = None
    delivery_fee: Optional[float] = None
    
    # Fechas
    placed_at: Optional[datetime] = None
    created_at: datetime
    updated_at: Optional[datetime] = None # Cambiado a Optional por si no existe
    
    # --- NUEVOS CAMPOS DE INTELIGENCIA (V2) ---
    # Los agregamos aqu√≠ para que el Frontend pueda recibirlos
    payment_method: Optional[str] = None
    cancellation_reason: Optional[str] = None
    canceled_by: Optional[str] = None

    class Config:
        from_attributes = True


==================================================
ARCHIVO: ./app/schemas/audit.py
==================================================

from pydantic import BaseModel
from typing import Optional


class AuditCreate(BaseModel):
    order_id: int
    stage: str
    action_taken: str
    root_cause: str
    notes: Optional[str] = None


==================================================
ARCHIVO: ./app/schemas/schedule.py
==================================================

from pydantic import BaseModel
from typing import Optional


class ScheduleCreate(BaseModel):
    store_id: int
    day_of_week: int  # 0=Lunes, 6=Domingo
    open_time: str  # "08:00"
    close_time: str  # "20:00"
    buffer_minutes: int = 60
    is_active: bool = True


class ScheduleOut(ScheduleCreate):
    id: int
    store_name: str  # Para mostrarlo en la tabla

    class Config:
        from_attributes = True


==================================================
ARCHIVO: ./app/services/__init__.py
==================================================



==================================================
ARCHIVO: ./app/services/analysis_service.py
==================================================

from sqlalchemy.orm import Session
from sqlalchemy import func, desc, cast, Date, case, and_, or_, text
from typing import List, Dict, Any, Optional
from datetime import date, datetime, timedelta
from app.db.base import OrderItem
import re

from app.db.base import Order, OrderStatusLog, Driver, Store, Customer


# --- HELPER: B√öSQUEDA GLOBAL ---
def apply_search(query, search_query: str):
    if search_query:
        return query.join(
            Customer, Order.customer_id == Customer.id, isouter=True
        ).filter(
            or_(
                Order.external_id.ilike(f"%{search_query}%"),
                Customer.name.ilike(f"%{search_query}%"),
            )
        )
    return query


def _parse_duration_string(duration_str: str) -> int:
    if not duration_str:
        return 0
    total_seconds = 0
    duration_str = duration_str.lower()
    hours_match = re.search(r"(\d+)\s*(h|hr|hora)", duration_str)
    if hours_match:
        total_seconds += int(hours_match.group(1)) * 3600
    minutes_match = re.search(r"(\d+)\s*(m|min)", duration_str)
    if minutes_match:
        total_seconds += int(minutes_match.group(1)) * 60
    return total_seconds


# --- FUNCIONES DE AN√ÅLISIS ---


def get_daily_trends(
    db: Session,
    start_date: Optional[date] = None,
    end_date: Optional[date] = None,
    store_name: Optional[str] = None,
    search_query: Optional[str] = None,
) -> Dict[str, List]:
    # Usamos timezone para agrupar por el d√≠a CORRECTO en Venezuela
    date_col = func.date(
        func.timezone("America/Caracas", func.timezone("UTC", Order.created_at))
    )

    query = db.query(
        date_col.label("date"),
        func.count(Order.id).label("total_orders"),
        func.sum(Order.total_amount).label("total_revenue"),
        func.avg(
            case(
                (
                    and_(
                        Order.current_status == "delivered",
                        Order.order_type == "Delivery",
                        Order.delivery_time_minutes != None,
                    ),
                    Order.delivery_time_minutes,
                ),
                else_=None,
            )
        ).label("avg_time"),
    )

    if start_date:
        query = query.filter(date_col >= start_date)
    if end_date:
        query = query.filter(date_col <= end_date)

    if store_name:
        query = query.join(Store, Order.store_id == Store.id).filter(
            Store.name == store_name
        )
    query = apply_search(query, search_query)

    results = query.group_by(date_col).order_by(date_col).all()

    return {
        "labels": [r.date.strftime("%Y-%m-%d") for r in results],
        "revenue": [float(r.total_revenue or 0) for r in results],
        "orders": [int(r.total_orders) for r in results],
        "avg_times": [round(float(r.avg_time or 0), 1) for r in results],
    }


def get_driver_leaderboard(
    db: Session,
    start_date: Optional[date] = None,
    end_date: Optional[date] = None,
    store_name: Optional[str] = None,
    search_query: Optional[str] = None,
):
    local_date = func.date(
        func.timezone("America/Caracas", func.timezone("UTC", Order.created_at))
    )

    query = db.query(
        Driver.name,
        func.count(Order.id).label("total_orders"),
        func.max(Order.created_at).label("last_delivery"),
        func.min(Order.created_at).label("first_delivery"),
    ).join(Order, Order.driver_id == Driver.id)

    if start_date:
        query = query.filter(local_date >= start_date)
    if end_date:
        query = query.filter(local_date <= end_date)
    if store_name:
        query = query.join(Store, Order.store_id == Store.id).filter(
            Store.name == store_name
        )

    query = apply_search(query, search_query)

    results = (
        query.group_by(Driver.name)
        .order_by(desc("total_orders"), Driver.name)
        .limit(50)
        .all()
    )

    data = []
    now = datetime.utcnow()
    for row in results:
        days_inactive = -1
        daily_avg = 0.0
        status = "unknown"
        if row.first_delivery:
            days_active = (now - row.first_delivery).days
            if days_active < 1:
                days_active = 1
            daily_avg = row.total_orders / days_active
        if row.last_delivery:
            days_inactive = (now - row.last_delivery).days
            if row.total_orders < 20:
                status = "new"
            elif days_inactive <= 2:
                status = "active"
            elif days_inactive <= 10:
                status = "warning"
            else:
                status = "inactive"
        data.append(
            {
                "name": row.name,
                "orders": row.total_orders,
                "days_inactive": days_inactive,
                "daily_avg": round(daily_avg, 1),
                "status": status,
            }
        )
    return data


def get_top_stores(
    db: Session,
    start_date: Optional[date] = None,
    end_date: Optional[date] = None,
    store_name: Optional[str] = None,
    search_query: Optional[str] = None,
):
    # Subquery para fecha inicio
    start_date_subquery = (
        db.query(Order.store_id, func.min(Order.created_at).label("first_order_date"))
        .group_by(Order.store_id)
        .subquery()
    )

    # FIX: Join estricto + Filtro de nombre no nulo
    query = (
        db.query(
            Store.name,
            func.count(Order.id).label("total_orders"),
            start_date_subquery.c.first_order_date,
        )
        .join(Order, Order.store_id == Store.id)
        .join(start_date_subquery, Store.id == start_date_subquery.c.store_id)
    )

    # Filtros
    local_date = func.date(
        func.timezone("America/Caracas", func.timezone("UTC", Order.created_at))
    )
    if start_date:
        query = query.filter(local_date >= start_date)
    if end_date:
        query = query.filter(local_date <= end_date)

    # QUIR√öRGICO: Eliminar tiendas sin nombre
    query = query.filter(Store.name != None)

    if store_name:
        query = query.filter(Store.name == store_name)
    query = apply_search(query, search_query)

    results = (
        query.group_by(Store.name, start_date_subquery.c.first_order_date)
        .order_by(desc("total_orders"))
        .all()
    )

    return [
        {
            "name": row.name,
            "orders": row.total_orders,
            "first_seen": (
                row.first_order_date.strftime("%d/%m/%Y")
                if row.first_order_date
                else "N/A"
            ),
        }
        for row in results
    ]


def get_heatmap_data(
    db: Session,
    start_date: Optional[date] = None,
    end_date: Optional[date] = None,
    store_name: Optional[str] = None,
):
    # FIX: Solo 'delivered' y coordenadas v√°lidas
    query = (
        db.query(Order.latitude, Order.longitude)
        .filter(Order.current_status == "delivered")
        .filter(Order.latitude != None)
        .filter(Order.latitude != 0)
        .filter(Order.latitude != 0.0)
    )

    local_created_at = func.timezone(
        "America/Caracas", func.timezone("UTC", Order.created_at)
    )
    local_date = func.date(local_created_at)

    if start_date:
        query = query.filter(local_date >= start_date)
    if end_date:
        query = query.filter(local_date <= end_date)
    if store_name:
        query = query.join(Store, Order.store_id == Store.id).filter(
            Store.name == store_name
        )

    results = query.all()
    return [[float(r.latitude), float(r.longitude), 0.6] for r in results]


def calculate_bottlenecks(
    db: Session,
    start_date: Optional[date] = None,
    end_date: Optional[date] = None,
    store_name: Optional[str] = None,
    search_query: Optional[str] = None,
):
    # Limites Anti-Zombie
    MAX_STEP_SEC = 21600

    query = db.query(
        OrderStatusLog.order_id,
        OrderStatusLog.status,
        OrderStatusLog.timestamp,
        Order.created_at,
        Order.order_type,
        Order.current_status,
    ).join(Order, OrderStatusLog.order_id == Order.id)
    local_date = func.date(
        func.timezone("America/Caracas", func.timezone("UTC", Order.created_at))
    )

    if start_date:
        query = query.filter(local_date >= start_date)
    if end_date:
        query = query.filter(local_date <= end_date)
    if store_name:
        query = query.join(Store, Order.store_id == Store.id).filter(
            Store.name == store_name
        )
    query = apply_search(query, search_query)

    logs = query.order_by(OrderStatusLog.order_id, OrderStatusLog.timestamp).all()
    if not logs:
        return {"delivery": [], "pickup": []}

    metrics = {
        "Delivery": {
            "pending": [],
            "processing": [],
            "confirmed": [],
            "driver_assigned": [],
            "on_the_way": [],
            "delivered_life_time": [],
            "canceled_life_time": [],
        },
        "Pickup": {"pending": [], "processing": [], "canceled_life_time": []},
    }

    orders_data = {}
    for log in logs:
        if log.order_id not in orders_data:
            orders_data[log.order_id] = {
                "created_at": log.created_at,
                "type": log.order_type,
                "current_status": log.current_status,
                "logs": [],
            }
        orders_data[log.order_id]["logs"].append(log)

    for oid, data in orders_data.items():
        o_created, o_type, o_status, o_logs = (
            data["created_at"],
            data["type"],
            data["current_status"],
            data["logs"],
        )

        # 1. Decidir tipo de pedido (Si no est√° definido, forzamos Delivery)
        o_type = o_type or "Delivery"
        if o_type not in metrics:
            continue  # Evitar errores si el tipo no existe
        target = metrics[o_type]  # AHORA USAMOS PICKUP/DELIVERY

        # 2. Cancelados (Separados)
        if o_status == "canceled":
            cancel_log = next(
                (l for l in reversed(o_logs) if l.status == "canceled"), None
            )
            if cancel_log:
                # CORRECCI√ìN DE ZONA HORARIA:
                # o_created viene del Scraper (Hora VET, ej: 09:00).
                # cancel_log viene del Servidor (Hora UTC, ej: 13:00).
                # Para compararlos, debemos sumar 4 horas a la fecha de creaci√≥n.

                # Ajuste VET -> UTC (Sumar 4 horas)
                created_at_utc = o_created + timedelta(hours=4)

                life = (cancel_log.timestamp - created_at_utc).total_seconds()

                # FILTRO DE OUTLIERS:
                # 1. Ignoramos negativos (errores de reloj)
                # 2. Ignoramos > 8 horas (zombies administrativos)
                if 0 < life < 28800:
                    target["canceled_life_time"].append(life)
            continue

        # 3. Calcular tiempos por estado
        for i in range(len(o_logs) - 1):
            curr, nxt = o_logs[i], o_logs[i + 1]
            if curr.status in target:
                delta = (nxt.timestamp - curr.timestamp).total_seconds()
                if 10 < delta < MAX_STEP_SEC:
                    target[curr.status].append(delta)

    # 4. Construir las barras de tiempo
    def build_flow(metric_dict):
        res = []
        total = 0.0

        # Orden de estados (Importante)
        steps = ["pending", "processing", "confirmed", "driver_assigned", "on_the_way"]

        for step in steps:
            if step in metric_dict and metric_dict[step]:
                avg = sum(metric_dict[step]) / len(metric_dict[step])
                res.append({"status": step, "avg_duration_seconds": avg})
                total += avg

        # Barra TOTAL Entregado (Calculada)
        if total > 0:
            res.append({"status": "delivered", "avg_duration_seconds": total})

        # Barra Cancelado (Promedio, por separado)
        if metric_dict.get("canceled_life_time"):
            avg_can = sum(metric_dict["canceled_life_time"]) / len(
                metric_dict["canceled_life_time"]
            )
            res.append({"status": "canceled", "avg_duration_seconds": avg_can})

        return res

    return {
        "delivery": build_flow(metrics["Delivery"]),
        "pickup": build_flow(metrics["Pickup"]),
    }

    query = db.query(
        OrderStatusLog.order_id,
        OrderStatusLog.status,
        OrderStatusLog.timestamp,
        Order.created_at,
        Order.order_type,
        Order.current_status,
    ).join(Order, OrderStatusLog.order_id == Order.id)
    local_date = func.date(
        func.timezone("America/Caracas", func.timezone("UTC", Order.created_at))
    )

    if start_date:
        query = query.filter(local_date >= start_date)
    if end_date:
        query = query.filter(local_date <= end_date)
    if store_name:
        query = query.join(Store, Order.store_id == Store.id).filter(
            Store.name == store_name
        )
    query = apply_search(query, search_query)

    logs = query.order_by(OrderStatusLog.order_id, OrderStatusLog.timestamp).all()
    if not logs:
        return {"delivery": [], "pickup": []}

    metrics = {
        "Delivery": {
            "pending": [],
            "processing": [],
            "confirmed": [],
            "driver_assigned": [],
            "on_the_way": [],
            "canceled_life_time": [],
        },
        "Pickup": {"pending": [], "processing": [], "canceled_life_time": []},
    }

    orders_data = {}
    for log in logs:
        if log.order_id not in orders_data:
            orders_data[log.order_id] = {
                "created_at": log.created_at,
                "type": log.order_type,
                "current_status": log.current_status,
                "logs": [],
            }
        orders_data[log.order_id]["logs"].append(log)

    for oid, data in orders_data.items():
        o_created, o_type, o_status, o_logs = (
            data["created_at"],
            data["type"],
            data["current_status"],
            data["logs"],
        )
        if o_type not in metrics:
            continue
        target = metrics[o_type]

        # FIX: Cancelados se acumulan aparte
        if o_status == "canceled":
            cancel_log = next(
                (l for l in reversed(o_logs) if l.status == "canceled"), None
            )
            if cancel_log:
                life = (cancel_log.timestamp - o_created).total_seconds()
                if 0 < life < 172800:
                    target["canceled_life_time"].append(life)
            continue

        clean_logs = []
        for log in o_logs:
            if not clean_logs or clean_logs[-1].status != log.status:
                clean_logs.append(log)

        for i in range(len(clean_logs) - 1):
            curr, nxt = clean_logs[i], clean_logs[i + 1]

            # Si el estado actual es 'delivered', ya no calculamos m√°s tiempo
            if curr.status == "delivered":
                break

            if curr.status in target:
                delta = (nxt.timestamp - curr.timestamp).total_seconds()
                # MAX_STEP_SEC (6 horas) evita errores de pedidos que se quedan abiertos
                if 10 < delta < MAX_STEP_SEC:
                    target[curr.status].append(delta)

    # FIX: Sumar promedios para el Total Entregado
    def build_flow(metric_dict):
        res = []
        total = 0.0
        steps = ["pending", "processing", "confirmed", "driver_assigned", "on_the_way"]
        for step in steps:
            if step in metric_dict and metric_dict[step]:
                avg = sum(metric_dict[step]) / len(metric_dict[step])
                res.append({"status": step, "avg_duration_seconds": avg})
                total += avg

        # Barra Total
        if total > 0:
            res.append({"status": "delivered", "avg_duration_seconds": total})

        # Barra Cancelado (Promedio)
        if metric_dict.get("canceled_life_time"):
            avg_can = sum(metric_dict["canceled_life_time"]) / len(
                metric_dict["canceled_life_time"]
            )
            res.append({"status": "canceled", "avg_duration_seconds": avg_can})
        return res

    return {
        "delivery": build_flow(metrics["Delivery"]),
        "pickup": build_flow(metrics["Pickup"]),
    }


def get_top_customers(
    db: Session,
    start_date: Optional[date] = None,
    end_date: Optional[date] = None,
    store_name: Optional[str] = None,
    search_query: Optional[str] = None,
):
    local_date = func.date(
        func.timezone("America/Caracas", func.timezone("UTC", Order.created_at))
    )

    # FIX: Evitamos apply_search() para no duplicar el JOIN con Customer
    query = (
        db.query(
            Customer.name,
            func.count(Order.id).label("total_orders"),
            func.sum(Order.total_amount).label("total_spent"),
        )
        .join(Order, Order.customer_id == Customer.id)
        .filter(Order.current_status == "delivered")
    )

    if start_date:
        query = query.filter(local_date >= start_date)
    if end_date:
        query = query.filter(local_date <= end_date)
    if store_name:
        query = query.join(Store, Order.store_id == Store.id).filter(
            Store.name == store_name
        )

    # Filtro manual
    if search_query:
        query = query.filter(Customer.name.ilike(f"%{search_query}%"))

    all_results = query.group_by(Customer.name).order_by(desc("total_spent")).all()

    final_list = []
    for index, row in enumerate(all_results):
        final_list.append(
            {
                "rank": index + 1,
                "name": row.name or "Cliente Desconocido",
                "count": row.total_orders,
                "total_amount": float(row.total_spent or 0),
            }
        )
    return final_list[:20]


def get_total_duration_for_order(db: Session, order_id: int):
    logs = (
        db.query(OrderStatusLog)
        .filter(OrderStatusLog.order_id == order_id)
        .order_by(OrderStatusLog.timestamp)
        .all()
    )
    if logs and len(logs) >= 2:
        return {
            "total_seconds": (logs[-1].timestamp - logs[0].timestamp).total_seconds(),
            "source": "live_logs",
        }
    order = db.query(Order).filter(Order.id == order_id).first()
    if order and hasattr(order, "duration") and order.duration:
        seconds = _parse_duration_string(order.duration)
        if seconds > 0:
            return {"total_seconds": seconds, "source": "historical_scraping"}
    return {"total_seconds": 0, "source": "unknown"}


def get_cancellation_reasons(
    db: Session,
    start_date: Optional[date] = None,
    end_date: Optional[date] = None,
    store_name: Optional[str] = None,
    search_query: Optional[str] = None,
):
    local_date = func.date(
        func.timezone("America/Caracas", func.timezone("UTC", Order.created_at))
    )

    query = db.query(
        Order.cancellation_reason, func.count(Order.id).label("count")
    ).filter(Order.current_status == "canceled", Order.cancellation_reason != None)

    if start_date:
        query = query.filter(local_date >= start_date)
    if end_date:
        query = query.filter(local_date <= end_date)
    if store_name:
        query = query.join(Store, Order.store_id == Store.id).filter(
            Store.name == store_name
        )

    query = apply_search(query, search_query)

    results = query.group_by(Order.cancellation_reason).order_by(desc("count")).all()
    return [{"reason": row.cancellation_reason, "count": row.count} for row in results]


def get_top_products(
    db: Session,
    start_date: Optional[date] = None,
    end_date: Optional[date] = None,
    store_name: Optional[str] = None,
    search_query: Optional[str] = None,
):
    query = db.query(
        OrderItem.name,
        func.sum(OrderItem.quantity).label("total_qty"),
        func.sum(OrderItem.total_price).label("total_revenue"),
    ).join(Order, OrderItem.order_id == Order.id)

    if start_date:
        query = query.filter(cast(Order.created_at, Date) >= start_date)
    if end_date:
        query = query.filter(cast(Order.created_at, Date) <= end_date)
    if store_name:
        query = query.join(Store, Order.store_id == Store.id).filter(
            Store.name == store_name
        )

    if search_query:
        query = query.join(
            Customer, Order.customer_id == Customer.id, isouter=True
        ).filter(
            or_(
                OrderItem.name.ilike(f"%{search_query}%"),
                Customer.name.ilike(f"%{search_query}%"),
                Order.external_id.ilike(f"%{search_query}%"),
            )
        )

    query = query.filter(
        OrderItem.unit_price > 0.01,
        ~OrderItem.name.ilike("%obsequio%"),
        ~OrderItem.name.ilike("%bolsa%gopharma%"),
    )

    results = query.group_by(OrderItem.name).order_by(desc("total_qty")).limit(10).all()

    return [
        {
            "name": row.name,
            "quantity": int(row.total_qty),
            "revenue": float(row.total_revenue),
        }
        for row in results
    ]


==================================================
ARCHIVO: ./app/services/kpi_service.py
==================================================

import re
from sqlalchemy.orm import Session, joinedload
from sqlalchemy import func, cast, Date, or_
from typing import Dict, Any, Optional
from datetime import date, datetime, timedelta
from app.db.base import Order, Store, Customer


def _parse_duration_to_minutes(s: str) -> float:
    if not s or s == "--":
        return 0.0
    try:
        minutes = 0.0
        # Normalizamos a min√∫sculas y quitamos acentos b√°sicos por si acaso
        text = s.lower().replace("√°", "a").strip()

        # PATRONES ROBUSTOS (Iguales al Frontend)
        # Busca: Numero + espacios + (horas, hora, hrs, hr, h)
        h_match = re.search(r"(\d+)\s*(?:horas?|hours?|hrs?|h)", text)

        # Busca: Numero + espacios + (minutos, minuto, mins, min, m)
        m_match = re.search(r"(\d+)\s*(?:minutos?|minutes?|mins?|min|m)", text)

        if h_match:
            minutes += float(h_match.group(1)) * 60

        if m_match:
            minutes += float(m_match.group(1))

        return minutes
    except:
        return 0.0


def get_main_kpis(
    db: Session,
    start_date: Optional[date] = None,
    end_date: Optional[date] = None,
    store_name: Optional[str] = None,
    search_query: Optional[str] = None,
) -> Dict[str, Any]:

    # OPTIMIZACI√ìN: Cargar logs y tienda en la misma consulta para evitar el problema N+1
    base_query = db.query(Order).options(
        joinedload(Order.status_logs), joinedload(Order.store)
    )
    # --- CORRECCI√ìN DE ZONA HORARIA (VENEZUELA) ---
    local_created_at = func.timezone(
        "America/Caracas", func.timezone("UTC", Order.created_at)
    )
    local_date = func.date(local_created_at)

    # --- FILTROS ---
    if start_date:
        base_query = base_query.filter(local_date >= start_date)
    if end_date:
        base_query = base_query.filter(local_date <= end_date)

    if store_name:
        base_query = base_query.join(Store, Order.store_id == Store.id).filter(
            Store.name == store_name
        )

    if search_query:
        base_query = base_query.join(
            Customer, Order.customer_id == Customer.id, isouter=True
        ).filter(
            or_(
                Order.external_id.ilike(f"%{search_query}%"),
                Customer.name.ilike(f"%{search_query}%"),
            )
        )

    # --- C√ÅLCULO DE DATOS ---
    orders = base_query.all()

    # Inicializaci√≥n de Acumuladores
    total_revenue = 0.0
    total_fees_gross = 0.0
    total_coupons = 0.0
    total_service_fee_accum = 0.0

    total_delivery_fees_only = 0.0  # KPI Costo Env√≠o

    driver_payout = 0.0
    profit_delivery = 0.0
    profit_service = 0.0
    profit_commission = 0.0

    # Contadores
    count_deliveries = 0
    count_pickups = 0
    count_canceled = 0
    lost_revenue = 0.0

    durations_minutes = []

    for o in orders:
        # 1. Filtro inicial: Cancelados (Se cuentan aparte)
        if o.current_status == "canceled":
            count_canceled += 1
            lost_revenue += float(o.total_amount or 0.0)
            continue

        # --- CORRECCI√ìN DE TIPO BLINDADA (Case-Insensitive) ---
        raw = o.order_type
        # Sacamos el valor del Enum o el String, lo pasamos a min√∫sculas y limpiamos
        o_type_clean = str(raw.value if hasattr(raw, "value") else raw).lower().strip()

        # Fallback: Si es nulo o no se reconoce, lo tratamos como Delivery (90% de la operaci√≥n)
        if not o_type_clean or o_type_clean == "none":
            o_type_clean = "delivery"

        # 2. Valores Financieros Base (Sanitizados)
        total_amt = float(o.total_amount or 0.0)
        delivery_real = float(
            o.gross_delivery_fee
            if o.gross_delivery_fee and o.gross_delivery_fee > 0
            else (o.delivery_fee or 0.0)
        )
        coupon = float(o.coupon_discount or 0.0)
        prod_price = float(o.product_price or 0.0)
        svc_fee = float(o.service_fee or 0.0)

        # 3. L√≥gica de Conteo por Tipo (FUERA de la validaci√≥n de 'delivered')
        if "pickup" in o_type_clean:
            count_pickups += 1
        else:
            # Es Delivery
            count_deliveries += 1
            total_delivery_fees_only += delivery_real

            # --- C√ÅLCULO DE TIEMPOS (SOLO PARA ENTREGADOS) ---
            if o.current_status == "delivered":
                duration_val = 0.0
                # PRIORIDAD 1: Texto del Legacy (Ej: "1h 4m")
                if o.duration:
                    duration_val = _parse_duration_to_minutes(o.duration)

                # PRIORIDAD 2: Valor num√©rico guardado
                if (
                    duration_val == 0
                    and o.delivery_time_minutes
                    and o.delivery_time_minutes > 0
                ):
                    duration_val = float(o.delivery_time_minutes)

                # PRIORIDAD 3: C√°lculo matem√°tico por logs
                if duration_val == 0:
                    done_log = next(
                        (l for l in o.status_logs if l.status == "delivered"), None
                    )
                    if done_log and o.created_at:
                        created_utc = o.created_at + timedelta(hours=4)
                        total_seconds = (
                            done_log.timestamp - created_utc
                        ).total_seconds()
                        if total_seconds > 0:
                            duration_val = int(total_seconds / 60)  # Minutos enteros

                # Filtro de seguridad (entre 1 min y 10 horas)
                if 0 < duration_val < 600:
                    durations_minutes.append(duration_val)

        # 4. Acumuladores Globales (Para pedidos no cancelados)
        total_revenue += total_amt
        total_fees_gross += delivery_real
        total_coupons += coupon
        total_service_fee_accum += svc_fee

        # --- F√ìRMULAS FINANCIERAS ---
        driver_payout += delivery_real * 0.80
        profit_delivery += (delivery_real * 0.20) / 1.16

        iva_prod = prod_price * 0.16
        base_service = prod_price + iva_prod + delivery_real + svc_fee
        profit_service += (base_service * 0.05) / 1.16

        rate = 0.0
        if o.store and o.store.commission_rate:
            rate = float(o.store.commission_rate)
        profit_commission += prod_price * (rate / 100.0)

    # --- RESULTADOS FINALES ---
    real_net_profit = (
        profit_delivery + profit_service + profit_commission
    ) - total_coupons

    avg_time = (
        sum(durations_minutes) / len(durations_minutes) if durations_minutes else 0.0
    )

    valid_orders_count = count_deliveries + count_pickups

    avg_ticket = (total_revenue / valid_orders_count) if valid_orders_count > 0 else 0.0
    avg_delivery_fee_value = (
        (total_delivery_fees_only / count_deliveries) if count_deliveries > 0 else 0.0
    )
    avg_service_fee = (
        (total_service_fee_accum / valid_orders_count)
        if valid_orders_count > 0
        else 0.0
    )

    total_users_historic = db.query(Customer).count()
    unique_customers = {o.customer_id for o in orders if o.customer_id}

    # 1. Convertimos UTC a VET antes de sacar la fecha
    local_joined_at_ts = func.timezone(
        "America/Caracas", func.timezone("UTC", Customer.joined_at)
    )
    local_joined_at = func.date(local_joined_at_ts)

    new_users_q = db.query(Customer)
    if start_date:
        new_users_q = new_users_q.filter(local_joined_at >= start_date)
    if end_date:
        new_users_q = new_users_q.filter(local_joined_at <= end_date)

    return {
        "total_orders": len(orders),
        "total_revenue": round(total_revenue, 2),
        "total_fees": round(total_fees_gross, 2),
        "total_coupons": round(total_coupons, 2),
        "driver_payout": round(driver_payout, 2),
        "company_profit": round(real_net_profit, 2),
        "total_deliveries": count_deliveries,
        "total_pickups": count_pickups,
        "total_canceled": count_canceled,
        "lost_revenue": round(lost_revenue, 2),
        "avg_delivery_minutes": round(avg_time, 1),
        "avg_ticket": round(avg_ticket, 2),
        "avg_delivery_ticket": round(avg_delivery_fee_value, 2),
        "avg_service_fee": round(avg_service_fee, 2),
        "total_users_historic": total_users_historic,
        "active_users_period": len(unique_customers),
        "new_users_registered": new_users_q.count(),
    }


==================================================
ARCHIVO: ./app/services/selectors.py
==================================================

from selenium.webdriver.common.by import By

LOGIN_SELECTORS = {
    "email_input": (By.NAME, "email"),
    "password_input": (By.NAME, "password"),
    "login_button": (By.CSS_SELECTOR, "button[type='submit']"),
    "dashboard_indicator": (By.CSS_SELECTOR, "a[href='https://ecosistema.gopharma.com.ve/admin/order/list/all']")
}

ORDER_TABLE_SELECTORS = {
    "table_body": (By.ID, "set-rows"),
    "order_id_link": (By.CSS_SELECTOR, "td.table-column-pl-0 a"),
}

ORDER_DETAIL_SELECTORS = {
    "order_placed_at": (By.XPATH, "//i[@class='tio-date-range']/parent::span"),
    
    # Enlaces principales (IDs y Nombres)
    "store_name": (By.XPATH, "//a[contains(@href, 'store/view')]"),
    "customer_name": (By.XPATH, "//a[contains(@href, 'customer/view')]/div/span[contains(@class, 'font-semibold')]"),
    "driver_name": (By.XPATH, "//a[contains(@href, 'delivery-man/preview')]/div/span[1]"),
    
    # Montos
    "delivery_fee": (By.XPATH, "//dt[normalize-space()='Tarifa de entrega:']/following-sibling::dd"),
    "total_amount": (By.XPATH, "//dt[normalize-space()='Total:']/following-sibling::dd"),
    
    # --- NUEVOS DATOS DE INTELIGENCIA ---
    # M√©todo de pago: Buscamos el h6 que contiene el texto y tomamos el √∫ltimo span
    "payment_method": (By.XPATH, "//h6[contains(., 'M√©todo de pago')]/span[last()]"),
    
    # Cancelaci√≥n: Buscamos en la tarjeta lateral derecha (sidebar)
    "cancellation_reason": (By.XPATH, "//span[contains(., 'Motivo de cancelaci√≥n')]/following-sibling::span[contains(@class, 'info')]"),
    "canceled_by": (By.XPATH, "//span[contains(., 'Cancelado por')]/following-sibling::span[contains(@class, 'info')]"),
    
    # IDs para relaciones
    "store_link": (By.XPATH, "//a[contains(@href, 'store/view')]"),
    "customer_link": (By.XPATH, "//a[contains(@href, 'customer/view')]"),
    "driver_link": (By.XPATH, "//a[contains(@href, 'delivery-man/preview')]"),
}


==================================================
ARCHIVO: ./app/services/task_service.py
==================================================

import os
import logging
import redis # Necesario para el force
from celery import Celery

logger = logging.getLogger(__name__)

def trigger_backfill():
    """
    Env√≠a Backfill usando Import Bypass (Celery Sender).
    """
    broker_url = os.getenv("REDIS_URL", "redis://redis:6379/0")
    simple_app = Celery("sender", broker=broker_url)
    
    task_name = "tasks.celery_tasks.backfill_historical_data"
    task = simple_app.send_task(task_name)
    
    logger.info(f"üöÄ Tarea '{task_name}' enviada. ID: {task.id}")
    return task.id

def trigger_drone(force: bool = False):
    """
    Lanza el Drone con opci√≥n de Rompe-Candados.
    Usa Import Bypass para evitar errores de ruta.
    """
    broker_url = os.getenv("REDIS_URL", "redis://redis:6379/0")
    
    # 1. GESTI√ìN DE CANDADOS (FORCE)
    if force:
        try:
            r = redis.Redis.from_url(broker_url)
            lock_key = "celery_lock_drone_enrichment"
            deleted = r.delete(lock_key)
            if deleted:
                logger.warning(f"üîì FORCE: Candado '{lock_key}' eliminado manualmente.")
            else:
                logger.info(f"‚ÑπÔ∏è FORCE: No hab√≠a candado.")
        except Exception as e:
            logger.error(f"‚ùå Error borrando candado: {e}")

    # 2. LANZAMIENTO (Usando Celery Sender "Light")
    simple_app = Celery("sender", broker=broker_url)
    
    task_name = "tasks.celery_tasks.enrich_missing_data"
    task = simple_app.send_task(task_name)
    
    logger.info(f"üöÅ Drone lanzado (Force={force}). ID: {task.id}")
    return task.id

def trigger_customer_sync():
    broker_url = os.getenv("REDIS_URL", "redis://redis:6379/0")
    simple_app = Celery("sender", broker=broker_url)
    
    # Enviamos kwargs con limit_pages=None para que sea INFINITO
    simple_app.send_task("tasks.celery_tasks.sync_customer_database", kwargs={"limit_pages": None})
    
    return "Sync Full Started"


==================================================
ARCHIVO: ./app/static/css/styles.css
==================================================

/* --- VARIABLES DE DISE√ëO (PALETA PROFESIONAL) --- */
:root {
    --bg-body: #f3f4f6;       /* Gris muy suave para el fondo */
    --bg-card: #ffffff;       /* Blanco puro para tarjetas */
    --text-main: #1f2937;     /* Gris oscuro (casi negro) para lectura */
    --text-muted: #6b7280;    /* Gris medio para etiquetas */
    --border-color: #e5e7eb;  /* Bordes sutiles */
    --primary: #3b82f6;
}

/* --- ESTILOS GENERALES --- */
body {
    background-color: var(--bg-body);
    color: var(--text-main);
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    -webkit-font-smoothing: antialiased;
}

/* --- TARJETAS (Efecto Elevaci√≥n) --- */
.card {
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
    border-radius: 12px;
    transition: box-shadow 0.3s ease, transform 0.2s ease;
}

.card:hover {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
}

/* --- TIPOGRAF√çA --- */
h1, h2, h3, h4, h5, h6 {
    color: #111827;
    font-weight: 700;
}

.text-muted {
    color: var(--text-muted) !important;
}

/* Forzar que los textos que antes eran blancos ahora sean oscuros */
.text-white {
    color: #1f2937 !important; 
}

.text-white-50 {
    color: #6b7280 !important;
}

/* --- TABLAS (Limpio y legible) --- */
.table {
    color: var(--text-main);
    margin-bottom: 0;
}

.table thead th {
    background-color: #f9fafb;
    color: #374151;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    border-bottom: 1px solid var(--border-color);
    padding-top: 1rem;
    padding-bottom: 1rem;
}

.table tbody td {
    vertical-align: middle;
    padding: 1rem 0.5rem;
    border-bottom: 1px solid var(--border-color);
}

.table-hover tbody tr:hover {
    background-color: #f9fafb;
}

/* --- BADGES (Pasteles) --- */
.badge {
    padding: 0.5em 0.8em;
    font-weight: 600;
    border-radius: 6px;
    letter-spacing: 0.3px;
}

/* Badge Verde (Success) */
.bg-success {
    background-color: #d1fae5 !important;
    color: #065f46 !important;
}

/* Badge Rojo (Danger) */
.bg-danger {
    background-color: #fee2e2 !important;
    color: #991b1b !important;
}

/* Badge Azul (Primary) */
.bg-primary {
    background-color: #dbeafe !important;
    color: #1e40af !important;
}

/* Badge Amarillo (Warning) */
.bg-warning {
    background-color: #fef3c7 !important;
    color: #92400e !important;
}

/* Badge Info */
.bg-info {
    background-color: #e0f2fe !important;
    color: #075985 !important;
}

/* --- MAPA Y GR√ÅFICOS --- */
#heatmapContainer {
    z-index: 1;
    background: #e5e7eb; /* Color de fondo mientras carga */
}

/* Colapso suave */
.collapse-icon {
    transition: transform 0.3s ease;
}
[aria-expanded="true"] .collapse-icon {
    transform: rotate(180deg);
}

/* --- BOTONES --- */
.btn-primary {
    background-color: var(--primary);
    border-color: var(--primary);
}
.btn-outline-secondary {
    border-color: #d1d5db;
    color: #374151;
}
.btn-outline-secondary:hover {
    background-color: #f3f4f6;
    color: #111827;
}

/* Animar pulso del Live */
.animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: .5; }
}


==================================================
ARCHIVO: ./app/static/js/dashboard.js
==================================================

document.addEventListener('DOMContentLoaded', function () {
    console.log("üöÄ Dashboard V5.1 (Fixed & Stable) Cargado");

    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');

    if (!token) { window.location.href = '/login'; return; }

    if (role !== 'admin') {
        document.body.classList.add('role-viewer');
        console.log("üîí Modo Visualizador (Datos financieros ocultos)");

        const style = document.createElement('style');
        // A√ëAD√ç .admin-only AQU√ç ABAJO PARA GARANTIZAR QUE SE OCULTE
        style.innerHTML = `
            #kpi-total-revenue, #kpi-total-fees, #kpi-total-coupons, 
            #kpi-driver-payout, #kpi-company-profit, #trendsChart, #heatmapContainer,
            .admin-only 
            { display: none !important; }
            .col-money { visibility: hidden; } 
        `;
        document.head.appendChild(style);
    }

    document.getElementById('btn-logout')?.addEventListener('click', () => {
        localStorage.clear(); window.location.href = '/login';
    });

    Chart.defaults.color = '#4b5563';
    Chart.defaults.borderColor = '#f3f4f6';
    Chart.defaults.font.family = "'Segoe UI', sans-serif";

    let datePicker, driverLeaderboardChart, bottleneckChart, orderTypeChart, trendsChart, cancellationChartInstance;
    let mapInstance, heatLayer, ordersInterval;
    let bottleneckPickupChart = null;

    const statusTranslations = {
        'pending': 'Pendiente', 'processing': 'Prep.', 'confirmed': 'Solicitando',
        'driver_assigned': 'Asignado', 'on_the_way': 'En Camino', 'delivered': 'Entregado', 'canceled': 'Cancelado'
    };
    const statusOrder = ['pending', 'processing', 'confirmed', 'driver_assigned', 'on_the_way', 'delivered', 'canceled'];

    // Funci√≥n para descargar Excel Oficial SIN recargar y CON Token
    window.downloadOfficialExcel = async function (btn, orderId) {
        // 1. Feedback Visual (Loading)
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Generando...';
        btn.disabled = true;

        try {
            // 2. Petici√≥n Segura (Usa authFetch para incluir el Token)
            const res = await authFetch(`/api/data/download-legacy-excel/${orderId}`);

            if (res && res.ok) {
                // 3. Convertir respuesta a archivo descargable (Blob)
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);

                // 4. Crear enlace fantasma y clicarlo
                const a = document.createElement('a');
                a.href = url;
                a.download = `Orden_Oficial_${orderId}.xlsx`; // Nombre del archivo
                document.body.appendChild(a);
                a.click();

                // 5. Limpieza
                window.URL.revokeObjectURL(url);
                a.remove();
            } else {
                alert("‚ö†Ô∏è No se pudo descargar el archivo. Verifique que el pedido exista en el sistema Legacy.");
            }
        } catch (e) {
            console.error("Error descarga:", e);
            alert("Error de conexi√≥n al intentar descargar.");
        } finally {
            // 6. Restaurar bot√≥n
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    };

    // Variable para guardar instancias de gr√°ficas y no duplicarlas
    let timelineCharts = {};

    window.toggleOrderDetails = async function (rowId) {
        const detailRow = document.getElementById(`detail-${rowId}`);
        const icon = document.getElementById(`icon-${rowId}`);
        const mainRow = document.getElementById(`row-${rowId}`);

        if (detailRow.classList.contains('d-none')) {
            // ABRIR
            detailRow.classList.remove('d-none');
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-down');
            mainRow.classList.add('table-active');

            // --- CORRECCI√ìN DE TIEMPO DE RENDERIZADO ---
            // Esperamos 150ms a que el acorde√≥n empiece a abrirse para que el canvas tenga dimensiones.
            setTimeout(async () => {
                const ctx = document.getElementById(`timeline-chart-${rowId}`)?.getContext('2d');
                const loader = document.getElementById(`timeline-loading-${rowId}`);

                // Doble chequeo: Si ya existe en memoria Y el canvas est√° en el DOM, no hacemos nada.
                // Si existe en memoria pero el canvas cambi√≥ (por refresh), la limpieza del Paso 1 ya lo habr√° matado.
                if (timelineCharts[rowId]) return;

                if (ctx) {
                    if (loader) loader.classList.remove('d-none');

                    try {
                        const res = await authFetch(`/api/analysis/order/${rowId}/timeline`);
                        if (!res) return; // Validaci√≥n extra
                        const data = await res.json();

                        if (loader) loader.classList.add('d-none');

                        if (!data.labels || data.labels.length === 0) {
                            if (loader) {
                                loader.classList.remove('d-none');
                                loader.innerText = "Sin datos cronol√≥gicos suficientes.";
                            }
                            return;
                        }

                        // Crear Gr√°fica
                        timelineCharts[rowId] = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: data.labels,
                                datasets: [{
                                    data: data.data,
                                    backgroundColor: data.colors,
                                    borderRadius: 4,
                                    barThickness: 20
                                }]
                            },
                            options: {
                                indexAxis: 'y',
                                responsive: true,
                                maintainAspectRatio: false,
                                animation: { duration: 500 }, // Suavizar entrada
                                plugins: {
                                    legend: { display: false },
                                    tooltip: { callbacks: { label: (c) => `${c.raw} min` } },
                                    datalabels: {
                                        color: '#000',
                                        anchor: 'end',
                                        align: 'right',
                                        formatter: (val) => Math.round(val) + "m",
                                        font: { weight: 'bold', size: 10 }
                                    }
                                },
                                scales: {
                                    x: { display: false },
                                    y: { grid: { display: false } }
                                },
                                layout: { padding: { right: 35 } }
                            },
                            plugins: [ChartDataLabels]
                        });

                    } catch (e) {
                        console.error("Error timeline:", e);
                        if (loader) loader.innerText = "Error cargando gr√°fica.";
                    }
                }
            }, 150); // <--- FIN DEL TIMEOUT

        } else {
            // CERRAR
            detailRow.classList.add('d-none');
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-right');
            mainRow.classList.remove('table-active');
        }
    };

    // --- REPARACI√ìN BOT√ìN REPORTE ---
    const btnReport = document.getElementById('btn-open-report');
    if (btnReport) {
        // Eliminamos listeners anteriores (clonando) para evitar duplicados si se recarga
        const newBtn = btnReport.cloneNode(true);
        btnReport.parentNode.replaceChild(newBtn, btnReport);

        newBtn.addEventListener('click', (e) => {
            e.preventDefault();
            // Construimos la URL base sin par√°metros primero
            let url = '/report';
            // Obtenemos los par√°metros actuales del filtro usando la funci√≥n helper
            const params = buildUrl('').search;
            // Abrimos en nueva pesta√±a
            window.open(url + params, '_blank');
        });
    }

    async function authFetch(url, options = {}) { // <--- Recibe URL y Opciones
        try {
            // Combinamos los headers de autenticaci√≥n con las opciones que enviamos (POST, etc)
            const defaultHeaders = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };

            // Mezclar headers por si enviamos otros custom
            const finalOptions = {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...(options.headers || {})
                }
            };

            const response = await fetch(url, finalOptions); // <--- Ahora s√≠ pasa el POST

            if (response.status === 401) {
                localStorage.clear();
                window.location.href = '/login';
                return null;
            }
            return response;
        } catch (error) {
            console.error("Error en authFetch:", error);
            return null;
        }
    }

    // Helper para sacar la fecha local exacta (YYYY-MM-DD) sin conversiones locas a UTC
    function formatDateLocal(date) {
        if (!date) return '';
        const offset = date.getTimezoneOffset();
        const localDate = new Date(date.getTime() - (offset * 60 * 1000));
        return localDate.toISOString().split('T')[0];
    }

    function buildUrl(endpoint) {
        const url = new URL(window.location.origin + endpoint);

        // --- CAMBIO AQU√ç: USAR formatDateLocal ---
        if (datePicker && datePicker.selectedDates.length > 0) {
            // Usamos nuestra funci√≥n segura en lugar de .toISOString() directo
            url.searchParams.append('start_date', formatDateLocal(datePicker.selectedDates[0]));

            if (datePicker.selectedDates.length > 1) {
                url.searchParams.append('end_date', formatDateLocal(datePicker.selectedDates[1]));
            } else {
                // TRUCO: Si selecciona un solo d√≠a (ej: 13 Ene), forzamos start=13 y end=13
                // Esto arregla el bug de que "no muestra nada" si solo eliges el inicio.
                url.searchParams.append('end_date', formatDateLocal(datePicker.selectedDates[0]));
            }
        }
        // ----------------------------------------

        const storeSelect = document.getElementById('store-filter');
        if (storeSelect && storeSelect.value) url.searchParams.append('store_name', storeSelect.value);
        const searchInput = document.getElementById('search-input');
        if (searchInput && searchInput.value.trim()) url.searchParams.append('search', searchInput.value.trim());
        return url;
    }

    async function updateKpis() {
        const res = await authFetch(buildUrl('/api/kpi/main'));
        if (!res) return;
        const data = await res.json();
        const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };

        setVal('kpi-total-revenue', `$${(data.total_revenue || 0).toFixed(2)}`);
        setVal('kpi-total-fees', `$${(data.total_fees || 0).toFixed(2)}`);
        setVal('kpi-total-coupons', `-$${(data.total_coupons || 0).toFixed(2)}`);
        setVal('kpi-driver-payout', `$${(data.driver_payout || 0).toFixed(2)}`);
        setVal('kpi-company-profit', `$${(data.company_profit || 0).toFixed(2)}`);
        setVal('kpi-total-orders', data.total_orders);
        setVal('kpi-deliveries', data.total_deliveries);
        setVal('kpi-pickups', data.total_pickups);
        setVal('kpi-new-users', data.new_users_registered ?? 0);

        const cancelEl = document.getElementById('kpi-canceled');
        if (cancelEl) cancelEl.innerHTML = `${data.total_canceled} <span class="text-danger opacity-75 small" style="font-size:0.7em;">(-$${(data.lost_revenue || 0).toFixed(2)})</span>`;
        setVal('kpi-avg-time', `${data.avg_delivery_minutes || 0} min`);
        updateOrderTypeChart(data.total_deliveries, data.total_pickups);
    }

    async function updateRecentOrdersTable() {
        const res = await authFetch(buildUrl('/api/data/orders'));
        if (!res) return;
        const data = await res.json();

        // --- CONEXI√ìN VIGILANTE ---
        checkOperationalAnomalies(data);
        // --------------------------

        // Guardamos data global para el Modal ATC
        currentOrdersData = data;

        const tableBody = document.getElementById('recent-orders-table-body');
        if (!tableBody) return;

        let calcTotalMins = 0;
        let calcTotalCount = 0;

        const cleanFinalTime = (text) => {
            if (!text) return "--";
            try {
                // Regex blindado para singular/plural y may√∫sculas
                const hMatch = text.match(/(\d+)\s*(?:Horas?|Hours?|Hrs?|h)/i);
                const mMatch = text.match(/(\d+)\s*(?:Minutos?|Minutes?|Mins?|m)/i);

                const h = hMatch ? parseInt(hMatch[1], 10) : 0;
                const m = mMatch ? parseInt(mMatch[1], 10) : 0;

                if (h > 0) return `${h}h ${m}m`;
                return `${m}m`;
            } catch (e) { return text; }
        };

        const calcDiff = (start, end) => {
            if (!start || !end) return "0m";

            const d1 = new Date(start);
            // Aseguramos UTC en el fin
            const endString = end.endsWith('Z') ? end : end + 'Z';
            const d2 = new Date(endString);

            let diffMs = d2 - d1;

            // FIX CR√çTICO: Si da negativo, asumimos que ambos eran locales y recalculamos
            if (diffMs < 0) {
                const d2_local = new Date(end.replace('Z', ''));
                diffMs = d2_local - d1;
            }

            if (isNaN(diffMs) || diffMs <= 0) return "0m";

            const totalSecs = Math.floor(diffMs / 1000);
            const h = Math.floor(totalSecs / 3600);
            const m = Math.floor((totalSecs % 3600) / 60);

            if (h > 0) return `${h}h ${m}m`;
            return `${m}m`;
        };

        const getMinutesFromOrder = (o) => {
            // 1. Prioridad: Texto del Legacy (La verdad absoluta)
            if (o.duration_text) {
                const hMatch = o.duration_text.match(/(\d+)\s*(?:Horas?|Hours?|Hrs?|h)/i);
                const mMatch = o.duration_text.match(/(\d+)\s*(?:Minutos?|Minutes?|Mins?|m)/i);
                const h = hMatch ? parseInt(hMatch[1], 10) : 0;
                const m = mMatch ? parseInt(mMatch[1], 10) : 0;
                if (h > 0 || m > 0) return (h * 60) + m;
            }
            // 2. Fallback: C√°lculo de fechas
            if (o.created_at && o.state_start_at) {
                const d1 = new Date(o.created_at);
                const endString = o.state_start_at.endsWith('Z') ? o.state_start_at : o.state_start_at + 'Z';
                const d2 = new Date(endString);
                let diffMs = d2 - d1;
                if (diffMs < 0) diffMs = new Date(o.state_start_at.replace('Z', '')) - d1;

                if (diffMs > 0) return Math.floor(diffMs / 60000);
            }
            return 0;
        };


        let html = '';
        let lastCustomer = "";
        let activeCount = 0;

        data.forEach((o, index) => {

            if (o.current_status === 'delivered' && o.order_type === 'Delivery') {
                let minutes = 0;

                // 1. Intentamos sacar los minutos del texto oficial del Legacy
                if (o.duration_text) {
                    const h = o.duration_text.match(/(\d+)\s*(?:Horas?|Hours?|Hrs?|h)/i)?.[1] || 0;
                    const m = o.duration_text.match(/(\d+)\s*(?:Minutos?|Minutes?|Mins?|m)/i)?.[1] || 0;
                    minutes = (parseInt(h) * 60) + parseInt(m);
                }

                // 2. Si no hay texto, calculamos por fechas (Fallback)
                if (minutes === 0 && o.created_at && o.state_start_at) {
                    const d1 = new Date(o.created_at);
                    const endStr = o.state_start_at.endsWith('Z') ? o.state_start_at : o.state_start_at + 'Z';
                    const d2 = new Date(endStr);
                    let diff = d2 - d1;
                    if (diff < 0) diff = new Date(o.state_start_at.replace('Z', '')) - d1; // Fix negativo
                    minutes = Math.floor(diff / 60000);
                }

                // Sumamos si el tiempo es v√°lido (mayor a 0 y menor a 1000 min para evitar errores locos)
                if (minutes > 0 && minutes < 1000) {
                    calcTotalMins += minutes;
                    calcTotalCount++;
                }
            }
            // -----------------------------------------------------

            // ------------------------------------------
            // 1. L√ìGICA DE AGRUPACI√ìN VISUAL (MULTI-CARRITO)
            // ------------------------------------------
            let isMultiCart = false;
            let isHead = false; // ¬øEs el primero del grupo?
            let multiClass = "";
            let multiLabel = "";

            // Miramos el siguiente pedido en la lista
            const nextOrder = data[index + 1];
            const isNextSame = nextOrder && nextOrder.customer_name === o.customer_name && o.customer_name !== "An√≥nimo";
            const isPrevSame = o.customer_name === lastCustomer && o.customer_name !== "An√≥nimo";

            if (isNextSame || isPrevSame) {
                isMultiCart = true;
                multiClass = "multi-cart-row"; // Aplicamos el estilo de bloque

                if (!isPrevSame) {
                    // Es el PRIMERO del grupo (Cabeza)
                    isHead = true;
                    multiLabel = `<span class="badge bg-indigo text-white ms-2 shadow-sm" style="font-size:0.6rem; background-color: #6610f2;">üì¶ Multi-Pedido (Inicio)</span>`;
                } else {
                    // Es uno de los SIGUIENTES (Cola)
                    multiClass += " multi-cart-connector"; // L√≠nea punteada arriba
                    multiLabel = `<span class="text-indigo ms-2 fw-bold small" style="color: #6610f2; font-size:0.7rem;">‚Ü≥ Parte del pedido anterior</span>`;
                }
            }
            lastCustomer = o.customer_name;

            // ------------------------------------------
            // 2. DETECCI√ìN PEDIDO VIVO (LATIDO)
            // ------------------------------------------
            let rowClass = "";
            // Si el pedido NO ha terminado (ni entregado ni cancelado), le ponemos el latido
            if (o.current_status !== 'delivered' && o.current_status !== 'canceled') {
                rowClass = "live-row";
                activeCount++;
            }

            // =========================================================
            // 3. DEFINICI√ìN DE VARIABLES DE ESTADO
            // =========================================================
            let statusBadge = '';
            let isFinal = false;

            // Configuraci√≥n Visual por Estado
            const statusConfig = {
                'created': { color: 'dark', icon: 'fa-asterisk', label: 'Creado' },
                'pending': { color: 'secondary', icon: 'fa-clock', label: 'Pendiente' },
                'processing': { color: 'warning', icon: 'fa-file-invoice-dollar', label: 'Facturando' },
                'confirmed': { color: 'primary', icon: 'fa-tower-broadcast', label: 'Solicitando' },
                'driver_assigned': { color: 'dark', icon: 'fa-user-check', label: 'Asignado' },
                'on_the_way': { color: 'info', icon: 'fa-motorcycle', label: 'En Camino' },
                'delivered': { color: 'success', icon: 'fa-check', label: 'ENTREGADO' },
                'canceled': { color: 'danger', icon: 'fa-ban', label: 'CANCELADO' }
            };

            // Obtener config o default
            const st = statusConfig[o.current_status] || { color: 'light', icon: 'fa-question', label: o.current_status };

            // Determinamos si es estado final (para el cron√≥metro)
            if (o.current_status === 'delivered' || o.current_status === 'canceled') {
                isFinal = true;
            } else {
                rowClass = 'live-row'; // <--- ESTO ACTIVA EL LATIDO
            }

            // Generamos el HTML del Badge
            if (o.current_status === 'on_the_way') {
                // Estilo especial PULSE para "En Camino"
                statusBadge = `<span class="badge bg-info text-white animate-pulse shadow-sm">
                                <i class="fa-solid ${st.icon} me-1"></i>${st.label}
                               </span>`;
            } else {
                // Estilo Moderno (Fondo suave + Borde)
                // text-warning-emphasis es para que el amarillo se lea bien sobre blanco
                const textColor = st.color === 'warning' ? 'text-warning-emphasis' : `text-${st.color}`;

                statusBadge = `<span class="badge bg-${st.color} bg-opacity-10 ${textColor} border border-${st.color} border-opacity-25">
                                <i class="fa-solid ${st.icon} me-1"></i>${st.label}
                               </span>`;
            }

            // B. Lealtad (TIER BADGE)
            let tierBadge = '<span class="badge rounded-pill bg-light text-muted border" style="font-size:0.6rem">Nuevo</span>';
            const count = o.customer_orders_count || 1;
            if (count > 10) tierBadge = '<span class="badge rounded-pill bg-warning text-dark border border-warning" style="font-size:0.6rem">VIP</span>';
            else if (count > 1) tierBadge = '<span class="badge rounded-pill bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25">Frecuente</span>';

            // C. Bot√≥n Resync (SOLO ADMIN)
            const userRole = localStorage.getItem('role');
            let resyncButtonHtml = '';

            if (userRole === 'admin') {
                resyncButtonHtml = `
                    <button class="btn btn-link p-0 text-muted btn-resync ms-2" 
                            onclick="event.stopPropagation(); resyncOrder('${o.external_id}', this)" 
                            title="Sincronizar datos (Solo Admin)">
                        <i class="fa-solid fa-arrows-rotate small"></i>
                    </button>
                `;
            }

            // D. Tiempo (H√≠brido: Scraped o Calculado)
            let timeHtml = '';
            let finalDurationStr = "";

            if (isFinal) {
                // 1. Intentamos usar el texto oficial del Legacy
                let displayTime = cleanFinalTime(o.duration_text);

                // 2. Si falla (dice "--" o vac√≠o), lo calculamos nosotros
                if ((!displayTime || displayTime === "--" || displayTime === "") && o.state_start_at && o.created_at) {
                    // Para un pedido finalizado, state_start_at es la fecha de finalizaci√≥n
                    displayTime = calcDiff(o.created_at, o.state_start_at);
                }

                finalDurationStr = displayTime;

                // Color sem√°ntico seg√∫n duraci√≥n (Ej: >60m en Rojo)
                // (Opcional, pero ayuda visualmente)

                timeHtml = `<div class="fw-bold text-dark fs-6">${displayTime}</div><small class="text-muted" style="font-size:0.7rem">Tiempo Total</small>`;
            } else {
                // Notar data-state-start para el cron√≥metro de fase
                timeHtml = `
                    <div class="live-timer-container" data-created="${o.created_at}" data-state-start="${o.state_start_at}">
                        <div class="fw-bold text-dark fs-5 timer-total font-monospace">--:--</div>
                        <small class="text-muted" style="font-size:0.65rem">En fase: <span class="timer-state text-primary fw-bold">--:--</span></small>
                    </div>`;
            }

            // E. Log√≠stica
            const typeBadge = o.order_type === 'Delivery'
                ? '<span class="badge bg-primary bg-opacity-10 text-primary mb-1"><i class="fa-solid fa-motorcycle me-1"></i>Delivery</span>'
                : '<span class="badge bg-warning bg-opacity-10 text-warning mb-1"><i class="fa-solid fa-person-walking me-1"></i>Pickup</span>';

            const driverHtml = o.driver && o.driver.name !== 'No Asignado'
                ? `<div class="d-flex align-items-center small text-dark"><i class="fa-solid fa-helmet-safety me-2 text-muted"></i>${o.driver.name}</div>`
                : `<div class="small text-muted fst-italic">--</div>`;

            // F. Items Detalle
            let itemsTable = '<div class="text-muted small fst-italic p-3">Sin productos registrados</div>';
            if (o.items && o.items.length > 0) {
                itemsTable = `
                    <table class="table table-sm table-borderless mb-0 small" style="background: transparent;">
                        <thead class="text-muted border-bottom"><tr><th>Producto</th><th class="text-center">Cant.</th><th class="text-end">Precio</th><th class="text-end">Total</th></tr></thead>
                        <tbody>
                            ${o.items.map(i => `
                                <tr>
                                    <td class="text-truncate" style="max-width: 250px;" title="${i.name}">${i.name}</td>
                                    <td class="text-center">${i.quantity}</td>
                                    <td class="text-end">$${i.unit_price.toFixed(2)}</td>
                                    <td class="text-end fw-bold">$${i.total_price.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            // =========================================================
            // 2. RENDERIZADO HTML
            // =========================================================

            // FILA PRINCIPAL
            html += `
                <tr id="row-${o.id}" class="${rowClass} ${multiClass}" style="cursor: pointer; transition: background 0.2s;" onclick="toggleOrderDetails('${o.id}')">
                    <td class="ps-4">
                        <div class="d-flex align-items-center">
                            <i id="icon-${o.id}" class="fa-solid fa-chevron-right text-muted me-2 small" style="width: 15px; transition: transform 0.2s;"></i>
                            <div>
                                <div class="d-flex align-items-center">
                                    <div class="fw-bold text-dark">#${o.external_id}</div>
                                    <!-- PUNTICO VIOLETA -->
                                    ${o.has_audit ? `<span class="ms-2 badge bg-indigo text-white rounded-pill border border-white shadow-sm" style="font-size: 0.6rem; background-color: #6610f2;" title="Incidencia Gestionada"><i class="fa-solid fa-check"></i></span>` : ''}
                                    ${resyncButtonHtml}
                                </div>
                                
                                <!-- NUEVO: RELOJ -->
                                <div class="d-flex align-items-center text-muted small mt-1" title="Hora de Creaci√≥n">
                                    <i class="fa-regular fa-clock me-1 text-primary" style="font-size: 0.7rem;"></i>
                                    <span class="font-monospace" style="font-size: 0.75rem;">
                                        ${new Date(o.created_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })}
                                    </span>
                                </div>

                                <span class="badge bg-light text-secondary border fw-normal mt-1" style="font-size:0.7rem">${o.store_name}</span>
                            </div>
                        </div>
                
                    <td>
                        <div class="fw-bold text-dark" style="font-size: 0.95rem;">
                            ${o.customer_name}
                            <!-- Etiqueta Visual de Multi-Pedido -->
                            ${multiLabel} 
                        </div>
                        <div class="d-flex align-items-center mt-1 gap-2">
                             <!-- (El resto sigue igual: Tier badge, Tel√©fono...) -->
                            ${tierBadge}
                            ${o.customer_phone ? `<a href="https://wa.me/${o.customer_phone.replace(/\D/g, '')}" target="_blank" onclick="event.stopPropagation()" class="text-success small text-decoration-none"><i class="fa-brands fa-whatsapp"></i></a>` : ''}
                        </div>
                    </td>
                    <td>
                        ${typeBadge}
                        ${driverHtml}
                    </td>
                    <td>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="me-3">${statusBadge}</div>
                            <div class="text-end">${timeHtml}</div>
                        </div>
                    </td>
                    <td class="text-end pe-4">
                        <div class="fw-bold text-dark fs-6">$${(o.total_amount || 0).toFixed(2)}</div>
                    </td>
                </tr>
            `;

            // FILA DETALLE
            html += `
                <tr id="detail-${o.id}" class="d-none bg-light shadow-inner">
                    <td colspan="5" class="p-0">
                        <div class="p-3 border-start border-4 border-primary">
                            <div class="row g-3">
                                <!-- COL 1: PRODUCTOS -->
                                <div class="col-md-5 border-end">
                                    <h6 class="fw-bold small text-muted mb-2 text-uppercase"><i class="fa-solid fa-pills me-2"></i>Detalle del Pedido</h6>
                                    ${itemsTable}
                                </div>
                                
                                <!-- COL 2: GR√ÅFICA DE TIEMPOS (NUEVO) -->
                                <div class="col-md-4 border-end d-flex flex-column">
                                    <h6 class="fw-bold small text-muted mb-2 text-uppercase"><i class="fa-solid fa-stopwatch me-2"></i>Cronolog√≠a (Mins)</h6>
                                    <div style="flex-grow: 1; position: relative; min-height: 150px;">
                                        <canvas id="timeline-chart-${o.id}"></canvas>
                                        <div id="timeline-loading-${o.id}" class="text-center text-muted mt-5 small d-none">Cargando tiempos...</div>
                                    </div>
                                </div>

                                <!-- COL 3: ACCIONES -->
                                <div class="col-md-3 d-flex flex-column justify-content-center ps-4">
                                    <h6 class="fw-bold small text-muted mb-3 text-uppercase">‚ö° Acciones</h6>
                                    
                                    <button onclick="event.stopPropagation(); openATCModal('${o.id}', '${o.external_id}')" 
                                            class="btn btn-primary btn-sm w-100 mb-2 text-start shadow-sm">
                                        <i class="fa-solid fa-file-invoice me-2"></i>Ficha ATC
                                    </button>
                                    <!-- BOT√ìN NUEVO: ASISTENTE ATC -->
                                    <button onclick="event.stopPropagation(); openAssistant('${o.id}', '${o.external_id}', '${o.current_status}', '${o.customer_name}', '${o.state_start_at}', '${finalDurationStr}')" 
                                            class="btn btn-outline-danger btn-sm w-100 mb-2 text-start shadow-sm fw-bold">
                                        <i class="fa-solid fa-user-doctor me-2"></i>Gestionar Retraso
                                    </button>

                                    <a href="https://ecosistema.gopharma.com.ve/admin/order/list/all?search=${o.external_id}" target="_blank" 
                                       onclick="event.stopPropagation()"
                                       class="btn btn-white border btn-sm w-100 text-start">
                                        <i class="fa-solid fa-external-link-alt me-2 text-muted"></i>Ver Legacy
                                    </a>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        });
        Object.values(timelineCharts).forEach(chart => chart.destroy()); // Limpieza de memoria Chart.js
        timelineCharts = {};

        tableBody.innerHTML = html;
        // Sobrescribimos el KPI falso del backend con nuestro c√°lculo real
        if (calcTotalCount > 0) {
            const realAvg = (calcTotalMins / calcTotalCount).toFixed(1);
            const kpiElement = document.getElementById('kpi-avg-time');
            if (kpiElement) {
                kpiElement.innerHTML = `${realAvg} min <small class="text-success" style="font-size:0.5em"></small>`;
            }
        } else {
            // Si no hay pedidos entregados a√∫n
            const kpiElement = document.getElementById('kpi-avg-time');
            if (kpiElement) kpiElement.innerText = "-- min";
        }
        // -----------------------------------------------------
        // --- ACTUALIZAR AVISOS EN PESTA√ëA ---
        updateDynamicFavicon(activeCount);
        document.title = activeCount > 0 ? `(${activeCount}) GoAnalisis` : "GoAnalisis Pro";

        startLiveTimers();
    }


    function startLiveTimers() {
        if (ordersInterval) clearInterval(ordersInterval);

        const formatTime = (seconds) => {
            if (seconds < 0) return "0s";
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            if (h > 0) return `${h}h ${m}m ${s}s`;
            return `${m}m ${s}s`;
        };

        ordersInterval = setInterval(() => {
            const now = new Date();

            document.querySelectorAll('.live-timer-container').forEach(el => {
                // 1. TIEMPO TOTAL (Viene en Local, se usa directo)
                // data-created="2026-01-14T11:19:00" -> Navegador asume Local
                const createdDate = new Date(el.dataset.created);
                const totalSeconds = Math.floor((now - createdDate) / 1000);

                const totalEl = el.querySelector('.timer-total');
                if (totalEl) totalEl.textContent = formatTime(totalSeconds);

                // 2. TIEMPO DE FASE (Viene en UTC, forzamos conversi√≥n)
                // data-state-start="2026-01-14T15:57..." -> Es UTC, hay que decirle al navegador
                let stateStr = el.dataset.stateStart;

                if (stateStr) {
                    // TRUCO: Si no termina en 'Z', se la ponemos.
                    // Esto obliga a JS a tratarlo como UTC y restarle las 4 horas de VET
                    if (!stateStr.endsWith('Z')) stateStr += 'Z';

                    const stateStartDate = new Date(stateStr);
                    const phaseEl = el.querySelector('.timer-state');

                    if (phaseEl && !isNaN(stateStartDate)) {
                        const phaseSeconds = Math.floor((now - stateStartDate) / 1000);
                        phaseEl.textContent = formatTime(phaseSeconds);

                        // Alerta Roja > 20 min
                        if (phaseSeconds > 1200) {
                            phaseEl.classList.remove('text-primary');
                            phaseEl.classList.add('text-danger', 'fw-bold');
                        } else {
                            phaseEl.classList.remove('text-danger', 'fw-bold');
                            phaseEl.classList.add('text-primary');
                        }
                    }
                }
            });
        }, 1000);
    }

    function updateOrderTypeChart(d, p) {
        const ctx = document.getElementById('orderTypeChart')?.getContext('2d');
        if (!ctx) return;
        if (orderTypeChart) orderTypeChart.destroy();
        orderTypeChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Delivery', 'Retiro'],
                datasets: [{
                    data: [d, p],
                    backgroundColor: ['#3b82f6', '#f59e0b'],
                    borderWidth: 0
                }]
            },
            options: {
                cutout: '70%',
                maintainAspectRatio: false,
                plugins: { legend: { display: false } } // Oculto leyenda por espacio
            }
        });
    }

    async function updateBottleneckChart() {
        try {
            const ctxDelivery = document.getElementById('bottleneckChart')?.getContext('2d');
            const ctxPickup = document.getElementById('bottleneckPickupChart')?.getContext('2d');

            if (!ctxDelivery && !ctxPickup) return;

            const res = await authFetch(buildUrl('/api/analysis/bottlenecks'));
            if (!res) return;
            const data = await res.json();

            // 1. CONFIGURACI√ìN VISUAL
            const localStatusOrder = [
                'created', 'pending', 'processing', 'confirmed', 'driver_assigned', 'on_the_way',
                'delivered', 'canceled'
            ];

            const localTranslations = {
                'created': 'Creado',
                'pending': 'Pendiente',
                'processing': 'Facturando',
                'confirmed': 'Solicitando',
                'driver_assigned': 'Asignado',
                'on_the_way': 'En Camino',
                'delivered': 'Entregado (Total)',
                'canceled': 'Cancelado (Promedio)'
            };

            const processData = (list) => {
                if (!Array.isArray(list)) return { labels: [], values: [], colors: [] };

                const sorted = list
                    .filter(d => d.avg_duration_seconds > 0)
                    .sort((a, b) => localStatusOrder.indexOf(a.status) - localStatusOrder.indexOf(b.status));

                const labels = sorted.map(d => localTranslations[d.status] || d.status);
                // Convertimos a minutos con 1 decimal
                const values = sorted.map(d => (d.avg_duration_seconds / 60).toFixed(1));

                const colors = sorted.map(d => {
                    if (d.status === 'canceled') return '#ef4444';
                    if (d.status === 'delivered') return '#10b981';
                    if (d.status === 'on_the_way') return '#0dcaf0'; // Info
                    if (d.status === 'processing') return '#ffc107'; // Warning
                    return ctxPickup ? '#3b82f6' : '#f59e0b';
                });

                return { labels, values, colors };
            };

            // CONFIGURACI√ìN COM√öN (DATALABELS)
            const chartOptions = {
                indexAxis: 'y',
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    // AQU√ç EST√Å LA MAGIA DE LOS N√öMEROS
                    datalabels: {
                        anchor: 'end', // Al final de la barra
                        align: 'end',  // Por fuera (a la derecha)
                        color: '#4b5563',
                        font: { weight: 'bold', size: 11 },
                        formatter: function (value) {
                            return value + ' m'; // Ej: "15.2 m"
                        }
                    }
                },
                scales: {
                    x: { display: false, max: undefined }, // Dejar que se autoajuste para que quepan los n√∫meros
                    y: { grid: { display: false } }
                },
                layout: {
                    padding: { right: 40 } // Espacio extra a la derecha para que no se corte el texto
                }
            };

            // 2. RENDER DELIVERY
            if (ctxDelivery) {
                const dData = processData(data.delivery);

                // Si ya existe, destruirlo para limpiar plugins viejos
                if (bottleneckChart) bottleneckChart.destroy();

                // ACTIVAR PLUGIN
                //Chart.register(ChartDataLabels);

                bottleneckChart = new Chart(ctxDelivery, {
                    type: 'bar',
                    data: {
                        labels: dData.labels,
                        datasets: [{
                            label: 'Minutos',
                            data: dData.values,
                            backgroundColor: dData.colors,
                            borderRadius: 4,
                            barPercentage: 0.6
                        }]
                    },
                    options: chartOptions
                });
            }

            // 3. RENDER PICKUP
            if (ctxPickup) {
                const pData = processData(data.pickup);

                if (bottleneckPickupChart) bottleneckPickupChart.destroy();

                bottleneckPickupChart = new Chart(ctxPickup, {
                    type: 'bar',
                    data: {
                        labels: pData.labels,
                        datasets: [{
                            label: 'Minutos',
                            data: pData.values,
                            backgroundColor: pData.colors,
                            borderRadius: 4,
                            barPercentage: 0.6
                        }]
                    },
                    options: chartOptions
                });
            }
        } catch (error) {
            console.error("‚ö†Ô∏è Error renderizando gr√°ficos de tiempos:", error);
        }
    }

    async function updateCancellationChart() {
        const ctx = document.getElementById('cancellationChart')?.getContext('2d');
        if (!ctx) return;

        const res = await authFetch(buildUrl('/api/analysis/cancellations'));
        if (!res) return;
        const data = await res.json();

        let labels = data.length ? data.map(d => d.reason || 'Sin motivo') : ['Sin datos'];
        let values = data.length ? data.map(d => d.count) : [0];

        if (cancellationChartInstance) cancellationChartInstance.destroy();

        cancellationChartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#3b82f6']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' },
                    // --- CORRECCI√ìN DEL ERROR ---
                    // Desactivamos datalabels aqu√≠ para evitar el error "_labels undefined"
                    datalabels: { display: false }
                }
            }
        });
    }

    async function loadTopCustomers() {
        const tbody = document.querySelector('#topCustomersTable tbody');
        if (!tbody) return; // Si no hay tabla, salimos

        const res = await authFetch(buildUrl('/api/data/top-customers'));
        if (!res) return;
        const data = await res.json();

        tbody.innerHTML = '';
        data.forEach(c => {
            let rank = `#${c.rank}`; if (c.rank === 1) rank = 'ü•á'; if (c.rank === 2) rank = 'ü•à'; if (c.rank === 3) rank = 'ü•â';
            tbody.innerHTML += `<tr><td class="ps-4 fw-bold text-warning">${rank}</td><td class="fw-bold">${c.name}</td><td class="text-center"><span class="badge bg-primary">${c.count}</span></td><td class="text-end fw-bold text-success">$${c.total_amount.toFixed(2)}</td><td class="text-end pe-4 text-muted">$${(c.total_amount / c.count).toFixed(2)}</td></tr>`;
        });
    }

    async function updateTopProducts() {
        const tbody = document.getElementById('top-products-body');
        if (!tbody) return;
        const res = await authFetch(buildUrl('/api/data/top-products'));
        if (!res) return;
        const data = await res.json();
        tbody.innerHTML = '';
        data.forEach((p, i) => {
            let icon = i === 0 ? 'ü•á' : (i === 1 ? 'ü•à' : (i === 2 ? 'ü•â' : 'üì¶'));
            tbody.innerHTML += `<tr><td class="ps-4"><span>${icon}</span> <b>${p.name}</b></td><td class="text-center"><span class="badge bg-soft-primary text-primary border">${p.quantity}</span></td><td class="text-end pe-4 text-success fw-bold">$${p.revenue.toFixed(2)}</td></tr>`;
        });
    }

    // --- 4. TENDENCIAS (Gr√°fico Mixto: $ + Pedidos + Tiempo) ---
    async function updateTrendsChart() {
        const ctx = document.getElementById('trendsChart')?.getContext('2d');
        if (!ctx) return;

        const res = await authFetch(buildUrl('/api/data/trends'));
        if (!res) return;
        const data = await res.json();

        if (trendsChart) trendsChart.destroy();

        trendsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        type: 'line',
                        label: 'Ingresos ($)',
                        data: data.revenue,
                        borderColor: '#10b981', // Verde
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        yAxisID: 'y',
                        fill: true,
                        tension: 0.3,
                        order: 1
                    },
                    {
                        type: 'bar',
                        label: 'Pedidos',
                        data: data.orders,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)', // Azul
                        borderColor: '#3b82f6',
                        borderWidth: 1,
                        yAxisID: 'y1',
                        order: 2
                    },
                    {
                        type: 'line',
                        label: 'Tiempo (min)',
                        data: data.avg_times,
                        borderColor: '#ef4444', // Rojo
                        backgroundColor: 'transparent',
                        yAxisID: 'y1',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        order: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: {
                        display: true, position: 'left', grid: { color: '#e5e7eb' },
                        title: { display: true, text: 'Facturaci√≥n ($)' }
                    },
                    y1: {
                        display: true, position: 'right', grid: { display: false },
                        title: { display: true, text: 'Pedidos / Minutos' }
                    }
                },
                plugins: { legend: { labels: { usePointStyle: true } } }
            }
        });
    }

    // --- 5. TOP REPARTIDORES (Leaderboard) ---
    async function updateDriverLeaderboard() {
        const ctx = document.getElementById('driverLeaderboardChart')?.getContext('2d');
        if (!ctx) return;

        const res = await authFetch(buildUrl('/api/data/driver-leaderboard'));
        if (!res) return;
        const data = await res.json();

        if (driverLeaderboardChart) driverLeaderboardChart.destroy();

        // L√≥gica de colores seg√∫n estado
        const bgColors = data.map(d => {
            if (d.status === 'new') return '#3b82f6';    // Azul (Nuevo)
            if (d.status === 'active') return '#10b981'; // Verde (Activo)
            if (d.status === 'warning') return '#f59e0b';// Amarillo (Alerta)
            return '#ef4444';                            // Rojo (Inactivo)
        });

        const labels = data.map(d => {
            let timeMsg = d.days_inactive === 0 ? "Hoy" : `${d.days_inactive}d`;
            if (d.days_inactive === -1) timeMsg = "Nuevo";
            return `${d.name} (${timeMsg})`;
        });

        driverLeaderboardChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Entregas',
                    data: data.map(d => d.orders),
                    backgroundColor: bgColors,
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                maintainAspectRatio: false,
                scales: { x: { grid: { color: '#e5e7eb' } } },
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- 6. TOP TIENDAS (Lista HTML) ---
    async function updateTopStoresList() {
        const list = document.getElementById('top-stores-list');
        if (!list) return;

        const res = await authFetch(buildUrl('/api/data/top-stores'));
        if (!res) return;
        const data = await res.json();

        list.innerHTML = '';
        data.slice(0, 10).forEach(s => {
            list.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center px-3 py-2">
                    <div class="d-flex flex-column">
                        <span class="text-dark fw-bold small">
                            <i class="fa-solid fa-store me-2 text-muted"></i>${s.name}
                        </span>
                        <small class="text-muted ms-4" style="font-size: 0.65rem;">
                            Desde: ${s.first_seen}
                        </small>
                    </div>
                    <span class="badge bg-success bg-opacity-10 text-success rounded-pill border border-success border-opacity-25">
                        ${s.orders}
                    </span>
                </li>`;
        });
    }

    // --- 7. MAPA DE CALOR (Leaflet - BLINDADO) ---
    async function updateHeatmap() {
        const mapDiv = document.getElementById('heatmapContainer');
        if (!mapDiv) return;

        // 1. Obtener Datos (Siempre, para tenerlos listos)
        const res = await authFetch(buildUrl('/api/data/heatmap'));
        if (!res) return;
        const data = await res.json();

        // 2. CHECK DE SEGURIDAD (Si est√° oculto/colapsado)
        if (mapDiv.clientHeight === 0 || mapDiv.clientWidth === 0) {
            console.warn("‚ö†Ô∏è Mapa oculto: Limpiando capas para evitar crash.");

            // CR√çTICO: Si el mapa est√° oculto, QUITAMOS la capa de calor para que no intente
            // dibujarse en un canvas de 0px y genere el error IndexSizeError.
            if (mapInstance && heatLayer) {
                mapInstance.removeLayer(heatLayer);
                heatLayer = null;
            }
            return;
        }

        // 3. Inicializaci√≥n √∫nica (Si es visible y no existe el mapa)
        if (!mapInstance) {
            mapInstance = L.map('heatmapContainer').setView([10.4806, -66.9036], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap'
            }).addTo(mapInstance);
        }

        // 4. Forzar ajuste de tama√±o (Vital cuando se abre el acorde√≥n)
        mapInstance.invalidateSize();

        // 5. Limpieza de capa anterior (Si exist√≠a)
        if (heatLayer) {
            mapInstance.removeLayer(heatLayer);
            heatLayer = null;
        }

        // 6. Pintar Nueva Capa
        if (data && data.length > 0) {
            try {
                heatLayer = L.heatLayer(data, {
                    radius: 20,
                    blur: 15,
                    maxZoom: 14,
                    minOpacity: 0.4,
                    gradient: { 0.4: 'cyan', 0.65: 'lime', 1: 'red' }
                }).addTo(mapInstance);

                // Auto-ajustar zoom para ver los puntos
                if (data.length > 1) {
                    const bounds = data.map(p => [p[0], p[1]]);
                    mapInstance.fitBounds(bounds, { padding: [20, 20] });
                }
            } catch (e) {
                console.error("Error pintando heatmap:", e);
            }
        }

        // 7. Cargar Tiendas (Puntos Azules)
        try {
            const resStores = await authFetch('/api/data/stores-locations');
            if (resStores) {
                const stores = await resStores.json();
                stores.forEach(s => {
                    // Usamos un ID √∫nico para no duplicar marcadores si ya existen (opcional, Leaflet maneja esto bien)
                    L.circleMarker([s.lat, s.lng], {
                        radius: 5, fillColor: "#fff", color: "#3b82f6", weight: 2, fillOpacity: 1
                    }).bindPopup(`<b>${s.name}</b>`).addTo(mapInstance);
                });
            }
        } catch (e) { }
    }

    // --- 8. FILTRO DE TIENDAS (Dropdown) ---
    async function loadStoreFilterOptions() {
        const sel = document.getElementById('store-filter');
        if (!sel) return;

        console.log("üè™ Cargando lista de tiendas...");

        // FIX: La ruta correcta debe incluir /data/
        const res = await authFetch('/api/data/all-stores-names');

        if (!res || !res.ok) {
            console.error("‚ùå Error cargando tiendas. Ruta no encontrada o error servidor.");
            sel.innerHTML = '<option value="">Error al cargar</option>';
            return;
        }

        const data = await res.json();
        console.log(`‚úÖ ${data.length} tiendas encontradas.`);

        // Limpiamos y ponemos la opci√≥n default
        sel.innerHTML = '<option value="">Todas las Tiendas</option>';

        data.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            sel.appendChild(opt);
        });

        // Recargar dashboard al cambiar selecci√≥n
        sel.onchange = function () {
            console.log("Filtro tienda cambiado a:", sel.value);
            fetchAllData(true);
        };
    }

    // --- FIX MAPA COLAPSABLE ---
    const mapCollapse = document.getElementById('collapseMap');
    if (mapCollapse) {
        mapCollapse.addEventListener('shown.bs.collapse', function () {
            // Cuando se abre, llamamos a la funci√≥n ahora que S√ç tiene altura
            updateHeatmap();
        });
    }

    async function fetchAllData(isSearch = false) {
        // Actualizamos hora
        const now = new Date();
        const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        document.getElementById('last-updated').textContent = timeString;

        // Usamos await para garantizar que los datos cr√≠ticos carguen primero
        await updateKpis();
        await updateRecentOrdersTable();

        // Ejecutamos en paralelo los secundarios para velocidad
        updateBottleneckChart();
        updateCancellationChart();

        // Llamada a las funciones restantes (aseg√∫rate de que estas existan en tu archivo real)
        // Como pusiste "dummy code" en el prompt, asumo que las tienes definidas abajo.
        if (typeof loadTopCustomers === 'function') loadTopCustomers();
        if (typeof updateTopProducts === 'function') updateTopProducts();
        if (typeof updateDriverLeaderboard === 'function') updateDriverLeaderboard();
        if (typeof updateTopStoresList === 'function') updateTopStoresList();
        if (typeof updateHeatmap === 'function') updateHeatmap();
        if (typeof updateTrendsChart === 'function') updateTrendsChart();
    }

    datePicker = flatpickr("#date-range-picker", { mode: "range", dateFormat: "Y-m-d", defaultDate: [new Date(), new Date()], onClose: fetchAllData });
    document.getElementById('btn-update')?.addEventListener('click', () => fetchAllData(true));
    document.getElementById('btn-all-history')?.addEventListener('click', () => { datePicker.setDate(["2024-01-01", new Date()]); fetchAllData(); });
    // --- NUEVO LISTENER PARA BOT√ìN HOY ---
    document.getElementById('btn-today')?.addEventListener('click', () => {
        const today = new Date();
        // Seteamos Hoy como Inicio y Fin
        datePicker.setDate([today, today]);
        fetchAllData();
    });
    // -------------------------------------

    loadStoreFilterOptions();

    fetchAllData();
    setInterval(fetchAllData, 60000);
    // --- FUNCI√ìN RESYNC MANUAL ---
    window.resyncOrder = async function (externalId, btnElement) {
        // 1. Efecto Visual de Carga (Spinning)
        const icon = btnElement.querySelector('i');
        icon.classList.add('fa-spin', 'text-primary');
        btnElement.disabled = true;

        try {
            // 2. Llamada al Backend
            const res = await authFetch(`/api/data/orders/${externalId}/resync`, {
                method: 'POST' // Es una acci√≥n, usamos POST
            });

            if (res && res.ok) {
                // 3. √âxito: Feedback y Recarga suave
                icon.classList.remove('text-primary');
                icon.classList.add('text-success');

                // Peque√±a pausa para que el usuario vea el verde
                setTimeout(() => {
                    fetchAllData(); // Recargamos la tabla para ver los cambios
                }, 500);
            } else {
                alert("Error al sincronizar. Revise los logs.");
                icon.classList.remove('fa-spin', 'text-primary');
                icon.classList.add('text-danger');
                btnElement.disabled = false;
            }
        } catch (e) {
            console.error(e);
            alert("Error de conexi√≥n.");
            icon.classList.remove('fa-spin');
            btnElement.disabled = false;
        }
    };

    // --- FUNCI√ìN AUDITOR√çA ATC (V4 - INTEGRADA Y BLINDADA) ---
    window.openATCModal = async function (dbId, externalId) {
        const modalEl = document.getElementById('modalATC');
        if (!modalEl) return;
        const modalBody = document.getElementById('modalATCBody');
        const modal = new bootstrap.Modal(modalEl);

        modalBody.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <h5 class="mt-3 fw-bold">Generando Ficha T√©cnica...</h5>
                <p class="text-muted">Sincronizando Legacy + Base de Datos Local...</p>
            </div>
        `;
        modal.show();

        try {
            // 1. PETICI√ìN DE DATOS
            const res = await authFetch(`/api/data/live-audit/${externalId}`);
            if (!res || !res.ok) throw new Error("Error conectando con API de Auditor√≠a.");

            const responseJson = await res.json();
            const data = responseJson.legacy; // Datos del CSV (La Verdad)
            const items = responseJson.items || []; // Productos (DB Local)

            if (!data) throw new Error("El archivo CSV del Legacy lleg√≥ vac√≠o.");

            // 2. CONFIGURACI√ìN VISUAL
            const originalTitle = document.title;
            const cleanName = (data['Nombre del cliente'] || 'Cliente').replace(/[\\/:*?"<>|]/g, '');
            document.title = `Ficha #${data['ID del pedido']} - ${cleanName}`;

            modalEl.addEventListener('hidden.bs.modal', () => { document.title = originalTitle; }, { once: true });

            // 3. PARSER INTELIGENTE (USA / VED)
            const parseM = (val) => {
                if (!val) return 0.00;
                if (typeof val === 'number') return val;
                let v = String(val).trim();

                // Detecci√≥n autom√°tica de formato
                // Caso VED: "1.500,50" (Coma al final)
                if (v.includes(',') && (v.lastIndexOf(',') > v.lastIndexOf('.'))) {
                    v = v.replace(/\./g, '').replace(',', '.');
                }
                // Caso USA: "1,500.50" (Punto al final)
                else if (v.includes('.') && (v.lastIndexOf('.') > v.lastIndexOf(','))) {
                    v = v.replace(/,/g, '');
                }
                return parseFloat(v) || 0.00;
            };

            const fmt = (n, symbol = "$") => {
                return `${symbol}${n.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            };

            // 4. EXTRACCI√ìN DE TASA
            let exchangeRate = 0;
            const tasaStr = data['Tasa de cambio'] || "";
            // Regex que busca "VED 123.45" o "= 123.45"
            const match = tasaStr.match(/VED\s*([\d.,]+)/i) || tasaStr.match(/=\s*([\d.,]+)/);
            if (match) exchangeRate = parseM(match[1]);

            console.log(`üìä Debug: Items=${items.length}, Tasa=${exchangeRate}, StringTasa="${tasaStr}"`);

            // 5. C√ÅLCULO DE TABLA DETALLADA (EL CEREBRO)
            let productsHtml = '';

            if (items.length > 0 && exchangeRate > 0) {
                // --- ALGORITMO DETECTIVE DE IVA ---
                const IVA_RATE = 0.16;
                const totalDbNetUsd = items.reduce((acc, item) => acc + (item.unit_price * item.quantity), 0);
                const legacyTaxUsd = parseM(data['Impuesto (USD)']);

                let itemTaxMap = new Array(items.length).fill(0);
                let methodUsed = "proportional"; // Por defecto seguro

                // L√≥gica de detecci√≥n
                if (legacyTaxUsd === 0) {
                    methodUsed = "none"; // Todo exento
                } else if (Math.abs(legacyTaxUsd - (totalDbNetUsd * IVA_RATE)) < 0.05) {
                    itemTaxMap.fill(1);
                    methodUsed = "all"; // Todo gravado
                } else if (items.length <= 20) {
                    // Detective Subset Sum (Solo si hay pocos items)
                    const targetBase = legacyTaxUsd / IVA_RATE;
                    const findSubset = (idx, currentSum, selection) => {
                        if (Math.abs(currentSum - targetBase) < 0.03) return selection;
                        if (idx >= items.length || currentSum > targetBase + 0.03) return null;

                        // Con item
                        const v = items[idx].unit_price * items[idx].quantity;
                        const r1 = findSubset(idx + 1, currentSum + v, [...selection, idx]);
                        if (r1) return r1;
                        // Sin item
                        return findSubset(idx + 1, currentSum, selection);
                    };

                    const res = findSubset(0, 0, []);
                    if (res) {
                        res.forEach(i => itemTaxMap[i] = 1);
                        methodUsed = "exact";
                    }
                }

                // Fallback proporcional
                let taxMultiplierFallback = 1;
                if (totalDbNetUsd > 0) taxMultiplierFallback = 1 + (legacyTaxUsd / totalDbNetUsd);

                // --- ARMADO DE HTML ---
                productsHtml = `
                    <div class="mt-4 mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fa-solid fa-calculator text-primary me-2"></i>
                            <div>
                                <h6 class="fw-bold text-dark mb-0">C√ÅLCULO UNITARIO (Para Devoluciones)</h6>
                                <small class="text-muted" style="font-size: 0.7rem;">
                                    ${methodUsed === 'exact' ? 'IVA identificado por producto' : methodUsed === 'proportional' ? 'IVA prorrateado (estimado)' : 'C√°lculo directo'}
                                </small>
                            </div>
                        </div>
                        <div class="table-responsive border rounded-3">
                            <table class="table table-striped table-hover mb-0 align-middle small">
                                <thead class="bg-light text-secondary">
                                    <tr>
                                        <th class="ps-3 py-2">PRODUCTO</th>
                                        <th class="text-center py-2">CANT.</th>
                                        <th class="text-end py-2">UNIT ($)</th>
                                        <th class="text-end py-2 bg-soft-success text-success fw-bold border-start">REEMBOLSO (Bs)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${items.map((item, idx) => {
                    let multiplier = 1;
                    let badge = '';

                    // --- REGLA MAESTRA DEL CERO ---
                    if (item.unit_price === 0) {
                        multiplier = 1; // El cero se queda quieto
                        badge = '<span class="badge bg-light text-secondary border ms-1" style="font-size:0.6em">Obsequio</span>';
                    }
                    // --- L√ìGICA DE IMPUESTOS NORMAL ---
                    else if (methodUsed === 'exact' || methodUsed === 'all') {
                        if (itemTaxMap[idx] === 1) {
                            multiplier = 1.16;
                            badge = '<span class="badge bg-secondary ms-1" style="font-size:0.6em">+IVA</span>';
                        }
                    } else if (methodUsed === 'proportional') {
                        multiplier = taxMultiplierFallback;
                    }

                    const grossUsd = item.unit_price * multiplier;
                    const grossBs = grossUsd * exchangeRate;

                    return `
                                        <tr>
                                            <td class="ps-3 text-truncate" style="max-width: 250px;">${item.name}</td>
                                            <td class="text-center fw-bold">${item.quantity}</td>
                                            <td class="text-end text-muted">${fmt(item.unit_price)}${badge}</td>
                                            <td class="text-end fw-bold text-success bg-soft-success border-start fs-6">
                                                ${fmt(grossBs, 'Bs.')}
                                            </td>
                                        </tr>`;
                }).join('')}
                                </tbody>
                            </table>
                            <div class="bg-light p-1 px-3 text-end text-muted fst-italic" style="font-size: 0.75rem;">
                                Tasa Ref: 1 USD = ${fmt(exchangeRate, 'Bs.')}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // MENSAJE DE ERROR AMIGABLE SI FALLA LA TABLA
                let errorMsg = "No se pudo generar el c√°lculo detallado.";
                if (items.length === 0) errorMsg = "‚ö†Ô∏è No hay productos registrados en la base de datos local para este pedido.";
                else if (exchangeRate === 0) errorMsg = "‚ö†Ô∏è No se pudo leer la Tasa de Cambio del archivo Legacy.";

                productsHtml = `<div class="alert alert-warning mt-3 small">${errorMsg}</div>`;
            }

            // 6. PLANTILLA FINAL
            const html = `
                <style>
                    @media print {
                        @page { margin: 15mm; size: auto; }
                        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        .modal-footer, .btn-close { display: none !important; }
                        .card { border: 1px solid #ddd !important; }
                        a { text-decoration: none !important; color: black !important; }
                    }
                </style>

                <div class="d-flex justify-content-between align-items-start mb-4 border-bottom pb-3">
                    <div>
                        <div class="text-primary fw-bold small mb-1"><i class="fa-solid fa-shield-halved me-1"></i>DATOS OFICIALES DEL LEGACY</div>
                        <h1 class="fw-bold mb-0 text-dark display-6">#${data['ID del pedido']}</h1>
                        <div class="text-muted">${data['Nombre de la tienda']}</div>
                    </div>
                    <div class="text-end">
                        <div class="small text-muted text-uppercase fw-bold">FECHA OFICIAL</div>
                        <div class="fs-5 text-dark mb-2">${data['Fecha']}</div>
                        <span class="badge bg-${data['Estado del pedido'] === 'Entregado' ? 'success' : 'dark'} fs-6 border">
                            ${data['Estado del pedido']}
                        </span>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-6">
                        <div class="p-3 border rounded h-100">
                            <h6 class="text-primary fw-bold mb-3"><i class="fa-solid fa-user me-2"></i>CLIENTE</h6>
                            <table class="table table-borderless table-sm mb-0 small">
                                <tr><td class="text-muted ps-0">Nombre:</td><td class="fw-bold text-end">${data['Nombre del cliente']}</td></tr>
                                <tr><td class="text-muted ps-0">Email:</td><td class="text-end text-break">${data['Correo electr√≥nico del cliente']}</td></tr>
                                <tr><td class="text-muted ps-0">Tel√©fono:</td><td class="text-end fw-bold">${data['Tel√©fono del cliente']}</td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 border rounded h-100">
                            <h6 class="text-success fw-bold mb-3"><i class="fa-solid fa-money-check-dollar me-2"></i>PAGO</h6>
                            <table class="table table-borderless table-sm mb-0 small">
                                <tr><td class="text-muted ps-0">M√©todo:</td><td class="text-end fw-bold">${data['M√©todo de pago']}</td></tr>
                                <tr><td class="text-muted ps-0">Referencia:</td><td class="text-end fw-bold text-primary">${data['Referencia']}</td></tr>
                                <tr><td class="text-muted ps-0">Estado:</td><td class="text-end text-success fw-bold">${data['Estado del pago']}</td></tr>
                                <tr><td class="text-muted ps-0">Tasa:</td><td class="text-end">${data['Tasa de cambio']}</td></tr>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- AQU√ç SE INYECTA LA TABLA DE PRODUCTOS -->
                ${productsHtml}

                <h6 class="fw-bold text-dark ps-1 mb-2 mt-4"><i class="fa-solid fa-receipt me-2"></i>DESGLOSE FINAL (LEGACY)</h6>
                <div class="table-responsive border rounded mb-3">
                    <table class="table table-bordered mb-0 small">
                        <thead class="bg-light text-center text-uppercase text-secondary">
                            <tr><th>Concepto</th><th>USD ($)</th><th>VED (Bs)</th></tr>
                        </thead>
                        <tbody>
                            <tr><td class="ps-3">Subtotal Art√≠culos</td><td class="text-end pe-3">${fmt(parseM(data['Precio del art√≠culo (USD)']))}</td><td class="text-end pe-3">${fmt(parseM(data['Precio del art√≠culo (VED)']), 'Bs.')}</td></tr>
                            <tr><td class="ps-3">Descuentos</td><td class="text-end pe-3 text-danger">-${fmt(parseM(data['Monto descontado (USD)']))}</td><td class="text-end pe-3 text-danger">-${fmt(parseM(data['Monto descontado (VED)']), 'Bs.')}</td></tr>
                            <tr><td class="ps-3">Impuestos</td><td class="text-end pe-3">${fmt(parseM(data['Impuesto (USD)']))}</td><td class="text-end pe-3">${fmt(parseM(data['Impuesto (VED)']), 'Bs.')}</td></tr>
                            <tr><td class="ps-3 text-muted">Delivery Fee</td><td class="text-end pe-3 text-muted">${fmt(parseM(data['Cargo de entrega (USD)']))}</td><td class="text-end pe-3 text-muted">${fmt(parseM(data['Cargo de entrega (VED)']), 'Bs.')}</td></tr>
                            <tr><td class="ps-3 text-muted">Service Fee</td><td class="text-end pe-3 text-muted">${fmt(parseM(data['Tarifa de servicio (USD)']))}</td><td class="text-end pe-3 text-muted">${fmt(parseM(data['Tarifa de servicio (VED)']), 'Bs.')}</td></tr>
                        </tbody>
                        <tfoot class="bg-dark text-white">
                            <tr>
                                <td class="ps-3 fw-bold text-end">TOTAL COBRADO:</td>
                                <td class="text-end pe-3 fw-bold fs-6">${fmt(parseM(data['Monto total (USD)']))}</td>
                                <td class="text-end pe-3 fw-bold fs-6">${fmt(parseM(data['Monto total (VED)']), 'Bs.')}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="alert alert-warning small d-flex align-items-start py-2">
                    <i class="fa-solid fa-triangle-exclamation mt-1 me-2"></i>
                    <div><strong>Nota:</strong> Service Fee y Delivery Fee no suelen ser reembolsables.</div>
                </div>
            `;

            modalBody.innerHTML = html;

        } catch (e) {
            console.error(e);
            modalBody.innerHTML = `<div class="text-center py-5 text-danger"><h5>Error</h5><p>${e.message}</p></div>`;
        }
    };
    // =========================================================
    // üîî M√ìDULO VIGILANTE V2 (PERSISTENTE Y ROBUSTO)
    // =========================================================

    // Leemos preferencia guardada (o false por defecto)
    let notificationsEnabled = localStorage.getItem('vigilante_active') === 'true';
    let ordersMemory = {};
    let isFirstLoad = true;

    const soundNewOrder = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
    const soundAlert = new Audio("https://actions.google.com/sounds/v1/alarms/bugle_tune.ogg");

    const btnNotif = document.getElementById('btn-notifications');
    const badgeNotif = document.getElementById('notif-badge');

    // 1. INICIALIZACI√ìN VISUAL (Al cargar p√°gina)
    function initVigilante() {
        if (!btnNotif) {
            console.warn("‚ö†Ô∏è No se encontr√≥ el bot√≥n #btn-notifications en el HTML.");
            return;
        }

        // Si el usuario lo dej√≥ activo, verificamos que el navegador a√∫n tenga permiso
        if (notificationsEnabled && Notification.permission === "granted") {
            updateNotifIcon(true);
            console.log("üîî Vigilante: Restaurado (ACTIVO)");
        } else {
            notificationsEnabled = false;
            updateNotifIcon(false);
            console.log("üîï Vigilante: Inactivo");
        }
    }

    // 2. GESTI√ìN DEL BOT√ìN
    btnNotif?.addEventListener('click', () => {
        console.log("üëÜ Click en Campana. Permiso:", Notification.permission);

        const isSecure = window.isSecureContext;

        if (!notificationsEnabled) {
            // A. YA TIENE PERMISO -> ACTIVAR
            if (Notification.permission === "granted") {
                toggleVigilante(true);
            }
            // B. BLOQUEADO O NO SEGURO -> MOSTRAR AYUDA INTELIGENTE
            else if (Notification.permission === "denied" || !isSecure) {

                // 1. Detectar Navegador para dar la URL correcta
                const userAgent = navigator.userAgent.toLowerCase();
                let flagsUrl = "chrome://flags/#unsafely-treat-insecure-origin-as-secure"; // Default (Chrome/Brave)

                if (userAgent.indexOf("edg") > -1) {
                    flagsUrl = "edge://flags/#unsafely-treat-insecure-origin-as-secure"; // Microsoft Edge
                } else if (userAgent.indexOf("opera") > -1 || userAgent.indexOf("opr") > -1) {
                    flagsUrl = "opera://flags/#unsafely-treat-insecure-origin-as-secure"; // Opera
                }

                // 2. Rellenar los inputs del Modal
                const inputFlag = document.getElementById('inputFlagUrl');
                const inputIp = document.getElementById('inputServerUrl');

                if (inputFlag) inputFlag.value = flagsUrl;
                if (inputIp) inputIp.value = window.location.origin; // IP Autom√°tica (ej: http://10.10.100.58:8001)

                // 3. Mostrar Modal
                const helpModal = new bootstrap.Modal(document.getElementById('modalNotifHelp'));
                helpModal.show();
            }
            // C. PRIMERA VEZ -> PEDIR PERMISO
            else {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        toggleVigilante(true);
                    } else {
                        // Si niega, la pr√≥xima vez caer√° en el Caso B
                        console.warn("Usuario deneg√≥ permiso.");
                    }
                });
            }
        } else {
            toggleVigilante(false);
        }
    });

    function toggleVigilante(state) {
        notificationsEnabled = state;
        localStorage.setItem('vigilante_active', state); // Guardar preferencia
        updateNotifIcon(state);

        if (state) {
            // Sonido de confirmaci√≥n
            soundNewOrder.volume = 0.5;
            soundNewOrder.play().catch(e => console.warn("Audio bloqueado:", e));

            // Notificaci√≥n de prueba
            new Notification("GoAnalisis Vigilante", {
                body: "‚úÖ Monitoreo en segundo plano activado.",
                icon: "/static/img/logo.png"
            });
        }
    }

    function updateNotifIcon(isActive) {
        const icon = btnNotif.querySelector('i');
        if (isActive) {
            // ESTADO ACTIVO
            btnNotif.classList.remove('btn-outline-secondary');
            btnNotif.classList.add('btn-primary', 'shadow', 'pulse-animation');
            icon.className = 'fa-solid fa-bell';
            badgeNotif.classList.remove('d-none');
        } else {
            // ESTADO INACTIVO
            btnNotif.classList.add('btn-outline-secondary');
            btnNotif.classList.remove('btn-primary', 'shadow', 'pulse-animation');
            icon.className = 'fa-regular fa-bell-slash';
            badgeNotif.classList.add('d-none');
        }
    }

    // 3. FUNCI√ìN DE DISPARO
    function sendNotification(title, body, type = 'info') {
        if (!notificationsEnabled) return;

        // Visual
        const notif = new Notification(title, {
            body: body,
            icon: '/static/img/logo.png',
            requireInteraction: type === 'alert',
            tag: title
        });

        notif.onclick = () => { window.focus(); notif.close(); };

        // Audio
        try {
            if (type === 'alert') {
                soundAlert.currentTime = 0;
                soundAlert.volume = 1.0;
                soundAlert.play();
            } else {
                soundNewOrder.currentTime = 0;
                soundNewOrder.volume = 0.5;
                soundNewOrder.play();
            }
        } catch (e) { console.warn("Audio error:", e); }
    }

    // 4. L√ìGICA DE DETECCI√ìN (EL CEREBRO)
    function checkOperationalAnomalies(newOrders) {
        const LIMITS = { 'pending': 10, 'processing': 15, 'confirmed': 15, 'driver_assigned': 15, 'on_the_way': 45 };
        const currentIds = new Set();

        // --- DEFINIR EL INICIO DEL D√çA (00:00 AM) ---
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Resetear a medianoche local
        const todayTime = today.getTime();

        newOrders.forEach(o => {
            // --- FILTRO ANTI-SPAM (SEGURIDAD) ---
            // Convertimos la fecha del pedido a objeto Date
            const orderDate = new Date(o.created_at);

            // Si el pedido es m√°s viejo que hoy a las 00:00, LO IGNORAMOS.
            if (orderDate.getTime() < todayTime) {
                return; // Salta a la siguiente iteraci√≥n sin notificar
            }
            // ------------------------------------

            currentIds.add(o.id);
            const prev = ordersMemory[o.id];

            // A. NUEVO PEDIDO
            if (!prev) {
                if (!isFirstLoad) {
                    sendNotification(`üí∞ Nuevo Pedido #${o.external_id}`, `${o.customer_name} ($${o.total_amount})`, 'info');
                }
            }
            // B. CAMBIO DE ESTADO
            else if (prev.status !== o.current_status) {
                const mapStatus = {
                    'processing': 'üü° Facturando',
                    'confirmed': 'üîµ Solicitando',
                    'driver_assigned': '‚ö´ Motorizado Asignado',
                    'on_the_way': 'üí† En Camino',
                    'delivered': '‚úÖ Entregado',
                    'canceled': 'üî¥ Cancelado'
                };
                if (mapStatus[o.current_status]) {
                    sendNotification(`Actualizaci√≥n #${o.external_id}`, `Ahora est√°: ${mapStatus[o.current_status]}`, 'info');
                }
            }

            // C. RETRASOS
            if (o.state_start_at && LIMITS[o.current_status]) {
                let stateStr = o.state_start_at;
                if (!stateStr.endsWith('Z')) stateStr += 'Z';

                const elapsedMinutes = (new Date() - new Date(stateStr)) / 1000 / 60;
                const keyAlert = `alerted_${o.current_status}`;

                const prevFlags = prev || {};

                if (elapsedMinutes > LIMITS[o.current_status] && !prevFlags[keyAlert]) {
                    sendNotification(
                        `‚ö†Ô∏è DEMORA CR√çTICA #${o.external_id}`,
                        `${Math.floor(elapsedMinutes)} min en ${o.current_status.toUpperCase()}`,
                        'alert'
                    );
                    if (!ordersMemory[o.id]) ordersMemory[o.id] = {};
                    ordersMemory[o.id][keyAlert] = true;
                }
            }

            const existing = ordersMemory[o.id] || {};
            ordersMemory[o.id] = { ...existing, status: o.current_status, time: new Date() };
        });
        isFirstLoad = false;
    }

    // Inicializar al cargar
    initVigilante();

    // =========================================================
    // üß† ASISTENTE OPERATIVO ATC (PROTOCOLO INTELIGENTE)
    // =========================================================

    const ATC_PROTOCOLS = {
        'created': {
            color: 'dark',
            title: 'Pedido Reci√©n Creado',
            checklist: [
                "Verificar si el pedido cay√≥ en el sistema Legacy",
                "Verificar si el pago se proces√≥ correctamente"
            ],
            causes: [
                "Retraso en integraci√≥n",
                "Cliente abandon√≥ pasarela",
                "Error de sistema"
            ]
        },
        'pending': {
            color: 'secondary',
            title: 'Pago Pendiente / Pasarela',
            checklist: [
                "Llamar al cliente: ¬øHubo error en el pago?",
                "Verificar Pasarela: ¬øReporta transacci√≥n fallida?",
                "Verificar si el cliente duplic√≥ el pedido por error"
            ],
            causes: [
                "Cliente no complet√≥ el pago",
                "Tarjeta rechazada / Saldo insuficiente",
                "Falla T√©cnica Pasarela",
                "Cliente duplic√≥ pedido (Anular)",
                "Cliente arrepentido"
            ]
        },
        'processing': { // Facturando
            color: 'warning',
            title: 'Farmacia / Facturaci√≥n',
            checklist: [
                "Llamar a Farmacia: ¬øPor qu√© no facturan?",
                "Verificar inventario: ¬øFalta alg√∫n producto?",
                "Si falta stock: Ofrecer reemplazo o devoluci√≥n parcial",
                "Si no contestan: Escalar a Supervisor de Tienda"
            ],
            causes: [
                "Tienda Full / Personal Ocupado",
                "Falla de Luz / Internet en Tienda",
                "Quiebre de Stock (Producto Faltante)",
                "Tienda no contesta tel√©fono",
                "Problema con impresora fiscal"
            ]
        },
        'confirmed': { // Solicitando
            color: 'primary',
            title: 'Buscando Motorizado',
            checklist: [
                "Verificar entorno (Lluvia / Hora Pico)",
                "Intentar asignar Motoemprendedor (Flota Propia)",
                "Llamar cliente para avisar posible demora"
            ],
            causes: [
                "Alta Demanda / Pocos Motorizados",
                "Lluvia / Mal Clima",
                "Zona Roja / Nadie acepta",
                "Tarifa de env√≠o muy baja"
            ]
        },
        'driver_assigned': { // Asignado
            color: 'dark',
            title: 'Motorizado Asignado',
            checklist: [
                "Llamar Motorizado: ¬øPor qu√© no llega a tienda?",
                "Verificar si se mueve en el mapa (si aplica)",
                "Si no responde > 15min: Liberar y Reasignar"
            ],
            causes: [
                "Motorizado con caucho espichado / Aver√≠a",
                "Motorizado rechaz√≥ despu√©s de aceptar",
                "Tr√°fico pesado hacia tienda",
                "Motorizado no contesta"
            ]
        },
        'on_the_way': { // En Camino
            color: 'info',
            title: 'Ruta al Cliente',
            checklist: [
                "Llamar Motorizado: ¬øUbicaci√≥n actual?",
                "Verificar direcci√≥n de entrega con cliente",
                "Pedir paciencia al cliente"
            ],
            causes: [
                "Direcci√≥n dif√≠cil / Ubicaci√≥n err√≥nea",
                "Cliente no contesta al llegar",
                "Motorizado perdido",
                "Retenci√≥n policial / Alcabala",
                "Accidente leve / Aver√≠a en ruta"
            ]
        },
        'delivered': { // Post-Mortem Entregado
            color: 'success',
            title: 'Auditor√≠a Post-Mortem',
            checklist: [
                "Revisar Gr√°fica de Cronolog√≠a (¬øD√≥nde se tard√≥?)",
                "Verificar si el cliente report√≥ quejas",
                "Contactar al responsable del retraso para feedback"
            ],
            causes: [
                "Retraso Administrativo (Farmacia)",
                "Retraso Log√≠stico (Motorizado)",
                "Incidente T√©cnico",
                "Cliente demor√≥ en recibir",
                "Fuerza Mayor (Lluvia/Tranca)"
            ]
        },
        'canceled': { // Post-Mortem Cancelado
            color: 'danger',
            title: 'An√°lisis de Cancelaci√≥n',
            checklist: [
                "Verificar motivo autom√°tico de cancelaci√≥n",
                "Confirmar si se notific√≥ al cliente",
                "Validar si se requiere nota de cr√©dito"
            ],
            causes: [
                "Cliente solicit√≥ cancelar",
                "Quiebre de Stock (Tienda)",
                "Pago no verificado / Fraude",
                "Zona fuera de cobertura",
                "Duplicidad de pedido"
            ]
        }
    };

    // Mapa de nombres legibles para el selector
    const PHASE_NAMES = {
        'pending': '1. Pago / Pasarela',
        'processing': '2. Facturaci√≥n (Farmacia)',
        'confirmed': '3. B√∫squeda de Motorizado',
        'driver_assigned': '4. Asignaci√≥n / Recogida',
        'on_the_way': '5. Traslado (En Camino)',
        'delivered': '6. Cierre / Entrega',
        'canceled': 'X. Cancelaci√≥n'
    };

    // --- ABRIR ASISTENTE (V2 - MULTI FASE) ---
    window.openAssistant = async function (dbId, externalId, currentStatus, customerName, startTimeStr, finalDurationText) {
        const modal = new bootstrap.Modal(document.getElementById('modalAssistant'));

        // 1. Datos B√°sicos
        document.getElementById('auditDbId').value = dbId;
        document.getElementById('assistOrderId').textContent = `#${externalId}`;
        document.getElementById('assistCustomer').textContent = customerName;

        // 2. L√≥gica de Tiempo (Inteligente)
        const timeBadge = document.getElementById('assistTime');

        // Limpiar clases previas
        timeBadge.classList.remove('text-danger', 'text-success', 'text-dark', 'bg-light');

        if (currentStatus === 'delivered' || currentStatus === 'canceled') {
            // CASO CERRADO: Mostramos el tiempo total est√°tico
            // Si viene vac√≠o por alguna raz√≥n, ponemos "--"
            const text = finalDurationText || "--";
            timeBadge.textContent = `Tiempo Total: ${text}`;

            // Estilo Verde para entregado, Gris/Oscuro para cancelado
            if (currentStatus === 'delivered') {
                timeBadge.classList.add('text-success', 'border-success', 'bg-soft-success');
            } else {
                timeBadge.classList.add('text-dark', 'bg-light');
            }

        } else {
            // CASO VIVO: Calculamos minutos transcurridos en fase actual
            let timeText = "-- min";
            if (startTimeStr) {
                let start = startTimeStr;
                if (!start.endsWith('Z')) start += 'Z';
                const mins = Math.floor((new Date() - new Date(start)) / 1000 / 60);
                timeText = `${mins} min en fase`;
            }
            timeBadge.textContent = timeText;
            timeBadge.classList.add('text-danger', 'bg-light'); // Rojo para indicar urgencia
        }

        // 3. LLENAR SELECTOR (L√≥gica Blindada)
        const selector = document.getElementById('auditPhaseSelector');
        selector.innerHTML = '';

        let statusExists = false;

        // Llenamos las opciones
        Object.keys(ATC_PROTOCOLS).forEach(key => {
            const opt = document.createElement('option');
            opt.value = key;
            opt.textContent = PHASE_NAMES[key] || key.toUpperCase();
            selector.appendChild(opt);

            if (key === currentStatus) statusExists = true;
        });

        // 4. SELECCI√ìN EXPL√çCITA Y RENDERIZADO
        // Forzamos el valor manualmente para asegurar que el DOM lo tenga antes de renderizar
        if (statusExists) {
            selector.value = currentStatus;
        } else {
            // Si el estado actual (ej: "draft") no tiene protocolo, ponemos el primero por defecto
            selector.selectedIndex = 0;
            console.warn(`El estado '${currentStatus}' no tiene protocolo definido. Usando default.`);
        }

        // LLAMADA CR√çTICA: Ahora que el selector tiene valor, pintamos el checklist
        renderProtocolUI();

        // 5. Cargar Historial
        loadAuditHistory(dbId);

        modal.show();
    };

    // --- FUNCI√ìN RENDERIZADORA DE UI (V2) ---
    window.renderProtocolUI = function () {
        // 1. Obtener elementos
        const selector = document.getElementById('auditPhaseSelector');
        const checklistContainer = document.getElementById('assistChecklist');
        const causeSelect = document.getElementById('assistRootCause');

        // Debug de Elementos
        if (!selector) return console.error("‚ùå Falta ID: auditPhaseSelector");
        if (!checklistContainer) return console.error("‚ùå Falta ID: assistChecklist");

        const stage = selector.value;
        const protocol = ATC_PROTOCOLS[stage];

        console.log(`üé® Renderizando fase: ${stage}`);

        // 2. Validar Protocolo
        if (!protocol) {
            console.warn(`‚ö†Ô∏è No existe protocolo para: ${stage}`);
            checklistContainer.innerHTML = '<div class="text-muted small">No hay protocolo definido.</div>';
            return;
        }

        // 3. Aplicar Color Header
        const header = document.getElementById('assistHeader');
        if (header) header.className = `modal-header text-white bg-${protocol.color}`;

        // 4. Renderizar Checklist
        console.log(`üìù Preguntas encontradas: ${protocol.checklist?.length || 0}`);

        if (protocol.checklist && protocol.checklist.length > 0) {
            const htmlChecks = protocol.checklist.map((item, idx) => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="checkAction${idx}" value="${item}">
                    <label class="form-check-label text-dark" for="checkAction${idx}" style="font-size: 0.9rem; cursor:pointer">
                        ${item}
                    </label>
                </div>
            `).join('');
            checklistContainer.innerHTML = htmlChecks;
        } else {
            checklistContainer.innerHTML = '<div class="text-muted small fst-italic">Sin pasos obligatorios.</div>';
        }

        // 5. Renderizar Causas
        if (causeSelect) {
            causeSelect.innerHTML = `<option value="" selected disabled>Seleccione causa...</option>` +
                (protocol.causes || []).map(c => `<option value="${c}">${c}</option>`).join('');
        }
    };

    // --- CARGAR HISTORIAL (ESTILO L√çNEA DE TIEMPO) ---
    async function loadAuditHistory(orderId) {
        const list = document.getElementById('assistHistoryList');
        // Icono de carga
        list.innerHTML = `
            <div class="text-center py-3 text-muted">
                <i class="fa-solid fa-circle-notch fa-spin me-2"></i>Consultando bit√°cora...
            </div>`;

        // Mapeo de colores para las fases en el historial
        const stageColors = {
            'pending': 'secondary', 'created': 'dark',
            'processing': 'warning', 'confirmed': 'primary',
            'driver_assigned': 'dark', 'on_the_way': 'info',
            'delivered': 'success', 'canceled': 'danger'
        };

        const stageNames = {
            'pending': 'Pendiente', 'processing': 'Facturaci√≥n',
            'confirmed': 'Buscando Moto', 'driver_assigned': 'Asignado',
            'on_the_way': 'En Camino', 'delivered': 'Entregado',
            'canceled': 'Cancelado'
        };

        try {
            const res = await authFetch(`/api/audit/history/${orderId}`);
            if (res && res.ok) {
                const logs = await res.json();

                if (logs.length === 0) {
                    list.innerHTML = `
                        <div class="text-center py-4 text-muted bg-white rounded border border-dashed">
                            <i class="fa-regular fa-clipboard me-2"></i>No hay reportes previos.
                            <div class="small">S√© el primero en reportar una incidencia.</div>
                        </div>`;
                    return;
                }

                // Renderizar Tarjetas de Historial
                list.innerHTML = logs.map(log => {
                    const color = stageColors[log.stage] || 'secondary';
                    const faseName = stageNames[log.stage] || log.stage;
                    const dateObj = new Date(log.date);
                    const dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    return `
                    <div class="card mb-2 border-0 shadow-sm">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <div>
                                    <span class="badge bg-${color} text-uppercase" style="font-size:0.65rem">${faseName}</span>
                                    <strong class="small text-dark ms-1"><i class="fa-solid fa-user-tag me-1"></i>${log.user}</strong>
                                </div>
                                <small class="text-muted" style="font-size:0.7rem">${dateStr}</small>
                            </div>
                            
                            <div class="bg-light p-2 rounded mb-1 border-start border-3 border-${color}">
                                <div class="d-flex align-items-center text-danger small fw-bold mb-1">
                                    <i class="fa-solid fa-triangle-exclamation me-2"></i>${log.cause}
                                </div>
                                <div class="text-dark small mb-1">
                                    <i class="fa-solid fa-check-double text-success me-1"></i>${log.action}
                                </div>
                                ${log.notes ? `<div class="text-muted small fst-italic mt-1 border-top pt-1"><i class="fa-regular fa-comment me-1"></i>"${log.notes}"</div>` : ''}
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');

                // Auto-expandir el acorde√≥n si hay historial para que sea visible
                const collapseElement = document.getElementById('collapseHistory');
                if (collapseElement && !collapseElement.classList.contains('show')) {
                    new bootstrap.Collapse(collapseElement).show();
                }

            } else {
                list.innerHTML = '<div class="alert alert-danger small">Error cargando datos.</div>';
            }
        } catch (e) {
            console.error(e);
            list.innerHTML = '<div class="alert alert-danger small">Error de conexi√≥n.</div>';
        }
    }

    // --- GUARDAR GESTI√ìN (V2) ---
    window.saveAuditLog = async function () {
        const orderId = document.getElementById('auditDbId').value;
        const stage = document.getElementById('auditPhaseSelector').value;
        const cause = document.getElementById('assistRootCause').value;
        const notes = document.getElementById('assistNotes').value;

        // 1. Contar casillas marcadas
        const checkedBoxes = document.querySelectorAll('#assistChecklist input:checked');
        const actions = Array.from(checkedBoxes).map(cb => cb.value);

        // 2. Contar casillas TOTALES visibles
        const totalBoxesInScreen = document.querySelectorAll('#assistChecklist input').length;

        // --- VALIDACI√ìN: Solo exige marcar si hay opciones para marcar ---
        if (totalBoxesInScreen > 0 && actions.length === 0) {
            return alert("‚ö†Ô∏è Protocolo incompleto: Por favor marque las acciones realizadas en el checklist.");
        }

        if (!cause) return alert("‚ö†Ô∏è Campo obligatorio: Debe seleccionar la Causa Ra√≠z del problema.");

        const payload = {
            order_id: parseInt(orderId),
            stage: stage,
            action_taken: actions.length > 0 ? actions.join(" | ") : "Gesti√≥n Directa (Sin checklist)",
            root_cause: cause,
            notes: notes
        };

        try {
            const btnSave = document.querySelector('#modalAssistant .btn-primary');
            const originalText = btnSave.innerHTML;
            btnSave.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Guardando...';
            btnSave.disabled = true;

            const res = await authFetch('/api/audit/log', {
                method: 'POST',
                body: JSON.stringify(payload)
            });

            if (res && res.ok) {
                alert("‚úÖ Gesti√≥n registrada con √©xito.");

                // Limpieza parcial para permitir otra entrada
                document.getElementById('assistNotes').value = "";
                document.getElementById('assistRootCause').value = "";
                document.querySelectorAll('#assistChecklist input').forEach(cb => cb.checked = false);

                // Recargar historial
                loadAuditHistory(orderId);
            } else {
                alert("Error al guardar en el servidor.");
            }

            // Restaurar bot√≥n
            btnSave.innerHTML = originalText;
            btnSave.disabled = false;

        } catch (e) {
            console.error(e);
            alert("Error de conexi√≥n.");
        }
    };
    const faviconImg = new Image();
    // Agregamos ?v=1 para que el navegador ignore la cach√© anterior
    faviconImg.src = '/static/img/icono.png?v=' + Date.now();

    // Log de seguridad para que veas en la consola si carg√≥ bien
    faviconImg.onload = () => console.log("üñºÔ∏è Icono cargado para el Favicon Din√°mico");
    faviconImg.onerror = () => console.error("‚ùå No se pudo cargar /static/img/icono.png");

    function updateDynamicFavicon(count) {
        const link = document.getElementById('dynamic-favicon');
        if (!link || !faviconImg.complete) return;

        // 1. Aumentamos a 64x64 para mayor nitidez
        const canvas = document.createElement('canvas');
        canvas.width = 64;
        canvas.height = 64;
        const ctx = canvas.getContext('2d');

        // 2. Dibujar el icono ocupando TODO el espacio (Zoom 100%)
        // Si tu icono tiene bordes transparentes, esto lo estira al m√°ximo
        ctx.drawImage(faviconImg, 0, 0, 64, 64);

        // 3. Si hay pedidos vivos, dibujar burbuja
        if (count > 0) {
            const text = count > 9 ? '9+' : count.toString();

            // Coordenadas para la esquina inferior derecha
            const circleX = 46;
            const circleY = 46;
            const radius = 16; // Tama√±o proporcional

            // C√≠rculo Rojo Intenso
            ctx.beginPath();
            ctx.arc(circleX, circleY, radius, 0, 2 * Math.PI);
            ctx.fillStyle = '#ff0000';
            ctx.fill();

            // Borde Blanco grueso para que resalte (Efecto WhatsApp)
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#ffffff';
            ctx.stroke();

            // Texto m√°s grande y centrado
            ctx.font = 'bold 22px Arial'; // Letra bien grande
            ctx.fillStyle = '#ffffff';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, circleX, circleY + 2);
        }

        // 4. Actualizar link
        link.href = canvas.toDataURL('image/png');
    }

    // =========================================================
    // ‚è∞ GESTOR DE HORARIOS
    // =========================================================
    const daysMap = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"];

    // 1. Cargar Tiendas en el Select
    async function loadStoresForSchedule() {
        const selWeekly = document.getElementById('schedStore');
        const selHoli = document.getElementById('holiStore'); // El nuevo select

        const res = await authFetch('/api/data/stores-locations');
        if (res && res.ok) {
            const stores = await res.json();
            const optionsHtml = stores.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

            if (selWeekly) selWeekly.innerHTML = optionsHtml;
            if (selHoli) selHoli.innerHTML = '<option value="all">üåç Todas las Tiendas</option>' + optionsHtml;
        }
    }


    // 2. Cargar Reglas Existentes
    async function loadSchedules() {
        const tbody = document.getElementById('schedulesTableBody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Cargando...</td></tr>';

        const res = await authFetch('/api/schedules/');
        if (res && res.ok) {
            const rules = await res.json();
            if (rules.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Sin reglas configuradas.</td></tr>';
                return;
            }

            tbody.innerHTML = rules.map(r => `
                <tr>
                    <td class="fw-bold small">${r.store_name}</td>
                    <td><span class="badge bg-light text-dark border">${daysMap[r.day_of_week]}</span></td>
                    <td>${r.open_time} - ${r.close_time}</td>
                    <td class="text-danger small">-${r.buffer_minutes} min</td>
                    <td class="text-end">
                        <button class="btn btn-link text-danger p-0" onclick="deleteSchedule(${r.id})">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
    }

    // 3. Guardar Regla
    document.getElementById('formSchedule')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
            store_id: document.getElementById('schedStore').value,
            day_of_week: document.getElementById('schedDay').value,
            open_time: document.getElementById('schedOpen').value,
            close_time: document.getElementById('schedClose').value,
            buffer_minutes: 60 // Fijo por ahora
        };

        const res = await authFetch('/api/schedules/', {
            method: 'POST',
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            loadSchedules(); // Recargar tabla
            alert("‚úÖ Regla guardada.");
        } else {
            alert("Error al guardar.");
        }
    });

    // 4. Borrar
    window.deleteSchedule = async (id) => {
        if (!confirm("¬øEliminar esta regla?")) return;
        await authFetch(`/api/schedules/${id}`, { method: 'DELETE' });
        loadSchedules();
    };
    // --- GESTI√ìN DE FERIADOS (NUEVO) ---

    // 1. Cargar Lista de Feriados
    async function loadHolidays() {
        const container = document.getElementById('holidaysList');
        if (!container) return;

        const res = await authFetch('/api/holidays/');
        if (res && res.ok) {
            const data = await res.json(); // Ahora recibimos una lista de dicts planos

            if (data.length === 0) {
                container.innerHTML = '<div class="text-center py-3 text-muted fst-italic">No hay feriados programados.</div>';
                return;
            }

            container.innerHTML = data.map(h => `
                <div class="d-flex justify-content-between align-items-center bg-soft-danger p-2 mb-2 rounded border border-danger border-opacity-10">
                    <div>
                        <span class="badge bg-danger me-2" style="font-size:0.65rem">${h.store_name}</span>
                        <strong class="text-dark">${new Date(h.date).toLocaleDateString('es-ES', { timeZone: 'UTC', day: '2-digit', month: 'long' })}</strong>
                        <span class="text-muted ms-2">‚Äî ${h.description}</span>
                    </div>
                    <button class="btn btn-sm btn-link text-danger" onclick="deleteHoliday(${h.id})">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            `).join('');
        }
    }

    // 2. Modificar el guardado del feriado
    document.getElementById('formHoliday')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const storeVal = document.getElementById('holiStore').value;
        const payload = {
            date: document.getElementById('holiDate').value,
            description: document.getElementById('holiDesc').value,
            store_id: storeVal === 'all' ? null : parseInt(storeVal) // Enviamos null si es global
        };

        const res = await authFetch('/api/holidays/', {
            method: 'POST',
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            loadHolidays();
            alert("‚úÖ Excepci√≥n de cierre guardada.");
        }
    });

    // 3. Borrar Feriado
    window.deleteHoliday = async (id) => {
        if (!confirm("¬øEliminar este feriado? Las tiendas volver√°n a su horario normal ese d√≠a.")) return;
        const res = await authFetch(`/api/holidays/${id}`, { method: 'DELETE' });
        if (res.ok) loadHolidays();
    };

    // Evento al abrir el modal para cargar datos frescos
    document.getElementById('modalSchedules')?.addEventListener('show.bs.modal', () => {
        loadStoresForSchedule();
        loadSchedules();
        loadHolidays();
    });


}); // <--- FINAL DEL ARCHIVO (ASEG√öRATE DE QUE EST√â)


==================================================
ARCHIVO: ./app/templates/index.html
==================================================

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoAnalisis Pro</title>
    <!-- FAVICON DIN√ÅMICO -->
    <link rel="icon" type="image/png" href="/static/img/icono.png?v=1" id="dynamic-favicon">
    <!-- Bootstrap 5 y Estilos -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/light.css">

    <!-- LEAFLET MAPS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <!-- CSS Personalizado -->
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Segoe UI', sans-serif;
            color: #374151;
        }

        .card {
            border: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .navbar {
            background-color: #ffffff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .text-soft-primary {
            color: #3b82f6;
        }

        .bg-soft-primary {
            background-color: #eff6ff;
        }

        .text-soft-success {
            color: #10b981;
        }

        .bg-soft-success {
            background-color: #ecfdf5;
        }

        .text-soft-warning {
            color: #f59e0b;
        }

        .bg-soft-warning {
            background-color: #fffbeb;
        }

        .text-soft-danger {
            color: #ef4444;
        }

        .bg-soft-danger {
            background-color: #fef2f2;
        }

        .kpi-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #6b7280;
            letter-spacing: 0.5px;
        }

        .kpi-val {
            font-size: 1.75rem;
            font-weight: 600;
            line-height: 1.2;
        }

        /* Animaci√≥n de Pedido Vivo (Latido Suave) */
        @keyframes row-pulse {
            0% {
                box-shadow: inset 4px 0 0 0 transparent;
                background-color: rgba(255, 255, 255, 0);
            }

            50% {
                box-shadow: inset 4px 0 0 0 #0dcaf0;
                background-color: rgba(13, 202, 240, 0.05);
            }

            /* Azul Cyan Suave */
            100% {
                box-shadow: inset 4px 0 0 0 transparent;
                background-color: rgba(255, 255, 255, 0);
            }
        }

        .live-row {
            animation: row-pulse 2.5s infinite ease-in-out;
            font-weight: 500;
            /* Un poquito m√°s de peso a la letra */
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg sticky-top mb-4 py-3">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="/static/img/logo.png" alt="Logo" class="navbar-logo me-2" style="height: 32px;">
                <span class="fw-bold">GoAnalisis</span>
                <span class="badge bg-primary-subtle text-primary ms-2 rounded-pill"
                    style="font-size: 0.6rem;">V5.1</span>
            </a>
            <div class="d-flex align-items-center">
                <!-- BOT√ìN CONFIGURAR HORARIOS -->
                <button class="btn btn-sm btn-outline-dark rounded-circle me-3 admin-only" data-bs-toggle="modal"
                    data-bs-target="#modalSchedules" title="Configurar Horarios Farmacias">
                    <i class="fa-solid fa-clock"></i>
                </button>
                <!-- BOT√ìN NUEVO: NOTIFICACIONES -->
                <button id="btn-notifications"
                    class="btn btn-sm btn-outline-secondary rounded-circle me-3 position-relative"
                    title="Activar Alertas Operativas">
                    <i class="fa-regular fa-bell"></i>
                    <span
                        class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle d-none"
                        id="notif-badge">
                        <span class="visually-hidden">Alertas activas</span>
                    </span>
                </button>
                <a href="#" id="btn-open-report" class="btn btn-sm btn-light text-muted border-0 me-3 admin-only">
                    <i class="fa-solid fa-file-invoice me-2"></i>Reporte
                </a>
                <button id="btn-logout" class="btn btn-sm btn-outline-secondary rounded-pill px-3">
                    <i class="fa-solid fa-power-off me-2"></i>Salir
                </button>
            </div>
        </div>
    </nav>

    <main class="container-fluid px-4">
        <!-- BARRA DE HERRAMIENTAS -->
        <div class="card mb-4">
            <div class="card-body p-3">
                <div class="row align-items-end g-3">
                    <div class="col-md-4">
                        <label class="form-label text-muted small fw-bold mb-1">Rango de Fechas</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i
                                    class="fa-regular fa-calendar text-muted"></i></span>
                            <input type="text" class="form-control border-start-0 ps-0" id="date-range-picker"
                                placeholder="Hoy">
                            <!-- BOT√ìN NUEVO: HOY -->
                            <button class="btn btn-light border fw-bold text-primary" type="button" id="btn-today"
                                title="Ir a Hoy">Hoy</button>
                            <button class="btn btn-light border" type="button" id="btn-all-history"
                                title="Ver Hist√≥rico">‚àû</button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted small fw-bold mb-1">Tienda</label>
                        <select class="form-select" id="store-filter">
                            <option value="">Cargando...</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted small fw-bold mb-1">B√∫squeda</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="search-input" placeholder="#ID o Cliente...">
                            <button class="btn btn-light border" id="btn-clear-search">√ó</button>
                        </div>
                    </div>
                    <div class="col-md-2"><button class="btn btn-primary w-100 fw-bold" id="btn-update">Filtrar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 1. RESUMEN FINANCIERO -->
        <div class="row g-3 mb-4 admin-only">
            <div class="col-12 col-md-6 col-xl">
                <div class="card h-100 border-start border-4 border-secondary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="kpi-label">Volumen (GMV)</div>
                                <div class="kpi-val text-dark" id="kpi-total-revenue">--</div>
                            </div>
                            <div class="bg-light rounded-circle p-2 text-secondary"><i
                                    class="fa-solid fa-sack-dollar fa-lg"></i></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-xl">
                <div class="card h-100 border-start border-4 border-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="kpi-label text-primary">Valor Env√≠os</div>
                                <div class="kpi-val text-primary" id="kpi-total-fees">--</div>
                            </div>
                            <div class="bg-soft-primary rounded-circle p-2 text-primary"><i
                                    class="fa-solid fa-motorcycle fa-lg"></i></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-xl">
                <div class="card h-100 border-start border-4 border-danger">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="kpi-label text-danger">Cupones (Inv.)</div>
                                <div class="kpi-val text-danger" id="kpi-total-coupons">--</div>
                            </div>
                            <div class="bg-soft-danger rounded-circle p-2 text-danger"><i
                                    class="fa-solid fa-tags fa-lg"></i></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-xl">
                <div class="card h-100 border-start border-4 border-warning">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="kpi-label text-warning">N√≥mina Moto</div>
                                <div class="kpi-val text-warning" id="kpi-driver-payout">--</div>
                            </div>
                            <div class="bg-soft-warning rounded-circle p-2 text-warning"><i
                                    class="fa-solid fa-helmet-safety fa-lg"></i></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-xl">
                <div class="card h-100 border-start border-4 border-success bg-soft-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="kpi-label text-success">Ganancia Neta</div>
                                <div class="kpi-val text-success fw-bold" id="kpi-company-profit">--</div>
                            </div>
                            <div class="bg-white rounded-circle p-2 text-success shadow-sm"><i
                                    class="fa-solid fa-chart-line fa-lg"></i></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. OPERATIVO -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-2 col-xl">
                <div class="card h-100 p-2 text-center"><small class="text-muted fw-bold">TOTAL</small>
                    <div class="h5 mb-0 fw-bold" id="kpi-total-orders">--</div>
                </div>
            </div>
            <div class="col-6 col-md-2 col-xl">
                <div class="card h-100 p-2 text-center border-bottom border-3 border-info"><small
                        class="text-info fw-bold">DELIVERY</small>
                    <div class="h5 mb-0 fw-bold text-dark" id="kpi-deliveries">--</div>
                </div>
            </div>
            <div class="col-6 col-md-2 col-xl">
                <div class="card h-100 p-2 text-center border-bottom border-3 border-warning"><small
                        class="text-warning fw-bold">PICKUP</small>
                    <div class="h5 mb-0 fw-bold text-dark" id="kpi-pickups">--</div>
                </div>
            </div>
            <div class="col-6 col-md-2 col-xl">
                <div class="card h-100 p-2 text-center border-bottom border-3 border-danger"><small
                        class="text-danger fw-bold">CANCELADOS</small>
                    <div class="h5 mb-0 fw-bold text-dark" id="kpi-canceled">--</div>
                </div>
            </div>
            <div class="col-6 col-md-2 col-xl">
                <div class="card h-100 p-2 text-center"><small class="text-muted fw-bold">TIEMPO PROM.</small>
                    <div class="h5 mb-0 fw-bold text-dark" id="kpi-avg-time">--</div>
                </div>
            </div>
            <div class="col-6 col-md-2 col-xl">
                <div class="card h-100 p-2 text-center border-bottom border-3 border-primary"><small
                        class="text-primary fw-bold">NUEVOS USUARIOS</small>
                    <div class="h5 mb-0 fw-bold text-dark" id="kpi-new-users">--</div>
                </div>
            </div>
        </div>

        <!-- TABLA PEDIDOS EN VIVO -->
        <div class="card mb-4 overflow-hidden">
            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center py-3 cursor-pointer"
                data-bs-toggle="collapse" data-bs-target="#collapseOrders">
                <span class="fw-bold"><i class="fa-solid fa-list-check me-2 text-primary"></i> √öltimos Pedidos <small
                        class="text-muted ms-2 fw-normal" id="last-updated">--:--</small></span>
                <div class="d-flex align-items-center">
                    <span class="badge bg-danger bg-opacity-75 animate-pulse me-3">EN VIVO</span>
                    <i class="fa-solid fa-chevron-down text-muted collapse-icon"></i>
                </div>
            </div>
            <div id="collapseOrders" class="collapse show">
                <div class="table-responsive">
                    <!-- TABLA REINGENIERIZADA (5 COLUMNAS) -->
                    <table class="table table-hover align-middle mb-0" style="font-size: 0.9rem;">
                        <thead class="bg-light text-muted small text-uppercase">
                            <tr>
                                <th class="ps-4 py-3" style="width: 15%">Identificaci√≥n</th> <!-- ID + Tienda -->
                                <th style="width: 25%">Cliente</th> <!-- Nombre + Lealtad + Tlf -->
                                <th style="width: 25%">Log√≠stica</th> <!-- Tipo + Motorizado -->
                                <th style="width: 20%">Estado / Tiempo</th> <!-- Status + Cron√≥metro/Final -->
                                <th class="text-end pe-4" style="width: 15%">Total</th> <!-- Dinero -->
                            </tr>
                        </thead>
                        <tbody id="recent-orders-table-body" class="border-top-0"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- MAPA Y TENDENCIAS -->
        <div class="row g-4 mb-4 admin-only">
            <div class="col-lg-8">
                <div class="card h-100">
                    <div class="card-header bg-white border-0 py-3 cursor-pointer" data-bs-toggle="collapse"
                        data-bs-target="#collapseMap">
                        <span class="fw-bold"><i class="fa-solid fa-map-location-dot me-2 text-danger"></i> Mapa de
                            Oportunidades</span>
                    </div>
                    <div id="collapseMap" class="collapse">
                        <div class="card-body p-0">
                            <div id="heatmapContainer" style="height: 400px; width: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-header bg-white border-0 py-3"><span class="fw-bold"><i
                                class="fa-solid fa-chart-column me-2 text-primary"></i> Tendencias</span></div>
                    <div class="card-body">
                        <div style="height: 350px;"><canvas id="trendsChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AN√ÅLISIS OPERATIVO (4 COLUMNAS) -->
        <div class="row g-3 mb-4 admin-only">

            <!-- 1. TIPO DE ORDEN (Dona) -->
            <div class="col-12 col-sm-6 col-lg-2">
                <div class="card h-100">
                    <div class="card-header bg-white border-0 py-2">
                        <span class="fw-bold small text-muted">TIPO ORDEN</span>
                    </div>
                    <div class="card-body p-2 d-flex align-items-center justify-content-center">
                        <!-- ALTURA DEFINIDA CR√çTICA PARA CHART.JS -->
                        <div style="height: 150px; width: 100%; position: relative;">
                            <canvas id="orderTypeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. MOTIVOS CANCELACI√ìN (Pie) -->
            <div class="col-12 col-sm-6 col-lg-4">
                <div class="card h-100">
                    <div class="card-header bg-white border-0 py-2">
                        <span class="fw-bold small text-danger"><i class="fa-solid fa-ban me-1"></i> MOTIVOS</span>
                    </div>
                    <div class="card-body p-2">
                        <div style="height: 150px; width: 100%;">
                            <canvas id="cancellationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. TIEMPOS DELIVERY (Barra Naranja) -->
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="card h-100">
                    <div class="card-header bg-white border-0 py-2">
                        <span class="fw-bold small text-primary"><i class="fa-solid fa-motorcycle me-1"></i> DELIVERY
                            (Min)</span>
                    </div>
                    <div class="card-body p-2">
                        <div style="height: 150px; width: 100%;">
                            <canvas id="bottleneckChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. TIEMPOS PICKUP (Barra Azul) -->
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="card h-100">
                    <div class="card-header bg-white border-0 py-2">
                        <span class="fw-bold small text-warning"><i class="fa-solid fa-person-walking-luggage me-1"></i>
                            PICKUP (Min)</span>
                    </div>
                    <div class="card-body p-2">
                        <div style="height: 150px; width: 100%;">
                            <canvas id="bottleneckPickupChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DETALLES TIENDAS Y DRIVERS -->
        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-white border-0 py-3"><span class="fw-bold text-success"><i
                                class="fa-solid fa-shop me-2"></i> Top Tiendas</span></div>
                    <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                        <ul class="list-group list-group-flush" id="top-stores-list"></ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-white border-0 py-3"><span class="fw-bold text-warning"><i
                                class="fa-solid fa-motorcycle me-2"></i> Top Repartidores</span></div>
                    <div class="card-body">
                        <div style="height: 250px;"><canvas id="driverLeaderboardChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- [MODIFICADO] PRODUCTOS Y CLIENTES (LADO A LADO) -->
        <div class="row g-4 mb-5">
            <!-- Top Productos -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-white border-0 py-3"><span class="fw-bold text-primary"><i
                                class="fa-solid fa-pills me-2"></i> Top 10 Productos</span></div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light text-muted small">
                                    <tr>
                                        <th class="ps-4">Producto</th>
                                        <th class="text-center">Uds</th>
                                        <th class="text-end pe-4">Ingresos</th>
                                    </tr>
                                </thead>
                                <tbody id="top-products-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- [RESTAURADO] Top Clientes -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-white border-0 py-3"><span class="fw-bold text-info"><i
                                class="fa-solid fa-users me-2"></i> Top Clientes</span></div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" id="topCustomersTable">
                                <thead class="bg-light text-muted small">
                                    <tr>
                                        <th class="ps-4">#</th>
                                        <th>Cliente</th>
                                        <th class="text-center">Ped.</th>
                                        <th class="text-end">Total</th>
                                        <th class="text-end pe-4">Avg</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ========================================== -->
    <!-- MODAL AUDITOR√çA ATC (Estructura Vac√≠a) -->
    <!-- ========================================== -->
    <div class="modal fade" id="modalATC" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg">
                <!-- Header Azul -->
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold">
                        <i class="fa-solid fa-file-invoice me-2"></i>Auditor√≠a de Pedido
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>

                <!-- Cuerpo (Aqu√≠ el JS inyecta la magia) -->
                <div class="modal-body p-4" id="modalATCBody">
                    <!-- Spinner por defecto -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">Iniciando...</p>
                    </div>
                </div>

                <!-- Footer con Acciones -->
                <div class="modal-footer bg-light">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <small class="text-muted fst-italic"><i class="fa-solid fa-robot me-1"></i>Auditado por
                            GoAnalisis Dron</small>
                        <div>
                            <!-- Bot√≥n de respaldo (Excel Lento) -->
                            <button type="button" class="btn btn-outline-secondary btn-sm me-2"
                                id="btn-legacy-download">
                                <i class="fa-solid fa-cloud-arrow-down me-1"></i>Excel Oficial
                            </button>
                            <!-- Bot√≥n Imprimir -->
                            <button type="button" class="btn btn-dark btn-sm fw-bold" onclick="window.print()">
                                <i class="fa-solid fa-print me-1"></i>Imprimir Ficha
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ========================================== -->
    <!-- MODAL GESTI√ìN DE HORARIOS (V3 - FERIADOS)  -->
    <!-- ========================================== -->
    <div class="modal fade" id="modalSchedules" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <!-- Header con contraste corregido -->
                <div class="modal-header bg-dark border-0">
                    <h5 class="modal-title fw-bold text-white">
                        <i class="fa-solid fa-store-slash me-2 text-danger"></i>Control de Horarios
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>

                <div class="modal-body p-0">
                    <!-- Navegaci√≥n de Pesta√±as -->
                    <ul class="nav nav-tabs bg-light px-3 pt-2" id="schedTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active fw-bold small text-uppercase" data-bs-toggle="tab"
                                data-bs-target="#tab-weekly">
                                <i class="fa-solid fa-calendar-days me-1"></i>Horario Semanal
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link fw-bold small text-uppercase" data-bs-toggle="tab"
                                data-bs-target="#tab-holidays">
                                <i class="fa-solid fa-calendar-check me-1"></i>D√≠as Feriados
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content p-4">
                        <!-- PESTA√ëA 1: HORARIO SEMANAL -->
                        <div class="tab-pane fade show active" id="tab-weekly">
                            <!-- Formulario Nueva Regla -->
                            <div class="card bg-light border-0 mb-4">
                                <div class="card-body p-3">
                                    <h6 class="fw-bold text-secondary small mb-3 text-uppercase">Nueva Regla de Apagado
                                    </h6>
                                    <form id="formSchedule" class="row g-2 align-items-end">
                                        <div class="col-md-4">
                                            <label class="x-small text-muted fw-bold">FARMACIA</label>
                                            <select class="form-select form-select-sm" id="schedStore"
                                                required></select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="x-small text-muted fw-bold">D√çA</label>
                                            <select class="form-select form-select-sm" id="schedDay" required>
                                                <option value="0">Lunes</option>
                                                <option value="1">Martes</option>
                                                <option value="2">Mi√©rcoles</option>
                                                <option value="3">Jueves</option>
                                                <option value="4">Viernes</option>
                                                <option value="5">S√°bado</option>
                                                <option value="6">Domingo</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="x-small text-muted fw-bold">ABRE</label>
                                            <input type="time" class="form-control form-control-sm" id="schedOpen"
                                                value="08:00" required>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="x-small text-muted fw-bold">CIERRA</label>
                                            <input type="time" class="form-control form-control-sm" id="schedClose"
                                                value="20:00" required>
                                        </div>
                                        <div class="col-md-2">
                                            <button type="submit" class="btn btn-primary btn-sm w-100 fw-bold">
                                                <i class="fa-solid fa-plus"></i> Guardar
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Tabla Reglas Semanales -->
                            <h6 class="fw-bold text-dark small text-uppercase mb-2">Reglas Semanales Activas</h6>
                            <div class="table-responsive border rounded" style="max-height: 250px;">
                                <table class="table table-sm table-hover mb-0 align-middle">
                                    <thead class="bg-white sticky-top small text-muted">
                                        <tr>
                                            <th>Farmacia</th>
                                            <th>D√≠a</th>
                                            <th>Horario</th>
                                            <th>Acci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody id="schedulesTableBody" class="small">
                                        <!-- Se llena con JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- PESTA√ëA 2: D√çAS FERIADOS -->
                        <div class="tab-pane fade" id="tab-holidays">
                            <div class="card border-danger border-opacity-25 mb-4">
                                <div class="card-body p-3">
                                    <h6 class="fw-bold text-danger small mb-3 text-uppercase">Programar Cierre por
                                        Feriado</h6>
                                    <form id="formHoliday"
                                        class="row g-2 align-items-end mb-4 bg-light p-3 rounded border-danger border-start border-4">
                                        <div class="col-md-3">
                                            <label class="x-small text-muted fw-bold">FARMACIA</label>
                                            <select class="form-select form-select-sm" id="holiStore">
                                                <option value="all">üåç Todas las Tiendas</option>
                                                <!-- Se llena con JS igual que el otro select -->
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="x-small text-muted fw-bold">FECHA</label>
                                            <input type="date" class="form-control form-control-sm" id="holiDate"
                                                required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="x-small text-muted fw-bold">DESCRIPCI√ìN / MOTIVO</label>
                                            <input type="text" class="form-control form-control-sm" id="holiDesc"
                                                placeholder="Ej: San Valent√≠n / Inventario">
                                        </div>
                                        <div class="col-md-2">
                                            <button type="submit" class="btn btn-danger btn-sm w-100 fw-bold">
                                                <i class="fa-solid fa-calendar-xmark"></i> Cerrar
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <h6 class="fw-bold text-dark small text-uppercase mb-2">Feriados Programados</h6>
                            <div id="holidaysList" class="small">
                                <!-- Se llena con JS -->
                                <div class="text-center py-3 text-muted fst-italic">No hay feriados programados.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer bg-light py-2">
                    <small class="text-muted x-small">
                        <i class="fa-solid fa-circle-info me-1"></i>
                        El sistema apagar√° la app <strong>60 min antes</strong> del cierre programado.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- TABLA DE REGLAS ACTIVAS -->
    <h6 class="fw-bold text-dark">Reglas Activas</h6>
    <div class="table-responsive border rounded" style="max-height: 300px;">
        <table class="table table-sm table-striped table-hover mb-0 align-middle">
            <thead class="bg-white sticky-top">
                <tr>
                    <th>Farmacia</th>
                    <th>D√≠a</th>
                    <th>Horario Real</th>
                    <th>Apagado Auto (Buffer)</th>
                    <th class="text-end">Acci√≥n</th>
                </tr>
            </thead>
            <tbody id="schedulesTableBody">
                <!-- JS -->
            </tbody>
        </table>
    </div>
    </div>
    </div>
    </div>
    </div>

    <!-- ========================================== -->
    <!-- MODAL ASISTENTE OPERATIVO ATC (V2 - FINAL) -->
    <!-- ========================================== -->
    <div class="modal fade" id="modalAssistant" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <!-- Header din√°mico (Cambia de color seg√∫n estado) -->
                <div class="modal-header text-white" id="assistHeader">
                    <h5 class="modal-title fw-bold">
                        <i class="fa-solid fa-user-doctor me-2"></i>Gesti√≥n de Retraso
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>

                <div class="modal-body p-4">
                    <!-- Info del Pedido (Cabecera interna) -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h4 class="mb-0 fw-bold" id="assistOrderId">#--</h4>
                            <small class="text-muted" id="assistCustomer">Cliente...</small>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-light text-dark border px-3 py-2">
                                Tiempo en fase: <span id="assistTime" class="fw-bold text-danger">-- min</span>
                            </div>
                        </div>
                    </div>

                    <!-- FORMULARIO DE GESTI√ìN -->
                    <form id="formAudit">
                        <input type="hidden" id="auditDbId">

                        <!-- 0. SELECTOR DE FASE A AUDITAR (CR√çTICO) -->
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-primary">
                                <i class="fa-solid fa-layer-group me-1"></i>Fase a Auditar
                            </label>
                            <select class="form-select border-primary" id="auditPhaseSelector"
                                onchange="renderProtocolUI()">
                                <!-- Se llena din√°micamente con JS -->
                            </select>
                            <div class="form-text x-small">
                                Si hubo problemas en varias etapas, registre una por una.
                            </div>
                        </div>

                        <!-- 1. Checklist de Acciones -->
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-secondary">1. Protocolo /
                                Verificaci√≥n</label>
                            <div class="card bg-light border-0 p-3">
                                <!-- ESTE ID ES EL QUE BUSCA EL JS PARA INYECTAR LOS CHECKBOXES -->
                                <div id="assistChecklist" class="d-flex flex-column gap-2">
                                    <span class="text-muted small">Cargando protocolo...</span>
                                </div>
                            </div>
                        </div>

                        <!-- 2. Causa Ra√≠z -->
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-secondary">2. Causa del
                                Retraso</label>
                            <select class="form-select" id="assistRootCause">
                                <option value="" selected disabled>Seleccione el motivo...</option>
                                <!-- Se llena din√°micamente -->
                            </select>
                        </div>

                        <!-- 3. Notas -->
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-secondary">3. Notas
                                Adicionales</label>
                            <textarea class="form-control" id="assistNotes" rows="2"
                                placeholder="Detalles extra (opcional)..."></textarea>
                        </div>
                    </form>

                    <!-- HISTORIAL PREVIO (Acorde√≥n) -->
                    <div class="accordion mt-4" id="accordionHistory">
                        <div class="accordion-item border-0">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-white shadow-none text-muted py-2 small"
                                    type="button" data-bs-toggle="collapse" data-bs-target="#collapseHistory">
                                    <i class="fa-solid fa-clock-rotate-left me-2"></i>Ver Gestiones Anteriores
                                </button>
                            </h2>
                            <div id="collapseHistory" class="accordion-collapse collapse">
                                <div class="accordion-body bg-light p-2 small" id="assistHistoryList">
                                    <span class="text-muted fst-italic">Cargando historial...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary fw-bold px-4" onclick="saveAuditLog()">
                        <i class="fa-solid fa-floppy-disk me-2"></i>Registrar Gesti√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Estilo extra para etiquetas peque√±as -->
    <style>
        .x-small {
            font-size: 0.65rem;
        }

        .bg-soft-danger {
            background-color: rgba(220, 53, 69, 0.05);
        }

        .nav-tabs .nav-link {
            color: #6c757d;
            border: none;
        }

        .nav-tabs .nav-link.active {
            color: #0d6efd;
            background: none;
            border-bottom: 3px solid #0d6efd;
        }
    </style>
    <!-- ESTILOS DE IMPRESI√ìN (Para que salga limpia la hoja) -->
    <style>
        /* Estilo para Multi-Carritos */
        .multi-cart-row {
            border-left: 5px solid #6610f2 !important;
            /* Borde grueso morado */
            background-color: rgba(102, 16, 242, 0.03) !important;
            /* Fondo lila muy suave */
        }

        .multi-cart-connector {
            border-top: 1px dashed rgba(102, 16, 242, 0.3) !important;
            /* L√≠nea punteada entre pedidos */
        }

        @media print {
            body * {
                visibility: hidden;
            }

            /* Ocultar todo el sitio */
            #modalATC,
            #modalATC * {
                visibility: visible;
            }

            /* Mostrar solo el modal */
            #modalATC {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                background: white !important;
            }

            .modal-header,
            .modal-footer,
            .btn-close {
                display: none !important;
            }

            /* Ocultar botones al imprimir */
            .modal-body {
                padding: 0 !important;
            }
        }
    </style>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="/static/js/dashboard.js?v=6.1"></script>

    <!-- Script de Utilidad (Copiar al portapapeles en HTTP) -->
    <script>
        function copyToClipboard(elementId) {
            var copyText = document.getElementById(elementId);
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            var success = false;

            // Intento A: Moderno
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(copyText.value).then(() => animateButton(copyText));
                return;
            }
            // Intento B: Cl√°sico (Fallback HTTP)
            try { success = document.execCommand('copy'); } catch (err) { console.error("Error copy:", err); }

            if (success) animateButton(copyText);
            else alert("No se pudo copiar autom√°ticamente. Presiona Ctrl+C.");
        }

        function animateButton(inputElement) {
            const btn = inputElement.nextElementSibling;
            const originalHtml = btn.innerHTML;
            const originalClass = btn.classList.contains('btn-outline-primary') ? 'btn-outline-primary' : 'btn-outline-dark';

            btn.innerHTML = '<i class="fa-solid fa-check"></i> Copiado';
            btn.classList.remove(originalClass);
            btn.classList.add('btn-success', 'text-white');

            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.remove('btn-success', 'text-white');
                btn.classList.add(originalClass);
            }, 2000);
        }
    </script>
</body>

</html>

==================================================
ARCHIVO: ./app/templates/login.html
==================================================

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesi√≥n - GoAnalisis</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { 
            background-color: #f3f4f6; /* Gris suave corporativo */
            color: #1f2937; 
            height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        .login-card {
            background-color: #ffffff;
            width: 100%;
            max-width: 400px;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
            border: 1px solid #e5e7eb;
        }

        .brand-logo {
            height: 45px;
            margin-bottom: 1.5rem;
        }

        .form-label {
            font-weight: 600;
            font-size: 0.875rem;
            color: #4b5563;
            margin-bottom: 0.5rem;
        }

        .form-control {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            color: #111827;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .form-control:focus {
            background-color: #ffffff;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
            outline: none;
        }

        .btn-primary {
            background-color: #3b82f6;
            border-color: #3b82f6;
            padding: 0.75rem;
            font-weight: 600;
            border-radius: 8px;
            width: 100%;
            margin-top: 1rem;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .login-footer {
            margin-top: 2rem;
            text-align: center;
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .input-group-text {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            color: #9ca3af;
        }
    </style>
</head>
<body>

    <div class="login-card">
        <div class="text-center">
            <img src="/static/img/logo.png" alt="GoPharma" class="brand-logo">
            <h4 class="fw-bold mb-1">Bienvenido</h4>
            <p class="text-muted small mb-4">Ingresa tus credenciales para acceder</p>
        </div>

        <form id="loginForm">
            <div class="mb-3">
                <label class="form-label">Usuario</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fa-regular fa-user"></i></span>
                    <input type="text" id="username" class="form-control" placeholder="ej. admin" required>
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label">Contrase√±a</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fa-solid fa-lock"></i></span>
                    <input type="password" id="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">
                Ingresar al Sistema
            </button>

            <!-- Mensaje de Error -->
            <div id="error-msg" class="alert alert-danger mt-3 py-2 px-3 small text-center" style="display: none; border-radius: 8px;">
                <i class="fa-solid fa-circle-exclamation me-1"></i> <span>Error</span>
            </div>
        </form>

        <div class="login-footer">
            &copy; 2025 GoAnalisis Intelligence
        </div>
    </div>

    <script>
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            
            const errorContainer = document.getElementById('error-msg');
            const errorText = errorContainer.querySelector('span');
            const btn = document.querySelector('button');

            // Estado de carga
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Validando...';
            btn.disabled = true;
            errorContainer.style.display = 'none';

            const formData = new URLSearchParams();
            formData.append('username', user);
            formData.append('password', pass);

            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    localStorage.setItem('token', data.access_token);
                    localStorage.setItem('role', data.role);
                    
                    // Peque√±o delay para que se vea la transici√≥n
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Acceso Correcto';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');
                    
                    setTimeout(() => {
                        window.location.href = '/'; 
                    }, 500);
                } else {
                    throw new Error("Credenciales inv√°lidas");
                }
            } catch (err) {
                errorText.textContent = "Usuario o contrase√±a incorrectos.";
                errorContainer.style.display = 'block';
                
                // Restaurar bot√≥n
                btn.innerHTML = 'Ingresar al Sistema';
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-success');
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>


==================================================
ARCHIVO: ./app/templates/report.html
==================================================

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Reporte de Gesti√≥n - GoPharma</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js + Plugin DataLabels (Para los %) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <style>
        body {
            background-color: #ffffff;
            color: #374151;
            font-family: 'Segoe UI', sans-serif;
            -webkit-print-color-adjust: exact;
        }

        /* Panel de Control (No imprimir) */
        .controls-panel {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 1px solid #cbd5e1;
        }

        /* Tarjetas */
        .report-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 20px;
            height: 100%;
            position: relative;
        }

        .kpi-lbl {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #6b7280;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .kpi-val {
            font-size: 2rem;
            font-weight: 800;
            color: #111827;
            line-height: 1;
        }

        .kpi-sub {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 5px;
        }

        .section-header {
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            font-weight: 700;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #f3f4f6;
            padding-bottom: 5px;
        }

        /* Utilidades */
        .text-soft-dark {
            color: #374151;
        }

        .hidden-section {
            display: none !important;
        }

        @media print {
            .no-print {
                display: none !important;
            }

            body {
                padding: 0;
            }

            .report-card {
                border: 1px solid #ddd;
            }

            .section-header {
                margin-top: 20px;
            }
        }
    </style>
</head>

<body class="p-4">

    <!-- PANEL DE CONTROL -->
    <div class="container no-print mb-4">
        <div class="controls-panel d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <strong class="text-dark"><i class="fa-solid fa-sliders me-2"></i>Personalizar:</strong>

                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="toggle-finance" checked>
                    <label class="form-check-label" for="toggle-finance">Finanzas</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="toggle-areas" checked>
                    <label class="form-check-label" for="toggle-areas">√Åreas de Mejora</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="toggle-map" checked>
                    <label class="form-check-label" for="toggle-map">Mapa</label>
                </div>
            </div>
            <div>
                <button onclick="window.print()" class="btn btn-dark btn-sm fw-bold"><i
                        class="fa-solid fa-print me-2"></i>Imprimir / PDF</button>
            </div>
        </div>
    </div>

    <!-- REPORTE -->
    <div class="container">

        <!-- HEADER -->
        <div class="d-flex justify-content-between align-items-end mb-4 border-bottom pb-3">
            <div class="d-flex align-items-center">
                <img src="/static/img/logo.png" height="45" class="me-3" alt="Logo">
                <div>
                    <h2 class="fw-bold mb-0">Reporte de Gesti√≥n</h2>
                    <p class="text-muted mb-0 small" id="report-range">Generando...</p>
                </div>
            </div>
            <div class="text-end">
                <small class="text-muted d-block">Fecha de Emisi√≥n</small>
                <strong id="report-date">--</strong>
            </div>
        </div>

        <!-- 1. VOLUMEN DE PEDIDOS -->
        <div class="section-header">Volumen de Operaci√≥n</div>
        <div class="row g-3">
            <div class="col-md-4">
                <div class="report-card border-start border-4 border-primary">
                    <div class="kpi-lbl text-primary">Pedidos Totales</div>
                    <div class="kpi-val" id="r-orders">--</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="report-card border-start border-4 border-info">
                    <div class="kpi-lbl text-info">Pedidos Delivery</div>
                    <div class="kpi-val" id="r-delivery">--</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="report-card border-start border-4 border-warning">
                    <div class="kpi-lbl text-warning">Pedidos Pickup</div>
                    <div class="kpi-val" id="r-pickup">--</div>
                </div>
            </div>
        </div>

        <!-- 2. USUARIOS -->
        <div class="section-header">Crecimiento de Usuarios</div>
        <div class="row g-3">
            <div class="col-md-4">
                <div class="report-card">
                    <div class="kpi-lbl text-success">Nuevos Usuarios</div>
                    <div class="kpi-val" id="r-new-users">--</div>
                    <div class="kpi-sub">Registrados en este periodo</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="report-card">
                    <div class="kpi-lbl text-primary">Usuarios Activos</div>
                    <div class="kpi-val" id="r-active-users">--</div>
                    <div class="kpi-sub">Compraron en este periodo</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="report-card">
                    <div class="kpi-lbl text-dark">Total Usuarios Registrados</div>
                    <div class="kpi-val" id="r-total-users">--</div>
                    <div class="kpi-sub">Base de datos completa</div>
                </div>
            </div>
        </div>

        <!-- 3. PROMEDIOS Y EFICIENCIA -->
        <div class="section-header">Indicadores de Eficiencia</div>
        <div class="row g-3">
            <div class="col-md-3">
                <div class="report-card bg-light">
                    <div class="kpi-lbl">Tiempo Promedio Entrega</div>
                    <div class="kpi-val" id="r-time">--</div>
                    <div class="kpi-sub">Minutos</div>
                </div>
            </div>
            <div class="col-md-3" id="sec-ticket-global"> <!-- Parte de Finanzas -->
                <div class="report-card bg-light">
                    <div class="kpi-lbl">Ticket Promedio Global</div>
                    <div class="kpi-val text-dark" id="r-ticket">--</div>
                </div>
            </div>
            <div class="col-md-3" id="sec-ticket-delivery"> <!-- Parte de Finanzas -->
                <div class="report-card bg-light">
                    <div class="kpi-lbl text-info">Ticket Prom. Delivery</div>
                    <div class="kpi-val text-info" id="r-ticket-delivery">--</div>
                </div>
            </div>
            <div class="col-md-3" id="sec-fee-avg"> <!-- Parte de Finanzas -->
                <div class="report-card bg-light">
                    <div class="kpi-lbl text-success">Tarifa Servicio Prom.</div>
                    <div class="kpi-val text-success" id="r-service-avg">--</div>
                </div>
            </div>
        </div>

        <!-- 4. GR√ÅFICOS Y DETALLES -->
        <div class="section-header">An√°lisis Visual</div>
        <div class="row g-4">
            <!-- Tendencia -->
            <div class="col-md-8">
                <div class="report-card">
                    <h6 class="fw-bold mb-3 small text-muted">TENDENCIA DE PEDIDOS</h6>
                    <div style="height: 280px;"><canvas id="rTrendsChart"></canvas></div>
                </div>
            </div>

            <!-- Top Farmacias -->
            <div class="col-md-4">
                <div class="report-card p-0 overflow-hidden">
                    <div class="p-3 border-bottom bg-light">
                        <h6 class="fw-bold mb-0 small text-uppercase">Top 10 Farmacias</h6>
                    </div>
                    <table class="table table-sm table-striped mb-0">
                        <tbody id="r-stores-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- SECCI√ìN 5: PRODUCTOS (NUEVO) -->
        <div class="section-header text-dark"><i class="fa-solid fa-box-open me-2"></i>Desempe√±o de Productos</div>
        <div class="row mb-5">
            <div class="col-12">
                <div class="report-card p-0">
                    <table class="table table-sm table-striped mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-3">Nombre del Producto</th>
                                <th class="text-center">Cant. Vendida</th>
                                <th class="text-end pe-3">Total ($)</th>
                            </tr>
                        </thead>
                        <tbody id="r-products-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Fila de Cancelaciones y Mapa -->
        <div class="row g-4 mt-1">
            <!-- √Åreas de Mejora (Cancelaciones) -->
            <div class="col-md-4" id="sec-areas-mejora">
                <div class="report-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold mb-0 small text-uppercase text-danger">√Åreas de Mejora</h6>
                        <span class="badge bg-danger bg-opacity-10 text-danger" id="r-canceled-total">--
                            Cancelados</span>
                    </div>
                    <!-- Gr√°fico SOLO PORCENTAJES -->
                    <div style="height: 250px;"><canvas id="rCancelChart"></canvas></div>
                </div>
            </div>

            <!-- Mapa -->
            <div class="col-md-8" id="sec-map-container">
                <div class="report-card p-0">
                    <div class="p-3 border-bottom bg-light d-flex justify-content-between">
                        <h6 class="fw-bold mb-0 small text-uppercase">Mapa de Calor</h6>
                        <small class="text-muted">Clientes vs Tiendas</small>
                    </div>
                    <div id="reportMap" style="height: 300px; width: 100%;"></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- CONTROL DE VISTAS ---
        const toggles = {
            'toggle-finance': ['sec-ticket-global', 'sec-ticket-delivery', 'sec-fee-avg'],
            'toggle-areas': ['sec-areas-mejora'],
            'toggle-map': ['sec-map-container']
        };

        Object.keys(toggles).forEach(id => {
            document.getElementById(id).addEventListener('change', (e) => {
                toggles[id].forEach(targetId => {
                    const el = document.getElementById(targetId);
                    if (el) e.target.checked ? el.classList.remove('hidden-section') : el.classList.add('hidden-section');
                });
            });
        });

        // --- CARGA ---
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            if (!token) window.location.href = '/login';

            const params = new URLSearchParams(window.location.search);
            document.getElementById('report-range').textContent = `${params.get('start_date') || 'Inicio'} al ${params.get('end_date') || 'Hoy'}`;
            document.getElementById('report-date').textContent = new Date().toLocaleDateString();

            const start = params.get('start_date') || "Inicio";
            const end = params.get('end_date') || "Hoy";

            // --- CAMBIO QUIR√öRGICO: NOMBRE DEL ARCHIVO PDF ---
            // El navegador usa el t√≠tulo de la p√°gina como nombre del archivo al imprimir
            document.title = `Reporte de Gesti√≥n - ${start} al ${end} - GoPharma`;
            // ------------------------------------------------

            document.getElementById('report-range').textContent = `Periodo: ${start} al ${end}`;

            const headers = { 'Authorization': `Bearer ${token}` };
            const api = '/api';
            const fmt = (n) => `$${(n || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}`;

            try {
                // KPIs
                const kpiRes = await fetch(`${api}/kpi/main?${params}`, { headers });
                const kpi = await kpiRes.json();

                // Fila 1
                document.getElementById('r-orders').textContent = kpi.total_orders;
                document.getElementById('r-delivery').textContent = kpi.total_deliveries;
                document.getElementById('r-pickup').textContent = kpi.total_pickups;

                // Fila 2
                document.getElementById('r-new-users').textContent = kpi.new_users_registered;
                document.getElementById('r-active-users').textContent = kpi.active_users_period;
                document.getElementById('r-total-users').textContent = kpi.total_users_historic;

                // Fila 3
                document.getElementById('r-time').textContent = kpi.avg_delivery_minutes;
                document.getElementById('r-ticket').textContent = fmt(kpi.avg_ticket);
                document.getElementById('r-ticket-delivery').textContent = fmt(kpi.avg_delivery_ticket); // Nuevo
                document.getElementById('r-service-avg').textContent = fmt(kpi.avg_service_fee); // Nuevo

                // √Åreas de Mejora
                document.getElementById('r-canceled-total').textContent = `${kpi.total_canceled} Cancelados`;

                // GR√ÅFICO TENDENCIA (Solo Pedidos y Delivery)
                const trendsRes = await fetch(`${api}/data/trends?${params}`, { headers });
                const trends = await trendsRes.json();

                new Chart(document.getElementById('rTrendsChart'), {
                    type: 'bar',
                    data: {
                        labels: trends.labels,
                        datasets: [
                            {
                                type: 'line',
                                label: 'Ingresos ($)',
                                data: trends.revenue,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16,185,129,0.1)',
                                fill: true,
                                yAxisID: 'y',
                                tension: 0.3,
                                order: 2
                            },
                            {
                                type: 'bar',
                                label: 'Pedidos',
                                data: trends.orders,
                                backgroundColor: '#3b82f6',
                                yAxisID: 'y1',
                                order: 3
                            },
                            // --- NUEVO DATASET: TIEMPO ---
                            {
                                type: 'line',
                                label: 'Tiempo Prom (min)',
                                data: trends.avg_times,
                                borderColor: '#ef4444',
                                backgroundColor: 'transparent',
                                borderDash: [5, 5],
                                pointRadius: 3,
                                yAxisID: 'y1', // Comparte eje derecho
                                tension: 0.3,
                                order: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                position: 'left',
                                title: { display: true, text: 'Dinero ($)' }
                            },
                            y1: {
                                position: 'right',
                                grid: { display: false },
                                title: { display: true, text: 'Pedidos / Minutos' }
                            }
                        },
                        plugins: { legend: { display: true } }
                    }
                });

                // TOP TIENDAS
                const storesRes = await fetch(`${api}/data/top-stores?${params}`, { headers });
                const stores = await storesRes.json();
                const sBody = document.getElementById('r-stores-body');
                stores.slice(0, 10).forEach(s => {
                    sBody.innerHTML += `<tr><td class="small">${s.name}</td><td class="text-end fw-bold small">${s.orders}</td></tr>`;
                });

                // 4. TOP PRODUCTOS
                const prodRes = await fetch(`${api}/data/top-products?${params}`, { headers });
                const products = await prodRes.json();
                const pBody = document.getElementById('r-products-body');
                products.slice(0, 10).forEach(p => { // Top 10 en reporte
                    pBody.innerHTML += `
                        <tr>
                            <td class="ps-3 small fw-bold">${p.name}</td>
                            <td class="text-center small">${p.quantity}</td>
                            <td class="text-end pe-3 small text-success">$${p.revenue.toFixed(2)}</td>
                        </tr>
                    `;
                });

                // GR√ÅFICO CANCELACIONES (% ONLY)
                const cancelRes = await fetch(`${api}/analysis/cancellations?${params}`, { headers });
                const cancels = await cancelRes.json();
                new Chart(document.getElementById('rCancelChart'), {
                    type: 'doughnut',
                    plugins: [ChartDataLabels],
                    data: {
                        labels: cancels.map(d => d.reason),
                        datasets: [{ data: cancels.map(d => d.count), backgroundColor: ['#ef4444', '#f97316', '#f59e0b', '#84cc16'] }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } },
                            datalabels: {
                                color: '#fff',
                                font: { weight: 'bold' },
                                formatter: (val, ctx) => {
                                    let sum = 0;
                                    let dataArr = ctx.chart.data.datasets[0].data;
                                    dataArr.map(d => { sum += d; });
                                    let pct = (val * 100 / sum).toFixed(0) + "%";
                                    return pct; // SOLO %
                                }
                            }
                        }
                    }
                });

                // MAPA
                const map = L.map('reportMap', { zoomControl: false }).setView([10.4806, -66.9036], 11);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

                const heatRes = await fetch(`${api}/data/heatmap?${params}`, { headers });
                const heatData = await heatRes.json();
                if (heatData.length) L.heatLayer(heatData, { radius: 18, blur: 15, maxZoom: 13 }).addTo(map);

                const storeLocRes = await fetch(`${api}/data/stores-locations`, { headers });
                const storeLoc = await storeLocRes.json();
                storeLoc.forEach(s => L.circleMarker([s.lat, s.lng], { radius: 3, color: '#3b82f6', fillOpacity: 1 }).addTo(map));

            } catch (e) { console.error(e); }
        });
    </script>
</body>

</html>

==================================================
ARCHIVO: ./tasks/__init__.py
==================================================



==================================================
ARCHIVO: ./tasks/celery_app.py
==================================================

import os
from celery import Celery
from celery.schedules import crontab

# Leemos la variable del docker-compose
broker_url = os.getenv("REDIS_URL", "redis://redis:6379/0")

celery_app = Celery(
    "goanalisis_tasks",
    broker=broker_url,
    backend=broker_url,
    # üëáüëá AQU√ç EST√Å LA CLAVE: Debes agregar el nuevo archivo a esta lista üëáüëá
    include=[
        "tasks.celery_tasks",
        "tasks.ops_tasks",  # <--- ¬°ESTE FALTABA!
        "tasks.maintenance",  # <--- Este tambi√©n para la tarea de las 4 AM
    ],
)


celery_app.conf.update(
    task_serializer="json",
    accept_content=["json"],
    result_serializer="json",
    timezone="America/Caracas",
    enable_utc=True,
    broker_connection_retry_on_startup=True,
    worker_cancel_long_running_tasks_on_connection_loss=True,
)

# --- PROGRAMACI√ìN AUTOM√ÅTICA (CRONOGRAMA) ---
celery_app.conf.beat_schedule = {
    # 1. Monitor en Vivo (Cada minuto)
    # Busca pedidos nuevos en la p√°gina 1 y 2
    "monitor-every-minute": {
        "task": "tasks.celery_tasks.monitor_active_orders",
        "schedule": crontab(minute="*"),
    },
    # VIGILANTE DE HORARIOS (CADA 5 MINUTOS)
    "store-schedule-enforcer": {
        "task": "tasks.ops_tasks.enforce_schedules",
        "schedule": crontab(minute="*/5"),  # Cada 5 min (0, 5, 10, 15...)
    },
    # 2. Dron de Limpieza (Cada 30 minutos)
    # Revisa si quedaron pedidos sin mapa o sin finanzas y los arregla
    "drone-cleanup-every-30-mins": {
        "task": "tasks.celery_tasks.enrich_missing_data",
        "schedule": crontab(minute="*/30"),
    },
    # 3. VIGILANCIA DE CLIENTES (NUEVO)
    # Ejecuta a las 3:00 AM todos los d√≠as.
    # 'kwargs' pasa el argumento limit_pages=10 a la funci√≥n
    "customer-surveillance-daily": {
        "task": "tasks.celery_tasks.sync_customer_database",
        "schedule": crontab(hour=3, minute=0),
        "kwargs": {"limit_pages": 10},
    },
    # 4. AUTOREPARACI√ìN DE SISTEMA
    # 4:00 AM todos los d√≠as
    "nightly-healing": {
        "task": "tasks.maintenance.nightly_deep_clean",
        "schedule": crontab(hour=4, minute=0),
    },
}


==================================================
ARCHIVO: ./tasks/celery_tasks.py
==================================================

import logging
import re
import time
import math
from datetime import datetime, timedelta
from contextlib import contextmanager
from celery import shared_task
import redis

from app.core.config import settings
from app.db.session import SessionLocal
from app.db.base import Order, Store, Customer, Driver, OrderStatusLog, OrderItem
from tasks.scraper.order_scraper import OrderScraper
from tasks.scraper.drone_scraper import DroneScraper
from tasks.scraper.customer_scraper import CustomerScraper
from tasks.scraper.store_scraper import StoreScraper

redis_client = redis.Redis.from_url(settings.REDIS_URL)
logger = logging.getLogger(__name__)


# --- GESTOR DE CONTEXTO ---
@contextmanager
def redis_lock(lock_key: str, expire: int):
    acquired = redis_client.set(lock_key, "true", nx=True, ex=expire)
    try:
        yield acquired
    finally:
        if acquired:
            redis_client.delete(lock_key)


# --- HELPERS ---
def parse_spanish_date(date_str: str):
    """
    Parsea fechas h√≠bridas (Espa√±ol/Ingl√©s) con o sin puntos.
    Ej: '03 ene. 2026', '10 Dec 2025'
    """
    if not date_str:
        return datetime.utcnow()

    # Mapa Biling√ºe y a prueba de errores
    month_map = {
        "ene": "01",
        "jan": "01",
        "enero": "01",
        "january": "01",
        "feb": "02",
        "febrero": "02",
        "february": "02",
        "mar": "03",
        "marzo": "03",
        "march": "03",
        "abr": "04",
        "apr": "04",
        "abril": "04",
        "april": "04",
        "may": "05",
        "mayo": "05",
        "jun": "06",
        "junio": "06",
        "june": "06",
        "jul": "07",
        "julio": "07",
        "july": "07",
        "ago": "08",
        "aug": "08",
        "agosto": "08",
        "august": "08",
        "sep": "09",
        "septiembre": "09",
        "september": "09",
        "oct": "10",
        "octubre": "10",
        "october": "10",
        "nov": "11",
        "noviembre": "11",
        "november": "11",
        "dic": "12",
        "dec": "12",
        "diciembre": "12",
        "december": "12",
    }

    original = date_str
    try:
        # Limpieza: min√∫sculas y quitar puntos
        clean_str = date_str.lower().replace(".", "").strip()

        # Reemplazo inteligente de mes
        for m_name, m_num in month_map.items():
            # Usamos espacios para evitar reemplazar partes de palabras
            if m_name in clean_str:
                clean_str = clean_str.replace(m_name, m_num)
                break

        # Regex flexible: Busca (Dia) (MesNum) (A√±o 4 digitos) (Hora:Min)
        match = re.search(
            r"(\d{1,2})[\s/-]+(\d{1,2})[\s/-]+(\d{4})\s+(\d{1,2}:\d{2})", clean_str
        )

        if match:
            day, month, year, time_str = match.groups()
            return datetime.strptime(
                f"{day} {month} {year} {time_str}", "%d %m %Y %H:%M"
            )

        # Fallback: Si no encuentra hora, intenta solo fecha
        match_date = re.search(r"(\d{1,2})[\s/-]+(\d{1,2})[\s/-]+(\d{4})", clean_str)
        if match_date:
            day, month, year = match_date.groups()
            return datetime.strptime(f"{day} {month} {year}", "%d %m %Y")

        logger.warning(f"‚ö†Ô∏è No se pudo parsear fecha: '{original}'. Usando UTC Now.")
        return datetime.utcnow()

    except Exception as e:
        logger.error(f"Error parseando fecha '{original}': {e}")
        return datetime.utcnow()


def parse_duration_to_minutes(duration_str: str):
    if not duration_str:
        return None
    try:
        hours = 0
        h_match = re.search(r"(\d+)\s*Horas", duration_str, re.IGNORECASE)
        if h_match:
            hours = int(h_match.group(1))
        minutes = 0
        m_match = re.search(r"(\d+)\s*Minutos", duration_str, re.IGNORECASE)
        if m_match:
            minutes = int(m_match.group(1))
        seconds = 0
        s_match = re.search(r"(\d+)\s*segundos", duration_str, re.IGNORECASE)
        if s_match:
            seconds = int(s_match.group(1))
        return round((hours * 60) + minutes + (seconds / 60), 2)
    except:
        return None


def calculate_distance_km(lat1, lon1, lat2, lon2):
    if not lat1 or not lon1 or not lat2 or not lon2:
        return 0.0
    try:
        R = 6371
        dLat = math.radians(lat2 - lat1)
        dLon = math.radians(lon2 - lon1)
        a = (
            math.sin(dLat / 2) ** 2
            + math.cos(math.radians(lat1))
            * math.cos(math.radians(lat2))
            * math.sin(dLon / 2) ** 2
        )
        c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))
        return round(R * c, 3)
    except:
        return 0.0


def normalize_cancellation_reason(text: str) -> str:
    """Estandariza los motivos de cancelaci√≥n."""
    if not text or text == "." or len(text) < 3:
        return "Sin especificar"

    text = text.replace("del pedido :", "").replace("del pedido", "").strip()
    text_lower = text.lower()

    if any(
        x in text_lower
        for x in [
            "disponible",
            "existencia",
            "vencido",
            "da√±ado",
            "no hay",
            "no tenemos",
            "blister",
            "inventario",
            "coca cola",
            "falta",
            "agotado",
            "stock",
            "medicamento",
            "existente",
        ]
    ):
        return "Producto No Disponible / Da√±ado"
    if any(
        x in text_lower
        for x in ["payment", "pago", "transferencia", "zelle", "m√≥vil", "movil"]
    ):
        if "agotado" in text_lower or "tiempo" in text_lower:
            return "Tiempo de Pago Agotado"
        return "Problemas con el Pago"
    if any(
        x in text_lower
        for x in [
            "equivocado",
            "descripcion",
            "descripci√≥n",
            "precio",
            "c√≥digo",
            "codigo",
            "error",
        ]
    ):
        return "Error en Pedido / Descripci√≥n"
    if any(
        x in text_lower
        for x in ["nota", "prueba", "test", "orden de", "admin", "traspaso"]
    ):
        return "Cancelaci√≥n Administrativa"

    return text.title()


def process_drone_data(db, data: dict):
    try:
        external_id = data.get("external_id")
        if not external_id:
            return

        # --- DIAGN√ìSTICO DE ESTATUS (Log visible) ---
        raw_status = data.get("status_text", "").strip()
        status_text = raw_status.lower()

        db_status = "pending"  # Default

        # 1. Finales (Prioridad Absoluta)
        if "entregado" in status_text:
            db_status = "delivered"
        elif "cancelado" in status_text:
            db_status = "canceled"

        # 2. Inicial
        elif "creado" in status_text:
            db_status = "created"

        # 3. Operativos
        elif "camino" in status_text or "ruta" in status_text:
            db_status = "on_the_way"

        # --- CASO ESPECIAL DEL HTML ---
        elif "entrega" in status_text and "repartidor" in status_text:
            # "Entrega al repartidor"
            # Decidimos si es 'Solicitando' o 'Asignado' seg√∫n si ya tiene nombre
            has_driver_name = data.get("driver_name") and "N/A" not in data.get(
                "driver_name"
            )
            if has_driver_name:
                db_status = "driver_assigned"  # Tiene chofer -> Asignado
            else:
                db_status = "confirmed"  # No tiene -> Solicitando
        # -----------------------------

        elif "asignado" in status_text:
            db_status = "driver_assigned"

        elif "proceso" in status_text:  # El HTML Legacy usa "Procesos"
            db_status = "processing"

        elif "confirmado" in status_text:
            db_status = "confirmed"

        # Log para ver qu√© decidi√≥ el sistema
        if db_status == "pending" and "pendiente" not in status_text:
            logger.warning(
                f"‚ö†Ô∏è Estatus Raro en #{external_id}: '{raw_status}' -> Se qued√≥ como Pending"
            )

        # --- BUSCAR O CREAR RELACIONES ---
        # (Tiendas, Clientes, Drivers)

        store = None
        if data.get("store_name"):
            store = db.query(Store).filter(Store.name == data["store_name"]).first()
            if not store:
                store = Store(
                    name=data["store_name"], external_id=f"store_{data['store_name']}"
                )
                db.add(store)
                db.commit()
                db.refresh(store)
            # Actualizar coords tienda si faltan
            if "store_lat" in data and store.latitude is None:
                store.latitude = data["store_lat"]
                store.longitude = data["store_lng"]

        customer = None
        if data.get("customer_name"):
            customer = (
                db.query(Customer)
                .filter(Customer.name == data["customer_name"])
                .first()
            )
            if not customer:
                # AQU√ç EST√Å EL CAMBIO: Asignamos fecha de hoy para que cuente en el KPI
                customer = Customer(
                    name=data["customer_name"],
                    external_id=f"cust_{data['customer_name']}",
                    joined_at=datetime.utcnow(),
                )
                db.add(customer)
                db.commit()
                db.refresh(customer)

            # Actualizar tel√©fono si viene nuevo
            if data.get("customer_phone"):
                customer.phone = data["customer_phone"]

        driver = None
        d_name = data.get("driver_name", "N/A")
        if d_name and "N/A" not in d_name:
            driver = db.query(Driver).filter(Driver.name == d_name).first()
            if not driver:
                driver = Driver(name=d_name, external_id=f"driver_{d_name}")
                db.add(driver)
                db.commit()
                db.refresh(driver)

        # --- BUSCAR PEDIDO ---
        order = db.query(Order).filter(Order.external_id == external_id).first()

        # Fechas y C√°lculos
        created_at_dt = parse_spanish_date(data.get("created_at_text", ""))
        minutes_calc = parse_duration_to_minutes(data.get("duration_text", ""))

        dist_km = 0.0
        cust_lat, cust_lng = data.get("customer_lat"), data.get("customer_lng")
        if cust_lat and store and store.latitude:
            dist_km = calculate_distance_km(
                store.latitude, store.longitude, cust_lat, cust_lng
            )

        # --- L√ìGICA DE CLASIFICACI√ìN LOG√çSTICA V2 (La que arreglamos antes) ---
        order_type = "Delivery"

        # 1. Si hay driver, es Delivery seguro
        if driver and driver.name and "N/A" not in driver.name:
            order_type = "Delivery"
        # 2. Cancelado no tiene tipo
        elif db_status == "canceled":
            order_type = None
        # 3. Distancia cero = Pickup
        elif dist_km is not None and dist_km < 0.2 and dist_km >= 0:
            order_type = "Pickup"

        c_reason = normalize_cancellation_reason(data.get("cancellation_reason"))

        # --- GUARDADO ---
        if not order:
            # CREAR NUEVO
            order = Order(
                external_id=external_id,
                created_at=created_at_dt,
                total_amount=data.get("total_amount", 0),
                delivery_fee=data.get("delivery_fee", 0),
                gross_delivery_fee=data.get("real_delivery_fee", 0),
                service_fee=data.get("service_fee", 0),
                coupon_discount=data.get("coupon_discount", 0),
                tips=data.get("tips", 0),
                product_price=data.get("product_price", 0),
                current_status=db_status,
                order_type=order_type,
                distance_km=dist_km,
                latitude=cust_lat,
                longitude=cust_lng,
                cancellation_reason=c_reason,
                delivery_time_minutes=minutes_calc,
                duration=data.get("duration_text"),
                store_id=store.id if store else None,
                customer_id=customer.id if customer else None,
                driver_id=driver.id if driver else None,
            )
            db.add(order)
            db.commit()
            db.refresh(order)
            # Log inicial
            db.add(
                OrderStatusLog(
                    order_id=order.id, status=db_status, timestamp=datetime.utcnow()
                )
            )
        else:
            # ACTUALIZAR EXISTENTE

            # 1. Cambio de Estatus
            if order.current_status != db_status and order.current_status not in [
                "delivered",
                "canceled",
            ]:
                logger.info(
                    f"üîÑ Cambio #{external_id}: {order.current_status} -> {db_status}"
                )
                db.add(
                    OrderStatusLog(
                        order_id=order.id, status=db_status, timestamp=datetime.utcnow()
                    )
                )
                order.current_status = db_status
            elif (
                order.current_status in ["delivered", "canceled"]
                and db_status != order.current_status
            ):
                # Si ya estaba finalizado, ignoramos cualquier "retroceso" a pendiente que intente el robot
                logger.warning(
                    f"üö´ Intento de cambio de estado inv√°lido en #{external_id}: {order.current_status} -> {db_status} (Ignorado)"
                )

            # 2. Updates Financieros
            order.total_amount = data.get("total_amount", order.total_amount)
            if data.get("real_delivery_fee"):
                order.gross_delivery_fee = data["real_delivery_fee"]
            if data.get("service_fee"):
                order.service_fee = data["service_fee"]
            if data.get("product_price"):
                order.product_price = data["product_price"]
            if c_reason:
                order.cancellation_reason = c_reason

            # 3. Log√≠stica
            if minutes_calc:
                order.delivery_time_minutes = minutes_calc
            if cust_lat:
                order.latitude = cust_lat
                order.longitude = cust_lng
                order.distance_km = dist_km

            if order_type:
                order.order_type = order_type
            if driver:
                order.driver_id = driver.id
            if customer:
                order.customer_id = customer.id

        # 4. PRODUCTOS (Siempre actualizar detalle)
        if "items" in data and data["items"]:
            db.query(OrderItem).filter(OrderItem.order_id == order.id).delete()
            for item in data["items"]:
                db.add(
                    OrderItem(
                        order_id=order.id,
                        name=item["name"],
                        quantity=item["quantity"],
                        unit_price=item["unit_price"],
                        total_price=item["total_price"],
                        barcode=item.get("barcode"),
                    )
                )

        db.commit()
        logger.info(f"‚úÖ Procesado #{external_id}: {db_status} | {order_type}")

    except Exception as e:
        logger.error(f"Error save {data.get('external_id')}: {e}")
        db.rollback()


def save_orders_batch(orders_data: list):
    pass


# --- TAREAS ---


@shared_task(bind=True)
def backfill_historical_data(self):
    key = "celery_lock_backfill_historical_data"
    with redis_lock(key, 14400) as acquired:
        if not acquired:
            return
        ls = OrderScraper()
        drone = DroneScraper()
        db = SessionLocal()
        try:
            if not ls.login():
                return
            items = ls.get_historical_ids()
            ls.close_driver()
            if not drone.login():
                return
            for item in items:
                eid = item["id"]
                existing = db.query(Order).filter(Order.external_id == eid).first()
                if (
                    existing
                    and existing.delivery_time_minutes
                    and existing.latitude
                    and existing.product_price
                ):
                    continue
                data = drone.scrape_detail(eid, mode="full")
                data["duration_text"] = item["duration"]
                process_drone_data(db, data)
        except Exception as e:
            logger.error(f"Fatal: {e}")
        finally:
            if ls:
                ls.close_driver()
            if drone:
                drone.close_driver()
            db.close()


@shared_task(bind=True)
def monitor_active_orders(self):
    key = "celery_lock_monitor_active_orders"
    with redis_lock(key, 55) as acquired:
        if not acquired:
            return
        logger.info("üì° Monitor V4...")
        ls = OrderScraper()
        drone = DroneScraper()
        try:
            if not ls.login():
                return
            recent_items = ls.get_recent_order_ids(limit=15)
            ls.close_driver()
            if not recent_items:
                return
            if not drone.login():
                return
            db = SessionLocal()
            for item in recent_items:
                eid = item["id"]
                data = drone.scrape_detail(eid, mode="full")
                data["duration_text"] = item["duration"]
                process_drone_data(db, data)
            db.close()
        except Exception as e:
            logger.error(f"Monitor: {e}")
        finally:
            if ls:
                ls.close_driver()
            if drone:
                drone.close_driver()


@shared_task(bind=True)
def enrich_missing_data(self):
    """
    Dron de Limpieza: 1. Cancelados, 2. Mapas/Finanzas, 3. Zombies (Pendientes viejos).
    """
    key = "celery_lock_drone_enrichment"
    with redis_lock(key, 300) as acquired:
        if not acquired:
            return "Drone busy"

        db = SessionLocal()
        drone = DroneScraper()
        processed = 0
        BATCH_SIZE = 50

        try:
            # 1. Cancelados (Prioridad Alta)
            missing_reasons = (
                db.query(Order)
                .filter(
                    Order.current_status == "canceled",
                    Order.cancellation_reason == None,
                )
                .limit(BATCH_SIZE)
                .all()
            )
            if missing_reasons:
                if not drone.login():
                    return
                for order in missing_reasons:
                    data = drone.scrape_detail(order.external_id, mode="reason")
                    order.cancellation_reason = normalize_cancellation_reason(
                        data.get("cancellation_reason")
                    )
                    if "service_fee" in data:
                        order.service_fee = data["service_fee"]
                    processed += 1
                db.commit()

            # 2. Entregados incompletos (Mapa, Fee, Productos)
            if processed < BATCH_SIZE:
                limit = BATCH_SIZE - processed

                # --- CORRECCI√ìN: L√çMITE DE TIEMPO (5 D√çAS) ---
                # Evita que se quede pegado intentando arreglar pedidos prehist√≥ricos
                # que tienen errores permanentes.
                cutoff_days = datetime.utcnow() - timedelta(days=5)

                targets = (
                    db.query(Order)
                    .filter(
                        Order.created_at >= cutoff_days,
                        Order.current_status == "delivered",
                        Order.order_type != "Pickup",  # <--- ESTA ES LA CLAVE
                        (Order.latitude == None)
                        | (Order.gross_delivery_fee == 0)
                        | (Order.product_price == 0),
                    )
                    .limit(limit)
                    .all()
                )

                targets = (
                    db.query(Order)
                    .filter(
                        Order.created_at >= cutoff_days,
                        Order.current_status == "delivered",
                        Order.order_type != "Pickup",  # <--- ESTA ES LA CLAVE
                        (Order.latitude == None)
                        | (Order.gross_delivery_fee == 0)
                        | (Order.product_price == 0),
                    )
                    .limit(limit)
                    .all()
                )

            # --- 3. ZOMBIES (Pedidos 'Pendientes' con > 6 horas) ---
            # Esto arregla el caso del pedido 106784 autom√°ticamente
            if processed < BATCH_SIZE:
                limit = BATCH_SIZE - processed
                # Hora actual menos 6 horas
                time_threshold = datetime.utcnow() - timedelta(hours=6)

                zombies = (
                    db.query(Order)
                    .filter(
                        Order.current_status.in_(
                            [
                                "pending",
                                "processing",
                                "confirmed",
                                "driver_assigned",
                                "on_the_way",
                            ]
                        ),
                        Order.created_at < time_threshold,
                    )
                    .limit(limit)
                    .all()
                )

                if zombies:
                    logger.info(
                        f"üßü Dron: Revisando {len(zombies)} pedidos zombies antiguos..."
                    )
                    if not drone.driver:
                        drone.login()

                    for order in zombies:
                        # Entramos a ver si ya cambi√≥
                        data = drone.scrape_detail(order.external_id, mode="full")
                        process_drone_data(db, data)
                        processed += 1
                    db.commit()
            # -------------------------------------------------------

            if processed > 0:
                enrich_missing_data.apply_async(countdown=2)
                return f"Enriched {processed}"
            return "All Done"

        except Exception as e:
            logger.error(f"Drone error: {e}")
        finally:
            if drone:
                drone.close_driver()
            db.close()


@shared_task(bind=True, name="tasks.celery_tasks.sync_customer_database")
def sync_customer_database(self, limit_pages: int = None):
    """
    Sincroniza la base de datos de clientes.
    """
    key = "celery_lock_sync_customers"
    with redis_lock(key, 7200) as acquired:
        if not acquired:
            return "Sync running"

        mode_txt = (
            f"Vigilancia ({limit_pages} p√°gs)"
            if limit_pages
            else "FULL SYNC (Infinito)"
        )
        logger.info(f"üë• Iniciando Sincronizaci√≥n de Clientes: {mode_txt}")

        scraper = CustomerScraper()
        db = SessionLocal()

        # --- CORRECCI√ìN: Inicializar variables AQU√ç arriba ---
        count_new = 0
        count_updated = 0
        # ---------------------------------------------------

        try:
            users_data = scraper.scrape_customers(max_pages=limit_pages)
            scraper.close_driver()

            for u in users_data:
                # 1. Buscar por ID externo real (Prioridad)
                customer = None
                if u.get("id"):
                    customer = (
                        db.query(Customer)
                        .filter(Customer.external_id == u["id"])
                        .first()
                    )

                # 2. Buscar por nombre (Fallback)
                if not customer:
                    customer = (
                        db.query(Customer)
                        .filter(Customer.name.ilike(f"{u['name']}"))
                        .first()
                    )

                if customer:
                    # Actualizamos fecha si el scraper trajo una v√°lida
                    if u["joined_at"]:
                        customer.joined_at = u["joined_at"]
                        count_updated += 1

                    if u["phone"]:
                        customer.phone = u["phone"]

                    # Guardamos el ID real si no lo ten√≠a
                    if u.get("id") and not customer.external_id:
                        customer.external_id = u["id"]
                else:
                    # Crear nuevo
                    new_c = Customer(
                        name=u["name"],
                        phone=u["phone"],
                        joined_at=u["joined_at"],
                        external_id=u.get("id")
                        or f"reg_{int(time.time())}_{count_new}",
                    )
                    db.add(new_c)
                    count_new += 1

            db.commit()
            return f"Clientes: {count_new} nuevos, {count_updated} actualizados."

        except Exception as e:
            logger.error(f"Sync error: {e}")
            db.rollback()
        finally:
            if scraper:
                scraper.close_driver()
            db.close()


@shared_task(bind=True)
def sync_store_commissions(self):
    key = "celery_lock_sync_stores"
    with redis_lock(key, 1800) as acquired:
        if not acquired:
            return
        db = SessionLocal()
        stores = db.query(Store).all()
        scraper = StoreScraper()
        if not scraper.login():
            return
        updated = 0
        for s in stores:
            try:
                real_id = re.search(r"\d+", s.external_id or "").group(0)
                commission = scraper.scrape_commission(real_id)
                if commission > 0:
                    s.commission_rate = commission
                    updated += 1
            except:
                continue
        db.commit()
        scraper.close_driver()
        db.close()
        return f"Tiendas: {updated}"


==================================================
ARCHIVO: ./tasks/maintenance.py
==================================================

import logging
import redis
import time
from datetime import datetime, timedelta
from celery import shared_task
from sqlalchemy import text

from app.core.config import settings
from app.db.session import SessionLocal
from app.db.base import Order
from tasks.scraper.order_scraper import OrderScraper
from tasks.scraper.drone_scraper import DroneScraper
from tasks.celery_tasks import process_drone_data

# Configuraci√≥n de Logging
logger = logging.getLogger(__name__)
redis_client = redis.Redis.from_url(settings.REDIS_URL)

@shared_task(bind=True, name="tasks.maintenance.nightly_deep_clean")
def nightly_deep_clean(self):
    """
    PROTOCOL DE MANTENIMIENTO NOCTURNO (4:00 AM)
    1. Rompe candados de Redis olvidados.
    2. Ejecuta auditor√≠a profunda de las √∫ltimas 48h (Logic de recuperar_ayer).
    3. Mata procesos de Chrome hu√©rfanos (v√≠a Python).
    """
    logger.info("üè• INICIANDO PROTOCOLO DE AUTOCURACI√ìN NOCTURNA...")
    
    # --- FASE 1: ROMPER CANDADOS VIEJOS ---
    try:
        keys = redis_client.keys("celery_lock_*")
        if keys:
            logger.info(f"üîì Liberando {len(keys)} candados de tareas trabadas...")
            redis_client.delete(*keys)
    except Exception as e:
        logger.error(f"Error limpiando Redis: {e}")

    # --- FASE 2: AUDITOR√çA DE DATOS (√öLTIMAS 48H) ---
    # Esta es la l√≥gica de 'recuperar_ayer.py' automatizada
    try:
        logger.info("üïµÔ∏è‚Äç‚ôÇÔ∏è Iniciando Auditor√≠a de Integridad (48 Horas)...")
        db = SessionLocal()
        ls = OrderScraper()
        drone = DroneScraper()
        
        # 1. Bajamos historial reciente (20 p√°ginas = ~500 pedidos, cubre fin de semana)
        if ls.login():
            items = ls.get_historical_ids(max_pages=20)
            ls.close_driver()
            
            # Filtramos solo lo que valga la pena revisar (No Delivered/Canceled o Data incompleta)
            # O mejor: FORZAMOS la actualizaci√≥n de todo lo que no est√© 'delivered' en DB local
            # para asegurar que si se entreg√≥ en la madrugada, se marque.
            
            if drone.login():
                count = 0
                for item in items:
                    eid = item['id']
                    
                    # Buscamos en DB local
                    local_order = db.query(Order).filter(Order.external_id == eid).first()
                    
                    # CRITERIOS DE REPARACI√ìN:
                    # 1. No existe en DB.
                    # 2. En DB est√° 'pending/on_the_way' pero ya es viejo.
                    # 3. Tiene monto 0.
                    
                    needs_repair = False
                    
                    # 1. No existe en DB
                    if not local_order: 
                        needs_repair = True
                    
                    # 2. Zombie: No est√° finalizado (delivered/canceled)
                    elif local_order.current_status not in ['delivered', 'canceled']: 
                        needs_repair = True
                    
                    # 3. Datos Incompletos: Monto cero
                    elif local_order.total_amount == 0: 
                        needs_repair = True
                        
                    # 4. NUEVO: INCOHERENCIA LOG√çSTICA (Falso Delivery)
                    # Si dice "Entregado" y "Delivery", PERO no tiene chofer asignado -> Es un Pickup mal clasificado
                    elif (local_order.current_status == 'delivered' and 
                          local_order.order_type == 'Delivery' and 
                          local_order.driver_id is None):
                        needs_repair = True
                        logger.info(f"üßê Detectada Incoherencia en #{eid}: Delivery sin Chofer. Forzando correcci√≥n...")

                    if needs_repair:
                        count += 1
                        logger.info(f"üöë Reparando Pedido #{eid}...")
                        try:
                            data = drone.scrape_detail(eid, mode='full')
                            # Inyectar duraci√≥n de lista si el detalle no la trajo bien
                            if not data.get('duration_text'): 
                                data['duration_text'] = item.get('duration', '')
                            
                            process_drone_data(db, data)
                        except Exception as scrape_err:
                            logger.error(f"Fallo reparando {eid}: {scrape_err}")
                
                drone.close_driver()
                logger.info(f"‚úÖ Auditor√≠a finalizada. {count} pedidos corregidos.")
            else:
                logger.error("‚ùå Dron no pudo loguearse para la auditor√≠a.")
        else:
            logger.error("‚ùå Scraper de lista no pudo loguearse.")
            
        db.close()

    except Exception as e:
        logger.error(f"‚ùå Error cr√≠tico en Auditor√≠a de Datos: {e}")

    return "System Healthy"


==================================================
ARCHIVO: ./tasks/ops_tasks.py
==================================================

import logging
import re
from datetime import datetime, timedelta
from celery import shared_task
from app.db.session import SessionLocal
from app.db.base import Store, StoreSchedule, StoreHoliday
from tasks.scraper.store_controller import StoreControllerScraper
import logging

logger = logging.getLogger(__name__)


@shared_task(bind=True)
def enforce_schedules(self):
    db = SessionLocal()
    now_vet = datetime.utcnow() - timedelta(hours=4)
    today_date = now_vet.date()
    current_day = now_vet.weekday()
    current_minutes_total = now_vet.hour * 60 + now_vet.minute

    # 1. BUSCAR TIENDAS ACTIVAS
    # Para cada tienda, decidiremos qu√© regla aplicar
    all_stores = db.query(Store).filter(Store.external_id != None).all()

    controller = StoreControllerScraper()
    login_done = False
    changes_count = 0

    for store in all_stores:
        # --- L√ìGICA DE PRECEDENCIA ---

        # A. ¬øHay un feriado para esta tienda hoy (o un feriado global)?
        holiday = (
            db.query(StoreHoliday)
            .filter(
                StoreHoliday.date == today_date,
                (StoreHoliday.store_id == store.id) | (StoreHoliday.store_id == None),
            )
            .first()
        )

        rule_to_apply = None

        if holiday:
            logger.info(f"üéä Hoy es feriado para {store.name}: {holiday.description}")
            if holiday.is_closed_all_day:
                # Forzar apagado todo el d√≠a
                is_forbidden_time = True
            else:
                # Usar horario especial del feriado
                start_min = int(holiday.open_time.split(":")[0]) * 60 + int(
                    holiday.open_time.split(":")[1]
                )
                end_min = (
                    int(holiday.close_time.split(":")[0]) * 60
                    + int(holiday.close_time.split(":")[1])
                ) - 60
                is_forbidden_time = (current_minutes_total < start_min) or (
                    current_minutes_total >= end_min
                )
        else:
            # B. Si no es feriado, buscar regla semanal normal
            rule = (
                db.query(StoreSchedule)
                .filter(
                    StoreSchedule.store_id == store.id,
                    StoreSchedule.day_of_week == current_day,
                    StoreSchedule.is_active == True,
                )
                .first()
            )

            if not rule:
                continue  # No hay reglas para esta tienda hoy

            start_min = int(rule.open_time.split(":")[0]) * 60 + int(
                rule.open_time.split(":")[1]
            )
            end_min = (
                int(rule.close_time.split(":")[0]) * 60
                + int(rule.close_time.split(":")[1])
            ) - rule.buffer_minutes
            is_forbidden_time = (current_minutes_total < start_min) or (
                current_minutes_total >= end_min
            )

        # --- EJECUCI√ìN DEL APAGADO ---
        if is_forbidden_time:
            if not login_done:
                if controller.login():
                    login_done = True
                else:
                    break

            was_switched_off = controller.enforce_store_status(
                store.name, desired_status_bool=False
            )

            if was_switched_off:
                changes_count += 1

    if login_done:
        controller.close()
    db.close()

    # Reporte final m√°s honesto
    return f"Vigilancia completada. Se forz√≥ el cierre de {changes_count} tiendas que estaban abiertas indebidamente."


==================================================
ARCHIVO: ./tasks/scraper/__init__.py
==================================================



==================================================
ARCHIVO: ./tasks/scraper/customer_scraper.py
==================================================

import logging
import re
import time
from typing import List, Dict, Any
from datetime import datetime
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.service import Service as ChromeService
from app.core.config import settings

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class CustomerScraper:
    def __init__(self):
        self.base_url = "https://ecosistema.gopharma.com.ve/login/admin"
        self.users_url = "https://ecosistema.gopharma.com.ve/admin/users/customer/list?order_wise=latest"
        self.driver = None

    def setup_driver(self):
        if self.driver: return
        chrome_options = Options()
        chrome_options.add_argument("--headless=new")
        chrome_options.add_argument("--no-sandbox")
        chrome_options.add_argument("--disable-dev-shm-usage")
        chrome_options.add_argument("--disable-gpu")
        chrome_options.add_argument("--remote-allow-origins=*")
        chrome_options.add_argument("user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36")
        
        service = ChromeService()
        self.driver = webdriver.Chrome(service=service, options=chrome_options)

    def login(self) -> bool:
        if not self.driver: self.setup_driver()
        try:
            self.driver.get(self.base_url)
            wait = WebDriverWait(self.driver, 10)
            wait.until(EC.presence_of_element_located((By.NAME, "email"))).send_keys(settings.GOPHARMA_EMAIL)
            self.driver.find_element(By.NAME, "password").send_keys(settings.GOPHARMA_PASSWORD)
            try: self.driver.find_element(By.XPATH, "//button[@type='submit']").click()
            except: self.driver.find_element(By.NAME, "password").submit()
            time.sleep(3)
            return "login" not in self.driver.current_url
        except: return False

    def close_driver(self):
        if self.driver:
            try: self.driver.quit()
            except: pass
            self.driver = None

    def _parse_spanish_date(self, text):
        if not text: return None
        month_map = {
            'ene': '01', 'feb': '02', 'mar': '03', 'abr': '04', 'may': '05', 'jun': '06',
            'jul': '07', 'ago': '08', 'sep': '09', 'oct': '10', 'nov': '11', 'dic': '12',
            'enero': '01', 'febrero': '02', 'marzo': '03', 'abril': '04', 'mayo': '05', 'junio': '06',
            'julio': '07', 'agosto': '08', 'septiembre': '09', 'octubre': '10', 'noviembre': '11', 'diciembre': '12'
        }
        try:
            clean = text.lower().replace('.', '').strip()
            for m_name, m_num in month_map.items():
                if m_name in clean: clean = clean.replace(m_name, m_num); break
            
            match = re.search(r'(\d{1,2})[\s/-]+(\d{1,2})[\s/-]+(\d{4})', clean)
            if match:
                return datetime.strptime(f"{match.group(1)} {match.group(2)} {match.group(3)}", '%d %m %Y')
        except: pass
        return None

    def _correct_year_based_on_id(self, date_obj: datetime, cust_id: int) -> datetime:
        if not date_obj: return None
        
        # Correcci√≥n del Bug de A√±o Nuevo de Gopharma
        if date_obj.year == 2026:
            # RANGOS HIST√ìRICOS
            if cust_id < 100:
                return date_obj.replace(year=2023)
            elif cust_id < 2000:
                return date_obj.replace(year=2024)
            
            # PUNTO DE CORTE EXACTO: 23413
            # Si es menor a 23413, NO puede ser 2026, lo bajamos a 2025.
            elif cust_id < 23413: 
                return date_obj.replace(year=2025)
            
            # Si es >= 23413, es un registro real de Enero 2026. Lo dejamos quieto.
            
        return date_obj

    def scrape_customers(self, max_pages: int = None) -> List[Dict]:
        if not self.driver: self.setup_driver(); self.login()
        customers = []
        
        try:
            logger.info(f"üë• Scrapeando Clientes (Correcci√≥n de A√±os Activa)...")
            self.driver.get(self.users_url)
            WebDriverWait(self.driver, 10).until(EC.presence_of_element_located((By.ID, "datatable")))

            current_page = 1
            while True:
                if max_pages and current_page > max_pages: break
                
                # Log discreto cada 5 p√°ginas
                if current_page % 5 == 0: logger.info(f"   üìÑ Procesando p√°gina {current_page}...")
                
                rows = self.driver.find_elements(By.XPATH, "//table[@id='datatable']/tbody/tr")
                if not rows: break

                for row in rows:
                    try:
                        cols = row.find_elements(By.TAG_NAME, "td")
                        if len(cols) < 7: continue
                        
                        # ID (Col 0)
                        id_text = cols[0].text.strip()
                        if not id_text.isdigit(): continue
                        gopharma_id = int(id_text)

                        # Nombre (Col 1)
                        name = cols[1].text.split('\n')[0].strip()
                        
                        # Tel√©fono (Col 3)
                        phone = None
                        try:
                            phone_el = cols[3].find_element(By.XPATH, ".//a[contains(@href, 'tel:')]")
                            phone = phone_el.text.strip()
                        except: pass
                        
                        # Fecha (Col 6)
                        date_text = cols[6].text.strip()
                        raw_date = self._parse_spanish_date(date_text)
                        
                        # --- CORRECCI√ìN INTELIGENTE ---
                        final_date = self._correct_year_based_on_id(raw_date, gopharma_id)
                        # ------------------------------

                        if name:
                            customers.append({
                                "id": str(gopharma_id),
                                "name": name,
                                "phone": phone,
                                "joined_at": final_date
                            })
                    except: continue

                try:
                    next_btn = self.driver.find_element(By.XPATH, "//a[@aria-label='Next ¬ª']")
                    parent = next_btn.find_element(By.XPATH, "./..")
                    if "disabled" in parent.get_attribute("class"): break
                    self.driver.execute_script("arguments[0].click();", next_btn)
                    time.sleep(1.5) # Un poco m√°s r√°pido
                    current_page += 1
                except: break

        except Exception as e:
            logger.error(f"Error scraping customers: {e}")
        finally:
            self.close_driver()
        
        return customers


==================================================
ARCHIVO: ./tasks/scraper/drone_scraper.py
==================================================

import logging
import re
import os
import time
import urllib.parse

# --- CORRECCI√ìN: Agregados List y Dict ---
from typing import Dict, Any, Optional, Tuple, List
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.service import Service as ChromeService

# from webdriver_manager.chrome import ChromeDriverManager
from app.core.config import settings

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class DroneScraper:
    def __init__(self):
        self.base_detail_url = "https://ecosistema.gopharma.com.ve/admin/order/details"
        self.driver = None
        self.wait_timeout = 10

    def setup_driver(self):
        # Importaciones locales para no ensuciar el resto del archivo
        from selenium.webdriver.chrome.service import Service
        from selenium.webdriver.chrome.options import Options
        from webdriver_manager.chrome import ChromeDriverManager
        import logging

        chrome_options = Options()
        chrome_options.add_argument("--headless=new")
        chrome_options.add_argument("--no-sandbox")
        chrome_options.add_argument("--disable-dev-shm-usage")
        chrome_options.add_argument("--disable-gpu")
        chrome_options.add_argument("--window-size=1920,1080")

        # Configuraci√≥n de descargas
        self.download_dir = "/tmp/downloads"
        if not os.path.exists(self.download_dir):
            os.makedirs(self.download_dir, mode=0o777)

        prefs = {
            "download.default_directory": self.download_dir,
            "download.prompt_for_download": False,
            "safebrowsing.enabled": True,
        }
        chrome_options.add_experimental_option("prefs", prefs)

        # --- INSTALACI√ìN AUTOM√ÅTICA DEL DRIVER ---
        try:
            logger.info("üîß Instalando ChromeDriver compatible...")
            # Esto descarga la versi√≥n exacta para el Chrome que tienes instalado
            driver_path = ChromeDriverManager().install()

            # Correcci√≥n de permisos (a veces baja sin permisos de ejecuci√≥n)
            os.chmod(driver_path, 0o755)

            service = Service(executable_path=driver_path)
            self.driver = webdriver.Chrome(service=service, options=chrome_options)
            logger.info(f"‚úÖ Driver iniciado correctamente desde: {driver_path}")

        except Exception as e:
            logger.error(f"‚ùå Error fatal iniciando driver: {e}")
            raise e

        # Comandos CDP finales
        try:
            params = {"behavior": "allow", "downloadPath": self.download_dir}
            self.driver.execute_cdp_cmd("Page.setDownloadBehavior", params)
        except:
            pass

    def login(self) -> bool:
        if not self.driver:
            self.setup_driver()
        try:
            self.driver.get("https://ecosistema.gopharma.com.ve/login/admin")
            wait = WebDriverWait(self.driver, self.wait_timeout)
            wait.until(EC.presence_of_element_located((By.NAME, "email"))).send_keys(
                settings.GOPHARMA_EMAIL
            )
            self.driver.find_element(By.NAME, "password").send_keys(
                settings.GOPHARMA_PASSWORD
            )
            try:
                self.driver.find_element(By.XPATH, "//button[@type='submit']").click()
            except:
                self.driver.find_element(By.NAME, "password").submit()
            time.sleep(3)
            return "login" not in self.driver.current_url
        except:
            return False

    def close_driver(self):
        if self.driver:
            try:
                self.driver.quit()
            except:
                pass
            self.driver = None

    # --- EXTRACTORES ---
    def _parse_money(self, text: str) -> float:
        try:
            match = re.search(r"(\d+(?:,\d{3})*(?:\.\d+)?)", text)
            return float(match.group(1).replace(",", "")) if match else 0.0
        except:
            return 0.0

    def _extract_financials(self, body_text: str) -> Dict[str, float]:
        data = {}

        def get_val(keyword):
            try:
                pattern = re.escape(keyword) + r".*?USD\s*([\d\.]+)"
                match = re.search(pattern, body_text, re.IGNORECASE | re.DOTALL)
                return float(match.group(1)) if match else 0.0
            except:
                return 0.0

        data["service_fee"] = get_val("Tarifa de servicio")
        data["coupon_discount"] = get_val("Descuento del cup√≥n")
        data["tips"] = get_val("Propinas al repartidor")
        data["real_delivery_fee"] = get_val("Tarifa de entrega")
        data["total_amount"] = get_val("Total:")

        # Intentar extraer precio de producto
        data["product_price"] = get_val("Precio de productos")

        return data

    def _parse_href_coords(self, href: str) -> Optional[Tuple[float, float]]:
        if not href:
            return None
        try:
            href = urllib.parse.unquote(href)
            match = re.search(r"q=loc:(-?\d+\.\d+)(?:\+|,|\s)(-?\d+\.\d+)", href)
            if match:
                return float(match.group(1)), float(match.group(2))
        except:
            pass
        return None

    def _extract_maps(self) -> Dict[str, float]:
        result = {}
        try:
            # 1. CLIENTE
            try:
                client_link = self.driver.find_element(
                    By.CSS_SELECTOR,
                    ".delivery--information-single a[href*='maps.google.com']",
                )
                c = self._parse_href_coords(client_link.get_attribute("href"))
                if c:
                    result["customer_lat"], result["customer_lng"] = c
            except:
                try:
                    client_link = self.driver.find_element(
                        By.XPATH,
                        "//h5[contains(., 'Informaci√≥n de entrega')]/ancestor::div[contains(@class, 'card-body')]//a[contains(@href, 'maps.google.com')]",
                    )
                    c = self._parse_href_coords(client_link.get_attribute("href"))
                    if c:
                        result["customer_lat"], result["customer_lng"] = c
                except:
                    pass

            # 2. TIENDA
            try:
                store_link = self.driver.find_element(
                    By.CSS_SELECTOR, "a.__gap-5px[href*='maps.google.com']"
                )
                c = self._parse_href_coords(store_link.get_attribute("href"))
                if c:
                    result["store_lat"], result["store_lng"] = c
            except:
                pass
        except:
            pass
        return result

    def _extract_basic_info(self) -> Dict[str, str]:
        info = {}
        try:
            status_el = self.driver.find_element(
                By.XPATH,
                "//div[contains(@class, 'order-invoice-right')]//span[contains(@class, 'badge')]",
            )
            info["status_text"] = status_el.text.strip()
        except:
            info["status_text"] = "pending"

        try:
            client_el = self.driver.find_element(
                By.CSS_SELECTOR, "a[href*='/customer/view/'] .media-body"
            )
            info["customer_name"] = client_el.text.split("\n")[0].strip()
        except:
            info["customer_name"] = "Desconocido"

        try:
            driver_el = self.driver.find_element(
                By.CSS_SELECTOR, "a[href*='/delivery-man/'] .media-body span"
            )
            info["driver_name"] = driver_el.text.strip()
        except:
            info["driver_name"] = "N/A"

        try:
            store_el = self.driver.find_element(
                By.CSS_SELECTOR, "a[href*='/store/view/'] .media-body span"
            )
            info["store_name"] = store_el.text.strip()
        except:
            info["store_name"] = "Desconocida"

        try:
            el = self.driver.find_element(
                By.CSS_SELECTOR, ".delivery--information-single a[href^='tel:']"
            )
            info["customer_phone"] = el.text.strip()
        except:
            pass

        try:
            header_text = self.driver.find_element(
                By.CLASS_NAME, "order-invoice-left"
            ).text
            date_match = re.search(
                r"(\d{1,2}\s+[A-Za-z\.]+\s+\d{4}\s+\d{1,2}:\d{2})", header_text
            )
            if date_match:
                info["created_at_text"] = date_match.group(1)
        except:
            pass

        return info

    def _extract_reason_smart(self) -> Optional[str]:
        try:
            labels = self.driver.find_elements(
                By.XPATH,
                "//*[contains(text(), 'Motivo de cancelaci√≥n') or contains(text(), 'Raz√≥n')]",
            )
            for label in labels:
                try:
                    parent = label.find_element(By.XPATH, "./..")
                    raw_text = parent.text
                    garbage = [
                        label.text,
                        "Motivo de cancelaci√≥n",
                        "del pedido",
                        ":",
                        "-",
                    ]
                    for g in garbage:
                        raw_text = raw_text.replace(g, "")
                    clean = raw_text.strip()
                    if len(clean) > 2:
                        return clean
                except:
                    continue
        except:
            pass
        return None

    # --- NUEVO: EXTRACTOR DE PRODUCTOS ---
    def _extract_products(self) -> List[Dict]:
        """Extrae la lista de productos del detalle."""
        items = []
        try:
            # Buscar filas de la tabla de productos
            rows = self.driver.find_elements(By.XPATH, "//table/tbody/tr")

            for row in rows:
                try:
                    cols = row.find_elements(By.TAG_NAME, "td")
                    if len(cols) < 3:
                        continue

                    # 1. Nombre
                    try:
                        name_el = cols[1].find_element(By.TAG_NAME, "strong")
                        name = name_el.text.strip()
                    except:
                        continue

                    # 2. Cantidad y Precio Unitario
                    qty = 1
                    price = 0.0
                    try:
                        info_text = cols[1].find_element(By.TAG_NAME, "h6").text
                        match = re.search(r"(\d+)\s*x\s*USD\s*([\d\.,]+)", info_text)
                        if match:
                            qty = int(match.group(1))
                            price = float(match.group(2).replace(",", ""))
                    except:
                        pass

                    # 3. C√≥digo de Barras
                    barcode = cols[2].get_attribute("title") or cols[2].text.strip()

                    # 4. Total L√≠nea
                    total = 0.0
                    try:
                        total_text = cols[3].text
                        total = self._parse_money(total_text)
                    except:
                        total = price * qty

                    if name:
                        items.append(
                            {
                                "name": name,
                                "quantity": qty,
                                "unit_price": price,
                                "total_price": total,
                                "barcode": barcode,
                            }
                        )
                except:
                    continue
        except Exception as e:
            logger.error(f"Error extracting products: {e}")

        return items

    def scrape_detail(self, external_id: str, mode: str = "full") -> Dict[str, Any]:
        if not self.driver:
            self.setup_driver()
            self.login()
        result = {"external_id": external_id}
        target_url = f"{self.base_detail_url}/{external_id}"

        try:
            self.driver.get(target_url)
            WebDriverWait(self.driver, 5).until(
                EC.presence_of_element_located((By.TAG_NAME, "body"))
            )
            body_text = self.driver.find_element(By.TAG_NAME, "body").text

            result.update(self._extract_basic_info())
            result.update(self._extract_financials(body_text))
            result.update(self._extract_maps())

            # Productos (Siempre)
            products = self._extract_products()
            if products:
                result["items"] = products

            if "cancelado" in result.get("status_text", "").lower():
                reason = self._extract_reason_smart()
                if reason:
                    result["cancellation_reason"] = reason

        except Exception as e:
            logger.error(f"‚ùå Error scraping {external_id}: {e}")

        return result


==================================================
ARCHIVO: ./tasks/scraper/ec_scraper.py
==================================================

import logging
import time
import os
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.action_chains import ActionChains
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.common.by import By
from app.core.config import settings

logging.basicConfig(
    level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)


class ECScraper:
    def __init__(self):
        self.BASE_URL = "https://ec.gopharma.com.ve/?from-splash=false"
        self.driver = None
        self.username = settings.EC_USER
        self.password = settings.EC_PASSWORD

    def setup_driver(self, headless=True):
        options = Options()
        options.add_argument("--window-size=1366,768")
        if headless:
            options.add_argument("--headless=new")
        options.add_argument("--no-sandbox")
        options.add_argument("--disable-dev-shm-usage")
        options.add_argument("--disable-blink-features=AutomationControlled")

        service = Service()
        self.driver = webdriver.Chrome(service=service, options=options)

        # JAULA DE CRISTAL
        self.driver.execute_cdp_cmd(
            "Emulation.setDeviceMetricsOverride",
            {
                "width": 1366,
                "height": 768,
                "deviceScaleFactor": 1,
                "mobile": False,
                "fitWindow": True,
            },
        )
        logger.info("üîí Resoluci√≥n forzada a: 1366x768")

    def close(self):
        if self.driver:
            self.driver.quit()

    def set_gps_location(self, lat, lng):
        """Teletransporta el navegador"""
        logger.info(f"üåç GPS Spoofing: {lat}, {lng}")
        self.driver.execute_cdp_cmd(
            "Emulation.setGeolocationOverride",
            {"latitude": lat, "longitude": lng, "accuracy": 100},
        )
        time.sleep(1)

    def _inject_calibration_grid(self):
        script = """
        (function() {
            if (document.getElementById('debug-grid')) return;
            var grid = document.createElement('div');
            grid.id = 'debug-grid';
            grid.style.pointerEvents = 'none'; grid.style.zIndex = '9999999';
            grid.style.position = 'fixed'; grid.style.top = '0'; grid.style.left = '0';
            document.body.appendChild(grid);
            function line(x,y,v){
                var d=document.createElement('div'); d.style.position='absolute'; d.style.background=v?'rgba(255,0,0,0.5)':'rgba(0,0,255,0.5)';
                if(v){d.style.left=x+'px';d.style.top='0';d.style.width='1px';d.style.height='768px';}
                else{d.style.top=y+'px';d.style.left='0';d.style.height='1px';d.style.width='1366px';}
                grid.appendChild(d);
            }
            for(var i=0;i<=1400;i+=100) line(i,0,1);
            for(var j=0;j<=800;j+=100) line(0,j,0);
        })();
        """
        try:
            self.driver.execute_script(script)
        except:
            pass

    def _super_click(self, x, y, desc="Elemento", step=0):
        try:
            logger.info(f"üìç [{step}] Click: {desc} ({x}, {y})")

            # Marcador Rojo
            js_mark = f"""
            var d = document.createElement('div'); d.style.position='absolute'; d.style.left='{x}px'; d.style.top='{y}px';
            d.style.width='15px'; d.style.height='15px'; d.style.background='red'; d.style.borderRadius='50%'; 
            d.style.zIndex='9999999'; d.innerText='{step}'; d.style.color='white'; d.style.fontSize='10px'; d.style.textAlign='center';
            document.body.appendChild(d);
            """
            self.driver.execute_script(js_mark)

            # 1. Disparo JS (Pointer Events)
            js_click = f"""
            var target = document.elementFromPoint({x}, {y}) || document.body;
            var opts = {{bubbles:true, cancelable:true, view:window, clientX:{x}, clientY:{y}, pointerId:1, pointerType:'mouse', button:0, buttons:1}};
            target.dispatchEvent(new PointerEvent('pointerdown', opts));
            target.dispatchEvent(new MouseEvent('mousedown', opts));
            setTimeout(()=>{{
                target.dispatchEvent(new PointerEvent('pointerup', opts));
                target.dispatchEvent(new MouseEvent('mouseup', opts));
                target.dispatchEvent(new MouseEvent('click', opts));
            }}, 100);
            """
            self.driver.execute_script(js_click)

            # 2. Respaldo ActionChains
            try:
                actions = ActionChains(self.driver)
                actions.move_by_offset(x, y).click().perform()
                actions.move_by_offset(-x, -y).perform()
            except:
                pass

            time.sleep(1.5)
            return True
        except Exception as e:
            logger.error(f"‚ùå Error click {step}: {e}")
            return False

    def _type_text_at_coords(self, text, x, y, step=0, submit=False):
        """Escribe texto. Si submit=True, presiona ENTER."""
        try:
            logger.info(f"‚å®Ô∏è [{step}] Escribiendo: {text}")
            self._super_click(x, y, "Foco Texto", step)
            time.sleep(0.5)

            actions = ActionChains(self.driver)
            actions.send_keys(Keys.CONTROL + "a")
            actions.send_keys(Keys.DELETE)
            actions.send_keys(text)

            if submit:
                logger.info("üöÄ Enviando ENTER...")
                actions.send_keys(Keys.ENTER)

            actions.perform()
            time.sleep(1.0)
            return True
        except Exception as e:
            logger.error(f"‚ùå Error escribiendo: {e}")
            return False

    def login_and_search(self):
        self.setup_driver(headless=True)  # Siempre headless en server

        try:
            logger.info("üöÄ StoreBot: Iniciando Secuencia...")
            self.driver.get(self.BASE_URL)
            time.sleep(15)  # Espera carga inicial

            self._inject_calibration_grid()

            # --- 1. LOGIN ---
            self._super_click(455, 90, "Cerrar Publicidad", 1)
            time.sleep(2)
            self._super_click(1210, 730, "Cookies", 2)
            time.sleep(1)
            self._super_click(455, 90, "Cerrar Publicidad (Intento 2)", 3)
            time.sleep(1)
            self._super_click(1160, 58, "Bot√≥n Login", 4)
            time.sleep(3)
            self._super_click(680, 665, "Switch Password", 5)
            time.sleep(2)

            self._type_text_at_coords(self.username, 683, 300, 6)
            self._type_text_at_coords(self.password, 683, 400, 7)

            self._super_click(550, 500, "Ingresar Verde", 8)

            logger.info("‚è≥ Esperando Login (8s)...")
            time.sleep(8)

            # --- 2. UBICACI√ìN (GPS) ---
            # Inyectamos coordenadas de una Farmacia (Ej: Las Mercedes)
            # Esto debe hacerse ANTES de darle a "Estoy Aqu√≠"
            self.set_gps_location(10.4806, -66.9036)

            self._super_click(455, 10, "Abrir Selector Direcci√≥n", 9)
            time.sleep(2)

            # Click en la Mira (Usar mi ubicaci√≥n)
            self._super_click(683, 400, "Boton 'Estoy Aqu√≠' (GPS)", 10)
            time.sleep(5)  # Esperar a que cargue el inventario de la tienda

            # --- 3. B√öSQUEDA ---
            self._super_click(960, 60, "Lupa Buscar", 11)
            time.sleep(2)

            # Escribir producto (Ej: Atamel) + ENTER
            PRODUCTO_PRUEBA = "Atamel"  # Cambia esto si quieres probar otro
            self._type_text_at_coords(PRODUCTO_PRUEBA, 160, 160, 12, submit=True)

            logger.info("‚è≥ Esperando resultados de b√∫squeda (5s)...")
            time.sleep(5)

            # --- 4. SELECCI√ìN ---
            # Clic en el primer resultado (Coordenada aproximada de la lista)
            self._super_click(150, 250, "Primer Producto", 13)
            time.sleep(5)

            # FOTO FINAL
            output_path = "/tmp/debug_ec_search.png"
            self.driver.save_screenshot(output_path)
            if os.path.exists(output_path):
                logger.info(f"üì∏ FOTO FINAL: {output_path}")

            return True

        except Exception as e:
            logger.error(f"‚ùå Crash: {e}")
            return False
        finally:
            self.close()


if __name__ == "__main__":
    bot = ECScraper()
    bot.login_and_search()


==================================================
ARCHIVO: ./tasks/scraper/order_scraper.py
==================================================

import shutil
import logging
import time
import re
import os
import glob
import requests
from bs4 import BeautifulSoup
from typing import List, Dict, Any, Optional
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.keys import Keys
from selenium.common.exceptions import NoSuchElementException
from selenium.webdriver.chrome.service import Service
from app.core.config import settings


logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class OrderScraper:
    def __init__(self):
        self.BASE_URL = "https://ecosistema.gopharma.com.ve"
        self.LOGIN_URL = f"{self.BASE_URL}/login/admin"
        # --- AGREGAR ESTA L√çNEA ---
        self.orders_url = f"{self.BASE_URL}/admin/order/list/all"
        # --------------------------
        self.driver = None
        self.download_dir = "/tmp/downloads"

    def setup_driver(self):
        # Importaciones locales para no ensuciar el resto del archivo
        from selenium.webdriver.chrome.service import Service
        from selenium.webdriver.chrome.options import Options
        from webdriver_manager.chrome import ChromeDriverManager
        import logging

        chrome_options = Options()
        chrome_options.add_argument("--headless=new")
        chrome_options.add_argument("--no-sandbox")
        chrome_options.add_argument("--disable-dev-shm-usage")
        chrome_options.add_argument("--disable-gpu")
        chrome_options.add_argument("--window-size=1920,1080")

        # Configuraci√≥n de descargas
        self.download_dir = "/tmp/downloads"
        if not os.path.exists(self.download_dir):
            os.makedirs(self.download_dir, mode=0o777)

        prefs = {
            "download.default_directory": self.download_dir,
            "download.prompt_for_download": False,
            "safebrowsing.enabled": True,
        }
        chrome_options.add_experimental_option("prefs", prefs)

        # --- INSTALACI√ìN AUTOM√ÅTICA DEL DRIVER ---
        try:
            logger.info("üîß Instalando ChromeDriver compatible...")
            # Esto descarga la versi√≥n exacta para el Chrome que tienes instalado
            driver_path = ChromeDriverManager().install()

            # Correcci√≥n de permisos (a veces baja sin permisos de ejecuci√≥n)
            os.chmod(driver_path, 0o755)

            service = Service(executable_path=driver_path)
            self.driver = webdriver.Chrome(service=service, options=chrome_options)
            logger.info(f"‚úÖ Driver iniciado correctamente desde: {driver_path}")

        except Exception as e:
            logger.error(f"‚ùå Error fatal iniciando driver: {e}")
            raise e

        # Comandos CDP finales
        try:
            params = {"behavior": "allow", "downloadPath": self.download_dir}
            self.driver.execute_cdp_cmd("Page.setDownloadBehavior", params)
        except:
            pass

    def login(self):
        if self.driver:
            try:
                # Si estamos en dashboard o admin, es v√°lido
                if (
                    "dashboard" in self.driver.current_url
                    or "/admin" in self.driver.current_url
                ):
                    return True
            except:
                pass
        else:
            self.setup_driver()

        max_retries = 3
        for attempt in range(1, max_retries + 1):
            try:
                logger.info(f"üîë Intento de Login {attempt}/{max_retries}...")

                # LIMPIEZA PREVENTIVA: Borrar cookies para evitar "Session Expired"
                try:
                    self.driver.delete_all_cookies()
                except:
                    pass

                self.driver.get(self.LOGIN_URL)

                # MANEJO EXPL√çCITO DE ALERTAS (Doble seguridad)
                try:
                    WebDriverWait(self.driver, 3).until(EC.alert_is_present())
                    alert = self.driver.switch_to.alert
                    logger.warning(f"‚ö†Ô∏è Alerta detectada y aceptada: {alert.text}")
                    alert.accept()
                except:
                    pass

                # Validar si ya entr√≥
                if "dashboard" in self.driver.current_url:
                    return True

                wait = WebDriverWait(self.driver, 20)
                email_input = wait.until(
                    EC.presence_of_element_located((By.NAME, "email"))
                )
                email_input.clear()
                email_input.send_keys(settings.GOPHARMA_EMAIL)
                time.sleep(0.5)

                pass_input = self.driver.find_element(By.NAME, "password")
                pass_input.clear()
                pass_input.send_keys(settings.GOPHARMA_PASSWORD)
                pass_input.send_keys(Keys.RETURN)

                # Esperamos dashboard O admin
                wait.until(
                    lambda d: "dashboard" in d.current_url or "/admin" in d.current_url
                )
                logger.info("‚úÖ Login Exitoso.")
                return True

            except Exception as e:
                logger.warning(f"‚ö†Ô∏è Fall√≥ intento {attempt}: {e}")
                # Si hay una alerta bloqueando, intentamos aceptarla de nuevo
                try:
                    self.driver.switch_to.alert.accept()
                except:
                    pass

                if self.driver:
                    self.driver.save_screenshot(
                        f"/app/static/error_login_try_{attempt}.png"
                    )

                time.sleep(2)

        logger.error("‚ùå Se agotaron los intentos de Login.")
        self.close_driver()
        return False

    def close_driver(self):
        if self.driver:
            try:
                self.driver.quit()
            except:
                pass
            self.driver = None

    def get_official_data_json(self, order_id: str):
        if not self.login():
            return None

        # 1. Limpieza
        if not os.path.exists(self.download_dir):
            os.makedirs(self.download_dir, mode=0o777)
        for f in glob.glob(os.path.join(self.download_dir, "*")):
            try:
                os.remove(f)
            except:
                pass

        # Permisos
        try:
            self.driver.execute_cdp_cmd(
                "Page.setDownloadBehavior",
                {"behavior": "allow", "downloadPath": self.download_dir},
            )
        except:
            pass

        logger.info(f"ü§ñ Robot: Auditando pedido #{order_id} (Smart Parser)...")

        try:
            self.driver.get(f"{self.BASE_URL}/admin/order/list/all")

            # 2. FILTRADO
            search_input = WebDriverWait(self.driver, 10).until(
                EC.visibility_of_element_located((By.ID, "datatableSearch_"))
            )
            search_input.clear()
            search_input.send_keys(order_id)
            search_input.send_keys(Keys.RETURN)
            time.sleep(3)

            # 3. CLICK CSV (Sin target blank)
            try:
                export_btn = self.driver.find_element(
                    By.CSS_SELECTOR, ".js-hs-unfold-invoker"
                )
                self.driver.execute_script("arguments[0].click();", export_btn)
                time.sleep(1)
                csv_btn = self.driver.find_element(
                    By.XPATH,
                    "//a[contains(@id, 'export-csv') or contains(text(), 'CSV')]",
                )
                self.driver.execute_script(
                    "arguments[0].removeAttribute('target');", csv_btn
                )
                self.driver.execute_script("arguments[0].click();", csv_btn)
            except Exception as e:
                logger.error(f"‚ùå Fall√≥ clic UI: {e}")
                return None

            # 4. ESPERA
            file_path = None
            for i in range(40):
                files = os.listdir(self.download_dir)
                candidates = [f for f in files if f.endswith(".csv")]
                if candidates:
                    full_path = os.path.join(self.download_dir, candidates[0])
                    if os.path.getsize(full_path) > 50:
                        file_path = full_path
                        break
                time.sleep(1)

            if not file_path:
                return None

            # 5. PARSEO INTELIGENTE (AQU√ç EST√Å LA MAGIA)
            logger.info(f"üìÑ Analizando estructura CSV: {file_path}")
            try:
                import csv

                # Leemos todas las l√≠neas primero
                with open(file_path, "r", encoding="utf-8-sig", errors="replace") as f:
                    lines = f.readlines()

                # A. BUSCAR DONDE EMPIEZAN LOS DATOS
                start_index = 0
                header_line = ""

                for i, line in enumerate(lines):
                    # Buscamos una columna clave que sabemos que existe
                    if "ID del pedido" in line or "order_id" in line or "Fecha" in line:
                        start_index = i
                        header_line = line
                        break

                logger.info(
                    f"üéØ Encabezados encontrados en l√≠nea {start_index}: {header_line.strip()[:50]}..."
                )

                # B. DETECTAR SEPARADOR (; o ,)
                # Contamos cu√°l aparece m√°s en la l√≠nea de encabezado
                semicolons = header_line.count(";")
                commas = header_line.count(",")
                delimiter = ";" if semicolons > commas else ","
                logger.info(f"üîç Separador detectado: '{delimiter}'")

                # C. PARSEAR DESDE LA L√çNEA CORRECTA
                data_list = []
                # Pasamos las l√≠neas desde start_index en adelante
                reader = csv.DictReader(lines[start_index:], delimiter=delimiter)

                for row in reader:
                    # Limpieza profunda de keys y values
                    clean_row = {}
                    for k, v in row.items():
                        if k:  # Solo si la llave existe
                            # Quitamos espacios y caracteres raros del nombre de la columna
                            clean_key = k.strip().replace('"', "")
                            clean_val = (v or "").strip().replace('"', "")
                            clean_row[clean_key] = clean_val

                    data_list.append(clean_row)

                return data_list

            except Exception as e:
                logger.error(f"‚ö†Ô∏è Error parseando CSV: {e}")
                return None

        except Exception as e:
            logger.error(f"‚ùå Crash Scraper: {e}")
            return None
        finally:
            self.close_driver()

    def _parse_duration(self, row_element) -> str:
        """Extrae el texto de duraci√≥n de la fila."""
        try:
            # Buscamos en la segunda columna (td[2]) que suele tener la fecha y duraci√≥n
            # Ojo: XPath relativo a la fila
            div = row_element.find_element(
                By.XPATH, ".//div[contains(., 'Duraci√≥n de tiempo')]"
            )
            return " ".join(div.text.replace("Duraci√≥n de tiempo:", "").strip().split())
        except:
            return ""

    def get_recent_order_ids(self, limit: int = 25) -> List[Dict[str, str]]:
        """
        Retorna lista de dicts: [{'id': '123', 'duration': '1h 5m'}]
        """
        if not self.driver:
            self.setup_driver()
            self.login()
        orders_found = []

        try:
            self.driver.get(self.orders_url)
            WebDriverWait(self.driver, 15).until(
                EC.presence_of_element_located((By.ID, "datatable"))
            )

            rows = self.driver.find_elements(
                By.XPATH, "//table[@id='datatable']/tbody/tr"
            )

            for row in rows:
                if len(orders_found) >= limit:
                    break
                try:
                    # Ignorar filas basura
                    if "Carrito" in row.text or "group-separator" in row.get_attribute(
                        "class"
                    ):
                        continue

                    # ID
                    link = row.find_element(
                        By.XPATH, ".//a[contains(@href, '/order/details/')]"
                    )
                    href = link.get_attribute("href")
                    order_id = href.split("/")[-1]

                    # Duraci√≥n (La rescatamos aqu√≠)
                    duration = self._parse_duration(row)

                    if order_id.isdigit():
                        orders_found.append({"id": order_id, "duration": duration})
                except:
                    continue

        except Exception as e:
            logger.error(f"Error get_recent: {e}")

        return orders_found

    def get_historical_ids(self, max_pages: int = None) -> List[Dict[str, str]]:
        """
        Navega por la paginaci√≥n hasta el final.
        Si max_pages es None, sigue hasta que no haya bot√≥n 'Siguiente'.
        """
        if not self.driver:
            self.setup_driver()
            self.login()
        all_data = []

        try:
            self.driver.get(self.orders_url)
            WebDriverWait(self.driver, 15).until(
                EC.presence_of_element_located((By.ID, "datatable"))
            )

            current_page = 1
            while True:
                # Freno de emergencia opcional (si se pasa un n√∫mero expl√≠cito)
                if max_pages and current_page > max_pages:
                    logger.info(
                        f"üõë L√≠mite de seguridad alcanzado ({max_pages} p√°gs). Deteniendo."
                    )
                    break

                logger.info(f"üìÑ Escaneando p√°g {current_page}...")

                rows = self.driver.find_elements(
                    By.XPATH, "//table[@id='datatable']/tbody/tr"
                )
                page_data = []

                for row in rows:
                    try:
                        if "Carrito" in row.text:
                            continue

                        link = row.find_element(
                            By.XPATH, ".//a[contains(@href, '/order/details/')]"
                        )
                        order_id = link.get_attribute("href").split("/")[-1]
                        duration = self._parse_duration(row)

                        if order_id.isdigit():
                            page_data.append({"id": order_id, "duration": duration})
                    except:
                        continue

                all_data.extend(page_data)

                # --- L√ìGICA DE PAGINACI√ìN INFINITA ---
                try:
                    next_btn = self.driver.find_element(
                        By.XPATH, "//a[@aria-label='Next ¬ª']"
                    )

                    # Verificamos si el bot√≥n est√° deshabilitado (clase 'disabled' en el padre <li>)
                    parent = next_btn.find_element(By.XPATH, "./..")
                    if "disabled" in parent.get_attribute("class"):
                        logger.info("üö´ Fin de la paginaci√≥n (Bot√≥n deshabilitado).")
                        break

                    # Click para avanzar
                    self.driver.execute_script("arguments[0].click();", next_btn)

                    # Esperamos que cargue la siguiente p√°gina
                    # (Peque√±a pausa t√©cnica para no saturar y dar tiempo al DOM)
                    time.sleep(2)

                    current_page += 1
                except NoSuchElementException:
                    logger.info("üö´ No se encontr√≥ bot√≥n siguiente. Fin de la lista.")
                    break
                except Exception as e:
                    logger.error(f"‚ö†Ô∏è Error al cambiar de p√°gina: {e}")
                    break

        except Exception as e:
            logger.error(f"Error backfill: {e}")

        # Deduplicar
        unique = {d["id"]: d for d in all_data}
        return list(unique.values())


==================================================
ARCHIVO: ./tasks/scraper/store_scraper.py
==================================================

import logging
import re
import time
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.service import Service as ChromeService
from webdriver_manager.chrome import ChromeDriverManager
from app.core.config import settings

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class StoreScraper:
    def __init__(self):
        self.base_url = "https://ecosistema.gopharma.com.ve/login/admin"
        self.driver = None

    def setup_driver(self):
        if self.driver: return
        chrome_options = Options()
        chrome_options.add_argument("--headless=new")
        chrome_options.add_argument("--no-sandbox")
        chrome_options.add_argument("--disable-dev-shm-usage")
        chrome_options.add_argument("--disable-gpu")
        chrome_options.add_argument("--remote-allow-origins=*")
        chrome_options.add_argument("user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36")
        
        # --- CORRECCI√ìN ---
        service = ChromeService()
        # ------------------
        
        self.driver = webdriver.Chrome(service=service, options=chrome_options)

    def login(self) -> bool:
        if not self.driver: self.setup_driver()
        try:
            self.driver.get(self.base_url)
            wait = WebDriverWait(self.driver, 10)
            wait.until(EC.presence_of_element_located((By.NAME, "email"))).send_keys(settings.GOPHARMA_EMAIL)
            self.driver.find_element(By.NAME, "password").send_keys(settings.GOPHARMA_PASSWORD)
            try: self.driver.find_element(By.XPATH, "//button[@type='submit']").click()
            except: self.driver.find_element(By.NAME, "password").submit()
            time.sleep(3)
            return "login" not in self.driver.current_url
        except: return False

    def close_driver(self):
        if self.driver:
            try: self.driver.quit()
            except: pass
            self.driver = None

    def scrape_commission(self, store_real_id: str) -> float:
        """
        Entra a la configuraci√≥n de la tienda y saca el % de comisi√≥n.
        Url objetivo: .../admin/store/view/{id}/business_plan
        """
        if not self.driver: self.setup_driver(); self.login()
        
        url = f"https://ecosistema.gopharma.com.ve/admin/store/view/{store_real_id}/business_plan"
        
        try:
            self.driver.get(url)
            WebDriverWait(self.driver, 5).until(EC.presence_of_element_located((By.TAG_NAME, "body")))
            
            # 1. Intentar sacar del input ID="comission"
            try:
                input_el = self.driver.find_element(By.ID, "comission")
                val = input_el.get_attribute("value")
                return float(val)
            except: pass

            # 2. Intentar sacar del texto "10 % Comisi√≥n"
            try:
                body = self.driver.find_element(By.TAG_NAME, "body").text
                match = re.search(r"(\d+(?:\.\d+)?)%\s*comisi√≥n", body, re.IGNORECASE)
                if match: return float(match.group(1))
            except: pass

        except Exception as e:
            logger.error(f"Error scraping store {store_real_id}: {e}")
        
        return 0.0


==================================================
ARCHIVO: ./tasks/scraper/check_resolution.py
==================================================

import logging
import time
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.chrome.service import Service

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


def check_screen():
    options = Options()
    # Usamos la configuraci√≥n actual para ver qu√© est√° pasando realmente
    options.add_argument("--window-size=1366,768")
    options.add_argument("--headless=new")
    options.add_argument("--no-sandbox")

    service = Service()
    driver = webdriver.Chrome(service=service, options=options)

    try:
        logger.info("üìè Midiendo resoluci√≥n real del Servidor...")
        driver.get("https://ec.gopharma.com.ve/?from-splash=false")
        time.sleep(5)

        # MAGIA JAVASCRIPT: Obtener el tama√±o √∫til real (Viewport)
        # Esto es lo que realmente importa para los clics, no el tama√±o de la ventana externa.
        metrics = driver.execute_script(
            """
            return {
                outerWidth: window.outerWidth,
                outerHeight: window.outerHeight,
                innerWidth: window.innerWidth,   
                innerHeight: window.innerHeight,
                dpr: window.devicePixelRatio
            };
        """
        )

        print("\n" + "=" * 40)
        print(f"üñ•Ô∏è  DATOS REALES DEL SERVIDOR:")
        print(
            f"   ‚Ä¢ Ventana Externa: {metrics['outerWidth']} x {metrics['outerHeight']}"
        )
        print(
            f"   ‚Ä¢ LIENZO √öTIL (Viewport): {metrics['innerWidth']} x {metrics['innerHeight']}"
        )
        print(f"   ‚Ä¢ Pixel Ratio: {metrics['dpr']}")
        print("=" * 40 + "\n")

    finally:
        driver.quit()


if __name__ == "__main__":
    check_screen()


==================================================
ARCHIVO: ./tasks/scraper/store_controller.py
==================================================

import logging
import time
import os
import re
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys  # <--- NECESARIO
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
from app.core.config import settings

logging.basicConfig(
    level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)


class StoreControllerScraper:
    def __init__(self):
        self.BASE_URL = "https://ecosistema.gopharma.com.ve"
        self.LOGIN_URL = f"{self.BASE_URL}/login/admin"
        self.LIST_URL = f"{self.BASE_URL}/admin/store/list"
        self.driver = None

    def setup_driver(self):
        if self.driver:
            return
        options = Options()
        options.add_argument("--headless=new")
        options.add_argument("--no-sandbox")
        options.add_argument("--disable-dev-shm-usage")
        options.add_argument("--window-size=1920,1080")
        options.add_argument("--disable-blink-features=AutomationControlled")

        # Opciones extra para estabilidad
        options.add_argument("--disable-gpu")
        options.add_argument("--ignore-certificate-errors")

        try:
            driver_path = ChromeDriverManager().install()
            service = Service(executable_path=driver_path)
            self.driver = webdriver.Chrome(service=service, options=options)
        except:
            service = Service(executable_path="/usr/bin/chromedriver")
            self.driver = webdriver.Chrome(service=service, options=options)

    def login(self):
        if not self.driver:
            self.setup_driver()
        try:
            self.driver.get(self.LOGIN_URL)
            wait = WebDriverWait(self.driver, 15)
            email = wait.until(EC.element_to_be_clickable((By.NAME, "email")))
            email.clear()
            email.send_keys(settings.GOPHARMA_EMAIL)

            pwd = self.driver.find_element(By.NAME, "password")
            pwd.clear()
            pwd.send_keys(settings.GOPHARMA_PASSWORD)

            btn = self.driver.find_element(By.XPATH, "//button[@type='submit']")
            self.driver.execute_script("arguments[0].click();", btn)
            time.sleep(5)
            return True
        except Exception as e:
            logger.error(f"Error Login: {e}")
            return False

    def close(self):
        if self.driver:
            try:
                self.driver.quit()
            except:
                pass
            self.driver = None

    def _super_click(self, element, x, y):
        """Simula presi√≥n humana sobre un elemento"""
        try:
            js_down = f"""
                var target = arguments[0];
                var opts = {{ bubbles: true, cancelable: true, view: window, clientX: {x}, clientY: {y}, pointerId: 1, pointerType: 'mouse', buttons: 1 }};
                target.dispatchEvent(new PointerEvent('pointerdown', opts));
                target.dispatchEvent(new MouseEvent('mousedown', opts));
            """
            self.driver.execute_script(js_down, element)
            time.sleep(0.2)
            js_up = f"""
                var target = arguments[0];
                var opts = {{ bubbles: true, cancelable: true, view: window, clientX: {x}, clientY: {y}, pointerId: 1, pointerType: 'mouse', buttons: 0 }};
                target.dispatchEvent(new PointerEvent('pointerup', opts));
                target.dispatchEvent(new MouseEvent('mouseup', opts));
                target.dispatchEvent(new MouseEvent('click', opts));
            """
            self.driver.execute_script(js_up, element)
            return True
        except:
            return False

    def enforce_store_status(self, store_name, desired_status_bool):
        if not self.driver:
            self.login()

        try:
            # Solo navegar si no estamos ya en la lista
            if "/admin/store/list" not in self.driver.current_url:
                self.driver.get(self.LIST_URL)

            wait = WebDriverWait(self.driver, 10)

            # 1. LIMPIEZA DEL NOMBRE
            clean_name = (
                store_name.replace("C.A.", "")
                .replace("S.A.", "")
                .replace(",", "")
                .replace(".", "")
                .strip()
            )
            words = clean_name.split()

            # Palabras comunes a ignorar para generar el t√©rmino de b√∫squeda
            forbidden = [
                "EL",
                "LA",
                "LOS",
                "LAS",
                "DE",
                "DEL",
                "Y",
                "FARMACIA",
                "FARMACIAS",
                "SUCURSAL",
                "SUCURLSAL",
                "GRUPO",
                "INVERSIONES",
                "DROGUERIA",
            ]

            # Buscar palabra clave m√°s fuerte
            search_term = next(
                (w for w in words if w.upper() not in forbidden and len(w) > 2),
                words[0],  # Si todas son prohibidas, usar la primera (ej: GRUPO)
            )

            logger.info(f"üîç Buscando '{store_name}' con t√©rmino: '{search_term}'")

            # 2. SELECCIONAR EL INPUT CORRECTO (ID ESPEC√çFICO)
            # Usamos datatableSearch_ porque es el que hace la b√∫squeda global en el servidor
            try:
                search_input = wait.until(
                    EC.element_to_be_clickable((By.ID, "datatableSearch_"))
                )
            except:
                # Fallback por si cambian el ID
                search_input = self.driver.find_element(
                    By.CSS_SELECTOR, "input[type='search']"
                )

            search_input.clear()
            search_input.send_keys(search_term)
            time.sleep(1)
            search_input.send_keys(Keys.ENTER)  # Importante: Presionar Enter

            # Esperar a que la tabla se actualice
            time.sleep(4)

            # 3. IDENTIFICAR FILAS Y EXTRAER ID
            # Buscamos en el tbody con ID "set-rows"
            tbody = self.driver.find_element(By.ID, "set-rows")
            rows = tbody.find_elements(By.TAG_NAME, "tr")

            real_legacy_id = None

            if not rows or (len(rows) == 1 and "No data found" in rows[0].text):
                # INTENTO 2: Si fall√≥, buscar por el nombre limpio completo (ej: "GRUPO FARMAYA")
                logger.warning(
                    f"‚ö†Ô∏è Fall√≥ b√∫squeda por '{search_term}'. Intentando nombre completo: '{clean_name}'"
                )
                search_input.clear()
                search_input.send_keys(clean_name)
                search_input.send_keys(Keys.ENTER)
                time.sleep(4)
                tbody = self.driver.find_element(By.ID, "set-rows")
                rows = tbody.find_elements(By.TAG_NAME, "tr")

            for row in rows:
                # Obtenemos todo el texto de la fila. Selenium concatena los divs.
                # En tu HTML: GRUPO FARMAYA C.A. \n ID:3
                row_text = row.text.upper()

                # Buscamos coincidencia flexible
                if search_term.upper() in row_text or clean_name.upper() in row_text:
                    # Regex para capturar el ID. En tu HTML es "ID:3" o "ID: 3"
                    id_match = re.search(r"ID\s*:\s*(\d+)", row.text)
                    if id_match:
                        real_legacy_id = id_match.group(1)
                        break

            if not real_legacy_id:
                # √öltimo recurso: si solo hay 1 fila y buscamos algo muy espec√≠fico, asumimos que es esa
                if len(rows) == 1:
                    id_match = re.search(r"ID\s*:\s*(\d+)", rows[0].text)
                    if id_match:
                        real_legacy_id = id_match.group(1)
                        logger.warning(
                            f"‚ö†Ô∏è Match forzado por fila √∫nica para {store_name} -> ID {real_legacy_id}"
                        )

            if not real_legacy_id:
                raise Exception(
                    f"No se encontr√≥ el ID num√©rico para {store_name} en la tabla."
                )

            logger.info(f"üéØ ID Real Detectado para '{store_name}': {real_legacy_id}")

            # 4. INTERACTUAR CON EL SWITCH
            # Basado en tu HTML: id="activeCheckbox3"
            checkbox_id = f"activeCheckbox{real_legacy_id}"

            # Verificar estado actual v√≠a JS para exactitud
            is_on = self.driver.execute_script(
                f"return document.getElementById('{checkbox_id}') != null && document.getElementById('{checkbox_id}').checked;"
            )

            logger.info(
                f"Estado de {store_name} (#{real_legacy_id}): {'ON' if is_on else 'OFF'}"
            )

            # 5. EJECUTAR CAMBIO SI ES NECESARIO (Solo APAGAR seg√∫n tu l√≥gica original)
            if not desired_status_bool and is_on:
                logger.info(f"üîå [ACCI√ìN REAL] Apagando {store_name}...")

                # Buscamos el LABEL que es lo que recibe el click visualmente
                label = self.driver.find_element(
                    By.CSS_SELECTOR, f"label[for='{checkbox_id}']"
                )

                # Scroll para asegurar visibilidad
                self.driver.execute_script(
                    "arguments[0].scrollIntoView({block: 'center'});", label
                )
                time.sleep(0.5)

                # Click potente
                clicked = self._super_click(
                    label, label.location["x"], label.location["y"]
                )
                if not clicked:
                    label.click()

                # Confirmar SweetAlert
                try:
                    confirm = WebDriverWait(self.driver, 3).until(
                        EC.element_to_be_clickable(
                            (
                                By.CSS_SELECTOR,
                                ".swal2-confirm, .confirm, button.swal2-confirm",
                            )
                        )
                    )
                    confirm.click()
                    time.sleep(2)
                except:
                    pass
                return True

            logger.info(f"‚èπÔ∏è {store_name} ya estaba en estado correcto.")
            return False

        except Exception as e:
            # Captura de pantalla para debug
            try:
                self.driver.save_screenshot(
                    f"/tmp/debug_error_{store_name.replace(' ', '_')}.png"
                )
            except:
                pass
            logger.error(f"‚ùå Error cr√≠tico en {store_name}: {e}")
            return False


==================================================
ARCHIVO: ./tests/__init__.py
==================================================



==================================================
ARCHIVO: ./tests/test_analysis.py
==================================================

