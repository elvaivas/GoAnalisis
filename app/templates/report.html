<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reporte Ejecutivo - GoAnalisis</title>
    <!-- Bootstrap 5 & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        
        /* Tarjetas KPI */
        .report-card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; height: 100%; page-break-inside: avoid; }
        .kpi-title { font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 5px; }
        .kpi-value { font-size: 1.6rem; font-weight: 800; color: #111827; }
        
        /* Explicación de Fórmulas */
        .formula-text { font-size: 0.65rem; color: #9ca3af; margin-top: 8px; border-top: 1px dashed #e5e7eb; padding-top: 4px; line-height: 1.2; font-family: 'Consolas', monospace; }
        
        /* Secciones */
        .section-header { margin-top: 30px; margin-bottom: 15px; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px; color: #374151; font-weight: bold; font-size: 1.1rem; }
        
        /* Tablas */
        .table-sm td, .table-sm th { padding: 0.4rem; font-size: 0.85rem; }
        
        /* Impresión */
        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .report-card { box-shadow: none; border: 1px solid #ccc; }
            .container { max-width: 100% !important; width: 100% !important; }
        }
    </style>
</head>
<body class="py-4">

    <div class="container">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center">
                <!-- Logo: Asegúrate de que la ruta sea correcta -->
                <img src="/static/img/logo.png" height="45" class="me-3" alt="GoPharma"> 
                <div>
                    <h3 class="fw-bold mb-0 text-dark">Reporte de Gestión</h3>
                    <p class="text-muted mb-0" id="report-range">Generando...</p>
                </div>
            </div>
            <div class="no-print">
                <button onclick="window.print()" class="btn btn-dark"><i class="fa-solid fa-print me-2"></i>Imprimir / PDF</button>
                <button onclick="window.close()" class="btn btn-outline-secondary">Cerrar</button>
            </div>
        </div>

        <!-- 1. FINANZAS (El Núcleo del Negocio) -->
        <div class="section-header"><i class="fa-solid fa-coins me-2"></i>Desempeño Financiero Real</div>
        <div class="row g-3">
            
            <!-- GMV -->
            <div class="col-md-3">
                <div class="report-card border-top border-4 border-secondary">
                    <div class="kpi-title text-secondary">Recaudación Total (GMV)</div>
                    <div class="kpi-value" id="r-revenue">--</div>
                    <div class="formula-text">Suma total facturada en pedidos entregados.</div>
                </div>
            </div>

            <!-- Costo Delivery Bruto -->
            <div class="col-md-3">
                <div class="report-card border-top border-4 border-primary">
                    <div class="kpi-title text-primary">Valor Bruto Envíos</div>
                    <div class="kpi-value text-primary" id="r-fee">--</div>
                    <div class="formula-text">Suma de tarifas de envío reales (antes de descuentos).</div>
                </div>
            </div>

            <!-- Nómina Motorizados -->
            <div class="col-md-3">
                <div class="report-card border-top border-4 border-warning">
                    <div class="kpi-title text-warning">Pago a Motorizados</div>
                    <div class="kpi-value text-warning" id="r-payout">--</div>
                    <div class="formula-text"><strong>80%</strong> del Valor Bruto de Envíos.</div>
                </div>
            </div>

            <!-- Inversión Marketing -->
            <div class="col-md-3">
                <div class="report-card border-top border-4 border-danger">
                    <div class="kpi-title text-danger">Subsidio / Cupones</div>
                    <div class="kpi-value text-danger" id="r-coupons">--</div>
                    <div class="formula-text">Costo asumido por la empresa (Delivery Gratis).</div>
                </div>
            </div>
        </div>

        <div class="row g-3 mt-1">
             <!-- GANANCIA NETA -->
             <div class="col-md-4">
                <div class="report-card bg-success bg-opacity-10 border border-success">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="kpi-title text-success fw-bold">GANANCIA NETA (EBITDA)</div>
                            <div class="kpi-value text-success" id="r-profit">--</div>
                        </div>
                        <i class="fa-solid fa-chart-line fa-3x text-success opacity-25"></i>
                    </div>
                    <div class="formula-text text-dark mt-2">
                        <strong>Fórmula:</strong><br>
                        [(20% Delivery + 5% Servicio + % Comisión) / 1.16] - Cupones
                    </div>
                </div>
            </div>

            <!-- Dinero Perdido -->
            <div class="col-md-4">
                <div class="report-card border-top border-4 border-dark">
                    <div class="kpi-title">Costo de Oportunidad</div>
                    <div class="kpi-value text-muted" id="r-lost">--</div>
                    <div class="formula-text">Valor total de pedidos <strong>Cancelados</strong> (Ventas perdidas).</div>
                </div>
            </div>

            <!-- Ticket Promedio -->
            <div class="col-md-4">
                <div class="report-card border-top border-4 border-info">
                    <div class="kpi-title text-info">Ticket Promedio</div>
                    <div class="kpi-value text-info" id="r-ticket">--</div>
                    <div class="formula-text">Recaudación / Cantidad de Pedidos.</div>
                </div>
            </div>
        </div>

        <!-- 2. CRECIMIENTO Y OPERACIONES -->
        <div class="section-header"><i class="fa-solid fa-users me-2"></i>Crecimiento y Eficiencia</div>
        <div class="row g-3">
            <div class="col-md-2">
                <div class="report-card text-center">
                    <div class="kpi-title">Pedidos Totales</div>
                    <div class="h4 fw-bold mb-0" id="r-orders">--</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="report-card text-center">
                    <div class="kpi-title text-info">Delivery</div>
                    <div class="h4 fw-bold mb-0 text-info" id="r-delivery">--</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="report-card text-center">
                    <div class="kpi-title text-warning">Pickup</div>
                    <div class="h4 fw-bold mb-0 text-warning" id="r-pickup">--</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="report-card text-center">
                    <div class="kpi-title text-success">Nuevos Usuarios</div>
                    <div class="h4 fw-bold mb-0 text-success" id="r-new-users">--</div>
                    <small class="text-muted" style="font-size: 0.6em;">Registrados en periodo</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="report-card text-center">
                    <div class="kpi-title text-primary">Usuarios Activos</div>
                    <div class="h4 fw-bold mb-0 text-primary" id="r-active-users">--</div>
                    <small class="text-muted" style="font-size: 0.6em;">Compraron en periodo</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="report-card text-center">
                    <div class="kpi-title">Tiempo Promedio</div>
                    <div class="h4 fw-bold mb-0" id="r-time">--</div>
                    <small class="text-muted" style="font-size: 0.6em;">Minutos</small>
                </div>
            </div>
        </div>

        <!-- 3. GRÁFICOS Y DETALLES -->
        <div class="row g-4 mt-2">
            <div class="col-md-8">
                <div class="report-card">
                    <h6 class="fw-bold mb-3 small text-uppercase">Tendencia de Ingresos vs Pedidos</h6>
                    <div style="height: 300px;"><canvas id="rTrendsChart"></canvas></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="report-card">
                    <h6 class="fw-bold mb-3 small text-uppercase">Razones de Cancelación</h6>
                    <div style="height: 300px;"><canvas id="rCancelChart"></canvas></div>
                </div>
            </div>
        </div>

        <div class="row g-4 mt-2">
            <div class="col-md-6">
                <div class="report-card">
                    <h6 class="fw-bold mb-2 small text-uppercase text-success">Top 10 Farmacias (Ventas)</h6>
                    <table class="table table-sm table-striped">
                        <thead><tr class="text-muted"><th>Nombre</th><th class="text-end">Pedidos</th></tr></thead>
                        <tbody id="r-stores-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="col-md-6">
                <div class="report-card">
                    <h6 class="fw-bold mb-2 small text-uppercase text-warning">Top 10 Motorizados (Eficiencia)</h6>
                    <table class="table table-sm table-striped">
                        <thead><tr class="text-muted"><th>Nombre</th><th class="text-end">Entregas</th><th class="text-end">Estado</th></tr></thead>
                        <tbody id="r-drivers-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPT DE CARGA -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            if (!token) { alert("Acceso denegado. Inicie sesión."); window.location.href='/login'; return; }

            // Leer URL Params
            const params = new URLSearchParams(window.location.search);
            const start = params.get('start_date') || "Inicio";
            const end = params.get('end_date') || "Hoy";
            document.getElementById('report-range').textContent = `Periodo analizado: ${start} al ${end}`;

            const headers = { 'Authorization': `Bearer ${token}` };
            const api = '/api';

            const fmt = (n) => `$${(n||0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

            try {
                // 1. CARGAR KPIs
                const kpiRes = await fetch(`${api}/kpi/main?${params}`, {headers});
                const kpi = await kpiRes.json();

                document.getElementById('r-revenue').textContent = fmt(kpi.total_revenue);
                document.getElementById('r-fee').textContent = fmt(kpi.total_fees);
                document.getElementById('r-payout').textContent = fmt(kpi.driver_payout);
                document.getElementById('r-coupons').textContent = `-${fmt(kpi.total_coupons)}`;
                document.getElementById('r-profit').textContent = fmt(kpi.company_profit);
                document.getElementById('r-lost').textContent = fmt(kpi.lost_revenue);
                document.getElementById('r-ticket').textContent = fmt(kpi.avg_ticket);

                document.getElementById('r-orders').textContent = kpi.total_orders;
                document.getElementById('r-delivery').textContent = kpi.total_deliveries;
                document.getElementById('r-pickup').textContent = kpi.total_pickups;
                document.getElementById('r-new-users').textContent = kpi.new_users_registered;
                document.getElementById('r-active-users').textContent = kpi.active_users_period;
                document.getElementById('r-time').textContent = kpi.avg_delivery_minutes;

                // 2. GRÁFICOS
                const trendsRes = await fetch(`${api}/data/trends?${params}`, {headers});
                const trends = await trendsRes.json();
                new Chart(document.getElementById('rTrendsChart'), {
                    type: 'bar',
                    data: {
                        labels: trends.labels,
                        datasets: [
                            { type: 'line', label: 'Ingresos', data: trends.revenue, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill:true, yAxisID: 'y', tension:0.4 },
                            { type: 'bar', label: 'Pedidos', data: trends.orders, backgroundColor: '#3b82f6', yAxisID: 'y1' }
                        ]
                    },
                    options: { responsive:true, maintainAspectRatio:false, scales: { y:{position:'left'}, y1:{position:'right', grid:{display:false}} } }
                });

                const cancelRes = await fetch(`${api}/analysis/cancellations?${params}`, {headers});
                const cancels = await cancelRes.json();
                new Chart(document.getElementById('rCancelChart'), {
                    type: 'doughnut',
                    data: {
                        labels: cancels.map(d=>d.reason),
                        datasets: [{ data: cancels.map(d=>d.count), backgroundColor: ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#3b82f6'] }]
                    },
                    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right'}} }
                });

                // 3. TABLAS
                const storesRes = await fetch(`${api}/data/top-stores?${params}`, {headers});
                const stores = await storesRes.json();
                const sBody = document.getElementById('r-stores-body');
                stores.slice(0,10).forEach(s => sBody.innerHTML += `<tr><td>${s.name}</td><td class="text-end fw-bold">${s.orders}</td></tr>`);

                const driversRes = await fetch(`${api}/data/driver-leaderboard?${params}`, {headers});
                const drivers = await driversRes.json();
                const dBody = document.getElementById('r-drivers-body');
                drivers.slice(0,10).forEach(d => {
                    const statusColor = d.status === 'active' ? 'success' : (d.status==='warning'?'warning':'danger');
                    dBody.innerHTML += `<tr><td>${d.name}</td><td class="text-end fw-bold">${d.orders}</td><td class="text-end"><span class="badge bg-${statusColor}">${d.status.toUpperCase()}</span></td></tr>`;
                });

            } catch (e) { console.error(e); }
        });
    </script>
</body>
</html>
