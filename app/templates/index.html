<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoAnalisis Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>

    <nav class="navbar navbar-expand-lg sticky-top mb-4">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="/static/img/logo.png" alt="Logo" class="navbar-logo me-2" style="height: 30px;">
                <span class="fw-bold text-white">GoAnalisis</span> 
                <span class="badge bg-primary ms-2" style="font-size: 0.6rem;">V5.0</span>
            </a>
            
            <!-- BOTÓN DE LOGOUT (NUEVO) -->
            <button id="btn-logout" class="btn btn-sm btn-outline-light border-0">
                <i class="fa-solid fa-right-from-bracket me-2"></i> Salir
            </button>
        </div>
    </nav>

    <main class="container-fluid px-4">
        
        <!-- FILTROS Y BÚSQUEDA -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-end g-2">
                    <div class="col-md-4">
                        <label class="form-label text-muted small"><i class="fa-regular fa-calendar me-1"></i> Rango de Fechas</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="date-range-picker" placeholder="Hoy (Por defecto)">
                            <button class="btn btn-outline-secondary border-secondary" type="button" id="btn-all-history" title="Ver Todo el Historial">
                                <i class="fa-solid fa-infinity"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted small"><i class="fa-solid fa-store me-1"></i> Tienda</label>
                        <select class="form-select" id="store-filter"><option value="">Cargando...</option></select>
                    </div>
                    <!-- NUEVO: BUSCADOR -->
                    <div class="col-md-4">
                        <label class="form-label text-muted small"><i class="fa-solid fa-magnifying-glass me-1"></i> Búsqueda Global</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="search-input" placeholder="ID Pedido (Exacto) o Cliente...">
                            <button class="btn btn-outline-secondary border-secondary" type="button" id="btn-clear-search" style="border-left: 0;">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-2 text-end">
                        <button class="btn btn-primary w-100" id="btn-update">
                            <i class="fa-solid fa-rotate-right me-2"></i> Filtrar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPIs FINANCIEROS -->
        <div class="row g-3 mb-3 admin-only">
            <div class="col-12 col-md-6 col-xl">
                <div class="card h-100 border-start border-4 border-secondary"><div class="card-body p-3"><div class="kpi-title text-muted small text-uppercase">Movimiento</div><div class="d-flex justify-content-between align-items-center"><div class="kpi-value h4 mb-0 fw-bold text-white" id="kpi-total-revenue">--</div><i class="fa-solid fa-sack-dollar text-secondary opacity-50 fa-xl"></i></div></div></div>
            </div>
            <div class="col-12 col-md-6 col-xl">
                <div class="card h-100 border-start border-4 border-primary"><div class="card-body p-3"><div class="kpi-title text-primary small text-uppercase fw-bold">Total Delivery</div><div class="d-flex justify-content-between align-items-center"><div class="kpi-value h4 mb-0 fw-bold text-primary" id="kpi-total-fees">--</div><i class="fa-solid fa-motorcycle text-primary opacity-50 fa-xl"></i></div></div></div>
            </div>
            <div class="col-12 col-md-6 col-xl">
                <div class="card h-100 border-start border-4 border-danger bg-danger bg-opacity-10"><div class="card-body p-3"><div class="kpi-title text-danger small text-uppercase fw-bold">Cupones (Inv.)</div><div class="d-flex justify-content-between align-items-center"><div class="kpi-value h4 mb-0 fw-bold text-danger" id="kpi-total-coupons">--</div><i class="fa-solid fa-tags text-danger fa-xl"></i></div></div></div>
            </div>
            <div class="col-12 col-md-6 col-xl">
                <div class="card h-100 border-start border-4 border-warning bg-warning bg-opacity-10"><div class="card-body p-3"><div class="kpi-title text-warning-emphasis small text-uppercase fw-bold">Motorizados</div><div class="d-flex justify-content-between align-items-center"><div class="kpi-value h4 mb-0 fw-bold text-warning-emphasis" id="kpi-driver-payout">--</div><i class="fa-solid fa-helmet-safety fa-xl text-warning"></i></div></div></div>
            </div>
            <div class="col-12 col-md-6 col-xl">
                <div class="card h-100 border-start border-4 border-success bg-success bg-opacity-10"><div class="card-body p-3"><div class="kpi-title text-success small text-uppercase fw-bold">Ganancia Neta</div><div class="d-flex justify-content-between align-items-center"><div class="kpi-value h4 mb-0 fw-bold text-success" id="kpi-company-profit">--</div><i class="fa-solid fa-chart-line fa-xl text-success"></i></div></div></div>
            </div>
        </div>

        <!-- KPIs OPERATIVOS -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-2 col-xl"><div class="card h-100 border-start border-4 border-light"><div class="card-body p-2 text-center"><small class="text-muted text-uppercase fw-bold" style="font-size: 0.65rem;">Total</small><div class="h5 fw-bold mb-0 text-white" id="kpi-total-orders">--</div></div></div></div>
            <div class="col-6 col-md-2 col-xl"><div class="card h-100 border-start border-4 border-info"><div class="card-body p-2 text-center"><small class="text-info text-uppercase fw-bold" style="font-size: 0.65rem;">Delivery</small><div class="h5 fw-bold mb-0 text-white" id="kpi-deliveries">--</div></div></div></div>
            <div class="col-6 col-md-2 col-xl"><div class="card h-100 border-start border-4 border-warning"><div class="card-body p-2 text-center"><small class="text-warning text-uppercase fw-bold" style="font-size: 0.65rem;">Pickup</small><div class="h5 fw-bold mb-0 text-white" id="kpi-pickups">--</div></div></div></div>
            <div class="col-6 col-md-2 col-xl"><div class="card h-100 border-start border-4 border-secondary bg-danger bg-opacity-10"><div class="card-body p-2 text-center"><small class="text-danger text-uppercase fw-bold" style="font-size: 0.65rem;">Cancelados</small><div class="h5 fw-bold mb-0 text-white" id="kpi-canceled">--</div></div></div></div>
            <div class="col-6 col-md-2 col-xl"><div class="card h-100 border-start border-4 border-danger"><div class="card-body p-2 text-center"><small class="text-danger text-uppercase fw-bold" style="font-size: 0.65rem;">Tiempo (min)</small><div class="h5 fw-bold mb-0 text-white" id="kpi-avg-time">--</div></div></div></div>
        </div>

        <!-- TABLA PEDIDOS (Colapsable) -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center cursor-pointer"
                 data-bs-toggle="collapse" data-bs-target="#collapseOrders" aria-expanded="true">
                <span><i class="fa-solid fa-list me-2"></i> Últimos Pedidos <small class="text-muted ms-2" id="last-updated">--:--</small></span>
                <div class="d-flex align-items-center"><span class="badge bg-danger animate-pulse me-3">LIVE</span><i class="fa-solid fa-chevron-down collapse-icon"></i></div>
            </div>
            <div id="collapseOrders" class="collapse show"><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead>
    <tr class="text-muted small text-uppercase">
        <th class="ps-4">ID</th>
        <th>Cliente</th> <!-- Nueva -->
        <th>Estado</th>
        <th>Dist.</th>   <!-- Nueva -->
        <th>Total</th>
        <th>Fee</th>
        <th class="text-end pe-4">Tiempos</th>
    </tr>
</thead><tbody id="recent-orders-table-body"></tbody></table></div></div></div>
        </div>

        <!-- MAPA (Colapsado por defecto: NO TIENE 'show') -->
        <div class="row mb-4 admin-only">
            <div class="col-12">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center cursor-pointer" 
                         data-bs-toggle="collapse" data-bs-target="#collapseMap" aria-expanded="false"> <!-- False inicial -->
                        <span class="text-white"><i class="fa-solid fa-map-location-dot me-2 text-danger"></i> Mapa de Oportunidades</span>
                        <i class="fa-solid fa-chevron-down collapse-icon"></i>
                    </div>
                    <!-- CLASE 'collapse' (Sin show) -->
                    <div id="collapseMap" class="collapse">
                        <div class="card-body p-0">
                            <div id="heatmapContainer" style="height: 400px; width: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TENDENCIAS (Ahora Colapsable y Cerrado) -->
        <div class="row mb-4 admin-only">
            <div class="col-12">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center cursor-pointer"
                         data-bs-toggle="collapse" data-bs-target="#collapseTrends" aria-expanded="false">
                        <span><i class="fa-solid fa-chart-area me-2 text-primary"></i> Tendencias</span>
                        <i class="fa-solid fa-chevron-down collapse-icon"></i>
                    </div>
                    <!-- CLASE 'collapse' (Sin show) -->
                    <div id="collapseTrends" class="collapse">
                        <div class="card-body">
                            <div style="height: 350px;"><canvas id="trendsChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GRÁFICOS INFERIORES -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-header"><i class="fa-solid fa-chart-pie me-2 text-info"></i> Tipo</div>
                    <div class="card-body"><div style="height: 200px;"><canvas id="orderTypeChart"></canvas></div></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header text-danger"><i class="fa-solid fa-ban me-2"></i> Cancelaciones</div>
                    <div class="card-body"><div style="height: 250px;"><canvas id="cancellationChart"></canvas></div></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-header text-warning"><i class="fa-solid fa-hourglass-half me-2"></i> Tiempos (Proceso)</div>
                    <div class="card-body"><div style="height: 250px;"><canvas id="bottleneckChart"></canvas></div></div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header"><i class="fa-solid fa-trophy me-2 text-warning"></i> Top Repartidores</div>
                    <div class="card-body"><div style="height: 300px;"><canvas id="driverLeaderboardChart"></canvas></div></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header"><i class="fa-solid fa-shop me-2 text-success"></i> Top Tiendas</div>
                    <div class="card-body p-0" style="height: 330px; overflow-y: auto;"><ul class="list-group list-group-flush" id="top-stores-list"></ul></div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header"><i class="fa-solid fa-users me-2 text-primary"></i> Clientes Fieles</div>
            <div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0" id="topCustomersTable"><thead><tr><th class="ps-4">#</th><th>Cliente</th><th class="text-center">Pedidos</th><th class="text-end">Total</th><th class="text-end pe-4">Ticket Prom.</th></tr></thead><tbody></tbody></table></div></div>
        </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="/static/js/dashboard.js"></script>
</body>
</html>
